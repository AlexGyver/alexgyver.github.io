/*NON-ESP*/!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).mqtt=e()}}((function(){return function e(t,r,n){function i(o,a){if(!r[o]){if(!t[o]){var l="function"==typeof require&&require;if(!a&&l)return l(o,!0);if(s)return s(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var c=r[o]={exports:{}};t[o][0].call(c.exports,(function(e){return i(t[o][1][e]||e)}),c,c.exports,e,t,r,n)}return r[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.TypedEventEmitter=void 0;const i=n(e("events")),s=e("./shared");class o{}r.TypedEventEmitter=o,(0,s.applyMixin)(o,i.default)},{"./shared":17,events:49}],2:[function(e,t,r){(function(t,n){(function(){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const l=a(e("./topic-alias-recv")),u=a(e("mqtt-packet")),c=a(e("./default-message-id-provider")),h=e("readable-stream"),f=a(e("reinterval")),d=a(e("rfdc/default")),p=o(e("./validations")),b=a(e("debug")),g=a(e("./store")),m=a(e("./handlers")),y=e("./TypedEmitter"),_=t?t.nextTick:e=>{setTimeout(e,0)},w=n.setImmediate||((...e)=>{const t=e.shift();_((()=>{t(...e)}))}),v={keepalive:60,reschedulePings:!0,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,connectTimeout:3e4,clean:!0,resubscribe:!0,writeCache:!0},S=["ECONNREFUSED","EADDRINUSE","ECONNRESET","ENOTFOUND","ETIMEDOUT"];class E extends y.TypedEventEmitter{static defaultId(){return`mqttjs_${Math.random().toString(16).substr(2,8)}`}constructor(e,t){super(),this.options=t||{};for(const e in v)void 0===this.options[e]?this.options[e]=v[e]:this.options[e]=t[e];this.log=this.options.log||(0,b.default)("mqttjs:client"),this.noop=this._noop.bind(this),this.log("MqttClient :: options.protocol",t.protocol),this.log("MqttClient :: options.protocolVersion",t.protocolVersion),this.log("MqttClient :: options.username",t.username),this.log("MqttClient :: options.keepalive",t.keepalive),this.log("MqttClient :: options.reconnectPeriod",t.reconnectPeriod),this.log("MqttClient :: options.rejectUnauthorized",t.rejectUnauthorized),this.log("MqttClient :: options.properties.topicAliasMaximum",t.properties?t.properties.topicAliasMaximum:void 0),this.options.clientId="string"==typeof t.clientId?t.clientId:E.defaultId(),this.log("MqttClient :: clientId",this.options.clientId),this.options.customHandleAcks=5===t.protocolVersion&&t.customHandleAcks?t.customHandleAcks:(...e)=>{e[3](null,0)},this.options.writeCache||(u.default.writeToStream.cacheNumbers=!1),this.streamBuilder=e,this.messageIdProvider=void 0===this.options.messageIdProvider?new c.default:this.options.messageIdProvider,this.outgoingStore=t.outgoingStore||new g.default,this.incomingStore=t.incomingStore||new g.default,this.queueQoSZero=void 0===t.queueQoSZero||t.queueQoSZero,this._resubscribeTopics={},this.messageIdToTopic={},this.pingTimer=null,this.connected=!1,this.disconnecting=!1,this.queue=[],this.connackTimer=null,this.reconnectTimer=null,this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={},this._storeProcessingQueue=[],this.outgoing={},this._firstConnection=!0,t.properties&&t.properties.topicAliasMaximum>0&&(t.properties.topicAliasMaximum>65535?this.log("MqttClient :: options.properties.topicAliasMaximum is out of range"):this.topicAliasRecv=new l.default(t.properties.topicAliasMaximum)),this.on("connect",(()=>{const{queue:e}=this,t=()=>{const r=e.shift();this.log("deliver :: entry %o",r);let n=null;if(!r)return void this._resubscribe();n=r.packet,this.log("deliver :: call _sendPacket for %o",n);let i=!0;n.messageId&&0!==n.messageId&&(this.messageIdProvider.register(n.messageId)||(i=!1)),i?this._sendPacket(n,(e=>{r.cb&&r.cb(e),t()})):(this.log("messageId: %d has already used. The message is skipped and removed.",n.messageId),t())};this.log("connect :: sending queued packets"),t()})),this.on("close",(()=>{this.log("close :: connected set to `false`"),this.connected=!1,this.log("close :: clearing connackTimer"),clearTimeout(this.connackTimer),this.log("close :: clearing ping timer"),null!==this.pingTimer&&(this.pingTimer.clear(),this.pingTimer=null),this.topicAliasRecv&&this.topicAliasRecv.clear(),this.log("close :: calling _setupReconnect"),this._setupReconnect()})),this.options.manualConnect||(this.log("MqttClient :: setting up stream"),this.connect())}handleAuth(e,t){t()}handleMessage(e,t){t()}_nextId(){return this.messageIdProvider.allocate()}getLastMessageId(){return this.messageIdProvider.getLastAllocated()}connect(){var e;const t=new h.Writable,r=u.default.parser(this.options);let n=null;const i=[];this.log("connect :: calling method to clear reconnect"),this._clearReconnect(),this.log("connect :: using streamBuilder provided to client to create stream"),this.stream=this.streamBuilder(this),r.on("packet",(e=>{this.log("parser :: on packet push to packets array."),i.push(e)}));const s=()=>{this.log("work :: getting next packet in queue");const e=i.shift();if(e)this.log("work :: packet pulled from queue"),(0,m.default)(this,e,o);else{this.log("work :: no packets in queue");const e=n;n=null,this.log("work :: done flag is %s",!!e),e&&e()}},o=()=>{if(i.length)_(s);else{const e=n;n=null,e()}};t._write=(e,t,i)=>{n=i,this.log("writable stream :: parsing buffer"),r.parse(e),s()};this.log("connect :: pipe stream to writable stream"),this.stream.pipe(t),this.stream.on("error",(e=>{this.log("streamErrorHandler :: error",e.message),S.includes(e.code)?(this.log("streamErrorHandler :: emitting error"),this.emit("error",e)):this.noop(e)})),this.stream.on("close",(()=>{this.log("(%s)stream :: on close",this.options.clientId),this._flushVolatile(),this.log("stream: emit close to MqttClient"),this.emit("close")})),this.log("connect: sending packet `connect`");const a={cmd:"connect",protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion,clean:this.options.clean,clientId:this.options.clientId,keepalive:this.options.keepalive,username:this.options.username,password:this.options.password,properties:this.options.properties};if(this.options.will&&(a.will=Object.assign(Object.assign({},this.options.will),{payload:null===(e=this.options.will)||void 0===e?void 0:e.payload})),this.topicAliasRecv&&(a.properties||(a.properties={}),this.topicAliasRecv&&(a.properties.topicAliasMaximum=this.topicAliasRecv.max)),this._writePacket(a),r.on("error",this.emit.bind(this,"error")),this.options.properties){if(!this.options.properties.authenticationMethod&&this.options.properties.authenticationData)return this.end((()=>this.emit("error",new Error("Packet has no Authentication Method")))),this;if(this.options.properties.authenticationMethod&&this.options.authPacket&&"object"==typeof this.options.authPacket){const e=Object.assign({cmd:"auth",reasonCode:0},this.options.authPacket);this._writePacket(e)}}return this.stream.setMaxListeners(1e3),clearTimeout(this.connackTimer),this.connackTimer=setTimeout((()=>{this.log("!!connectTimeout hit!! Calling _cleanUp with force `true`"),this._cleanUp(!0)}),this.options.connectTimeout),this}publish(e,t,r,n){this.log("publish :: message `%s` to topic `%s`",t,e);const{options:i}=this;"function"==typeof r&&(n=r,r=null),r=r||{};r=Object.assign(Object.assign({},{qos:0,retain:!1,dup:!1}),r);const{qos:s,retain:o,dup:a,properties:l,cbStorePut:u}=r;if(this._checkDisconnecting(n))return this;const c=()=>{let r=0;if((1===s||2===s)&&(r=this._nextId(),null===r))return this.log("No messageId left"),!1;const c={cmd:"publish",topic:e,payload:t,qos:s,retain:o,messageId:r,dup:a};switch(5===i.protocolVersion&&(c.properties=l),this.log("publish :: qos",s),s){case 1:case 2:this.outgoing[c.messageId]={volatile:!1,cb:n||this.noop},this.log("MqttClient:publish: packet cmd: %s",c.cmd),this._sendPacket(c,void 0,u);break;default:this.log("MqttClient:publish: packet cmd: %s",c.cmd),this._sendPacket(c,n,u)}return!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!c())&&this._storeProcessingQueue.push({invoke:c,cbStorePut:r.cbStorePut,callback:n}),this}publishAsync(e,t,r){return new Promise(((n,i)=>{this.publish(e,t,r,(e=>{e?i(e):n()}))}))}subscribe(e,t,r){const n=this.options.protocolVersion;"function"==typeof t&&(r=t),r=r||this.noop;let i=!1,s=[];"string"==typeof e?s=e=[e]:Array.isArray(e)?s=e:"object"==typeof e&&(i=e.resubscribe,delete e.resubscribe,s=Object.keys(e));const o=p.validateTopics(s);if(null!==o)return w(r,new Error(`Invalid topic ${o}`)),this;if(this._checkDisconnecting(r))return this.log("subscribe: discconecting true"),this;const a={qos:0};5===n&&(a.nl=!1,a.rap=!1,a.rh=0);const l=(t=Object.assign(Object.assign({},a),t)).properties,u=[],c=(e,r)=>{if(r=r||t,!Object.prototype.hasOwnProperty.call(this._resubscribeTopics,e)||this._resubscribeTopics[e].qos<r.qos||i){const t={topic:e,qos:r.qos};5===n&&(t.nl=r.nl,t.rap=r.rap,t.rh=r.rh,t.properties=l),this.log("subscribe: pushing topic `%s` and qos `%s` to subs list",t.topic,t.qos),u.push(t)}};if(Array.isArray(e)?e.forEach((e=>{this.log("subscribe: array topic %s",e),c(e)})):Object.keys(e).forEach((t=>{this.log("subscribe: object topic %s, %o",t,e[t]),c(t,e[t])})),!u.length)return r(null,[]),this;const h=()=>{const e=this._nextId();if(null===e)return this.log("No messageId left"),!1;const t={cmd:"subscribe",subscriptions:u,messageId:e};if(l&&(t.properties=l),this.options.resubscribe){this.log("subscribe :: resubscribe true");const e=[];u.forEach((t=>{if(this.options.reconnectPeriod>0){const r={qos:t.qos};5===n&&(r.nl=t.nl||!1,r.rap=t.rap||!1,r.rh=t.rh||0,r.properties=t.properties),this._resubscribeTopics[t.topic]=r,e.push(t.topic)}})),this.messageIdToTopic[t.messageId]=e}return this.outgoing[t.messageId]={volatile:!0,cb(e,t){if(!e){const{granted:e}=t;for(let t=0;t<e.length;t+=1)u[t].qos=e[t]}r(e,u)}},this.log("subscribe :: call _sendPacket"),this._sendPacket(t),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!h())&&this._storeProcessingQueue.push({invoke:h,callback:r}),this}subscribeAsync(e,t){return new Promise(((r,n)=>{this.subscribe(e,t,((e,t)=>{e?n(e):r(t)}))}))}unsubscribe(e,t,r){"string"==typeof e&&(e=[e]),"function"==typeof t&&(r=t),r=r||this.noop;const n=p.validateTopics(e);if(null!==n)return w(r,new Error(`Invalid topic ${n}`)),this;if(this._checkDisconnecting(r))return this;const i=()=>{const n=this._nextId();if(null===n)return this.log("No messageId left"),!1;const i={cmd:"unsubscribe",messageId:n,unsubscriptions:[]};return"string"==typeof e?i.unsubscriptions=[e]:Array.isArray(e)&&(i.unsubscriptions=e),this.options.resubscribe&&i.unsubscriptions.forEach((e=>{delete this._resubscribeTopics[e]})),"object"==typeof t&&t.properties&&(i.properties=t.properties),this.outgoing[i.messageId]={volatile:!0,cb:r},this.log("unsubscribe: call _sendPacket"),this._sendPacket(i),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!i())&&this._storeProcessingQueue.push({invoke:i,callback:r}),this}unsubscribeAsync(e,t){return new Promise(((r,n)=>{this.unsubscribe(e,t,(e=>{e?n(e):r()}))}))}end(e,t,r){this.log("end :: (%s)",this.options.clientId),null!=e&&"boolean"==typeof e||(r=r||t,t=e,e=!1),"object"!=typeof t&&(r=r||t,t=null),this.log("end :: cb? %s",!!r),r&&"function"==typeof r||(r=this.noop);const n=()=>{this.log("end :: closeStores: closing incoming and outgoing stores"),this.disconnected=!0,this.incomingStore.close((e=>{this.outgoingStore.close((t=>{if(this.log("end :: closeStores: emitting end"),this.emit("end"),r){const n=e||t;this.log("end :: closeStores: invoking callback with args"),r(n)}}))})),this._deferredReconnect&&this._deferredReconnect()},i=()=>{this.log("end :: (%s) :: finish :: calling _cleanUp with force %s",this.options.clientId,e),this._cleanUp(e,(()=>{this.log("end :: finish :: calling process.nextTick on closeStores"),_(n)}),t)};return this.disconnecting?(r(),this):(this._clearReconnect(),this.disconnecting=!0,!e&&Object.keys(this.outgoing).length>0?(this.log("end :: (%s) :: calling finish in 10ms once outgoing is empty",this.options.clientId),this.once("outgoingEmpty",setTimeout.bind(null,i,10))):(this.log("end :: (%s) :: immediately calling finish",this.options.clientId),i()),this)}endAsync(e,t){return new Promise(((r,n)=>{this.end(e,t,(e=>{e?n(e):r()}))}))}removeOutgoingMessage(e){if(this.outgoing[e]){const{cb:t}=this.outgoing[e];this._removeOutgoingAndStoreMessage(e,(()=>{t(new Error("Message removed"))}))}return this}reconnect(e){this.log("client reconnect");const t=()=>{e?(this.options.incomingStore=e.incomingStore,this.options.outgoingStore=e.outgoingStore):(this.options.incomingStore=null,this.options.outgoingStore=null),this.incomingStore=this.options.incomingStore||new g.default,this.outgoingStore=this.options.outgoingStore||new g.default,this.disconnecting=!1,this.disconnected=!1,this._deferredReconnect=null,this._reconnect()};return this.disconnecting&&!this.disconnected?this._deferredReconnect=t:t(),this}_flushVolatile(){this.outgoing&&(this.log("_flushVolatile :: deleting volatile messages from the queue and setting their callbacks as error function"),Object.keys(this.outgoing).forEach((e=>{this.outgoing[e].volatile&&"function"==typeof this.outgoing[e].cb&&(this.outgoing[e].cb(new Error("Connection closed")),delete this.outgoing[e])})))}_flush(){this.outgoing&&(this.log("_flush: queue exists? %b",!!this.outgoing),Object.keys(this.outgoing).forEach((e=>{"function"==typeof this.outgoing[e].cb&&(this.outgoing[e].cb(new Error("Connection closed")),delete this.outgoing[e])})))}_removeTopicAliasAndRecoverTopicName(e){let t;e.properties&&(t=e.properties.topicAlias);let r=e.topic.toString();if(this.log("_removeTopicAliasAndRecoverTopicName :: alias %d, topic %o",t,r),0===r.length){if(void 0===t)return new Error("Unregistered Topic Alias");if(r=this.topicAliasSend.getTopicByAlias(t),void 0===r)return new Error("Unregistered Topic Alias");e.topic=r}t&&delete e.properties.topicAlias}_checkDisconnecting(e){return this.disconnecting&&(e&&e!==this.noop?e(new Error("client disconnecting")):this.emit("error",new Error("client disconnecting"))),this.disconnecting}_reconnect(){this.log("_reconnect: emitting reconnect to client"),this.emit("reconnect"),this.connected?(this.end((()=>{this.connect()})),this.log("client already connected. disconnecting first.")):(this.log("_reconnect: calling connect"),this.connect())}_setupReconnect(){!this.disconnecting&&!this.reconnectTimer&&this.options.reconnectPeriod>0?(this.reconnecting||(this.log("_setupReconnect :: emit `offline` state"),this.emit("offline"),this.log("_setupReconnect :: set `reconnecting` to `true`"),this.reconnecting=!0),this.log("_setupReconnect :: setting reconnectTimer for %d ms",this.options.reconnectPeriod),this.reconnectTimer=setInterval((()=>{this.log("reconnectTimer :: reconnect triggered!"),this._reconnect()}),this.options.reconnectPeriod)):this.log("_setupReconnect :: doing nothing...")}_clearReconnect(){this.log("_clearReconnect : clearing reconnect timer"),this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=null)}_cleanUp(e,t,r={}){if(t&&(this.log("_cleanUp :: done callback provided for on stream close"),this.stream.on("close",t)),this.log("_cleanUp :: forced? %s",e),e)0===this.options.reconnectPeriod&&this.options.clean&&this._flush(),this.log("_cleanUp :: (%s) :: destroying stream",this.options.clientId),this.stream.destroy();else{const e=Object.assign({cmd:"disconnect"},r);this.log("_cleanUp :: (%s) :: call _sendPacket with disconnect packet",this.options.clientId),this._sendPacket(e,(()=>{this.log("_cleanUp :: (%s) :: destroying stream",this.options.clientId),w((()=>{this.stream.end((()=>{this.log("_cleanUp :: (%s) :: stream destroyed",this.options.clientId)}))}))}))}this.disconnecting||(this.log("_cleanUp :: client not disconnecting. Clearing and resetting reconnect."),this._clearReconnect(),this._setupReconnect()),null!==this.pingTimer&&(this.log("_cleanUp :: clearing pingTimer"),this.pingTimer.clear(),this.pingTimer=null),t&&!this.connected&&(this.log("_cleanUp :: (%s) :: removing stream `done` callback `close` listener",this.options.clientId),this.stream.removeListener("close",t),t())}_storeAndSend(e,t,r){this.log("storeAndSend :: store packet with cmd %s to outgoingStore",e.cmd);let n,i=e;if("publish"===i.cmd&&(i=(0,d.default)(e),n=this._removeTopicAliasAndRecoverTopicName(i),n))return t&&t(n);this.outgoingStore.put(i,(n=>{if(n)return t&&t(n);r(),this._writePacket(e,t)}))}_applyTopicAlias(e){if(5===this.options.protocolVersion&&"publish"===e.cmd){let t;e.properties&&(t=e.properties.topicAlias);const r=e.topic.toString();if(this.topicAliasSend)if(t){if(0!==r.length&&(this.log("applyTopicAlias :: register topic: %s - alias: %d",r,t),!this.topicAliasSend.put(r,t)))return this.log("applyTopicAlias :: error out of range. topic: %s - alias: %d",r,t),new Error("Sending Topic Alias out of range")}else 0!==r.length&&(this.options.autoAssignTopicAlias?(t=this.topicAliasSend.getAliasByTopic(r),t?(e.topic="",e.properties=Object.assign(Object.assign({},e.properties),{topicAlias:t}),this.log("applyTopicAlias :: auto assign(use) topic: %s - alias: %d",r,t)):(t=this.topicAliasSend.getLruAlias(),this.topicAliasSend.put(r,t),e.properties=Object.assign(Object.assign({},e.properties),{topicAlias:t}),this.log("applyTopicAlias :: auto assign topic: %s - alias: %d",r,t))):this.options.autoUseTopicAlias&&(t=this.topicAliasSend.getAliasByTopic(r),t&&(e.topic="",e.properties=Object.assign(Object.assign({},e.properties),{topicAlias:t}),this.log("applyTopicAlias :: auto use topic: %s - alias: %d",r,t))));else if(t)return this.log("applyTopicAlias :: error out of range. topic: %s - alias: %d",r,t),new Error("Sending Topic Alias out of range")}}_noop(e){this.log("noop ::",e)}_writePacket(e,t){this.log("_writePacket :: packet: %O",e),this.log("_writePacket :: emitting `packetsend`"),this.emit("packetsend",e),this._shiftPingInterval(),this.log("_writePacket :: writing to stream");const r=u.default.writeToStream(e,this.stream,this.options);this.log("_writePacket :: writeToStream result %s",r),!r&&t&&t!==this.noop?(this.log("_writePacket :: handle events on `drain` once through callback."),this.stream.once("drain",t)):t&&(this.log("_writePacket :: invoking cb"),t())}_sendPacket(e,t,r,n){this.log("_sendPacket :: (%s) ::  start",this.options.clientId),r=r||this.noop,t=t||this.noop;const i=this._applyTopicAlias(e);if(i)t(i);else{if(!this.connected)return"auth"===e.cmd?void this._writePacket(e,t):(this.log("_sendPacket :: client not connected. Storing packet offline."),void this._storePacket(e,t,r));if(n)this._writePacket(e,t);else{switch(e.cmd){case"publish":break;case"pubrel":return void this._storeAndSend(e,t,r);default:return void this._writePacket(e,t)}switch(e.qos){case 2:case 1:this._storeAndSend(e,t,r);break;default:this._writePacket(e,t)}this.log("_sendPacket :: (%s) ::  end",this.options.clientId)}}}_storePacket(e,t,r){this.log("_storePacket :: packet: %o",e),this.log("_storePacket :: cb? %s",!!t),r=r||this.noop;let n=e;if("publish"===n.cmd){n=(0,d.default)(e);const r=this._removeTopicAliasAndRecoverTopicName(n);if(r)return t&&t(r)}const i=n.qos||0;0===i&&this.queueQoSZero||"publish"!==n.cmd?this.queue.push({packet:n,cb:t}):i>0?(t=this.outgoing[n.messageId]?this.outgoing[n.messageId].cb:null,this.outgoingStore.put(n,(e=>{if(e)return t&&t(e);r()}))):t&&t(new Error("No connection to broker"))}_setupPingTimer(){this.log("_setupPingTimer :: keepalive %d (seconds)",this.options.keepalive),!this.pingTimer&&this.options.keepalive&&(this.pingResp=!0,this.pingTimer=(0,f.default)((()=>{this._checkPing()}),1e3*this.options.keepalive))}_shiftPingInterval(){this.pingTimer&&this.options.keepalive&&this.options.reschedulePings&&this.pingTimer.reschedule(1e3*this.options.keepalive)}_checkPing(){this.log("_checkPing :: checking ping..."),this.pingResp?(this.log("_checkPing :: ping response received. Clearing flag and sending `pingreq`"),this.pingResp=!1,this._sendPacket({cmd:"pingreq"})):(this.log("_checkPing :: calling _cleanUp with force true"),this._cleanUp(!0))}_resubscribe(){this.log("_resubscribe");const e=Object.keys(this._resubscribeTopics);if(!this._firstConnection&&(this.options.clean||5===this.options.protocolVersion&&!this.connackPacket.sessionPresent)&&e.length>0)if(this.options.resubscribe)if(5===this.options.protocolVersion){this.log("_resubscribe: protocolVersion 5");for(let t=0;t<e.length;t++){const r={};r[e[t]]=this._resubscribeTopics[e[t]],r.resubscribe=!0,this.subscribe(r,{properties:r[e[t]].properties})}}else this._resubscribeTopics.resubscribe=!0,this.subscribe(this._resubscribeTopics);else this._resubscribeTopics={};this._firstConnection=!1}_onConnect(e){if(this.disconnected)return void this.emit("connect",e);this.connackPacket=e,this.messageIdProvider.clear(),this._setupPingTimer(),this.connected=!0;const t=()=>{let r=this.outgoingStore.createStream();const n=()=>{r.destroy(),r=null,this._flushStoreProcessingQueue(),i()},i=()=>{this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={}};this.once("close",n),r.on("error",(e=>{i(),this._flushStoreProcessingQueue(),this.removeListener("close",n),this.emit("error",e)}));const s=()=>{if(!r)return;const e=r.read(1);let t;e?(this._storeProcessing=!0,this._packetIdsDuringStoreProcessing[e.messageId]?s():this.disconnecting||this.reconnectTimer?r.destroy&&r.destroy():(t=this.outgoing[e.messageId]?this.outgoing[e.messageId].cb:null,this.outgoing[e.messageId]={volatile:!1,cb(e,r){t&&t(e,r),s()}},this._packetIdsDuringStoreProcessing[e.messageId]=!0,this.messageIdProvider.register(e.messageId)?this._sendPacket(e,void 0,void 0,!0):this.log("messageId: %d has already used.",e.messageId))):r.once("readable",s)};r.on("end",(()=>{let r=!0;for(const e in this._packetIdsDuringStoreProcessing)if(!this._packetIdsDuringStoreProcessing[e]){r=!1;break}r?(i(),this.removeListener("close",n),this._invokeAllStoreProcessingQueue(),this.emit("connect",e)):t()})),s()};t()}_invokeStoreProcessingQueue(){if(!this._storeProcessing&&this._storeProcessingQueue.length>0){const e=this._storeProcessingQueue[0];if(e&&e.invoke())return this._storeProcessingQueue.shift(),!0}return!1}_invokeAllStoreProcessingQueue(){for(;this._invokeStoreProcessingQueue(););}_flushStoreProcessingQueue(){for(const e of this._storeProcessingQueue)e.cbStorePut&&e.cbStorePut(new Error("Connection closed")),e.callback&&e.callback(new Error("Connection closed"));this._storeProcessingQueue.splice(0)}_removeOutgoingAndStoreMessage(e,t){delete this.outgoing[e],this.outgoingStore.del({messageId:e},((r,n)=>{t(r,n),this.messageIdProvider.deallocate(e),this._invokeStoreProcessingQueue()}))}}r.default=E}).call(this)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./TypedEmitter":1,"./default-message-id-provider":9,"./handlers":13,"./store":18,"./topic-alias-recv":19,"./validations":22,_process:102,debug:30,"mqtt-packet":75,"readable-stream":125,reinterval:131,"rfdc/default":132}],3:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=e("buffer"),s=e("readable-stream"),o=n(e("duplexify"));let a,l,u,c=!1;r.default=(e,t)=>{if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const r="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";!function(e){e.hostname||(e.hostname="localhost"),e.path||(e.path="/"),e.wsOptions||(e.wsOptions={})}(t);const n=function(e,t){const r="alis"===e.protocol?"wss":"ws";let n=`${r}://${e.hostname}${e.path}`;return e.port&&80!==e.port&&443!==e.port&&(n=`${r}://${e.hostname}:${e.port}${e.path}`),"function"==typeof e.transformWsUrl&&(n=e.transformWsUrl(n,e,t)),n}(t,e);return a=t.my,a.connectSocket({url:n,protocols:r}),l=function(){const e=new s.Transform;return e._write=(e,t,r)=>{a.sendSocketMessage({data:e.buffer,success(){r()},fail(){r(new Error)}})},e._flush=e=>{a.closeSocket({success(){e()}})},e}(),u=o.default.obj(),c||(c=!0,a.onSocketOpen((()=>{u.setReadable(l),u.setWritable(l),u.emit("connect")})),a.onSocketMessage((e=>{if("string"==typeof e.data){const t=i.Buffer.from(e.data,"base64");l.push(t)}else{const t=new FileReader;t.addEventListener("load",(()=>{let e=t.result;e=e instanceof ArrayBuffer?i.Buffer.from(e):i.Buffer.from(e,"utf8"),l.push(e)})),t.readAsArrayBuffer(e.data)}})),a.onSocketClose((()=>{u.end(),u.destroy()})),a.onSocketError((e=>{u.destroy(e)}))),u}},{buffer:29,duplexify:32,"readable-stream":125}],4:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.connectAsync=void 0;const i=n(e("debug")),s=n(e("url")),o=n(e("../client")),a=n(e("../is-browser")),l=(0,i.default)("mqttjs"),u={};function c(e,t){if(l("connecting to an MQTT broker..."),"object"!=typeof e||t||(t=e,e=""),t=t||{},e&&"string"==typeof e){const r=s.default.parse(e,!0);if(null!=r.port&&(r.port=Number(r.port)),null===(t=Object.assign(Object.assign({},r),t)).protocol)throw new Error("Missing protocol");t.protocol=t.protocol.replace(/:$/,"")}if(function(e){let t;e.auth&&(t=e.auth.match(/^(.+):(.+)$/),t?(e.username=t[1],e.password=t[2]):e.username=e.auth)}(t),t.query&&"string"==typeof t.query.clientId&&(t.clientId=t.query.clientId),t.cert&&t.key){if(!t.protocol)throw new Error("Missing secure protocol key");if(-1===["mqtts","wss","wxs","alis"].indexOf(t.protocol))switch(t.protocol){case"mqtt":t.protocol="mqtts";break;case"ws":t.protocol="wss";break;case"wx":t.protocol="wxs";break;case"ali":t.protocol="alis";break;default:throw new Error(`Unknown protocol for secure connection: "${t.protocol}"!`)}}if(!u[t.protocol]){const e=-1!==["mqtts","wss"].indexOf(t.protocol);t.protocol=["mqtt","mqtts","ws","wss","wx","wxs","ali","alis"].filter(((t,r)=>(!e||r%2!=0)&&"function"==typeof u[t]))[0]}if(!1===t.clean&&!t.clientId)throw new Error("Missing clientId for unclean clients");t.protocol&&(t.defaultProtocol=t.protocol);const r=new o.default((function(e){return t.servers&&(e._reconnectCount&&e._reconnectCount!==t.servers.length||(e._reconnectCount=0),t.host=t.servers[e._reconnectCount].host,t.port=t.servers[e._reconnectCount].port,t.protocol=t.servers[e._reconnectCount].protocol?t.servers[e._reconnectCount].protocol:t.defaultProtocol,t.hostname=t.host,e._reconnectCount++),l("calling streambuilder for",t.protocol),u[t.protocol](e,t)}),t);return r.on("error",(()=>{})),r}a.default?(u.wx=e("./wx").default,u.wxs=e("./wx").default,u.ali=e("./ali").default,u.alis=e("./ali").default):(u.mqtt=e("./tcp").default,u.tcp=e("./tcp").default,u.ssl=e("./tls").default,u.tls=u.ssl,u.mqtts=e("./tls").default),u.ws=e("./ws").default,u.wss=e("./ws").default,r.connectAsync=function(e,t,r=!0){return new Promise(((n,i)=>{const s=c(e,t),o={connect:e=>{a(),n(s)},end:()=>{a(),n(s)},error:e=>{a(),s.end(),i(e)}};function a(){Object.keys(o).forEach((e=>{s.off(e,o[e])}))}!1===r&&(o.close=()=>{o.error(new Error("Couldn't connect to server"))}),Object.keys(o).forEach((e=>{s.on(e,o[e])}))}))},r.default=c},{"../client":2,"../is-browser":16,"./ali":3,"./tcp":5,"./tls":6,"./ws":7,"./wx":8,debug:30,url:137}],5:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=n(e("net")),s=(0,n(e("debug")).default)("mqttjs:tcp");r.default=(e,t)=>{t.port=t.port||1883,t.hostname=t.hostname||t.host||"localhost";const{port:r}=t,n=t.hostname;return s("port %d and host %s",r,n),i.default.createConnection(r,n)}},{debug:30,net:26}],6:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=n(e("tls")),s=n(e("net")),o=(0,n(e("debug")).default)("mqttjs:tls");r.default=(e,t)=>{t.port=t.port||8883,t.host=t.hostname||t.host||"localhost",0===s.default.isIP(t.host)&&(t.servername=t.host),t.rejectUnauthorized=!1!==t.rejectUnauthorized,delete t.path,o("port %d host %s rejectUnauthorized %b",t.port,t.host,t.rejectUnauthorized);const r=i.default.connect(t);function n(n){t.rejectUnauthorized&&e.emit("error",n),r.end()}return r.on("secureConnect",(()=>{t.rejectUnauthorized&&!r.authorized?r.emit("error",new Error("TLS not authorized")):r.removeListener("error",n)})),r.on("error",n),r}},{debug:30,net:26,tls:26}],7:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=e("buffer"),s=n(e("ws")),o=n(e("debug")),a=n(e("duplexify")),l=e("readable-stream"),u=n(e("../is-browser")),c=(0,o.default)("mqttjs:ws"),h=["rejectUnauthorized","ca","cert","key","pfx","passphrase"];function f(e,t){let r=`${e.protocol}://${e.hostname}:${e.port}${e.path}`;return"function"==typeof e.transformWsUrl&&(r=e.transformWsUrl(r,e,t)),r}function d(e){const t=e;return e.hostname||(t.hostname="localhost"),e.port||("wss"===e.protocol?t.port=443:t.port=80),e.path||(t.path="/"),e.wsOptions||(t.wsOptions={}),u.default||"wss"!==e.protocol||h.forEach((r=>{Object.prototype.hasOwnProperty.call(e,r)&&!Object.prototype.hasOwnProperty.call(e.wsOptions,r)&&(t.wsOptions[r]=e[r])})),t}r.default=u.default?(e,t)=>{let r;c("browserStreamBuilder");const n=function(e){const t=d(e);if(t.hostname||(t.hostname=t.host),!t.hostname){if("undefined"==typeof document)throw new Error("Could not determine host. Specify host manually.");const e=new URL(document.URL);t.hostname=e.hostname,t.port||(t.port=Number(e.port))}return void 0===t.objectMode&&(t.objectMode=!(!0===t.binary||void 0===t.binary)),t}(t),s=n.browserBufferSize||524288,o=t.browserBufferTimeout||1e3,u=!t.objectMode,h=function(e,t){const r="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt",n=f(t,e),i=new WebSocket(n,[r]);return i.binaryType="arraybuffer",i}(e,t),p=function(e,t,r){const n=new l.Transform({objectMode:e.objectMode});return n._write=t,n._flush=r,n}(t,(function e(t,r,n){h.bufferedAmount>s&&setTimeout(e,o,t,r,n);u&&"string"==typeof t&&(t=i.Buffer.from(t,"utf8"));try{h.send(t)}catch(e){return n(e)}n()}),(function(e){h.close(),e()}));t.objectMode||(p._writev=w),p.on("close",(()=>{h.close()}));const b=void 0!==h.addEventListener;function g(){r.setReadable(p),r.setWritable(p),r.emit("connect")}function m(){r.end(),r.destroy()}function y(e){r.destroy(e)}function _(e){let{data:t}=e;t=t instanceof ArrayBuffer?i.Buffer.from(t):i.Buffer.from(t,"utf8"),p.push(t)}function w(e,t){const r=new Array(e.length);for(let t=0;t<e.length;t++)"string"==typeof e[t].chunk?r[t]=i.Buffer.from(e[t],"utf8"):r[t]=e[t].chunk;this._write(i.Buffer.concat(r),"binary",t)}return h.readyState===h.OPEN?r=p:(r=(0,a.default)(void 0,void 0,t),t.objectMode||(r._writev=w),b?h.addEventListener("open",g):h.onopen=g),r.socket=h,b?(h.addEventListener("close",m),h.addEventListener("error",y),h.addEventListener("message",_)):(h.onclose=m,h.onerror=y,h.onmessage=_),r}:(e,t)=>{c("streamBuilder");const r=d(t),n=f(r,e),i=function(e,t,r){c("createWebSocket"),c(`protocol: ${r.protocolId} ${r.protocolVersion}`);const n="MQIsdp"===r.protocolId&&3===r.protocolVersion?"mqttv3.1":"mqtt";return c(`creating new Websocket for url: ${t} and protocol: ${n}`),new s.default(t,[n],r.wsOptions)}(0,n,r),o=s.default.createWebSocketStream(i,r.wsOptions);return o.url=n,i.on("close",(()=>{o.destroy()})),o}},{"../is-browser":16,buffer:29,debug:30,duplexify:32,"readable-stream":125,ws:141}],8:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=e("buffer"),s=e("readable-stream"),o=n(e("duplexify"));let a,l,u;r.default=(e,t)=>{if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const r="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";!function(e){e.hostname||(e.hostname="localhost"),e.path||(e.path="/"),e.wsOptions||(e.wsOptions={})}(t);const n=function(e,t){const r="wxs"===e.protocol?"wss":"ws";let n=`${r}://${e.hostname}${e.path}`;return e.port&&80!==e.port&&443!==e.port&&(n=`${r}://${e.hostname}:${e.port}${e.path}`),"function"==typeof e.transformWsUrl&&(n=e.transformWsUrl(n,e,t)),n}(t,e);a=wx.connectSocket({url:n,protocols:[r]}),l=function(){const e=new s.Transform;return e._write=(e,t,r)=>{a.send({data:e.buffer,success(){r()},fail(e){r(new Error(e))}})},e._flush=e=>{a.close({success(){e()}})},e}(),u=o.default.obj(),u._destroy=(e,t)=>{a.close({success(){t&&t(e)}})};const c=u.destroy;return u.destroy=()=>{u.destroy=c,setTimeout((()=>{a.close({fail(){u._destroy(new Error)}})}),0)},a.onOpen((()=>{u.setReadable(l),u.setWritable(l),u.emit("connect")})),a.onMessage((e=>{let{data:t}=e;t=t instanceof ArrayBuffer?i.Buffer.from(t):i.Buffer.from(t,"utf8"),l.push(t)})),a.onClose((()=>{u.end(),u.destroy()})),a.onError((e=>{u.destroy(new Error(e.errMsg))})),u}},{buffer:29,duplexify:32,"readable-stream":125}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});r.default=class{constructor(){this.nextId=Math.max(1,Math.floor(65535*Math.random()))}allocate(){const e=this.nextId++;return 65536===this.nextId&&(this.nextId=1),e}getLastAllocated(){return 1===this.nextId?65535:this.nextId-1}register(e){return!0}deallocate(e){}clear(){}}},{}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ReasonCodes=void 0,r.ReasonCodes={0:"",1:"Unacceptable protocol version",2:"Identifier rejected",3:"Server unavailable",4:"Bad username or password",5:"Not authorized",16:"No matching subscribers",17:"No subscription existed",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",132:"Unsupported Protocol Version",133:"Client Identifier not valid",134:"Bad User Name or Password",135:"Not authorized",136:"Server unavailable",137:"Server busy",138:"Banned",139:"Server shutting down",140:"Bad authentication method",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",145:"Packet identifier in use",146:"Packet Identifier not found",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"};r.default=(e,t)=>{const{messageId:n}=t,i=t.cmd;let s=null;const o=e.outgoing[n]?e.outgoing[n].cb:null;let a;if(o){switch(e.log("_handleAck :: packet type",i),i){case"pubcomp":case"puback":{const i=t.reasonCode;i&&i>0&&16!==i?(a=new Error(`Publish error: ${r.ReasonCodes[i]}`),a.code=i,e._removeOutgoingAndStoreMessage(n,(()=>{o(a,t)}))):e._removeOutgoingAndStoreMessage(n,o);break}case"pubrec":{s={cmd:"pubrel",qos:2,messageId:n};const i=t.reasonCode;i&&i>0&&16!==i?(a=new Error(`Publish error: ${r.ReasonCodes[i]}`),a.code=i,e._removeOutgoingAndStoreMessage(n,(()=>{o(a,t)}))):e._sendPacket(s);break}case"suback":{delete e.outgoing[n],e.messageIdProvider.deallocate(n);const r=t.granted;for(let t=0;t<r.length;t++)if(0!=(128&r[t])){const t=e.messageIdToTopic[n];t&&t.forEach((t=>{delete e._resubscribeTopics[t]}))}delete e.messageIdToTopic[n],e._invokeStoreProcessingQueue(),o(null,t);break}case"unsuback":delete e.outgoing[n],e.messageIdProvider.deallocate(n),e._invokeStoreProcessingQueue(),o(null);break;default:e.emit("error",new Error("unrecognized packet type"))}e.disconnecting&&0===Object.keys(e.outgoing).length&&e.emit("outgoingEmpty")}else e.log("_handleAck :: Server sent an ack in error. Ignoring.")}},{}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=e("../shared"),i=e("./ack");r.default=(e,t)=>{const{options:r}=e,s=r.protocolVersion,o=5===s?t.reasonCode:t.returnCode;if(5===s)e.handleAuth(t,((t,r)=>{if(t)e.emit("error",t);else if(24===o)e.reconnecting=!1,e._sendPacket(r);else{const t=new n.ErrorWithReasonCode(`Connection refused: ${i.ReasonCodes[o]}`,o);e.emit("error",t)}}));else{const t=new n.ErrorWithReasonCode(`Protocol error: Auth packets are only supported in MQTT 5. Your version:${s}`,o);e.emit("error",t)}}},{"../shared":17,"./ack":10}],12:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=e("./ack"),s=n(e("../topic-alias-send")),o=e("../shared");r.default=(e,t)=>{e.log("_handleConnack");const{options:r}=e,n=5===r.protocolVersion?t.reasonCode:t.returnCode;if(clearTimeout(e.connackTimer),delete e.topicAliasSend,t.properties){if(t.properties.topicAliasMaximum){if(t.properties.topicAliasMaximum>65535)return void e.emit("error",new Error("topicAliasMaximum from broker is out of range"));t.properties.topicAliasMaximum>0&&(e.topicAliasSend=new s.default(t.properties.topicAliasMaximum))}t.properties.serverKeepAlive&&r.keepalive&&(r.keepalive=t.properties.serverKeepAlive,e._shiftPingInterval()),t.properties.maximumPacketSize&&(r.properties||(r.properties={}),r.properties.maximumPacketSize=t.properties.maximumPacketSize)}if(0===n)e.reconnecting=!1,e._onConnect(t);else if(n>0){const t=new o.ErrorWithReasonCode(`Connection refused: ${i.ReasonCodes[n]}`,n);e.emit("error",t)}}},{"../shared":17,"../topic-alias-send":20,"./ack":10}],13:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=n(e("./publish")),s=n(e("./auth")),o=n(e("./connack")),a=n(e("./ack")),l=n(e("./pubrel"));r.default=(e,t,r)=>{const{options:n}=e;if(5===n.protocolVersion&&n.properties&&n.properties.maximumPacketSize&&n.properties.maximumPacketSize<t.length)return e.emit("error",new Error(`exceeding packets size ${t.cmd}`)),e.end({reasonCode:149,properties:{reasonString:"Maximum packet size was exceeded"}}),e;switch(e.log("_handlePacket :: emitting packetreceive"),e.emit("packetreceive",t),t.cmd){case"publish":(0,i.default)(e,t,r);break;case"puback":case"pubrec":case"pubcomp":case"suback":case"unsuback":(0,a.default)(e,t),r();break;case"pubrel":(0,l.default)(e,t,r);break;case"connack":(0,o.default)(e,t),r();break;case"auth":(0,s.default)(e,t),r();break;case"pingresp":e.pingResp=!0,r();break;case"disconnect":e.emit("disconnect",t),r();break;default:e.log("_handlePacket :: unknown command"),r()}}},{"./ack":10,"./auth":11,"./connack":12,"./publish":14,"./pubrel":15}],14:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=[0,16,128,131,135,144,145,151,153];r.default=(e,t,r)=>{e.log("handlePublish: packet %o",t),r=void 0!==r?r:e.noop;let i=t.topic.toString();const s=t.payload,{qos:o}=t,{messageId:a}=t,{options:l}=e;if(5===e.options.protocolVersion){let r;if(t.properties&&(r=t.properties.topicAlias),void 0!==r)if(0===i.length){if(!(r>0&&r<=65535))return e.log("handlePublish :: topic alias out of range. alias: %d",r),void e.emit("error",new Error("Received Topic Alias is out of range"));{const t=e.topicAliasRecv.getTopicByAlias(r);if(!t)return e.log("handlePublish :: unregistered topic alias. alias: %d",r),void e.emit("error",new Error("Received unregistered Topic Alias"));i=t,e.log("handlePublish :: topic complemented by alias. topic: %s - alias: %d",i,r)}}else{if(!e.topicAliasRecv.put(i,r))return e.log("handlePublish :: topic alias out of range. alias: %d",r),void e.emit("error",new Error("Received Topic Alias is out of range"));e.log("handlePublish :: registered topic: %s - alias: %d",i,r)}}switch(e.log("handlePublish: qos %d",o),o){case 2:l.customHandleAcks(i,s,t,((i,s)=>("number"==typeof i&&(s=i,i=null),i?e.emit("error",i):-1===n.indexOf(s)?e.emit("error",new Error("Wrong reason code for pubrec")):void(s?e._sendPacket({cmd:"pubrec",messageId:a,reasonCode:s},r):e.incomingStore.put(t,(()=>{e._sendPacket({cmd:"pubrec",messageId:a},r)}))))));break;case 1:l.customHandleAcks(i,s,t,((o,l)=>("number"==typeof o&&(l=o,o=null),o?e.emit("error",o):-1===n.indexOf(l)?e.emit("error",new Error("Wrong reason code for puback")):(l||e.emit("message",i,s,t),void e.handleMessage(t,(t=>{if(t)return r&&r(t);e._sendPacket({cmd:"puback",messageId:a,reasonCode:l},r)}))))));break;case 0:e.emit("message",i,s,t),e.handleMessage(t,r);break;default:e.log("handlePublish: unknown QoS. Doing nothing.")}}},{}],15:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});r.default=(e,t,r)=>{e.log("handling pubrel packet");const n=void 0!==r?r:e.noop,{messageId:i}=t,s={cmd:"pubcomp",messageId:i};e.incomingStore.get(t,((t,r)=>{t?e._sendPacket(s,n):(e.emit("message",r.topic,r.payload,r),e.handleMessage(r,(t=>{if(t)return n(t);e.incomingStore.del(r,e.noop),e._sendPacket(s,n)})))}))}},{}],16:[function(e,t,r){(function(e){(function(){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const t=void 0!==e&&"browser"===e.title||"function"==typeof __webpack_require__,n="undefined"!=typeof window&&"undefined"!=typeof document||t;r.default=n}).call(this)}).call(this,e("_process"))},{_process:102}],17:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.applyMixin=r.ErrorWithReasonCode=void 0;class n extends Error{constructor(e,t){super(e),this.code=t,Object.setPrototypeOf(this,n.prototype),Object.getPrototypeOf(this).name="ErrorWithReasonCode"}}r.ErrorWithReasonCode=n,r.applyMixin=function(e,t,r=!1){var n;const i=[t];for(;;){const e=i[0],t=Object.getPrototypeOf(e);if(!(null==t?void 0:t.prototype))break;i.unshift(t)}for(const t of i)for(const i of Object.getOwnPropertyNames(t.prototype))(r||"constructor"!==i)&&Object.defineProperty(e.prototype,i,null!==(n=Object.getOwnPropertyDescriptor(t.prototype,i))&&void 0!==n?n:Object.create(null))}},{}],18:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=e("readable-stream"),i={objectMode:!0},s={clean:!0};r.default=class{constructor(e){this.options=e||{},this.options=Object.assign(Object.assign({},s),e),this._inflights=new Map}put(e,t){return this._inflights.set(e.messageId,e),t&&t(),this}createStream(){const e=new n.Readable(i),t=[];let r=!1,s=0;return this._inflights.forEach(((e,r)=>{t.push(e)})),e._read=()=>{!r&&s<t.length?e.push(t[s++]):e.push(null)},e.destroy=t=>{if(!r)return r=!0,setTimeout((()=>{e.emit("close")}),0),e},e}del(e,t){const r=this._inflights.get(e.messageId);return r?(this._inflights.delete(e.messageId),t(null,r)):t&&t(new Error("missing packet")),this}get(e,t){const r=this._inflights.get(e.messageId);return r?t(null,r):t&&t(new Error("missing packet")),this}close(e){this.options.clean&&(this._inflights=null),e&&e()}}},{"readable-stream":125}],19:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});r.default=class{constructor(e){this.aliasToTopic={},this.max=e}put(e,t){return!(0===t||t>this.max)&&(this.aliasToTopic[t]=e,this.length=Object.keys(this.aliasToTopic).length,!0)}getTopicByAlias(e){return this.aliasToTopic[e]}clear(){this.aliasToTopic={}}}},{}],20:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const i=n(e("lru-cache")),s=e("number-allocator");r.default=class{constructor(e){e>0&&(this.aliasToTopic=new i.default({max:e}),this.topicToAlias={},this.numberAllocator=new s.NumberAllocator(1,e),this.max=e,this.length=0)}put(e,t){if(0===t||t>this.max)return!1;const r=this.aliasToTopic.get(t);return r&&delete this.topicToAlias[r],this.aliasToTopic.set(t,e),this.topicToAlias[e]=t,this.numberAllocator.use(t),this.length=this.aliasToTopic.size,!0}getTopicByAlias(e){return this.aliasToTopic.get(e)}getAliasByTopic(e){const t=this.topicToAlias[e];return void 0!==t&&this.aliasToTopic.get(t),t}clear(){this.aliasToTopic.clear(),this.topicToAlias={},this.numberAllocator.clear(),this.length=0}getLruAlias(){const e=this.numberAllocator.firstVacant();return e||[...this.aliasToTopic.keys()][this.aliasToTopic.size-1]}}},{"lru-cache":72,"number-allocator":98}],21:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=e("number-allocator");r.default=class{constructor(){this.numberAllocator=new n.NumberAllocator(1,65535)}allocate(){return this.lastId=this.numberAllocator.alloc(),this.lastId}getLastAllocated(){return this.lastId}register(e){return this.numberAllocator.use(e)}deallocate(e){this.numberAllocator.free(e)}clear(){this.numberAllocator.clear()}}},{"number-allocator":98}],22:[function(e,t,r){"use strict";function n(e){const t=e.split("/");for(let e=0;e<t.length;e++)if("+"!==t[e]){if("#"===t[e])return e===t.length-1;if(-1!==t[e].indexOf("+")||-1!==t[e].indexOf("#"))return!1}return!0}Object.defineProperty(r,"__esModule",{value:!0}),r.validateTopics=r.validateTopic=void 0,r.validateTopic=n,r.validateTopics=function(e){if(0===e.length)return"empty_topic_list";for(let t=0;t<e.length;t++)if(!n(e[t]))return e[t];return null}},{}],23:[function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},o=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.ReasonCodes=r.UniqueMessageIdProvider=r.DefaultMessageIdProvider=r.Store=r.MqttClient=r.connectAsync=r.connect=r.Client=void 0;const l=a(e("./lib/client"));r.MqttClient=l.default;const u=a(e("./lib/default-message-id-provider"));r.DefaultMessageIdProvider=u.default;const c=a(e("./lib/unique-message-id-provider"));r.UniqueMessageIdProvider=c.default;const h=a(e("./lib/store"));r.Store=h.default;const f=s(e("./lib/connect"));r.connect=f.default,Object.defineProperty(r,"connectAsync",{enumerable:!0,get:function(){return f.connectAsync}}),r.Client=l.default,o(e("./lib/client"),r),o(e("./lib/shared"),r);var d=e("./lib/handlers/ack");Object.defineProperty(r,"ReasonCodes",{enumerable:!0,get:function(){return d.ReasonCodes}})},{"./lib/client":2,"./lib/connect":4,"./lib/default-message-id-provider":9,"./lib/handlers/ack":10,"./lib/shared":17,"./lib/store":18,"./lib/unique-message-id-provider":21}],24:[function(e,t,r){"use strict";const{AbortController:n,AbortSignal:i}="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0;t.exports=n,t.exports.AbortSignal=i,t.exports.default=n},{}],25:[function(e,t,r){"use strict";r.byteLength=function(e){var t=l(e),r=t[0],n=t[1];return 3*(r+n)/4-n},r.toByteArray=function(e){var t,r,n=l(e),o=n[0],a=n[1],u=new s(function(e,t,r){return 3*(t+r)/4-r}(0,o,a)),c=0,h=a>0?o-4:o;for(r=0;r<h;r+=4)t=i[e.charCodeAt(r)]<<18|i[e.charCodeAt(r+1)]<<12|i[e.charCodeAt(r+2)]<<6|i[e.charCodeAt(r+3)],u[c++]=t>>16&255,u[c++]=t>>8&255,u[c++]=255&t;2===a&&(t=i[e.charCodeAt(r)]<<2|i[e.charCodeAt(r+1)]>>4,u[c++]=255&t);1===a&&(t=i[e.charCodeAt(r)]<<10|i[e.charCodeAt(r+1)]<<4|i[e.charCodeAt(r+2)]>>2,u[c++]=t>>8&255,u[c++]=255&t);return u},r.fromByteArray=function(e){for(var t,r=e.length,i=r%3,s=[],o=16383,a=0,l=r-i;a<l;a+=o)s.push(u(e,a,a+o>l?l:a+o));1===i?(t=e[r-1],s.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],s.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return s.join("")};for(var n=[],i=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)n[a]=o[a],i[o.charCodeAt(a)]=a;function l(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function u(e,t,r){for(var i,s,o=[],a=t;a<r;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),o.push(n[(s=i)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return o.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},{}],26:[function(e,t,r){},{}],27:[function(e,t,r){var n=e("buffer"),i=n.Buffer;function s(e,t){for(var r in e)t[r]=e[r]}function o(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?t.exports=n:(s(n,r),r.Buffer=o),s(i,o),o.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,r)},o.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:29}],28:[function(e,t,r){"use strict";var n=e("safe-buffer").Buffer,i=n.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function s(e){var t;switch(this.encoding=function(e){var t=function(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}(e);if("string"!=typeof t&&(n.isEncoding===i||!i(e)))throw new Error("Unknown encoding: "+e);return t||e}(e),this.encoding){case"utf16le":this.text=l,this.end=u,t=4;break;case"utf8":this.fillLast=a,t=4;break;case"base64":this.text=c,this.end=h,t=3;break;default:return this.write=f,void(this.end=d)}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(t)}function o(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function a(e){var t=this.lastTotal-this.lastNeed,r=function(e,t,r){if(128!=(192&t[0]))return e.lastNeed=0,"пїЅ";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"пїЅ";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"пїЅ"}}(this,e);return void 0!==r?r:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function l(e,t){if((e.length-t)%2==0){var r=e.toString("utf16le",t);if(r){var n=r.charCodeAt(r.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function u(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var r=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,r)}return t}function c(e,t){var r=(e.length-t)%3;return 0===r?e.toString("base64",t):(this.lastNeed=3-r,this.lastTotal=3,1===r?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-r))}function h(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function f(e){return e.toString(this.encoding)}function d(e){return e&&e.length?this.write(e):""}r.StringDecoder=s,s.prototype.write=function(e){if(0===e.length)return"";var t,r;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";r=this.lastNeed,this.lastNeed=0}else r=0;return r<e.length?t?t+this.text(e,r):this.text(e,r):t||""},s.prototype.end=function(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"пїЅ":t},s.prototype.text=function(e,t){var r=function(e,t,r){var n=t.length-1;if(n<r)return 0;var i=o(t[n]);if(i>=0)return i>0&&(e.lastNeed=i-1),i;if(--n<r||-2===i)return 0;if(i=o(t[n]),i>=0)return i>0&&(e.lastNeed=i-2),i;if(--n<r||-2===i)return 0;if(i=o(t[n]),i>=0)return i>0&&(2===i?i=0:e.lastNeed=i-3),i;return 0}(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=r;var n=e.length-(r-this.lastNeed);return e.copy(this.lastChar,0,n),e.toString("utf8",t,n)},s.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},{"safe-buffer":27}],29:[function(e,t,r){(function(t){(function(){
/*!
* The buffer module from node.js, for the browser.
*
* @author   Feross Aboukhadijeh <https://feross.org>
* @license  MIT
*/
"use strict";var t=e("base64-js"),n=e("ieee754");r.Buffer=o,r.SlowBuffer=function(e){+e!=e&&(e=0);return o.alloc(+e)},r.INSPECT_MAX_BYTES=50;var i=2147483647;function s(e){if(e>i)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=o.prototype,t}function o(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return a(e,t,r)}function a(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!o.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var r=0|f(e,t),n=s(r),i=n.write(e,t);i!==r&&(n=n.slice(0,i));return n}(e,t);if(ArrayBuffer.isView(e))return c(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(F(e,ArrayBuffer)||e&&F(e.buffer,ArrayBuffer))return function(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');var n;n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r);return n.__proto__=o.prototype,n}(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return o.from(n,t,r);var i=function(e){if(o.isBuffer(e)){var t=0|h(e.length),r=s(t);return 0===r.length||e.copy(r,0,0,t),r}if(void 0!==e.length)return"number"!=typeof e.length||W(e.length)?s(0):c(e);if("Buffer"===e.type&&Array.isArray(e.data))return c(e.data)}(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return o.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function u(e){return l(e),s(e<0?0:0|h(e))}function c(e){for(var t=e.length<0?0:0|h(e.length),r=s(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}function h(e){if(e>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return 0|e}function f(e,t){if(o.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||F(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return N(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return U(e).length;default:if(i)return n?-1:N(e).length;t=(""+t).toLowerCase(),i=!0}}function d(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return R(this,t,r);case"utf8":case"utf-8":return A(this,t,r);case"ascii":return T(this,t,r);case"latin1":case"binary":return I(this,t,r);case"base64":return E(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return O(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function p(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function b(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),W(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=o.from(t,n)),o.isBuffer(t))return 0===t.length?-1:g(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):g(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function g(e,t,r,n,i){var s,o=1,a=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,a/=2,l/=2,r/=2}function u(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(i){var c=-1;for(s=r;s<a;s++)if(u(e,s)===u(t,-1===c?0:s-c)){if(-1===c&&(c=s),s-c+1===l)return c*o}else-1!==c&&(s-=s-c),c=-1}else for(r+l>a&&(r=a-l),s=r;s>=0;s--){for(var h=!0,f=0;f<l;f++)if(u(e,s+f)!==u(t,f)){h=!1;break}if(h)return s}return-1}function m(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;var s=t.length;n>s/2&&(n=s/2);for(var o=0;o<n;++o){var a=parseInt(t.substr(2*o,2),16);if(W(a))return o;e[r+o]=a}return o}function y(e,t,r,n){return D(N(t,e.length-r),e,r,n)}function _(e,t,r,n){return D(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function w(e,t,r,n){return _(e,t,r,n)}function v(e,t,r,n){return D(U(t),e,r,n)}function S(e,t,r,n){return D(function(e,t){for(var r,n,i,s=[],o=0;o<e.length&&!((t-=2)<0);++o)n=(r=e.charCodeAt(o))>>8,i=r%256,s.push(i),s.push(n);return s}(t,e.length-r),e,r,n)}function E(e,r,n){return 0===r&&n===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(r,n))}function A(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;i<r;){var s,o,a,l,u=e[i],c=null,h=u>239?4:u>223?3:u>191?2:1;if(i+h<=r)switch(h){case 1:u<128&&(c=u);break;case 2:128==(192&(s=e[i+1]))&&(l=(31&u)<<6|63&s)>127&&(c=l);break;case 3:s=e[i+1],o=e[i+2],128==(192&s)&&128==(192&o)&&(l=(15&u)<<12|(63&s)<<6|63&o)>2047&&(l<55296||l>57343)&&(c=l);break;case 4:s=e[i+1],o=e[i+2],a=e[i+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&(l=(15&u)<<18|(63&s)<<12|(63&o)<<6|63&a)>65535&&l<1114112&&(c=l)}null===c?(c=65533,h=1):c>65535&&(c-=65536,n.push(c>>>10&1023|55296),c=56320|1023&c),n.push(c),i+=h}return function(e){var t=e.length;if(t<=k)return String.fromCharCode.apply(String,e);var r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=k));return r}(n)}r.kMaxLength=i,o.TYPED_ARRAY_SUPPORT=function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(e){return!1}}(),o.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.buffer}}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),o.poolSize=8192,o.from=function(e,t,r){return a(e,t,r)},o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,o.alloc=function(e,t,r){return function(e,t,r){return l(e),e<=0?s(e):void 0!==t?"string"==typeof r?s(e).fill(t,r):s(e).fill(t):s(e)}(e,t,r)},o.allocUnsafe=function(e){return u(e)},o.allocUnsafeSlow=function(e){return u(e)},o.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==o.prototype},o.compare=function(e,t){if(F(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),F(t,Uint8Array)&&(t=o.from(t,t.offset,t.byteLength)),!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var r=e.length,n=t.length,i=0,s=Math.min(r,n);i<s;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=o.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){var s=e[r];if(F(s,Uint8Array)&&(s=o.from(s)),!o.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(n,i),i+=s.length}return n},o.byteLength=f,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)p(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},o.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?A(this,0,e):d.apply(this,arguments)},o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",t=r.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},o.prototype.compare=function(e,t,r,n,i){if(F(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),!o.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;for(var s=(i>>>=0)-(n>>>=0),a=(r>>>=0)-(t>>>=0),l=Math.min(s,a),u=this.slice(n,i),c=e.slice(t,r),h=0;h<l;++h)if(u[h]!==c[h]){s=u[h],a=c[h];break}return s<a?-1:a<s?1:0},o.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},o.prototype.indexOf=function(e,t,r){return b(this,e,t,r,!0)},o.prototype.lastIndexOf=function(e,t,r){return b(this,e,t,r,!1)},o.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var s=!1;;)switch(n){case"hex":return m(this,e,t,r);case"utf8":case"utf-8":return y(this,e,t,r);case"ascii":return _(this,e,t,r);case"latin1":case"binary":return w(this,e,t,r);case"base64":return v(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return S(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var k=4096;function T(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function I(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function R(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var i="",s=t;s<r;++s)i+=j(e[s]);return i}function O(e,t,r){for(var n=e.slice(t,r),i="",s=0;s<n.length;s+=2)i+=String.fromCharCode(n[s]+256*n[s+1]);return i}function C(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,r,n,i,s){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<s)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function x(e,t,r,n,i,s){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function M(e,t,r,i,s){return t=+t,r>>>=0,s||x(e,0,r,4),n.write(e,t,r,i,23,4),r+4}function B(e,t,r,i,s){return t=+t,r>>>=0,s||x(e,0,r,8),n.write(e,t,r,i,52,8),r+8}o.prototype.slice=function(e,t){var r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);var n=this.subarray(e,t);return n.__proto__=o.prototype,n},o.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||C(e,t,this.length);for(var n=this[e],i=1,s=0;++s<t&&(i*=256);)n+=this[e+s]*i;return n},o.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||C(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},o.prototype.readUInt8=function(e,t){return e>>>=0,t||C(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return e>>>=0,t||C(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return e>>>=0,t||C(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return e>>>=0,t||C(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return e>>>=0,t||C(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||C(e,t,this.length);for(var n=this[e],i=1,s=0;++s<t&&(i*=256);)n+=this[e+s]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},o.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||C(e,t,this.length);for(var n=t,i=1,s=this[e+--n];n>0&&(i*=256);)s+=this[e+--n]*i;return s>=(i*=128)&&(s-=Math.pow(2,8*t)),s},o.prototype.readInt8=function(e,t){return e>>>=0,t||C(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){e>>>=0,t||C(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},o.prototype.readInt16BE=function(e,t){e>>>=0,t||C(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},o.prototype.readInt32LE=function(e,t){return e>>>=0,t||C(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return e>>>=0,t||C(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return e>>>=0,t||C(e,4,this.length),n.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return e>>>=0,t||C(e,4,this.length),n.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return e>>>=0,t||C(e,8,this.length),n.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return e>>>=0,t||C(e,8,this.length),n.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||P(this,e,t,r,Math.pow(2,8*r)-1,0);var i=1,s=0;for(this[t]=255&e;++s<r&&(i*=256);)this[t+s]=e/i&255;return t+r},o.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||P(this,e,t,r,Math.pow(2,8*r)-1,0);var i=r-1,s=1;for(this[t+i]=255&e;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+r},o.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,1,255,0),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},o.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);P(this,e,t,r,i-1,-i)}var s=0,o=1,a=0;for(this[t]=255&e;++s<r&&(o*=256);)e<0&&0===a&&0!==this[t+s-1]&&(a=1),this[t+s]=(e/o>>0)-a&255;return t+r},o.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);P(this,e,t,r,i-1,-i)}var s=r-1,o=1,a=0;for(this[t+s]=255&e;--s>=0&&(o*=256);)e<0&&0===a&&0!==this[t+s+1]&&(a=1),this[t+s]=(e/o>>0)-a&255;return t+r},o.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},o.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeFloatLE=function(e,t,r){return M(this,e,t,!0,r)},o.prototype.writeFloatBE=function(e,t,r){return M(this,e,t,!1,r)},o.prototype.writeDoubleLE=function(e,t,r){return B(this,e,t,!0,r)},o.prototype.writeDoubleBE=function(e,t,r){return B(this,e,t,!1,r)},o.prototype.copy=function(e,t,r,n){if(!o.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var i=n-r;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,r,n);else if(this===e&&r<t&&t<n)for(var s=i-1;s>=0;--s)e[s+t]=this[s+r];else Uint8Array.prototype.set.call(e,this.subarray(r,n),t);return i},o.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!o.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){var i=e.charCodeAt(0);("utf8"===n&&i<128||"latin1"===n)&&(e=i)}}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var s;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(s=t;s<r;++s)this[s]=e;else{var a=o.isBuffer(e)?e:o.from(e,n),l=a.length;if(0===l)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<r-t;++s)this[s+t]=a[s%l]}return this};var L=/[^+/0-9A-Za-z-_]/g;function j(e){return e<16?"0"+e.toString(16):e.toString(16)}function N(e,t){var r;t=t||1/0;for(var n=e.length,i=null,s=[],o=0;o<n;++o){if((r=e.charCodeAt(o))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&s.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&s.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&s.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;s.push(r)}else if(r<2048){if((t-=2)<0)break;s.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;s.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return s}function U(e){return t.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(L,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function D(e,t,r,n){for(var i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function F(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function W(e){return e!=e}}).call(this)}).call(this,e("buffer").Buffer)},{"base64-js":25,buffer:29,ieee754:50}],30:[function(e,t,r){(function(n){(function(){r.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;e.splice(1,0,r,"color: inherit");let n=0,i=0;e[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(n++,"%c"===e&&(i=n))})),e.splice(i,0,r)},r.save=function(e){try{e?r.storage.setItem("debug",e):r.storage.removeItem("debug")}catch(e){}},r.load=function(){let e;try{e=r.storage.getItem("debug")}catch(e){}!e&&void 0!==n&&"env"in n&&(e=n.env.DEBUG);return e},r.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},r.storage=function(){try{return localStorage}catch(e){}}(),r.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),r.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],r.log=console.debug||console.log||(()=>{}),t.exports=e("./common")(r);const{formatters:i}=t.exports;i.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this)}).call(this,e("_process"))},{"./common":31,_process:102}],31:[function(e,t,r){t.exports=function(t){function r(e){let t,i,s,o=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),s=i-(t||i);n.diff=s,n.prev=t,n.curr=i,t=i,e[0]=r.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((t,i)=>{if("%%"===t)return"%";o++;const s=r.formatters[i];if("function"==typeof s){const r=e[o];t=s.call(n,r),e.splice(o,1),o--}return t})),r.formatArgs.call(n,e);(n.log||r.log).apply(n,e)}return a.namespace=e,a.useColors=r.useColors(),a.color=r.selectColor(e),a.extend=n,a.destroy=r.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==r.namespaces&&(i=r.namespaces,s=r.enabled(e)),s),set:e=>{o=e}}),"function"==typeof r.init&&r.init(a),a}function n(e,t){const n=r(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function i(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return r.debug=r,r.default=r,r.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},r.disable=function(){const e=[...r.names.map(i),...r.skips.map(i).map((e=>"-"+e))].join(",");return r.enable(""),e},r.enable=function(e){let t;r.save(e),r.namespaces=e,r.names=[],r.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),i=n.length;for(t=0;t<i;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?r.skips.push(new RegExp("^"+e.slice(1)+"$")):r.names.push(new RegExp("^"+e+"$")))},r.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=r.skips.length;t<n;t++)if(r.skips[t].test(e))return!1;for(t=0,n=r.names.length;t<n;t++)if(r.names[t].test(e))return!0;return!1},r.humanize=e("ms"),r.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach((e=>{r[e]=t[e]})),r.names=[],r.skips=[],r.formatters={},r.selectColor=function(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return r.colors[Math.abs(t)%r.colors.length]},r.enable(r.load()),r}},{ms:97}],32:[function(e,t,r){(function(r,n){(function(){var i=e("readable-stream"),s=e("end-of-stream"),o=e("inherits"),a=e("stream-shift"),l=n.from&&n.from!==Uint8Array.from?n.from([0]):new n([0]),u=function(e,t){e._corked?e.once("uncork",t):t()},c=function(e,t){return function(r){r?function(e,t){e._autoDestroy&&e.destroy(t)}(e,"premature close"===r.message?null:r):t&&!e._ended&&e.end()}},h=function(){},f=function(e,t,r){if(!(this instanceof f))return new f(e,t,r);i.Duplex.call(this,r),this._writable=null,this._readable=null,this._readable2=null,this._autoDestroy=!r||!1!==r.autoDestroy,this._forwardDestroy=!r||!1!==r.destroy,this._forwardEnd=!r||!1!==r.end,this._corked=1,this._ondrain=null,this._drained=!1,this._forwarding=!1,this._unwrite=null,this._unread=null,this._ended=!1,this.destroyed=!1,e&&this.setWritable(e),t&&this.setReadable(t)};o(f,i.Duplex),f.obj=function(e,t,r){return r||(r={}),r.objectMode=!0,r.highWaterMark=16,new f(e,t,r)},f.prototype.cork=function(){1==++this._corked&&this.emit("cork")},f.prototype.uncork=function(){this._corked&&0==--this._corked&&this.emit("uncork")},f.prototype.setWritable=function(e){if(this._unwrite&&this._unwrite(),this.destroyed)e&&e.destroy&&e.destroy();else if(null!==e&&!1!==e){var t=this,n=s(e,{writable:!0,readable:!1},c(this,this._forwardEnd)),i=function(){var e=t._ondrain;t._ondrain=null,e&&e()};this._unwrite&&r.nextTick(i),this._writable=e,this._writable.on("drain",i),this._unwrite=function(){t._writable.removeListener("drain",i),n()},this.uncork()}else this.end()},f.prototype.setReadable=function(e){if(this._unread&&this._unread(),this.destroyed)e&&e.destroy&&e.destroy();else{if(null===e||!1===e)return this.push(null),void this.resume();var t,r=this,n=s(e,{writable:!1,readable:!0},c(this)),o=function(){r._forward()},a=function(){r.push(null)};this._drained=!0,this._readable=e,this._readable2=e._readableState?e:(t=e,new i.Readable({objectMode:!0,highWaterMark:16}).wrap(t)),this._readable2.on("readable",o),this._readable2.on("end",a),this._unread=function(){r._readable2.removeListener("readable",o),r._readable2.removeListener("end",a),n()},this._forward()}},f.prototype._read=function(){this._drained=!0,this._forward()},f.prototype._forward=function(){if(!this._forwarding&&this._readable2&&this._drained){var e;for(this._forwarding=!0;this._drained&&null!==(e=a(this._readable2));)this.destroyed||(this._drained=this.push(e));this._forwarding=!1}},f.prototype.destroy=function(e,t){if(t||(t=h),this.destroyed)return t(null);this.destroyed=!0;var n=this;r.nextTick((function(){n._destroy(e),t(null)}))},f.prototype._destroy=function(e){if(e){var t=this._ondrain;this._ondrain=null,t?t(e):this.emit("error",e)}this._forwardDestroy&&(this._readable&&this._readable.destroy&&this._readable.destroy(),this._writable&&this._writable.destroy&&this._writable.destroy()),this.emit("close")},f.prototype._write=function(e,t,r){if(!this.destroyed)return this._corked?u(this,this._write.bind(this,e,t,r)):e===l?this._finish(r):this._writable?void(!1===this._writable.write(e)?this._ondrain=r:this.destroyed||r()):r()},f.prototype._finish=function(e){var t=this;this.emit("preend"),u(this,(function(){var r,n;r=t._forwardEnd&&t._writable,n=function(){!1===t._writableState.prefinished&&(t._writableState.prefinished=!0),t.emit("prefinish"),u(t,e)},r?r._writableState&&r._writableState.finished?n():r._writableState?r.end(n):(r.end(),n()):n()}))},f.prototype.end=function(e,t,r){return"function"==typeof e?this.end(null,null,e):"function"==typeof t?this.end(e,null,t):(this._ended=!0,e&&this.write(e),this._writableState.ending||this._writableState.destroyed||this.write(l),i.Writable.prototype.end.call(this,r))},t.exports=f}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:102,buffer:29,"end-of-stream":48,inherits:51,"readable-stream":47,"stream-shift":135}],33:[function(e,t,r){"use strict";var n={};function i(e,t,r){r||(r=Error);var i=function(e){var r,n;function i(r,n,i){return e.call(this,function(e,r,n){return"string"==typeof t?t:t(e,r,n)}(r,n,i))||this}return n=e,(r=i).prototype=Object.create(n.prototype),r.prototype.constructor=r,r.__proto__=n,i}(r);i.prototype.name=r.name,i.prototype.code=e,n[e]=i}function s(e,t){if(Array.isArray(e)){var r=e.length;return e=e.map((function(e){return String(e)})),r>2?"one of ".concat(t," ").concat(e.slice(0,r-1).join(", "),", or ")+e[r-1]:2===r?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}i("ERR_INVALID_OPT_VALUE",(function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'}),TypeError),i("ERR_INVALID_ARG_TYPE",(function(e,t,r){var n,i,o,a;if("string"==typeof t&&(i="not ",t.substr(!o||o<0?0:+o,i.length)===i)?(n="must not be",t=t.replace(/^not /,"")):n="must be",function(e,t,r){return(void 0===r||r>e.length)&&(r=e.length),e.substring(r-t.length,r)===t}(e," argument"))a="The ".concat(e," ").concat(n," ").concat(s(t,"type"));else{var l=function(e,t,r){return"number"!=typeof r&&(r=0),!(r+t.length>e.length)&&-1!==e.indexOf(t,r)}(e,".")?"property":"argument";a='The "'.concat(e,'" ').concat(l," ").concat(n," ").concat(s(t,"type"))}return a+=". Received type ".concat(typeof r)}),TypeError),i("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),i("ERR_METHOD_NOT_IMPLEMENTED",(function(e){return"The "+e+" method is not implemented"})),i("ERR_STREAM_PREMATURE_CLOSE","Premature close"),i("ERR_STREAM_DESTROYED",(function(e){return"Cannot call "+e+" after a stream was destroyed"})),i("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),i("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),i("ERR_STREAM_WRITE_AFTER_END","write after end"),i("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),i("ERR_UNKNOWN_ENCODING",(function(e){return"Unknown encoding: "+e}),TypeError),i("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),t.exports.codes=n},{}],34:[function(e,t,r){(function(r){(function(){"use strict";var n=Object.keys||function(e){var t=[];for(var r in e)t.push(r);return t};t.exports=u;var i=e("./_stream_readable"),s=e("./_stream_writable");e("inherits")(u,i);for(var o=n(s.prototype),a=0;a<o.length;a++){var l=o[a];u.prototype[l]||(u.prototype[l]=s.prototype[l])}function u(e){if(!(this instanceof u))return new u(e);i.call(this,e),s.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",c)))}function c(){this._writableState.ended||r.nextTick(h,this)}function h(e){e.end()}Object.defineProperty(u.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(u.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(u.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(u.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})}).call(this)}).call(this,e("_process"))},{"./_stream_readable":36,"./_stream_writable":38,_process:102,inherits:51}],35:[function(e,t,r){"use strict";t.exports=i;var n=e("./_stream_transform");function i(e){if(!(this instanceof i))return new i(e);n.call(this,e)}e("inherits")(i,n),i.prototype._transform=function(e,t,r){r(null,e)}},{"./_stream_transform":37,inherits:51}],36:[function(e,t,r){(function(r,n){(function(){"use strict";var i;t.exports=k,k.ReadableState=A;e("events").EventEmitter;var s=function(e,t){return e.listeners(t).length},o=e("./internal/streams/stream"),a=e("buffer").Buffer,l=n.Uint8Array||function(){};var u,c=e("util");u=c&&c.debuglog?c.debuglog("stream"):function(){};var h,f,d,p=e("./internal/streams/buffer_list"),b=e("./internal/streams/destroy"),g=e("./internal/streams/state").getHighWaterMark,m=e("../errors").codes,y=m.ERR_INVALID_ARG_TYPE,_=m.ERR_STREAM_PUSH_AFTER_EOF,w=m.ERR_METHOD_NOT_IMPLEMENTED,v=m.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;e("inherits")(k,o);var S=b.errorOrDestroy,E=["error","close","destroy","pause","resume"];function A(t,r,n){i=i||e("./_stream_duplex"),t=t||{},"boolean"!=typeof n&&(n=r instanceof i),this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.readableObjectMode),this.highWaterMark=g(this,t,"readableHighWaterMark",n),this.buffer=new p,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(h||(h=e("string_decoder/").StringDecoder),this.decoder=new h(t.encoding),this.encoding=t.encoding)}function k(t){if(i=i||e("./_stream_duplex"),!(this instanceof k))return new k(t);var r=this instanceof i;this._readableState=new A(t,this,r),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),o.call(this)}function T(e,t,r,n,i){u("readableAddChunk",t);var s,o=e._readableState;if(null===t)o.reading=!1,function(e,t){if(u("onEofChunk"),t.ended)return;if(t.decoder){var r=t.decoder.end();r&&r.length&&(t.buffer.push(r),t.length+=t.objectMode?1:r.length)}t.ended=!0,t.sync?C(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,P(e)))}(e,o);else if(i||(s=function(e,t){var r;n=t,a.isBuffer(n)||n instanceof l||"string"==typeof t||void 0===t||e.objectMode||(r=new y("chunk",["string","Buffer","Uint8Array"],t));var n;return r}(o,t)),s)S(e,s);else if(o.objectMode||t&&t.length>0)if("string"==typeof t||o.objectMode||Object.getPrototypeOf(t)===a.prototype||(t=function(e){return a.from(e)}(t)),n)o.endEmitted?S(e,new v):I(e,o,t,!0);else if(o.ended)S(e,new _);else{if(o.destroyed)return!1;o.reading=!1,o.decoder&&!r?(t=o.decoder.write(t),o.objectMode||0!==t.length?I(e,o,t,!1):x(e,o)):I(e,o,t,!1)}else n||(o.reading=!1,x(e,o));return!o.ended&&(o.length<o.highWaterMark||0===o.length)}function I(e,t,r,n){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",r)):(t.length+=t.objectMode?1:r.length,n?t.buffer.unshift(r):t.buffer.push(r),t.needReadable&&C(e)),x(e,t)}Object.defineProperty(k.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),k.prototype.destroy=b.destroy,k.prototype._undestroy=b.undestroy,k.prototype._destroy=function(e,t){t(e)},k.prototype.push=function(e,t){var r,n=this._readableState;return n.objectMode?r=!0:"string"==typeof e&&((t=t||n.defaultEncoding)!==n.encoding&&(e=a.from(e,t),t=""),r=!0),T(this,e,t,!1,r)},k.prototype.unshift=function(e){return T(this,e,null,!0,!1)},k.prototype.isPaused=function(){return!1===this._readableState.flowing},k.prototype.setEncoding=function(t){h||(h=e("string_decoder/").StringDecoder);var r=new h(t);this._readableState.decoder=r,this._readableState.encoding=this._readableState.decoder.encoding;for(var n=this._readableState.buffer.head,i="";null!==n;)i+=r.write(n.data),n=n.next;return this._readableState.buffer.clear(),""!==i&&this._readableState.buffer.push(i),this._readableState.length=i.length,this};var R=1073741824;function O(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=R?e=R:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function C(e){var t=e._readableState;u("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(u("emitReadable",t.flowing),t.emittedReadable=!0,r.nextTick(P,e))}function P(e){var t=e._readableState;u("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,N(e)}function x(e,t){t.readingMore||(t.readingMore=!0,r.nextTick(M,e,t))}function M(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var r=t.length;if(u("maybeReadMore read 0"),e.read(0),r===t.length)break}t.readingMore=!1}function B(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function L(e){u("readable nexttick read 0"),e.read(0)}function j(e,t){u("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),N(e),t.flowing&&!t.reading&&e.read(0)}function N(e){var t=e._readableState;for(u("flow",t.flowing);t.flowing&&null!==e.read(););}function U(e,t){return 0===t.length?null:(t.objectMode?r=t.buffer.shift():!e||e>=t.length?(r=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):r=t.buffer.consume(e,t.decoder),r);var r}function D(e){var t=e._readableState;u("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,r.nextTick(F,t,e))}function F(e,t){if(u("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var r=t._writableState;(!r||r.autoDestroy&&r.finished)&&t.destroy()}}function W(e,t){for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1}k.prototype.read=function(e){u("read",e),e=parseInt(e,10);var t=this._readableState,r=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return u("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?D(this):C(this),null;if(0===(e=O(e,t))&&t.ended)return 0===t.length&&D(this),null;var n,i=t.needReadable;return u("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&u("length less than watermark",i=!0),t.ended||t.reading?u("reading or ended",i=!1):i&&(u("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=O(r,t))),null===(n=e>0?U(e,t):null)?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),0===t.length&&(t.ended||(t.needReadable=!0),r!==e&&t.ended&&D(this)),null!==n&&this.emit("data",n),n},k.prototype._read=function(e){S(this,new w("_read()"))},k.prototype.pipe=function(e,t){var n=this,i=this._readableState;switch(i.pipesCount){case 0:i.pipes=e;break;case 1:i.pipes=[i.pipes,e];break;default:i.pipes.push(e)}i.pipesCount+=1,u("pipe count=%d opts=%j",i.pipesCount,t);var o=(!t||!1!==t.end)&&e!==r.stdout&&e!==r.stderr?l:g;function a(t,r){u("onunpipe"),t===n&&r&&!1===r.hasUnpiped&&(r.hasUnpiped=!0,u("cleanup"),e.removeListener("close",p),e.removeListener("finish",b),e.removeListener("drain",c),e.removeListener("error",d),e.removeListener("unpipe",a),n.removeListener("end",l),n.removeListener("end",g),n.removeListener("data",f),h=!0,!i.awaitDrain||e._writableState&&!e._writableState.needDrain||c())}function l(){u("onend"),e.end()}i.endEmitted?r.nextTick(o):n.once("end",o),e.on("unpipe",a);var c=function(e){return function(){var t=e._readableState;u("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&s(e,"data")&&(t.flowing=!0,N(e))}}(n);e.on("drain",c);var h=!1;function f(t){u("ondata");var r=e.write(t);u("dest.write",r),!1===r&&((1===i.pipesCount&&i.pipes===e||i.pipesCount>1&&-1!==W(i.pipes,e))&&!h&&(u("false write response, pause",i.awaitDrain),i.awaitDrain++),n.pause())}function d(t){u("onerror",t),g(),e.removeListener("error",d),0===s(e,"error")&&S(e,t)}function p(){e.removeListener("finish",b),g()}function b(){u("onfinish"),e.removeListener("close",p),g()}function g(){u("unpipe"),n.unpipe(e)}return n.on("data",f),function(e,t,r){if("function"==typeof e.prependListener)return e.prependListener(t,r);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(r):e._events[t]=[r,e._events[t]]:e.on(t,r)}(e,"error",d),e.once("close",p),e.once("finish",b),e.emit("pipe",n),i.flowing||(u("pipe resume"),n.resume()),e},k.prototype.unpipe=function(e){var t=this._readableState,r={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,r)),this;if(!e){var n=t.pipes,i=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var s=0;s<i;s++)n[s].emit("unpipe",this,{hasUnpiped:!1});return this}var o=W(t.pipes,e);return-1===o||(t.pipes.splice(o,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,r)),this},k.prototype.on=function(e,t){var n=o.prototype.on.call(this,e,t),i=this._readableState;return"data"===e?(i.readableListening=this.listenerCount("readable")>0,!1!==i.flowing&&this.resume()):"readable"===e&&(i.endEmitted||i.readableListening||(i.readableListening=i.needReadable=!0,i.flowing=!1,i.emittedReadable=!1,u("on readable",i.length,i.reading),i.length?C(this):i.reading||r.nextTick(L,this))),n},k.prototype.addListener=k.prototype.on,k.prototype.removeListener=function(e,t){var n=o.prototype.removeListener.call(this,e,t);return"readable"===e&&r.nextTick(B,this),n},k.prototype.removeAllListeners=function(e){var t=o.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||r.nextTick(B,this),t},k.prototype.resume=function(){var e=this._readableState;return e.flowing||(u("resume"),e.flowing=!e.readableListening,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,r.nextTick(j,e,t))}(this,e)),e.paused=!1,this},k.prototype.pause=function(){return u("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(u("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},k.prototype.wrap=function(e){var t=this,r=this._readableState,n=!1;for(var i in e.on("end",(function(){if(u("wrapped end"),r.decoder&&!r.ended){var e=r.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(i){(u("wrapped data"),r.decoder&&(i=r.decoder.write(i)),r.objectMode&&null==i)||(r.objectMode||i&&i.length)&&(t.push(i)||(n=!0,e.pause()))})),e)void 0===this[i]&&"function"==typeof e[i]&&(this[i]=function(t){return function(){return e[t].apply(e,arguments)}}(i));for(var s=0;s<E.length;s++)e.on(E[s],this.emit.bind(this,E[s]));return this._read=function(t){u("wrapped _read",t),n&&(n=!1,e.resume())},this},"function"==typeof Symbol&&(k.prototype[Symbol.asyncIterator]=function(){return void 0===f&&(f=e("./internal/streams/async_iterator")),f(this)}),Object.defineProperty(k.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(k.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(k.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),k._fromList=U,Object.defineProperty(k.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(k.from=function(t,r){return void 0===d&&(d=e("./internal/streams/from")),d(k,t,r)})}).call(this)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":33,"./_stream_duplex":34,"./internal/streams/async_iterator":39,"./internal/streams/buffer_list":40,"./internal/streams/destroy":41,"./internal/streams/from":43,"./internal/streams/state":45,"./internal/streams/stream":46,_process:102,buffer:29,events:49,inherits:51,"string_decoder/":136,util:26}],37:[function(e,t,r){"use strict";t.exports=c;var n=e("../errors").codes,i=n.ERR_METHOD_NOT_IMPLEMENTED,s=n.ERR_MULTIPLE_CALLBACK,o=n.ERR_TRANSFORM_ALREADY_TRANSFORMING,a=n.ERR_TRANSFORM_WITH_LENGTH_0,l=e("./_stream_duplex");function u(e,t){var r=this._transformState;r.transforming=!1;var n=r.writecb;if(null===n)return this.emit("error",new s);r.writechunk=null,r.writecb=null,null!=t&&this.push(t),n(e);var i=this._readableState;i.reading=!1,(i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}function c(e){if(!(this instanceof c))return new c(e);l.call(this,e),this._transformState={afterTransform:u.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",h)}function h(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?f(this,null,null):this._flush((function(t,r){f(e,t,r)}))}function f(e,t,r){if(t)return e.emit("error",t);if(null!=r&&e.push(r),e._writableState.length)throw new a;if(e._transformState.transforming)throw new o;return e.push(null)}e("inherits")(c,l),c.prototype.push=function(e,t){return this._transformState.needTransform=!1,l.prototype.push.call(this,e,t)},c.prototype._transform=function(e,t,r){r(new i("_transform()"))},c.prototype._write=function(e,t,r){var n=this._transformState;if(n.writecb=r,n.writechunk=e,n.writeencoding=t,!n.transforming){var i=this._readableState;(n.needTransform||i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}},c.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},c.prototype._destroy=function(e,t){l.prototype._destroy.call(this,e,(function(e){t(e)}))}},{"../errors":33,"./_stream_duplex":34,inherits:51}],38:[function(e,t,r){(function(r,n){(function(){"use strict";function i(e){var t=this;this.next=null,this.entry=null,this.finish=function(){!function(e,t,r){var n=e.entry;e.entry=null;for(;n;){var i=n.callback;t.pendingcb--,i(r),n=n.next}t.corkedRequestsFree.next=e}(t,e)}}var s;t.exports=k,k.WritableState=A;var o={deprecate:e("util-deprecate")},a=e("./internal/streams/stream"),l=e("buffer").Buffer,u=n.Uint8Array||function(){};var c,h=e("./internal/streams/destroy"),f=e("./internal/streams/state").getHighWaterMark,d=e("../errors").codes,p=d.ERR_INVALID_ARG_TYPE,b=d.ERR_METHOD_NOT_IMPLEMENTED,g=d.ERR_MULTIPLE_CALLBACK,m=d.ERR_STREAM_CANNOT_PIPE,y=d.ERR_STREAM_DESTROYED,_=d.ERR_STREAM_NULL_VALUES,w=d.ERR_STREAM_WRITE_AFTER_END,v=d.ERR_UNKNOWN_ENCODING,S=h.errorOrDestroy;function E(){}function A(t,n,o){s=s||e("./_stream_duplex"),t=t||{},"boolean"!=typeof o&&(o=n instanceof s),this.objectMode=!!t.objectMode,o&&(this.objectMode=this.objectMode||!!t.writableObjectMode),this.highWaterMark=f(this,t,"writableHighWaterMark",o),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var a=!1===t.decodeStrings;this.decodeStrings=!a,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var n=e._writableState,i=n.sync,s=n.writecb;if("function"!=typeof s)throw new g;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(n),t)!function(e,t,n,i,s){--t.pendingcb,n?(r.nextTick(s,i),r.nextTick(P,e,t),e._writableState.errorEmitted=!0,S(e,i)):(s(i),e._writableState.errorEmitted=!0,S(e,i),P(e,t))}(e,n,i,t,s);else{var o=O(n)||e.destroyed;o||n.corked||n.bufferProcessing||!n.bufferedRequest||R(e,n),i?r.nextTick(I,e,n,o,s):I(e,n,o,s)}}(n,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new i(this)}function k(t){var r=this instanceof(s=s||e("./_stream_duplex"));if(!r&&!c.call(k,this))return new k(t);this._writableState=new A(t,this,r),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),a.call(this)}function T(e,t,r,n,i,s,o){t.writelen=n,t.writecb=o,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new y("write")):r?e._writev(i,t.onwrite):e._write(i,s,t.onwrite),t.sync=!1}function I(e,t,r,n){r||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,n(),P(e,t)}function R(e,t){t.bufferProcessing=!0;var r=t.bufferedRequest;if(e._writev&&r&&r.next){var n=t.bufferedRequestCount,s=new Array(n),o=t.corkedRequestsFree;o.entry=r;for(var a=0,l=!0;r;)s[a]=r,r.isBuf||(l=!1),r=r.next,a+=1;s.allBuffers=l,T(e,t,!0,t.length,s,"",o.finish),t.pendingcb++,t.lastBufferedRequest=null,o.next?(t.corkedRequestsFree=o.next,o.next=null):t.corkedRequestsFree=new i(t),t.bufferedRequestCount=0}else{for(;r;){var u=r.chunk,c=r.encoding,h=r.callback;if(T(e,t,!1,t.objectMode?1:u.length,u,c,h),r=r.next,t.bufferedRequestCount--,t.writing)break}null===r&&(t.lastBufferedRequest=null)}t.bufferedRequest=r,t.bufferProcessing=!1}function O(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function C(e,t){e._final((function(r){t.pendingcb--,r&&S(e,r),t.prefinished=!0,e.emit("prefinish"),P(e,t)}))}function P(e,t){var n=O(t);if(n&&(function(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.pendingcb++,t.finalCalled=!0,r.nextTick(C,e,t)))}(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var i=e._readableState;(!i||i.autoDestroy&&i.endEmitted)&&e.destroy()}return n}e("inherits")(k,a),A.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(A.prototype,"buffer",{get:o.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(c=Function.prototype[Symbol.hasInstance],Object.defineProperty(k,Symbol.hasInstance,{value:function(e){return!!c.call(this,e)||this===k&&(e&&e._writableState instanceof A)}})):c=function(e){return e instanceof this},k.prototype.pipe=function(){S(this,new m)},k.prototype.write=function(e,t,n){var i,s=this._writableState,o=!1,a=!s.objectMode&&(i=e,l.isBuffer(i)||i instanceof u);return a&&!l.isBuffer(e)&&(e=function(e){return l.from(e)}(e)),"function"==typeof t&&(n=t,t=null),a?t="buffer":t||(t=s.defaultEncoding),"function"!=typeof n&&(n=E),s.ending?function(e,t){var n=new w;S(e,n),r.nextTick(t,n)}(this,n):(a||function(e,t,n,i){var s;return null===n?s=new _:"string"==typeof n||t.objectMode||(s=new p("chunk",["string","Buffer"],n)),!s||(S(e,s),r.nextTick(i,s),!1)}(this,s,e,n))&&(s.pendingcb++,o=function(e,t,r,n,i,s){if(!r){var o=function(e,t,r){e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=l.from(t,r));return t}(t,n,i);n!==o&&(r=!0,i="buffer",n=o)}var a=t.objectMode?1:n.length;t.length+=a;var u=t.length<t.highWaterMark;u||(t.needDrain=!0);if(t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest={chunk:n,encoding:i,isBuf:r,callback:s,next:null},c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else T(e,t,!1,a,n,i,s);return u}(this,s,a,e,t,n)),o},k.prototype.cork=function(){this._writableState.corked++},k.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||R(this,e))},k.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new v(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(k.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(k.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),k.prototype._write=function(e,t,r){r(new b("_write()"))},k.prototype._writev=null,k.prototype.end=function(e,t,n){var i=this._writableState;return"function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!=e&&this.write(e,t),i.corked&&(i.corked=1,this.uncork()),i.ending||function(e,t,n){t.ending=!0,P(e,t),n&&(t.finished?r.nextTick(n):e.once("finish",n));t.ended=!0,e.writable=!1}(this,i,n),this},Object.defineProperty(k.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(k.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),k.prototype.destroy=h.destroy,k.prototype._undestroy=h.undestroy,k.prototype._destroy=function(e,t){t(e)}}).call(this)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":33,"./_stream_duplex":34,"./internal/streams/destroy":41,"./internal/streams/state":45,"./internal/streams/stream":46,_process:102,buffer:29,inherits:51,"util-deprecate":139}],39:[function(e,t,r){(function(r){(function(){"use strict";var n;function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var s=e("./end-of-stream"),o=Symbol("lastResolve"),a=Symbol("lastReject"),l=Symbol("error"),u=Symbol("ended"),c=Symbol("lastPromise"),h=Symbol("handlePromise"),f=Symbol("stream");function d(e,t){return{value:e,done:t}}function p(e){var t=e[o];if(null!==t){var r=e[f].read();null!==r&&(e[c]=null,e[o]=null,e[a]=null,t(d(r,!1)))}}function b(e){r.nextTick(p,e)}var g=Object.getPrototypeOf((function(){})),m=Object.setPrototypeOf((i(n={get stream(){return this[f]},next:function(){var e=this,t=this[l];if(null!==t)return Promise.reject(t);if(this[u])return Promise.resolve(d(void 0,!0));if(this[f].destroyed)return new Promise((function(t,n){r.nextTick((function(){e[l]?n(e[l]):t(d(void 0,!0))}))}));var n,i=this[c];if(i)n=new Promise(function(e,t){return function(r,n){e.then((function(){t[u]?r(d(void 0,!0)):t[h](r,n)}),n)}}(i,this));else{var s=this[f].read();if(null!==s)return Promise.resolve(d(s,!1));n=new Promise(this[h])}return this[c]=n,n}},Symbol.asyncIterator,(function(){return this})),i(n,"return",(function(){var e=this;return new Promise((function(t,r){e[f].destroy(null,(function(e){e?r(e):t(d(void 0,!0))}))}))})),n),g);t.exports=function(e){var t,r=Object.create(m,(i(t={},f,{value:e,writable:!0}),i(t,o,{value:null,writable:!0}),i(t,a,{value:null,writable:!0}),i(t,l,{value:null,writable:!0}),i(t,u,{value:e._readableState.endEmitted,writable:!0}),i(t,h,{value:function(e,t){var n=r[f].read();n?(r[c]=null,r[o]=null,r[a]=null,e(d(n,!1))):(r[o]=e,r[a]=t)},writable:!0}),t));return r[c]=null,s(e,(function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=r[a];return null!==t&&(r[c]=null,r[o]=null,r[a]=null,t(e)),void(r[l]=e)}var n=r[o];null!==n&&(r[c]=null,r[o]=null,r[a]=null,n(d(void 0,!0))),r[u]=!0})),e.on("readable",b.bind(null,r)),r}}).call(this)}).call(this,e("_process"))},{"./end-of-stream":42,_process:102}],40:[function(e,t,r){"use strict";function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var o=e("buffer").Buffer,a=e("util").inspect,l=a&&a.custom||"inspect";t.exports=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.head=null,this.tail=null,this.length=0}var t,r,u;return t=e,r=[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,r=""+t.data;t=t.next;)r+=e+t.data;return r}},{key:"concat",value:function(e){if(0===this.length)return o.alloc(0);for(var t,r,n,i=o.allocUnsafe(e>>>0),s=this.head,a=0;s;)t=s.data,r=i,n=a,o.prototype.copy.call(t,r,n),a+=s.data.length,s=s.next;return i}},{key:"consume",value:function(e,t){var r;return e<this.head.data.length?(r=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):r=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),r}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,r=1,n=t.data;for(e-=n.length;t=t.next;){var i=t.data,s=e>i.length?i.length:e;if(s===i.length?n+=i:n+=i.slice(0,e),0==(e-=s)){s===i.length?(++r,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=i.slice(s));break}++r}return this.length-=r,n}},{key:"_getBuffer",value:function(e){var t=o.allocUnsafe(e),r=this.head,n=1;for(r.data.copy(t),e-=r.data.length;r=r.next;){var i=r.data,s=e>i.length?i.length:e;if(i.copy(t,t.length-e,0,s),0==(e-=s)){s===i.length?(++n,r.next?this.head=r.next:this.head=this.tail=null):(this.head=r,r.data=i.slice(s));break}++n}return this.length-=n,t}},{key:l,value:function(e,t){return a(this,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},t,{depth:0,customInspect:!1}))}}],r&&s(t.prototype,r),u&&s(t,u),e}()},{buffer:29,util:26}],41:[function(e,t,r){(function(e){(function(){"use strict";function r(e,t){i(e,t),n(e)}function n(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function i(e,t){e.emit("error",t)}t.exports={destroy:function(t,s){var o=this,a=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return a||l?(s?s(t):t&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,e.nextTick(i,this,t)):e.nextTick(i,this,t)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,(function(t){!s&&t?o._writableState?o._writableState.errorEmitted?e.nextTick(n,o):(o._writableState.errorEmitted=!0,e.nextTick(r,o,t)):e.nextTick(r,o,t):s?(e.nextTick(n,o),s(t)):e.nextTick(n,o)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(e,t){var r=e._readableState,n=e._writableState;r&&r.autoDestroy||n&&n.autoDestroy?e.destroy(t):e.emit("error",t)}}}).call(this)}).call(this,e("_process"))},{_process:102}],42:[function(e,t,r){"use strict";var n=e("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function i(){}t.exports=function e(t,r,s){if("function"==typeof r)return e(t,null,r);r||(r={}),s=function(e){var t=!1;return function(){if(!t){t=!0;for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];e.apply(this,n)}}}(s||i);var o=r.readable||!1!==r.readable&&t.readable,a=r.writable||!1!==r.writable&&t.writable,l=function(){t.writable||c()},u=t._writableState&&t._writableState.finished,c=function(){a=!1,u=!0,o||s.call(t)},h=t._readableState&&t._readableState.endEmitted,f=function(){o=!1,h=!0,a||s.call(t)},d=function(e){s.call(t,e)},p=function(){var e;return o&&!h?(t._readableState&&t._readableState.ended||(e=new n),s.call(t,e)):a&&!u?(t._writableState&&t._writableState.ended||(e=new n),s.call(t,e)):void 0},b=function(){t.req.on("finish",c)};return!function(e){return e.setHeader&&"function"==typeof e.abort}(t)?a&&!t._writableState&&(t.on("end",l),t.on("close",l)):(t.on("complete",c),t.on("abort",p),t.req?b():t.on("request",b)),t.on("end",f),t.on("finish",c),!1!==r.error&&t.on("error",d),t.on("close",p),function(){t.removeListener("complete",c),t.removeListener("abort",p),t.removeListener("request",b),t.req&&t.req.removeListener("finish",c),t.removeListener("end",l),t.removeListener("close",l),t.removeListener("finish",c),t.removeListener("end",f),t.removeListener("error",d),t.removeListener("close",p)}}},{"../../../errors":33}],43:[function(e,t,r){t.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],44:[function(e,t,r){"use strict";var n;var i=e("../../../errors").codes,s=i.ERR_MISSING_ARGS,o=i.ERR_STREAM_DESTROYED;function a(e){if(e)throw e}function l(e){e()}function u(e,t){return e.pipe(t)}t.exports=function(){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];var c,h=function(e){return e.length?"function"!=typeof e[e.length-1]?a:e.pop():a}(r);if(Array.isArray(r[0])&&(r=r[0]),r.length<2)throw new s("streams");var f=r.map((function(t,i){var s=i<r.length-1;return function(t,r,i,s){s=function(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}(s);var a=!1;t.on("close",(function(){a=!0})),void 0===n&&(n=e("./end-of-stream")),n(t,{readable:r,writable:i},(function(e){if(e)return s(e);a=!0,s()}));var l=!1;return function(e){if(!a&&!l)return l=!0,function(e){return e.setHeader&&"function"==typeof e.abort}(t)?t.abort():"function"==typeof t.destroy?t.destroy():void s(e||new o("pipe"))}}(t,s,i>0,(function(e){c||(c=e),e&&f.forEach(l),s||(f.forEach(l),h(c))}))}));return r.reduce(u)}},{"../../../errors":33,"./end-of-stream":42}],45:[function(e,t,r){"use strict";var n=e("../../../errors").codes.ERR_INVALID_OPT_VALUE;t.exports={getHighWaterMark:function(e,t,r,i){var s=function(e,t,r){return null!=e.highWaterMark?e.highWaterMark:t?e[r]:null}(t,i,r);if(null!=s){if(!isFinite(s)||Math.floor(s)!==s||s<0)throw new n(i?r:"highWaterMark",s);return Math.floor(s)}return e.objectMode?16:16384}}},{"../../../errors":33}],46:[function(e,t,r){t.exports=e("events").EventEmitter},{events:49}],47:[function(e,t,r){(r=t.exports=e("./lib/_stream_readable.js")).Stream=r,r.Readable=r,r.Writable=e("./lib/_stream_writable.js"),r.Duplex=e("./lib/_stream_duplex.js"),r.Transform=e("./lib/_stream_transform.js"),r.PassThrough=e("./lib/_stream_passthrough.js"),r.finished=e("./lib/internal/streams/end-of-stream.js"),r.pipeline=e("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":34,"./lib/_stream_passthrough.js":35,"./lib/_stream_readable.js":36,"./lib/_stream_transform.js":37,"./lib/_stream_writable.js":38,"./lib/internal/streams/end-of-stream.js":42,"./lib/internal/streams/pipeline.js":44}],48:[function(e,t,r){(function(r){(function(){var n=e("once"),i=function(){},s=function(e,t,o){if("function"==typeof t)return s(e,null,t);t||(t={}),o=n(o||i);var a=e._writableState,l=e._readableState,u=t.readable||!1!==t.readable&&e.readable,c=t.writable||!1!==t.writable&&e.writable,h=!1,f=function(){e.writable||d()},d=function(){c=!1,u||o.call(e)},p=function(){u=!1,c||o.call(e)},b=function(t){o.call(e,t?new Error("exited with error code: "+t):null)},g=function(t){o.call(e,t)},m=function(){r.nextTick(y)},y=function(){if(!h)return(!u||l&&l.ended&&!l.destroyed)&&(!c||a&&a.ended&&!a.destroyed)?void 0:o.call(e,new Error("premature close"))},_=function(){e.req.on("finish",d)};return!function(e){return e.setHeader&&"function"==typeof e.abort}(e)?c&&!a&&(e.on("end",f),e.on("close",f)):(e.on("complete",d),e.on("abort",m),e.req?_():e.on("request",_)),function(e){return e.stdio&&Array.isArray(e.stdio)&&3===e.stdio.length}(e)&&e.on("exit",b),e.on("end",p),e.on("finish",d),!1!==t.error&&e.on("error",g),e.on("close",m),function(){h=!0,e.removeListener("complete",d),e.removeListener("abort",m),e.removeListener("request",_),e.req&&e.req.removeListener("finish",d),e.removeListener("end",f),e.removeListener("close",f),e.removeListener("finish",d),e.removeListener("exit",b),e.removeListener("end",p),e.removeListener("error",g),e.removeListener("close",m)}};t.exports=s}).call(this)}).call(this,e("_process"))},{_process:102,once:100}],49:[function(e,t,r){"use strict";var n,i="object"==typeof Reflect?Reflect:null,s=i&&"function"==typeof i.apply?i.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};n=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}t.exports=a,t.exports.once=function(e,t){return new Promise((function(r,n){function i(r){e.removeListener(t,s),n(r)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}m(e,t,s,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&m(e,"error",t,r)}(e,i,{once:!0})}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var l=10;function u(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function h(e,t,r,n){var i,s,o,a;if(u(r),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),o=s[t]),void 0===o)o=s[t]=r,++e._eventsCount;else if("function"==typeof o?o=s[t]=n?[r,o]:[o,r]:n?o.unshift(r):o.push(r),(i=c(e))>0&&o.length>i&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,a=l,console&&console.warn&&console.warn(a)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=f.bind(n);return i.listener=r,n.wrapFn=i,i}function p(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):g(i,i.length)}function b(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function g(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function m(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(s){n.once&&e.removeEventListener(t,i),r(s)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return c(this)},a.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var l=i[e];if(void 0===l)return!1;if("function"==typeof l)s(l,this,t);else{var u=l.length,c=g(l,u);for(r=0;r<u;++r)s(c[r],this,t)}return!0},a.prototype.addListener=function(e,t){return h(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return h(this,e,t,!0)},a.prototype.once=function(e,t){return u(t),this.on(e,d(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return u(t),this.prependListener(e,d(this,e,t)),this},a.prototype.removeListener=function(e,t){var r,n,i,s,o;if(u(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){o=r[s].listener,i=s;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,s=Object.keys(r);for(n=0;n<s.length;++n)"removeListener"!==(i=s[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},a.prototype.listeners=function(e){return p(this,e,!0)},a.prototype.rawListeners=function(e){return p(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):b.call(e,t)},a.prototype.listenerCount=b,a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},{}],50:[function(e,t,r){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
r.read=function(e,t,r,n,i){var s,o,a=8*i-n-1,l=(1<<a)-1,u=l>>1,c=-7,h=r?i-1:0,f=r?-1:1,d=e[t+h];for(h+=f,s=d&(1<<-c)-1,d>>=-c,c+=a;c>0;s=256*s+e[t+h],h+=f,c-=8);for(o=s&(1<<-c)-1,s>>=-c,c+=n;c>0;o=256*o+e[t+h],h+=f,c-=8);if(0===s)s=1-u;else{if(s===l)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,n),s-=u}return(d?-1:1)*o*Math.pow(2,s-n)},r.write=function(e,t,r,n,i,s){var o,a,l,u=8*s-i-1,c=(1<<u)-1,h=c>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:s-1,p=n?1:-1,b=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=c):(o=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-o))<1&&(o--,l*=2),(t+=o+h>=1?f/l:f*Math.pow(2,1-h))*l>=2&&(o++,l/=2),o+h>=c?(a=0,o=c):o+h>=1?(a=(t*l-1)*Math.pow(2,i),o+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,i),o=0));i>=8;e[r+d]=255&a,d+=p,a/=256,i-=8);for(o=o<<i|a,u+=i;u>0;e[r+d]=255&o,d+=p,o/=256,u-=8);e[r+d-p]|=128*b}},{}],51:[function(e,t,r){"function"==typeof Object.create?t.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}},{}],52:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.ContainerIterator=r.Container=r.Base=void 0;r.ContainerIterator=class{constructor(e=0){this.iteratorType=e}equals(e){return this.o===e.o}};class n{constructor(){this.i=0}get length(){return this.i}size(){return this.i}empty(){return 0===this.i}}r.Base=n;r.Container=class extends n{}},{}],53:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.HashContainerIterator=r.HashContainer=void 0;var n,i=e("../../ContainerBase"),s=(n=e("../../../utils/checkObject"))&&n.t?n:{default:n},o=e("../../../utils/throwError");class a extends i.ContainerIterator{constructor(e,t,r){super(r),this.o=e,this.h=t,0===this.iteratorType?(this.pre=function(){return this.o.L===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.L,this},this.next=function(){return this.o===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.B,this}):(this.pre=function(){return this.o.B===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.B,this},this.next=function(){return this.o===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.L,this})}}r.HashContainerIterator=a;class l extends i.Container{constructor(){super(),this.H=[],this.g={},this.HASH_TAG=Symbol("@@HASH_TAG"),Object.setPrototypeOf(this.g,null),this.h={},this.h.L=this.h.B=this.p=this._=this.h}V(e){const{L:t,B:r}=e;t.B=r,r.L=t,e===this.p&&(this.p=r),e===this._&&(this._=t),this.i-=1}M(e,t,r){let n;if(void 0===r&&(r=(0,s.default)(e)),r){const r=e[this.HASH_TAG];if(void 0!==r)return this.H[r].l=t,this.i;Object.defineProperty(e,this.HASH_TAG,{value:this.H.length,configurable:!0}),n={u:e,l:t,L:this._,B:this.h},this.H.push(n)}else{const r=this.g[e];if(r)return r.l=t,this.i;n={u:e,l:t,L:this._,B:this.h},this.g[e]=n}return 0===this.i?(this.p=n,this.h.B=n):this._.B=n,this._=n,this.h.L=n,++this.i}I(e,t){if(void 0===t&&(t=(0,s.default)(e)),t){const t=e[this.HASH_TAG];return void 0===t?this.h:this.H[t]}return this.g[e]||this.h}clear(){const e=this.HASH_TAG;this.H.forEach((function(t){delete t.u[e]})),this.H=[],this.g={},Object.setPrototypeOf(this.g,null),this.i=0,this.p=this._=this.h.L=this.h.B=this.h}eraseElementByKey(e,t){let r;if(void 0===t&&(t=(0,s.default)(e)),t){const t=e[this.HASH_TAG];if(void 0===t)return!1;delete e[this.HASH_TAG],r=this.H[t],delete this.H[t]}else{if(r=this.g[e],void 0===r)return!1;delete this.g[e]}return this.V(r),!0}eraseElementByIterator(e){const t=e.o;return t===this.h&&(0,o.throwIteratorAccessError)(),this.V(t),e.next()}eraseElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;let t=this.p;for(;e--;)t=t.B;return this.V(t),this.i}}r.HashContainer=l},{"../../../utils/checkObject":70,"../../../utils/throwError":71,"../../ContainerBase":52}],54:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n,i=e("./Base"),s=(n=e("../../utils/checkObject"))&&n.t?n:{default:n},o=e("../../utils/throwError");class a extends i.HashContainerIterator{constructor(e,t,r,n){super(e,t,n),this.container=r}get pointer(){this.o===this.h&&(0,o.throwIteratorAccessError)();const e=this;return new Proxy([],{get:(t,r)=>"0"===r?e.o.u:"1"===r?e.o.l:void 0,set(t,r,n){if("1"!==r)throw new TypeError("props must be 1");return e.o.l=n,!0}})}copy(){return new a(this.o,this.h,this.container,this.iteratorType)}}class l extends i.HashContainer{constructor(e=[]){super();const t=this;e.forEach((function(e){t.setElement(e[0],e[1])}))}begin(){return new a(this.p,this.h,this)}end(){return new a(this.h,this.h,this)}rBegin(){return new a(this._,this.h,this,1)}rEnd(){return new a(this.h,this.h,this,1)}front(){if(0!==this.i)return[this.p.u,this.p.l]}back(){if(0!==this.i)return[this._.u,this._.l]}setElement(e,t,r){return this.M(e,t,r)}getElementByKey(e,t){if(void 0===t&&(t=(0,s.default)(e)),t){const t=e[this.HASH_TAG];return void 0!==t?this.H[t].l:void 0}const r=this.g[e];return r?r.l:void 0}getElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;let t=this.p;for(;e--;)t=t.B;return[t.u,t.l]}find(e,t){const r=this.I(e,t);return new a(r,this.h,this)}forEach(e){let t=0,r=this.p;for(;r!==this.h;)e([r.u,r.l],t++,this),r=r.B}[Symbol.iterator](){return function*(){let e=this.p;for(;e!==this.h;)yield[e.u,e.l],e=e.B}.bind(this)()}}var u=l;r.default=u},{"../../utils/checkObject":70,"../../utils/throwError":71,"./Base":53}],55:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=e("./Base"),i=e("../../utils/throwError");class s extends n.HashContainerIterator{constructor(e,t,r,n){super(e,t,n),this.container=r}get pointer(){return this.o===this.h&&(0,i.throwIteratorAccessError)(),this.o.u}copy(){return new s(this.o,this.h,this.container,this.iteratorType)}}class o extends n.HashContainer{constructor(e=[]){super();const t=this;e.forEach((function(e){t.insert(e)}))}begin(){return new s(this.p,this.h,this)}end(){return new s(this.h,this.h,this)}rBegin(){return new s(this._,this.h,this,1)}rEnd(){return new s(this.h,this.h,this,1)}front(){return this.p.u}back(){return this._.u}insert(e,t){return this.M(e,void 0,t)}getElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;let t=this.p;for(;e--;)t=t.B;return t.u}find(e,t){const r=this.I(e,t);return new s(r,this.h,this)}forEach(e){let t=0,r=this.p;for(;r!==this.h;)e(r.u,t++,this),r=r.B}[Symbol.iterator](){return function*(){let e=this.p;for(;e!==this.h;)yield e.u,e=e.B}.bind(this)()}}var a=o;r.default=a},{"../../utils/throwError":71,"./Base":53}],56:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=e("../ContainerBase");class i extends n.Base{constructor(e=[],t=function(e,t){return e>t?-1:e<t?1:0},r=!0){if(super(),this.v=t,Array.isArray(e))this.C=r?[...e]:e;else{this.C=[];const t=this;e.forEach((function(e){t.C.push(e)}))}this.i=this.C.length;const n=this.i>>1;for(let e=this.i-1>>1;e>=0;--e)this.k(e,n)}m(e){const t=this.C[e];for(;e>0;){const r=e-1>>1,n=this.C[r];if(this.v(n,t)<=0)break;this.C[e]=n,e=r}this.C[e]=t}k(e,t){const r=this.C[e];for(;e<t;){let t=e<<1|1;const n=t+1;let i=this.C[t];if(n<this.i&&this.v(i,this.C[n])>0&&(t=n,i=this.C[n]),this.v(i,r)>=0)break;this.C[e]=i,e=t}this.C[e]=r}clear(){this.i=0,this.C.length=0}push(e){this.C.push(e),this.m(this.i),this.i+=1}pop(){if(0===this.i)return;const e=this.C[0],t=this.C.pop();return this.i-=1,this.i&&(this.C[0]=t,this.k(0,this.i>>1)),e}top(){return this.C[0]}find(e){return this.C.indexOf(e)>=0}remove(e){const t=this.C.indexOf(e);return!(t<0)&&(0===t?this.pop():t===this.i-1?(this.C.pop(),this.i-=1):(this.C.splice(t,1,this.C.pop()),this.i-=1,this.m(t),this.k(t,this.i>>1)),!0)}updateItem(e){const t=this.C.indexOf(e);return!(t<0)&&(this.m(t),this.k(t,this.i>>1),!0)}toArray(){return[...this.C]}}var s=i;r.default=s},{"../ContainerBase":52}],57:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=e("../ContainerBase");class i extends n.Base{constructor(e=[]){super(),this.j=0,this.q=[];const t=this;e.forEach((function(e){t.push(e)}))}clear(){this.q=[],this.i=this.j=0}push(e){const t=this.q.length;if(this.j/t>.5&&this.j+this.i>=t&&t>4096){const t=this.i;for(let e=0;e<t;++e)this.q[e]=this.q[this.j+e];this.j=0,this.q[this.i]=e}else this.q[this.j+this.i]=e;return++this.i}pop(){if(0===this.i)return;const e=this.q[this.j++];return this.i-=1,e}front(){if(0!==this.i)return this.q[this.j]}}var s=i;r.default=s},{"../ContainerBase":52}],58:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=e("../ContainerBase");class i extends n.Base{constructor(e=[]){super(),this.S=[];const t=this;e.forEach((function(e){t.push(e)}))}clear(){this.i=0,this.S=[]}push(e){return this.S.push(e),this.i+=1,this.i}pop(){if(0!==this.i)return this.i-=1,this.S.pop()}top(){return this.S[this.i-1]}}var s=i;r.default=s},{"../ContainerBase":52}],59:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.RandomIterator=void 0;var n=e("../../ContainerBase"),i=e("../../../utils/throwError");class s extends n.ContainerIterator{constructor(e,t){super(t),this.o=e,0===this.iteratorType?(this.pre=function(){return 0===this.o&&(0,i.throwIteratorAccessError)(),this.o-=1,this},this.next=function(){return this.o===this.container.size()&&(0,i.throwIteratorAccessError)(),this.o+=1,this}):(this.pre=function(){return this.o===this.container.size()-1&&(0,i.throwIteratorAccessError)(),this.o+=1,this},this.next=function(){return-1===this.o&&(0,i.throwIteratorAccessError)(),this.o-=1,this})}get pointer(){return this.container.getElementByPos(this.o)}set pointer(e){this.container.setElementByPos(this.o,e)}}r.RandomIterator=s},{"../../../utils/throwError":71,"../../ContainerBase":52}],60:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=e("../../ContainerBase");class i extends n.Container{}var s=i;r.default=s},{"../../ContainerBase":52}],61:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n,i=(n=e("./Base"))&&n.t?n:{default:n},s=e("./Base/RandomIterator");class o extends s.RandomIterator{constructor(e,t,r){super(e,r),this.container=t}copy(){return new o(this.o,this.container,this.iteratorType)}}class a extends i.default{constructor(e=[],t=4096){super(),this.j=0,this.D=0,this.R=0,this.N=0,this.P=0,this.A=[];const r=(()=>{if("number"==typeof e.length)return e.length;if("number"==typeof e.size)return e.size;if("function"==typeof e.size)return e.size();throw new TypeError("Cannot get the length or size of the container")})();this.F=t,this.P=Math.max(Math.ceil(r/this.F),1);for(let e=0;e<this.P;++e)this.A.push(new Array(this.F));const n=Math.ceil(r/this.F);this.j=this.R=(this.P>>1)-(n>>1),this.D=this.N=this.F-r%this.F>>1;const i=this;e.forEach((function(e){i.pushBack(e)}))}T(){const e=[],t=Math.max(this.P>>1,1);for(let r=0;r<t;++r)e[r]=new Array(this.F);for(let t=this.j;t<this.P;++t)e[e.length]=this.A[t];for(let t=0;t<this.R;++t)e[e.length]=this.A[t];e[e.length]=[...this.A[this.R]],this.j=t,this.R=e.length-1;for(let r=0;r<t;++r)e[e.length]=new Array(this.F);this.A=e,this.P=e.length}O(e){const t=this.D+e+1,r=t%this.F;let n=r-1,i=this.j+(t-r)/this.F;return 0===r&&(i-=1),i%=this.P,n<0&&(n+=this.F),{curNodeBucketIndex:i,curNodePointerIndex:n}}clear(){this.A=[new Array(this.F)],this.P=1,this.j=this.R=this.i=0,this.D=this.N=this.F>>1}begin(){return new o(0,this)}end(){return new o(this.i,this)}rBegin(){return new o(this.i-1,this,1)}rEnd(){return new o(-1,this,1)}front(){if(0!==this.i)return this.A[this.j][this.D]}back(){if(0!==this.i)return this.A[this.R][this.N]}pushBack(e){return this.i&&(this.N<this.F-1?this.N+=1:this.R<this.P-1?(this.R+=1,this.N=0):(this.R=0,this.N=0),this.R===this.j&&this.N===this.D&&this.T()),this.i+=1,this.A[this.R][this.N]=e,this.i}popBack(){if(0===this.i)return;const e=this.A[this.R][this.N];return 1!==this.i&&(this.N>0?this.N-=1:this.R>0?(this.R-=1,this.N=this.F-1):(this.R=this.P-1,this.N=this.F-1)),this.i-=1,e}pushFront(e){return this.i&&(this.D>0?this.D-=1:this.j>0?(this.j-=1,this.D=this.F-1):(this.j=this.P-1,this.D=this.F-1),this.j===this.R&&this.D===this.N&&this.T()),this.i+=1,this.A[this.j][this.D]=e,this.i}popFront(){if(0===this.i)return;const e=this.A[this.j][this.D];return 1!==this.i&&(this.D<this.F-1?this.D+=1:this.j<this.P-1?(this.j+=1,this.D=0):(this.j=0,this.D=0)),this.i-=1,e}getElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;const{curNodeBucketIndex:t,curNodePointerIndex:r}=this.O(e);return this.A[t][r]}setElementByPos(e,t){if(e<0||e>this.i-1)throw new RangeError;const{curNodeBucketIndex:r,curNodePointerIndex:n}=this.O(e);this.A[r][n]=t}insert(e,t,r=1){if(e<0||e>this.i)throw new RangeError;if(0===e)for(;r--;)this.pushFront(t);else if(e===this.i)for(;r--;)this.pushBack(t);else{const n=[];for(let t=e;t<this.i;++t)n.push(this.getElementByPos(t));this.cut(e-1);for(let e=0;e<r;++e)this.pushBack(t);for(let e=0;e<n.length;++e)this.pushBack(n[e])}return this.i}cut(e){if(e<0)return this.clear(),0;const{curNodeBucketIndex:t,curNodePointerIndex:r}=this.O(e);return this.R=t,this.N=r,this.i=e+1,this.i}eraseElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;if(0===e)this.popFront();else if(e===this.i-1)this.popBack();else{const t=[];for(let r=e+1;r<this.i;++r)t.push(this.getElementByPos(r));this.cut(e),this.popBack();const r=this;t.forEach((function(e){r.pushBack(e)}))}return this.i}eraseElementByValue(e){if(0===this.i)return 0;const t=[];for(let r=0;r<this.i;++r){const n=this.getElementByPos(r);n!==e&&t.push(n)}const r=t.length;for(let e=0;e<r;++e)this.setElementByPos(e,t[e]);return this.cut(r-1)}eraseElementByIterator(e){const t=e.o;return this.eraseElementByPos(t),e=e.next()}find(e){for(let t=0;t<this.i;++t)if(this.getElementByPos(t)===e)return new o(t,this);return this.end()}reverse(){let e=0,t=this.i-1;for(;e<t;){const r=this.getElementByPos(e);this.setElementByPos(e,this.getElementByPos(t)),this.setElementByPos(t,r),e+=1,t-=1}}unique(){if(this.i<=1)return this.i;let e=1,t=this.getElementByPos(0);for(let r=1;r<this.i;++r){const n=this.getElementByPos(r);n!==t&&(t=n,this.setElementByPos(e++,n))}for(;this.i>e;)this.popBack();return this.i}sort(e){const t=[];for(let e=0;e<this.i;++e)t.push(this.getElementByPos(e));t.sort(e);for(let e=0;e<this.i;++e)this.setElementByPos(e,t[e])}shrinkToFit(){if(0===this.i)return;const e=[];this.forEach((function(t){e.push(t)})),this.P=Math.max(Math.ceil(this.i/this.F),1),this.i=this.j=this.R=this.D=this.N=0,this.A=[];for(let e=0;e<this.P;++e)this.A.push(new Array(this.F));for(let t=0;t<e.length;++t)this.pushBack(e[t])}forEach(e){for(let t=0;t<this.i;++t)e(this.getElementByPos(t),t,this)}[Symbol.iterator](){return function*(){for(let e=0;e<this.i;++e)yield this.getElementByPos(e)}.bind(this)()}}var l=a;r.default=l},{"./Base":60,"./Base/RandomIterator":59}],62:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n,i=(n=e("./Base"))&&n.t?n:{default:n},s=e("../ContainerBase"),o=e("../../utils/throwError");class a extends s.ContainerIterator{constructor(e,t,r,n){super(n),this.o=e,this.h=t,this.container=r,0===this.iteratorType?(this.pre=function(){return this.o.L===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.L,this},this.next=function(){return this.o===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.B,this}):(this.pre=function(){return this.o.B===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.B,this},this.next=function(){return this.o===this.h&&(0,o.throwIteratorAccessError)(),this.o=this.o.L,this})}get pointer(){return this.o===this.h&&(0,o.throwIteratorAccessError)(),this.o.l}set pointer(e){this.o===this.h&&(0,o.throwIteratorAccessError)(),this.o.l=e}copy(){return new a(this.o,this.h,this.container,this.iteratorType)}}class l extends i.default{constructor(e=[]){super(),this.h={},this.p=this._=this.h.L=this.h.B=this.h;const t=this;e.forEach((function(e){t.pushBack(e)}))}V(e){const{L:t,B:r}=e;t.B=r,r.L=t,e===this.p&&(this.p=r),e===this._&&(this._=t),this.i-=1}G(e,t){const r=t.B,n={l:e,L:t,B:r};t.B=n,r.L=n,t===this.h&&(this.p=n),r===this.h&&(this._=n),this.i+=1}clear(){this.i=0,this.p=this._=this.h.L=this.h.B=this.h}begin(){return new a(this.p,this.h,this)}end(){return new a(this.h,this.h,this)}rBegin(){return new a(this._,this.h,this,1)}rEnd(){return new a(this.h,this.h,this,1)}front(){return this.p.l}back(){return this._.l}getElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;let t=this.p;for(;e--;)t=t.B;return t.l}eraseElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;let t=this.p;for(;e--;)t=t.B;return this.V(t),this.i}eraseElementByValue(e){let t=this.p;for(;t!==this.h;)t.l===e&&this.V(t),t=t.B;return this.i}eraseElementByIterator(e){const t=e.o;return t===this.h&&(0,o.throwIteratorAccessError)(),e=e.next(),this.V(t),e}pushBack(e){return this.G(e,this._),this.i}popBack(){if(0===this.i)return;const e=this._.l;return this.V(this._),e}pushFront(e){return this.G(e,this.h),this.i}popFront(){if(0===this.i)return;const e=this.p.l;return this.V(this.p),e}setElementByPos(e,t){if(e<0||e>this.i-1)throw new RangeError;let r=this.p;for(;e--;)r=r.B;r.l=t}insert(e,t,r=1){if(e<0||e>this.i)throw new RangeError;if(r<=0)return this.i;if(0===e)for(;r--;)this.pushFront(t);else if(e===this.i)for(;r--;)this.pushBack(t);else{let n=this.p;for(let t=1;t<e;++t)n=n.B;const i=n.B;for(this.i+=r;r--;)n.B={l:t,L:n},n.B.L=n,n=n.B;n.B=i,i.L=n}return this.i}find(e){let t=this.p;for(;t!==this.h;){if(t.l===e)return new a(t,this.h,this);t=t.B}return this.end()}reverse(){if(this.i<=1)return;let e=this.p,t=this._,r=0;for(;r<<1<this.i;){const n=e.l;e.l=t.l,t.l=n,e=e.B,t=t.L,r+=1}}unique(){if(this.i<=1)return this.i;let e=this.p;for(;e!==this.h;){let t=e;for(;t.B!==this.h&&t.l===t.B.l;)t=t.B,this.i-=1;e.B=t.B,e.B.L=e,e=e.B}return this.i}sort(e){if(this.i<=1)return;const t=[];this.forEach((function(e){t.push(e)})),t.sort(e);let r=this.p;t.forEach((function(e){r.l=e,r=r.B}))}merge(e){const t=this;if(0===this.i)e.forEach((function(e){t.pushBack(e)}));else{let r=this.p;e.forEach((function(e){for(;r!==t.h&&r.l<=e;)r=r.B;t.G(e,r.L)}))}return this.i}forEach(e){let t=this.p,r=0;for(;t!==this.h;)e(t.l,r++,this),t=t.B}[Symbol.iterator](){return function*(){if(0===this.i)return;let e=this.p;for(;e!==this.h;)yield e.l,e=e.B}.bind(this)()}}var u=l;r.default=u},{"../../utils/throwError":71,"../ContainerBase":52,"./Base":60}],63:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n,i=(n=e("./Base"))&&n.t?n:{default:n},s=e("./Base/RandomIterator");class o extends s.RandomIterator{constructor(e,t,r){super(e,r),this.container=t}copy(){return new o(this.o,this.container,this.iteratorType)}}class a extends i.default{constructor(e=[],t=!0){if(super(),Array.isArray(e))this.J=t?[...e]:e,this.i=e.length;else{this.J=[];const t=this;e.forEach((function(e){t.pushBack(e)}))}}clear(){this.i=0,this.J.length=0}begin(){return new o(0,this)}end(){return new o(this.i,this)}rBegin(){return new o(this.i-1,this,1)}rEnd(){return new o(-1,this,1)}front(){return this.J[0]}back(){return this.J[this.i-1]}getElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;return this.J[e]}eraseElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;return this.J.splice(e,1),this.i-=1,this.i}eraseElementByValue(e){let t=0;for(let r=0;r<this.i;++r)this.J[r]!==e&&(this.J[t++]=this.J[r]);return this.i=this.J.length=t,this.i}eraseElementByIterator(e){const t=e.o;return e=e.next(),this.eraseElementByPos(t),e}pushBack(e){return this.J.push(e),this.i+=1,this.i}popBack(){if(0!==this.i)return this.i-=1,this.J.pop()}setElementByPos(e,t){if(e<0||e>this.i-1)throw new RangeError;this.J[e]=t}insert(e,t,r=1){if(e<0||e>this.i)throw new RangeError;return this.J.splice(e,0,...new Array(r).fill(t)),this.i+=r,this.i}find(e){for(let t=0;t<this.i;++t)if(this.J[t]===e)return new o(t,this);return this.end()}reverse(){this.J.reverse()}unique(){let e=1;for(let t=1;t<this.i;++t)this.J[t]!==this.J[t-1]&&(this.J[e++]=this.J[t]);return this.i=this.J.length=e,this.i}sort(e){this.J.sort(e)}forEach(e){for(let t=0;t<this.i;++t)e(this.J[t],t,this)}[Symbol.iterator](){return function*(){yield*this.J}.bind(this)()}}var l=a;r.default=l},{"./Base":60,"./Base/RandomIterator":59}],64:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=e("../../ContainerBase"),i=e("../../../utils/throwError");class s extends n.ContainerIterator{constructor(e,t,r){super(r),this.o=e,this.h=t,0===this.iteratorType?(this.pre=function(){return this.o===this.h.U&&(0,i.throwIteratorAccessError)(),this.o=this.o.L(),this},this.next=function(){return this.o===this.h&&(0,i.throwIteratorAccessError)(),this.o=this.o.B(),this}):(this.pre=function(){return this.o===this.h.W&&(0,i.throwIteratorAccessError)(),this.o=this.o.B(),this},this.next=function(){return this.o===this.h&&(0,i.throwIteratorAccessError)(),this.o=this.o.L(),this})}get index(){let e=this.o;const t=this.h.tt;if(e===this.h)return t?t.rt-1:0;let r=0;for(e.U&&(r+=e.U.rt);e!==t;){const t=e.tt;e===t.W&&(r+=1,t.U&&(r+=t.U.rt)),e=t}return r}}var o=s;r.default=o},{"../../../utils/throwError":71,"../../ContainerBase":52}],65:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.TreeNodeEnableIndex=r.TreeNode=void 0;class n{constructor(e,t){this.ee=1,this.u=void 0,this.l=void 0,this.U=void 0,this.W=void 0,this.tt=void 0,this.u=e,this.l=t}L(){let e=this;if(1===e.ee&&e.tt.tt===e)e=e.W;else if(e.U)for(e=e.U;e.W;)e=e.W;else{let t=e.tt;for(;t.U===e;)e=t,t=e.tt;e=t}return e}B(){let e=this;if(e.W){for(e=e.W;e.U;)e=e.U;return e}{let t=e.tt;for(;t.W===e;)e=t,t=e.tt;return e.W!==t?t:e}}te(){const e=this.tt,t=this.W,r=t.U;return e.tt===this?e.tt=t:e.U===this?e.U=t:e.W=t,t.tt=e,t.U=this,this.tt=t,this.W=r,r&&(r.tt=this),t}se(){const e=this.tt,t=this.U,r=t.W;return e.tt===this?e.tt=t:e.U===this?e.U=t:e.W=t,t.tt=e,t.W=this,this.tt=t,this.U=r,r&&(r.tt=this),t}}r.TreeNode=n;r.TreeNodeEnableIndex=class extends n{constructor(){super(...arguments),this.rt=1}te(){const e=super.te();return this.ie(),e.ie(),e}se(){const e=super.se();return this.ie(),e.ie(),e}ie(){this.rt=1,this.U&&(this.rt+=this.U.rt),this.W&&(this.rt+=this.W.rt)}}},{}],66:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=e("./TreeNode"),i=e("../../ContainerBase"),s=e("../../../utils/throwError");class o extends i.Container{constructor(e=function(e,t){return e<t?-1:e>t?1:0},t=!1){super(),this.Y=void 0,this.v=e,t?(this.re=n.TreeNodeEnableIndex,this.M=function(e,t,r){const n=this.ne(e,t,r);if(n){let e=n.tt;for(;e!==this.h;)e.rt+=1,e=e.tt;const t=this.he(n);if(t){const{parentNode:e,grandParent:r,curNode:n}=t;e.ie(),r.ie(),n.ie()}}return this.i},this.V=function(e){let t=this.fe(e);for(;t!==this.h;)t.rt-=1,t=t.tt}):(this.re=n.TreeNode,this.M=function(e,t,r){const n=this.ne(e,t,r);return n&&this.he(n),this.i},this.V=this.fe),this.h=new this.re}X(e,t){let r=this.h;for(;e;){const n=this.v(e.u,t);if(n<0)e=e.W;else{if(!(n>0))return e;r=e,e=e.U}}return r}Z(e,t){let r=this.h;for(;e;){this.v(e.u,t)<=0?e=e.W:(r=e,e=e.U)}return r}$(e,t){let r=this.h;for(;e;){const n=this.v(e.u,t);if(n<0)r=e,e=e.W;else{if(!(n>0))return e;e=e.U}}return r}rr(e,t){let r=this.h;for(;e;){this.v(e.u,t)<0?(r=e,e=e.W):e=e.U}return r}ue(e){for(;;){const t=e.tt;if(t===this.h)return;if(1===e.ee)return void(e.ee=0);if(e===t.U){const r=t.W;if(1===r.ee)r.ee=0,t.ee=1,t===this.Y?this.Y=t.te():t.te();else{if(r.W&&1===r.W.ee)return r.ee=t.ee,t.ee=0,r.W.ee=0,void(t===this.Y?this.Y=t.te():t.te());r.U&&1===r.U.ee?(r.ee=1,r.U.ee=0,r.se()):(r.ee=1,e=t)}}else{const r=t.U;if(1===r.ee)r.ee=0,t.ee=1,t===this.Y?this.Y=t.se():t.se();else{if(r.U&&1===r.U.ee)return r.ee=t.ee,t.ee=0,r.U.ee=0,void(t===this.Y?this.Y=t.se():t.se());r.W&&1===r.W.ee?(r.ee=1,r.W.ee=0,r.te()):(r.ee=1,e=t)}}}}fe(e){if(1===this.i)return this.clear(),this.h;let t=e;for(;t.U||t.W;){if(t.W)for(t=t.W;t.U;)t=t.U;else t=t.U;[e.u,t.u]=[t.u,e.u],[e.l,t.l]=[t.l,e.l],e=t}this.h.U===t?this.h.U=t.tt:this.h.W===t&&(this.h.W=t.tt),this.ue(t);const r=t.tt;return t===r.U?r.U=void 0:r.W=void 0,this.i-=1,this.Y.ee=0,r}oe(e,t){if(void 0===e)return!1;return!!this.oe(e.U,t)||(!!t(e)||this.oe(e.W,t))}he(e){for(;;){const t=e.tt;if(0===t.ee)return;const r=t.tt;if(t===r.U){const n=r.W;if(n&&1===n.ee){if(n.ee=t.ee=0,r===this.Y)return;r.ee=1,e=r;continue}if(e===t.W){if(e.ee=0,e.U&&(e.U.tt=t),e.W&&(e.W.tt=r),t.W=e.U,r.U=e.W,e.U=t,e.W=r,r===this.Y)this.Y=e,this.h.tt=e;else{const t=r.tt;t.U===r?t.U=e:t.W=e}return e.tt=r.tt,t.tt=e,r.tt=e,r.ee=1,{parentNode:t,grandParent:r,curNode:e}}t.ee=0,r===this.Y?this.Y=r.se():r.se(),r.ee=1}else{const n=r.U;if(n&&1===n.ee){if(n.ee=t.ee=0,r===this.Y)return;r.ee=1,e=r;continue}if(e===t.U){if(e.ee=0,e.U&&(e.U.tt=r),e.W&&(e.W.tt=t),r.W=e.U,t.U=e.W,e.U=r,e.W=t,r===this.Y)this.Y=e,this.h.tt=e;else{const t=r.tt;t.U===r?t.U=e:t.W=e}return e.tt=r.tt,t.tt=e,r.tt=e,r.ee=1,{parentNode:t,grandParent:r,curNode:e}}t.ee=0,r===this.Y?this.Y=r.te():r.te(),r.ee=1}return}}ne(e,t,r){if(void 0===this.Y)return this.i+=1,this.Y=new this.re(e,t),this.Y.ee=0,this.Y.tt=this.h,this.h.tt=this.Y,this.h.U=this.Y,void(this.h.W=this.Y);let n;const i=this.h.U,s=this.v(i.u,e);if(0!==s){if(s>0)i.U=new this.re(e,t),i.U.tt=i,n=i.U,this.h.U=n;else{const i=this.h.W,s=this.v(i.u,e);if(0===s)return void(i.l=t);if(s<0)i.W=new this.re(e,t),i.W.tt=i,n=i.W,this.h.W=n;else{if(void 0!==r){const i=r.o;if(i!==this.h){const r=this.v(i.u,e);if(0===r)return void(i.l=t);if(r>0){const r=i.L(),s=this.v(r.u,e);if(0===s)return void(r.l=t);s<0&&(n=new this.re(e,t),void 0===r.W?(r.W=n,n.tt=r):(i.U=n,n.tt=i))}}}if(void 0===n)for(n=this.Y;;){const r=this.v(n.u,e);if(r>0){if(void 0===n.U){n.U=new this.re(e,t),n.U.tt=n,n=n.U;break}n=n.U}else{if(!(r<0))return void(n.l=t);if(void 0===n.W){n.W=new this.re(e,t),n.W.tt=n,n=n.W;break}n=n.W}}}}return this.i+=1,n}i.l=t}I(e,t){for(;e;){const r=this.v(e.u,t);if(r<0)e=e.W;else{if(!(r>0))return e;e=e.U}}return e||this.h}clear(){this.i=0,this.Y=void 0,this.h.tt=void 0,this.h.U=this.h.W=void 0}updateKeyByIterator(e,t){const r=e.o;if(r===this.h&&(0,s.throwIteratorAccessError)(),1===this.i)return r.u=t,!0;if(r===this.h.U)return this.v(r.B().u,t)>0&&(r.u=t,!0);if(r===this.h.W)return this.v(r.L().u,t)<0&&(r.u=t,!0);const n=r.L().u;if(this.v(n,t)>=0)return!1;const i=r.B().u;return!(this.v(i,t)<=0)&&(r.u=t,!0)}eraseElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;let t=0;const r=this;return this.oe(this.Y,(function(n){return e===t?(r.V(n),!0):(t+=1,!1)})),this.i}eraseElementByKey(e){if(0===this.i)return!1;const t=this.I(this.Y,e);return t!==this.h&&(this.V(t),!0)}eraseElementByIterator(e){const t=e.o;t===this.h&&(0,s.throwIteratorAccessError)();const r=void 0===t.W;return 0===e.iteratorType?r&&e.next():r&&void 0!==t.U||e.next(),this.V(t),e}forEach(e){let t=0;for(const r of this)e(r,t++,this)}getElementByPos(e){if(e<0||e>this.i-1)throw new RangeError;let t,r=0;for(const n of this){if(r===e){t=n;break}r+=1}return t}getHeight(){if(0===this.i)return 0;const e=function(t){return t?Math.max(e(t.U),e(t.W))+1:0};return e(this.Y)}}var a=o;r.default=a},{"../../../utils/throwError":71,"../../ContainerBase":52,"./TreeNode":65}],67:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=o(e("./Base")),i=o(e("./Base/TreeIterator")),s=e("../../utils/throwError");function o(e){return e&&e.t?e:{default:e}}class a extends i.default{constructor(e,t,r,n){super(e,t,n),this.container=r}get pointer(){this.o===this.h&&(0,s.throwIteratorAccessError)();const e=this;return new Proxy([],{get:(t,r)=>"0"===r?e.o.u:"1"===r?e.o.l:void 0,set(t,r,n){if("1"!==r)throw new TypeError("props must be 1");return e.o.l=n,!0}})}copy(){return new a(this.o,this.h,this.container,this.iteratorType)}}class l extends n.default{constructor(e=[],t,r){super(t,r);const n=this;e.forEach((function(e){n.setElement(e[0],e[1])}))}*K(e){void 0!==e&&(yield*this.K(e.U),yield[e.u,e.l],yield*this.K(e.W))}begin(){return new a(this.h.U||this.h,this.h,this)}end(){return new a(this.h,this.h,this)}rBegin(){return new a(this.h.W||this.h,this.h,this,1)}rEnd(){return new a(this.h,this.h,this,1)}front(){if(0===this.i)return;const e=this.h.U;return[e.u,e.l]}back(){if(0===this.i)return;const e=this.h.W;return[e.u,e.l]}lowerBound(e){const t=this.X(this.Y,e);return new a(t,this.h,this)}upperBound(e){const t=this.Z(this.Y,e);return new a(t,this.h,this)}reverseLowerBound(e){const t=this.$(this.Y,e);return new a(t,this.h,this)}reverseUpperBound(e){const t=this.rr(this.Y,e);return new a(t,this.h,this)}setElement(e,t,r){return this.M(e,t,r)}find(e){const t=this.I(this.Y,e);return new a(t,this.h,this)}getElementByKey(e){return this.I(this.Y,e).l}union(e){const t=this;return e.forEach((function(e){t.setElement(e[0],e[1])})),this.i}[Symbol.iterator](){return this.K(this.Y)}}var u=l;r.default=u},{"../../utils/throwError":71,"./Base":66,"./Base/TreeIterator":64}],68:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=void 0;var n=o(e("./Base")),i=o(e("./Base/TreeIterator")),s=e("../../utils/throwError");function o(e){return e&&e.t?e:{default:e}}class a extends i.default{constructor(e,t,r,n){super(e,t,n),this.container=r}get pointer(){return this.o===this.h&&(0,s.throwIteratorAccessError)(),this.o.u}copy(){return new a(this.o,this.h,this.container,this.iteratorType)}}class l extends n.default{constructor(e=[],t,r){super(t,r);const n=this;e.forEach((function(e){n.insert(e)}))}*K(e){void 0!==e&&(yield*this.K(e.U),yield e.u,yield*this.K(e.W))}begin(){return new a(this.h.U||this.h,this.h,this)}end(){return new a(this.h,this.h,this)}rBegin(){return new a(this.h.W||this.h,this.h,this,1)}rEnd(){return new a(this.h,this.h,this,1)}front(){return this.h.U?this.h.U.u:void 0}back(){return this.h.W?this.h.W.u:void 0}insert(e,t){return this.M(e,void 0,t)}find(e){const t=this.I(this.Y,e);return new a(t,this.h,this)}lowerBound(e){const t=this.X(this.Y,e);return new a(t,this.h,this)}upperBound(e){const t=this.Z(this.Y,e);return new a(t,this.h,this)}reverseLowerBound(e){const t=this.$(this.Y,e);return new a(t,this.h,this)}reverseUpperBound(e){const t=this.rr(this.Y,e);return new a(t,this.h,this)}union(e){const t=this;return e.forEach((function(e){t.insert(e)})),this.i}[Symbol.iterator](){return this.K(this.Y)}}var u=l;r.default=u},{"../../utils/throwError":71,"./Base":66,"./Base/TreeIterator":64}],69:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),Object.defineProperty(r,"Deque",{enumerable:!0,get:function(){return l.default}}),Object.defineProperty(r,"HashMap",{enumerable:!0,get:function(){return f.default}}),Object.defineProperty(r,"HashSet",{enumerable:!0,get:function(){return h.default}}),Object.defineProperty(r,"LinkList",{enumerable:!0,get:function(){return a.default}}),Object.defineProperty(r,"OrderedMap",{enumerable:!0,get:function(){return c.default}}),Object.defineProperty(r,"OrderedSet",{enumerable:!0,get:function(){return u.default}}),Object.defineProperty(r,"PriorityQueue",{enumerable:!0,get:function(){return s.default}}),Object.defineProperty(r,"Queue",{enumerable:!0,get:function(){return i.default}}),Object.defineProperty(r,"Stack",{enumerable:!0,get:function(){return n.default}}),Object.defineProperty(r,"Vector",{enumerable:!0,get:function(){return o.default}});var n=d(e("./container/OtherContainer/Stack")),i=d(e("./container/OtherContainer/Queue")),s=d(e("./container/OtherContainer/PriorityQueue")),o=d(e("./container/SequentialContainer/Vector")),a=d(e("./container/SequentialContainer/LinkList")),l=d(e("./container/SequentialContainer/Deque")),u=d(e("./container/TreeContainer/OrderedSet")),c=d(e("./container/TreeContainer/OrderedMap")),h=d(e("./container/HashContainer/HashSet")),f=d(e("./container/HashContainer/HashMap"));function d(e){return e&&e.t?e:{default:e}}},{"./container/HashContainer/HashMap":54,"./container/HashContainer/HashSet":55,"./container/OtherContainer/PriorityQueue":56,"./container/OtherContainer/Queue":57,"./container/OtherContainer/Stack":58,"./container/SequentialContainer/Deque":61,"./container/SequentialContainer/LinkList":62,"./container/SequentialContainer/Vector":63,"./container/TreeContainer/OrderedMap":67,"./container/TreeContainer/OrderedSet":68}],70:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.default=function(e){const t=typeof e;return"object"===t&&null!==e||"function"===t}},{}],71:[function(e,t,r){"use strict";Object.defineProperty(r,"t",{value:!0}),r.throwIteratorAccessError=function(){throw new RangeError("Iterator access denied!")}},{}],72:[function(e,t,r){(function(e){(function(){const r="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,n="function"==typeof AbortController?AbortController:class{constructor(){this.signal=new o}abort(e=new Error("This operation was aborted")){this.signal.reason=this.signal.reason||e,this.signal.aborted=!0,this.signal.dispatchEvent({type:"abort",target:this.signal})}},i="function"==typeof AbortSignal,s="function"==typeof n.AbortSignal,o=i?AbortSignal:s?n.AbortController:class{constructor(){this.reason=void 0,this.aborted=!1,this._listeners=[]}dispatchEvent(e){"abort"===e.type&&(this.aborted=!0,this.onabort(e),this._listeners.forEach((t=>t(e)),this))}onabort(){}addEventListener(e,t){"abort"===e&&this._listeners.push(t)}removeEventListener(e,t){"abort"===e&&(this._listeners=this._listeners.filter((e=>e!==t)))}},a=new Set,l=(e,t)=>{const r=`LRU_CACHE_OPTION_${e}`;h(r)&&f(r,`${e} option`,`options.${t}`,m)},u=(e,t)=>{const r=`LRU_CACHE_METHOD_${e}`;if(h(r)){const{prototype:n}=m,{get:i}=Object.getOwnPropertyDescriptor(n,e);f(r,`${e} method`,`cache.${t}()`,i)}},c=(...t)=>{"object"==typeof e&&e&&"function"==typeof e.emitWarning?e.emitWarning(...t):console.error(...t)},h=e=>!a.has(e),f=(e,t,r,n)=>{a.add(e);c(`The ${t} is deprecated. Please use ${r} instead.`,"DeprecationWarning",e,n)},d=e=>e&&e===Math.floor(e)&&e>0&&isFinite(e),p=e=>d(e)?e<=Math.pow(2,8)?Uint8Array:e<=Math.pow(2,16)?Uint16Array:e<=Math.pow(2,32)?Uint32Array:e<=Number.MAX_SAFE_INTEGER?b:null:null;class b extends Array{constructor(e){super(e),this.fill(0)}}class g{constructor(e){if(0===e)return[];const t=p(e);this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}}class m{constructor(e={}){const{max:t=0,ttl:r,ttlResolution:n=1,ttlAutopurge:i,updateAgeOnGet:s,updateAgeOnHas:o,allowStale:u,dispose:f,disposeAfter:b,noDisposeOnSet:y,noUpdateTTL:_,maxSize:w=0,maxEntrySize:v=0,sizeCalculation:S,fetchMethod:E,fetchContext:A,noDeleteOnFetchRejection:k,noDeleteOnStaleGet:T,allowStaleOnFetchRejection:I,allowStaleOnFetchAbort:R,ignoreFetchAbort:O}=e,{length:C,maxAge:P,stale:x}=e instanceof m?{}:e;if(0!==t&&!d(t))throw new TypeError("max option must be a nonnegative integer");const M=t?p(t):Array;if(!M)throw new Error("invalid max value: "+t);if(this.max=t,this.maxSize=w,this.maxEntrySize=v||this.maxSize,this.sizeCalculation=S||C,this.sizeCalculation){if(!this.maxSize&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if("function"!=typeof this.sizeCalculation)throw new TypeError("sizeCalculation set to non-function")}if(this.fetchMethod=E||null,this.fetchMethod&&"function"!=typeof this.fetchMethod)throw new TypeError("fetchMethod must be a function if specified");if(this.fetchContext=A,!this.fetchMethod&&void 0!==A)throw new TypeError("cannot set fetchContext without fetchMethod");if(this.keyMap=new Map,this.keyList=new Array(t).fill(null),this.valList=new Array(t).fill(null),this.next=new M(t),this.prev=new M(t),this.head=0,this.tail=0,this.free=new g(t),this.initialFill=1,this.size=0,"function"==typeof f&&(this.dispose=f),"function"==typeof b?(this.disposeAfter=b,this.disposed=[]):(this.disposeAfter=null,this.disposed=null),this.noDisposeOnSet=!!y,this.noUpdateTTL=!!_,this.noDeleteOnFetchRejection=!!k,this.allowStaleOnFetchRejection=!!I,this.allowStaleOnFetchAbort=!!R,this.ignoreFetchAbort=!!O,0!==this.maxEntrySize){if(0!==this.maxSize&&!d(this.maxSize))throw new TypeError("maxSize must be a positive integer if specified");if(!d(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.initializeSizeTracking()}if(this.allowStale=!!u||!!x,this.noDeleteOnStaleGet=!!T,this.updateAgeOnGet=!!s,this.updateAgeOnHas=!!o,this.ttlResolution=d(n)||0===n?n:1,this.ttlAutopurge=!!i,this.ttl=r||P||0,this.ttl){if(!d(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.initializeTTLTracking()}if(0===this.max&&0===this.ttl&&0===this.maxSize)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.max&&!this.maxSize){const e="LRU_CACHE_UNBOUNDED";if(h(e)){a.add(e);c("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",e,m)}}x&&l("stale","allowStale"),P&&l("maxAge","ttl"),C&&l("length","sizeCalculation")}getRemainingTTL(e){return this.has(e,{updateAgeOnHas:!1})?1/0:0}initializeTTLTracking(){this.ttls=new b(this.max),this.starts=new b(this.max),this.setItemTTL=(e,t,n=r.now())=>{if(this.starts[e]=0!==t?n:0,this.ttls[e]=t,0!==t&&this.ttlAutopurge){const r=setTimeout((()=>{this.isStale(e)&&this.delete(this.keyList[e])}),t+1);r.unref&&r.unref()}},this.updateItemAge=e=>{this.starts[e]=0!==this.ttls[e]?r.now():0},this.statusTTL=(r,n)=>{r&&(r.ttl=this.ttls[n],r.start=this.starts[n],r.now=e||t(),r.remainingTTL=r.now+r.ttl-r.start)};let e=0;const t=()=>{const t=r.now();if(this.ttlResolution>0){e=t;const r=setTimeout((()=>e=0),this.ttlResolution);r.unref&&r.unref()}return t};this.getRemainingTTL=r=>{const n=this.keyMap.get(r);return void 0===n?0:0===this.ttls[n]||0===this.starts[n]?1/0:this.starts[n]+this.ttls[n]-(e||t())},this.isStale=r=>0!==this.ttls[r]&&0!==this.starts[r]&&(e||t())-this.starts[r]>this.ttls[r]}updateItemAge(e){}statusTTL(e,t){}setItemTTL(e,t,r){}isStale(e){return!1}initializeSizeTracking(){this.calculatedSize=0,this.sizes=new b(this.max),this.removeItemSize=e=>{this.calculatedSize-=this.sizes[e],this.sizes[e]=0},this.requireSize=(e,t,r,n)=>{if(this.isBackgroundFetch(t))return 0;if(!d(r)){if(!n)throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");if("function"!=typeof n)throw new TypeError("sizeCalculation must be a function");if(r=n(t,e),!d(r))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}return r},this.addItemSize=(e,t,r)=>{if(this.sizes[e]=t,this.maxSize){const t=this.maxSize-this.sizes[e];for(;this.calculatedSize>t;)this.evict(!0)}this.calculatedSize+=this.sizes[e],r&&(r.entrySize=t,r.totalCalculatedSize=this.calculatedSize)}}removeItemSize(e){}addItemSize(e,t){}requireSize(e,t,r,n){if(r||n)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache")}*indexes({allowStale:e=this.allowStale}={}){if(this.size)for(let t=this.tail;this.isValidIndex(t)&&(!e&&this.isStale(t)||(yield t),t!==this.head);)t=this.prev[t]}*rindexes({allowStale:e=this.allowStale}={}){if(this.size)for(let t=this.head;this.isValidIndex(t)&&(!e&&this.isStale(t)||(yield t),t!==this.tail);)t=this.next[t]}isValidIndex(e){return void 0!==e&&this.keyMap.get(this.keyList[e])===e}*entries(){for(const e of this.indexes())void 0===this.valList[e]||void 0===this.keyList[e]||this.isBackgroundFetch(this.valList[e])||(yield[this.keyList[e],this.valList[e]])}*rentries(){for(const e of this.rindexes())void 0===this.valList[e]||void 0===this.keyList[e]||this.isBackgroundFetch(this.valList[e])||(yield[this.keyList[e],this.valList[e]])}*keys(){for(const e of this.indexes())void 0===this.keyList[e]||this.isBackgroundFetch(this.valList[e])||(yield this.keyList[e])}*rkeys(){for(const e of this.rindexes())void 0===this.keyList[e]||this.isBackgroundFetch(this.valList[e])||(yield this.keyList[e])}*values(){for(const e of this.indexes())void 0===this.valList[e]||this.isBackgroundFetch(this.valList[e])||(yield this.valList[e])}*rvalues(){for(const e of this.rindexes())void 0===this.valList[e]||this.isBackgroundFetch(this.valList[e])||(yield this.valList[e])}[Symbol.iterator](){return this.entries()}find(e,t){for(const r of this.indexes()){const n=this.valList[r],i=this.isBackgroundFetch(n)?n.__staleWhileFetching:n;if(void 0!==i&&e(i,this.keyList[r],this))return this.get(this.keyList[r],t)}}forEach(e,t=this){for(const r of this.indexes()){const n=this.valList[r],i=this.isBackgroundFetch(n)?n.__staleWhileFetching:n;void 0!==i&&e.call(t,i,this.keyList[r],this)}}rforEach(e,t=this){for(const r of this.rindexes()){const n=this.valList[r],i=this.isBackgroundFetch(n)?n.__staleWhileFetching:n;void 0!==i&&e.call(t,i,this.keyList[r],this)}}get prune(){return u("prune","purgeStale"),this.purgeStale}purgeStale(){let e=!1;for(const t of this.rindexes({allowStale:!0}))this.isStale(t)&&(this.delete(this.keyList[t]),e=!0);return e}dump(){const e=[];for(const t of this.indexes({allowStale:!0})){const n=this.keyList[t],i=this.valList[t],s=this.isBackgroundFetch(i)?i.__staleWhileFetching:i;if(void 0===s)continue;const o={value:s};if(this.ttls){o.ttl=this.ttls[t];const e=r.now()-this.starts[t];o.start=Math.floor(Date.now()-e)}this.sizes&&(o.size=this.sizes[t]),e.unshift([n,o])}return e}load(e){this.clear();for(const[t,n]of e){if(n.start){const e=Date.now()-n.start;n.start=r.now()-e}this.set(t,n.value,n)}}dispose(e,t,r){}set(e,t,{ttl:r=this.ttl,start:n,noDisposeOnSet:i=this.noDisposeOnSet,size:s=0,sizeCalculation:o=this.sizeCalculation,noUpdateTTL:a=this.noUpdateTTL,status:l}={}){if(s=this.requireSize(e,t,s,o),this.maxEntrySize&&s>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.delete(e),this;let u=0===this.size?void 0:this.keyMap.get(e);if(void 0===u)u=this.newIndex(),this.keyList[u]=e,this.valList[u]=t,this.keyMap.set(e,u),this.next[this.tail]=u,this.prev[u]=this.tail,this.tail=u,this.size++,this.addItemSize(u,s,l),l&&(l.set="add"),a=!1;else{this.moveToTail(u);const r=this.valList[u];if(t!==r){if(this.isBackgroundFetch(r)?r.__abortController.abort(new Error("replaced")):i||(this.dispose(r,e,"set"),this.disposeAfter&&this.disposed.push([r,e,"set"])),this.removeItemSize(u),this.valList[u]=t,this.addItemSize(u,s,l),l){l.set="replace";const e=r&&this.isBackgroundFetch(r)?r.__staleWhileFetching:r;void 0!==e&&(l.oldValue=e)}}else l&&(l.set="update")}if(0===r||0!==this.ttl||this.ttls||this.initializeTTLTracking(),a||this.setItemTTL(u,r,n),this.statusTTL(l,u),this.disposeAfter)for(;this.disposed.length;)this.disposeAfter(...this.disposed.shift());return this}newIndex(){return 0===this.size?this.tail:this.size===this.max&&0!==this.max?this.evict(!1):0!==this.free.length?this.free.pop():this.initialFill++}pop(){if(this.size){const e=this.valList[this.head];return this.evict(!0),e}}evict(e){const t=this.head,r=this.keyList[t],n=this.valList[t];return this.isBackgroundFetch(n)?n.__abortController.abort(new Error("evicted")):(this.dispose(n,r,"evict"),this.disposeAfter&&this.disposed.push([n,r,"evict"])),this.removeItemSize(t),e&&(this.keyList[t]=null,this.valList[t]=null,this.free.push(t)),this.head=this.next[t],this.keyMap.delete(r),this.size--,t}has(e,{updateAgeOnHas:t=this.updateAgeOnHas,status:r}={}){const n=this.keyMap.get(e);if(void 0!==n){if(!this.isStale(n))return t&&this.updateItemAge(n),r&&(r.has="hit"),this.statusTTL(r,n),!0;r&&(r.has="stale",this.statusTTL(r,n))}else r&&(r.has="miss");return!1}peek(e,{allowStale:t=this.allowStale}={}){const r=this.keyMap.get(e);if(void 0!==r&&(t||!this.isStale(r))){const e=this.valList[r];return this.isBackgroundFetch(e)?e.__staleWhileFetching:e}}backgroundFetch(e,t,r,i){const s=void 0===t?void 0:this.valList[t];if(this.isBackgroundFetch(s))return s;const o=new n;r.signal&&r.signal.addEventListener("abort",(()=>o.abort(r.signal.reason)));const a={signal:o.signal,options:r,context:i},l=(n,i=!1)=>{const{aborted:s}=o.signal,l=r.ignoreFetchAbort&&void 0!==n;return r.status&&(s&&!i?(r.status.fetchAborted=!0,r.status.fetchError=o.signal.reason,l&&(r.status.fetchAbortIgnored=!0)):r.status.fetchResolved=!0),!s||l||i?(this.valList[t]===c&&(void 0===n?c.__staleWhileFetching?this.valList[t]=c.__staleWhileFetching:this.delete(e):(r.status&&(r.status.fetchUpdated=!0),this.set(e,n,a.options))),n):u(o.signal.reason)},u=n=>{const{aborted:i}=o.signal,s=i&&r.allowStaleOnFetchAbort,a=s||r.allowStaleOnFetchRejection,l=a||r.noDeleteOnFetchRejection;if(this.valList[t]===c){!l||void 0===c.__staleWhileFetching?this.delete(e):s||(this.valList[t]=c.__staleWhileFetching)}if(a)return r.status&&void 0!==c.__staleWhileFetching&&(r.status.returnedStale=!0),c.__staleWhileFetching;if(c.__returned===c)throw n};r.status&&(r.status.fetchDispatched=!0);const c=new Promise(((t,n)=>{this.fetchMethod(e,s,a).then((e=>t(e)),n),o.signal.addEventListener("abort",(()=>{r.ignoreFetchAbort&&!r.allowStaleOnFetchAbort||(t(),r.allowStaleOnFetchAbort&&(t=e=>l(e,!0)))}))})).then(l,(e=>(r.status&&(r.status.fetchRejected=!0,r.status.fetchError=e),u(e))));return c.__abortController=o,c.__staleWhileFetching=s,c.__returned=null,void 0===t?(this.set(e,c,{...a.options,status:void 0}),t=this.keyMap.get(e)):this.valList[t]=c,c}isBackgroundFetch(e){return e&&"object"==typeof e&&"function"==typeof e.then&&Object.prototype.hasOwnProperty.call(e,"__staleWhileFetching")&&Object.prototype.hasOwnProperty.call(e,"__returned")&&(e.__returned===e||null===e.__returned)}async fetch(e,{allowStale:t=this.allowStale,updateAgeOnGet:r=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:i=this.ttl,noDisposeOnSet:s=this.noDisposeOnSet,size:o=0,sizeCalculation:a=this.sizeCalculation,noUpdateTTL:l=this.noUpdateTTL,noDeleteOnFetchRejection:u=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:c=this.allowStaleOnFetchRejection,ignoreFetchAbort:h=this.ignoreFetchAbort,allowStaleOnFetchAbort:f=this.allowStaleOnFetchAbort,fetchContext:d=this.fetchContext,forceRefresh:p=!1,status:b,signal:g}={}){if(!this.fetchMethod)return b&&(b.fetch="get"),this.get(e,{allowStale:t,updateAgeOnGet:r,noDeleteOnStaleGet:n,status:b});const m={allowStale:t,updateAgeOnGet:r,noDeleteOnStaleGet:n,ttl:i,noDisposeOnSet:s,size:o,sizeCalculation:a,noUpdateTTL:l,noDeleteOnFetchRejection:u,allowStaleOnFetchRejection:c,allowStaleOnFetchAbort:f,ignoreFetchAbort:h,status:b,signal:g};let y=this.keyMap.get(e);if(void 0===y){b&&(b.fetch="miss");const t=this.backgroundFetch(e,y,m,d);return t.__returned=t}{const n=this.valList[y];if(this.isBackgroundFetch(n)){const e=t&&void 0!==n.__staleWhileFetching;return b&&(b.fetch="inflight",e&&(b.returnedStale=!0)),e?n.__staleWhileFetching:n.__returned=n}const i=this.isStale(y);if(!p&&!i)return b&&(b.fetch="hit"),this.moveToTail(y),r&&this.updateItemAge(y),this.statusTTL(b,y),n;const s=this.backgroundFetch(e,y,m,d),o=void 0!==s.__staleWhileFetching,a=o&&t;return b&&(b.fetch=o&&i?"stale":"refresh",a&&i&&(b.returnedStale=!0)),a?s.__staleWhileFetching:s.__returned=s}}get(e,{allowStale:t=this.allowStale,updateAgeOnGet:r=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:i}={}){const s=this.keyMap.get(e);if(void 0!==s){const o=this.valList[s],a=this.isBackgroundFetch(o);return this.statusTTL(i,s),this.isStale(s)?(i&&(i.get="stale"),a?(i&&(i.returnedStale=t&&void 0!==o.__staleWhileFetching),t?o.__staleWhileFetching:void 0):(n||this.delete(e),i&&(i.returnedStale=t),t?o:void 0)):(i&&(i.get="hit"),a?o.__staleWhileFetching:(this.moveToTail(s),r&&this.updateItemAge(s),o))}i&&(i.get="miss")}connect(e,t){this.prev[t]=e,this.next[e]=t}moveToTail(e){e!==this.tail&&(e===this.head?this.head=this.next[e]:this.connect(this.prev[e],this.next[e]),this.connect(this.tail,e),this.tail=e)}get del(){return u("del","delete"),this.delete}delete(e){let t=!1;if(0!==this.size){const r=this.keyMap.get(e);if(void 0!==r)if(t=!0,1===this.size)this.clear();else{this.removeItemSize(r);const t=this.valList[r];this.isBackgroundFetch(t)?t.__abortController.abort(new Error("deleted")):(this.dispose(t,e,"delete"),this.disposeAfter&&this.disposed.push([t,e,"delete"])),this.keyMap.delete(e),this.keyList[r]=null,this.valList[r]=null,r===this.tail?this.tail=this.prev[r]:r===this.head?this.head=this.next[r]:(this.next[this.prev[r]]=this.next[r],this.prev[this.next[r]]=this.prev[r]),this.size--,this.free.push(r)}}if(this.disposed)for(;this.disposed.length;)this.disposeAfter(...this.disposed.shift());return t}clear(){for(const e of this.rindexes({allowStale:!0})){const t=this.valList[e];if(this.isBackgroundFetch(t))t.__abortController.abort(new Error("deleted"));else{const r=this.keyList[e];this.dispose(t,r,"delete"),this.disposeAfter&&this.disposed.push([t,r,"delete"])}}if(this.keyMap.clear(),this.valList.fill(null),this.keyList.fill(null),this.ttls&&(this.ttls.fill(0),this.starts.fill(0)),this.sizes&&this.sizes.fill(0),this.head=0,this.tail=0,this.initialFill=1,this.free.length=0,this.calculatedSize=0,this.size=0,this.disposed)for(;this.disposed.length;)this.disposeAfter(...this.disposed.shift())}get reset(){return u("reset","clear"),this.clear}get length(){return((e,t)=>{const r=`LRU_CACHE_PROPERTY_${e}`;if(h(r)){const{prototype:n}=m,{get:i}=Object.getOwnPropertyDescriptor(n,e);f(r,`${e} property`,`cache.${t}`,i)}})("length","size"),this.size}static get AbortController(){return n}static get AbortSignal(){return o}}t.exports=m}).call(this)}).call(this,e("_process"))},{_process:102}],73:[function(e,t,r){const n=t.exports,{Buffer:i}=e("buffer");n.types={0:"reserved",1:"connect",2:"connack",3:"publish",4:"puback",5:"pubrec",6:"pubrel",7:"pubcomp",8:"subscribe",9:"suback",10:"unsubscribe",11:"unsuback",12:"pingreq",13:"pingresp",14:"disconnect",15:"auth"},n.requiredHeaderFlags={1:0,2:0,4:0,5:0,6:2,7:0,8:2,9:0,10:2,11:0,12:0,13:0,14:0,15:0},n.requiredHeaderFlagsErrors={};for(const e in n.requiredHeaderFlags){const t=n.requiredHeaderFlags[e];n.requiredHeaderFlagsErrors[e]="Invalid header flag bits, must be 0x"+t.toString(16)+" for "+n.types[e]+" packet"}n.codes={};for(const e in n.types){const t=n.types[e];n.codes[t]=e}n.CMD_SHIFT=4,n.CMD_MASK=240,n.DUP_MASK=8,n.QOS_MASK=3,n.QOS_SHIFT=1,n.RETAIN_MASK=1,n.VARBYTEINT_MASK=127,n.VARBYTEINT_FIN_MASK=128,n.VARBYTEINT_MAX=268435455,n.SESSIONPRESENT_MASK=1,n.SESSIONPRESENT_HEADER=i.from([n.SESSIONPRESENT_MASK]),n.CONNACK_HEADER=i.from([n.codes.connack<<n.CMD_SHIFT]),n.USERNAME_MASK=128,n.PASSWORD_MASK=64,n.WILL_RETAIN_MASK=32,n.WILL_QOS_MASK=24,n.WILL_QOS_SHIFT=3,n.WILL_FLAG_MASK=4,n.CLEAN_SESSION_MASK=2,n.CONNECT_HEADER=i.from([n.codes.connect<<n.CMD_SHIFT]),n.properties={sessionExpiryInterval:17,willDelayInterval:24,receiveMaximum:33,maximumPacketSize:39,topicAliasMaximum:34,requestResponseInformation:25,requestProblemInformation:23,userProperties:38,authenticationMethod:21,authenticationData:22,payloadFormatIndicator:1,messageExpiryInterval:2,contentType:3,responseTopic:8,correlationData:9,maximumQoS:36,retainAvailable:37,assignedClientIdentifier:18,reasonString:31,wildcardSubscriptionAvailable:40,subscriptionIdentifiersAvailable:41,sharedSubscriptionAvailable:42,serverKeepAlive:19,responseInformation:26,serverReference:28,topicAlias:35,subscriptionIdentifier:11},n.propertiesCodes={};for(const e in n.properties){const t=n.properties[e];n.propertiesCodes[t]=e}function s(e){return[0,1,2].map((t=>[0,1].map((r=>[0,1].map((s=>{const o=i.alloc(1);return o.writeUInt8(n.codes[e]<<n.CMD_SHIFT|(r?n.DUP_MASK:0)|t<<n.QOS_SHIFT|s,0,!0),o}))))))}n.propertiesTypes={sessionExpiryInterval:"int32",willDelayInterval:"int32",receiveMaximum:"int16",maximumPacketSize:"int32",topicAliasMaximum:"int16",requestResponseInformation:"byte",requestProblemInformation:"byte",userProperties:"pair",authenticationMethod:"string",authenticationData:"binary",payloadFormatIndicator:"byte",messageExpiryInterval:"int32",contentType:"string",responseTopic:"string",correlationData:"binary",maximumQoS:"int8",retainAvailable:"byte",assignedClientIdentifier:"string",reasonString:"string",wildcardSubscriptionAvailable:"byte",subscriptionIdentifiersAvailable:"byte",sharedSubscriptionAvailable:"byte",serverKeepAlive:"int16",responseInformation:"string",serverReference:"string",topicAlias:"int16",subscriptionIdentifier:"var"},n.PUBLISH_HEADER=s("publish"),n.SUBSCRIBE_HEADER=s("subscribe"),n.SUBSCRIBE_OPTIONS_QOS_MASK=3,n.SUBSCRIBE_OPTIONS_NL_MASK=1,n.SUBSCRIBE_OPTIONS_NL_SHIFT=2,n.SUBSCRIBE_OPTIONS_RAP_MASK=1,n.SUBSCRIBE_OPTIONS_RAP_SHIFT=3,n.SUBSCRIBE_OPTIONS_RH_MASK=3,n.SUBSCRIBE_OPTIONS_RH_SHIFT=4,n.SUBSCRIBE_OPTIONS_RH=[0,16,32],n.SUBSCRIBE_OPTIONS_NL=4,n.SUBSCRIBE_OPTIONS_RAP=8,n.SUBSCRIBE_OPTIONS_QOS=[0,1,2],n.UNSUBSCRIBE_HEADER=s("unsubscribe"),n.ACKS={unsuback:s("unsuback"),puback:s("puback"),pubcomp:s("pubcomp"),pubrel:s("pubrel"),pubrec:s("pubrec")},n.SUBACK_HEADER=i.from([n.codes.suback<<n.CMD_SHIFT]),n.VERSION3=i.from([3]),n.VERSION4=i.from([4]),n.VERSION5=i.from([5]),n.VERSION131=i.from([131]),n.VERSION132=i.from([132]),n.QOS=[0,1,2].map((e=>i.from([e]))),n.EMPTY={pingreq:i.from([n.codes.pingreq<<4,0]),pingresp:i.from([n.codes.pingresp<<4,0]),disconnect:i.from([n.codes.disconnect<<4,0])},n.MQTT5_PUBACK_PUBREC_CODES={0:"Success",16:"No matching subscribers",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",144:"Topic Name invalid",145:"Packet identifier in use",151:"Quota exceeded",153:"Payload format invalid"},n.MQTT5_PUBREL_PUBCOMP_CODES={0:"Success",146:"Packet Identifier not found"},n.MQTT5_SUBACK_CODES={0:"Granted QoS 0",1:"Granted QoS 1",2:"Granted QoS 2",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",143:"Topic Filter invalid",145:"Packet Identifier in use",151:"Quota exceeded",158:"Shared Subscriptions not supported",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"},n.MQTT5_UNSUBACK_CODES={0:"Success",17:"No subscription existed",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",143:"Topic Filter invalid",145:"Packet Identifier in use"},n.MQTT5_DISCONNECT_CODES={0:"Normal disconnection",4:"Disconnect with Will Message",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",135:"Not authorized",137:"Server busy",139:"Server shutting down",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"},n.MQTT5_AUTH_CODES={0:"Success",24:"Continue authentication",25:"Re-authenticate"}},{buffer:29}],74:[function(e,t,r){const n=e("./writeToStream"),i=e("events"),{Buffer:s}=e("buffer");class o extends i{constructor(){super(),this._array=new Array(20),this._i=0}write(e){return this._array[this._i++]=e,!0}concat(){let e=0;const t=new Array(this._array.length),r=this._array;let n,i=0;for(n=0;n<r.length&&void 0!==r[n];n++)"string"!=typeof r[n]?t[n]=r[n].length:t[n]=s.byteLength(r[n]),e+=t[n];const o=s.allocUnsafe(e);for(n=0;n<r.length&&void 0!==r[n];n++)"string"!=typeof r[n]?(r[n].copy(o,i),i+=t[n]):(o.write(r[n],i),i+=t[n]);return o}destroy(e){e&&this.emit("error",e)}}t.exports=function(e,t){const r=new o;return n(e,r,t),r.concat()}},{"./writeToStream":96,buffer:29,events:49}],75:[function(e,t,r){r.parser=e("./parser").parser,r.generate=e("./generate"),r.writeToStream=e("./writeToStream")},{"./generate":74,"./parser":95,"./writeToStream":96}],76:[function(e,t,r){"use strict";const{Buffer:n}=e("buffer"),i=Symbol.for("BufferList");function s(e){if(!(this instanceof s))return new s(e);s._init.call(this,e)}s._init=function(e){Object.defineProperty(this,i,{value:!0}),this._bufs=[],this.length=0,e&&this.append(e)},s.prototype._new=function(e){return new s(e)},s.prototype._offset=function(e){if(0===e)return[0,0];let t=0;for(let r=0;r<this._bufs.length;r++){const n=t+this._bufs[r].length;if(e<n||r===this._bufs.length-1)return[r,e-t];t=n}},s.prototype._reverseOffset=function(e){const t=e[0];let r=e[1];for(let e=0;e<t;e++)r+=this._bufs[e].length;return r},s.prototype.get=function(e){if(e>this.length||e<0)return;const t=this._offset(e);return this._bufs[t[0]][t[1]]},s.prototype.slice=function(e,t){return"number"==typeof e&&e<0&&(e+=this.length),"number"==typeof t&&t<0&&(t+=this.length),this.copy(null,0,e,t)},s.prototype.copy=function(e,t,r,i){if(("number"!=typeof r||r<0)&&(r=0),("number"!=typeof i||i>this.length)&&(i=this.length),r>=this.length)return e||n.alloc(0);if(i<=0)return e||n.alloc(0);const s=!!e,o=this._offset(r),a=i-r;let l=a,u=s&&t||0,c=o[1];if(0===r&&i===this.length){if(!s)return 1===this._bufs.length?this._bufs[0]:n.concat(this._bufs,this.length);for(let t=0;t<this._bufs.length;t++)this._bufs[t].copy(e,u),u+=this._bufs[t].length;return e}if(l<=this._bufs[o[0]].length-c)return s?this._bufs[o[0]].copy(e,t,c,c+l):this._bufs[o[0]].slice(c,c+l);s||(e=n.allocUnsafe(a));for(let t=o[0];t<this._bufs.length;t++){const r=this._bufs[t].length-c;if(!(l>r)){this._bufs[t].copy(e,u,c,c+l),u+=r;break}this._bufs[t].copy(e,u,c),u+=r,l-=r,c&&(c=0)}return e.length>u?e.slice(0,u):e},s.prototype.shallowSlice=function(e,t){if(e=e||0,t="number"!=typeof t?this.length:t,e<0&&(e+=this.length),t<0&&(t+=this.length),e===t)return this._new();const r=this._offset(e),n=this._offset(t),i=this._bufs.slice(r[0],n[0]+1);return 0===n[1]?i.pop():i[i.length-1]=i[i.length-1].slice(0,n[1]),0!==r[1]&&(i[0]=i[0].slice(r[1])),this._new(i)},s.prototype.toString=function(e,t,r){return this.slice(t,r).toString(e)},s.prototype.consume=function(e){if(e=Math.trunc(e),Number.isNaN(e)||e<=0)return this;for(;this._bufs.length;){if(!(e>=this._bufs[0].length)){this._bufs[0]=this._bufs[0].slice(e),this.length-=e;break}e-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift()}return this},s.prototype.duplicate=function(){const e=this._new();for(let t=0;t<this._bufs.length;t++)e.append(this._bufs[t]);return e},s.prototype.append=function(e){if(null==e)return this;if(e.buffer)this._appendBuffer(n.from(e.buffer,e.byteOffset,e.byteLength));else if(Array.isArray(e))for(let t=0;t<e.length;t++)this.append(e[t]);else if(this._isBufferList(e))for(let t=0;t<e._bufs.length;t++)this.append(e._bufs[t]);else"number"==typeof e&&(e=e.toString()),this._appendBuffer(n.from(e));return this},s.prototype._appendBuffer=function(e){this._bufs.push(e),this.length+=e.length},s.prototype.indexOf=function(e,t,r){if(void 0===r&&"string"==typeof t&&(r=t,t=void 0),"function"==typeof e||Array.isArray(e))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if("number"==typeof e?e=n.from([e]):"string"==typeof e?e=n.from(e,r):this._isBufferList(e)?e=e.slice():Array.isArray(e.buffer)?e=n.from(e.buffer,e.byteOffset,e.byteLength):n.isBuffer(e)||(e=n.from(e)),t=Number(t||0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const i=this._offset(t);let s=i[0],o=i[1];for(;s<this._bufs.length;s++){const t=this._bufs[s];for(;o<t.length;){if(t.length-o>=e.length){const r=t.indexOf(e,o);if(-1!==r)return this._reverseOffset([s,r]);o=t.length-e.length+1}else{const t=this._reverseOffset([s,o]);if(this._match(t,e))return t;o++}}o=0}return-1},s.prototype._match=function(e,t){if(this.length-e<t.length)return!1;for(let r=0;r<t.length;r++)if(this.get(e+r)!==t[r])return!1;return!0},function(){const e={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const t in e)!function(t){s.prototype[t]=null===e[t]?function(e,r){return this.slice(e,e+r)[t](0,r)}:function(r=0){return this.slice(r,r+e[t])[t](0)}}(t)}(),s.prototype._isBufferList=function(e){return e instanceof s||s.isBufferList(e)},s.isBufferList=function(e){return null!=e&&e[i]},t.exports=s},{buffer:29}],77:[function(e,t,r){"use strict";const n=e("readable-stream").Duplex,i=e("inherits"),s=e("./BufferList");function o(e){if(!(this instanceof o))return new o(e);if("function"==typeof e){this._callback=e;const t=function(e){this._callback&&(this._callback(e),this._callback=null)}.bind(this);this.on("pipe",(function(e){e.on("error",t)})),this.on("unpipe",(function(e){e.removeListener("error",t)})),e=null}s._init.call(this,e),n.call(this)}i(o,n),Object.assign(o.prototype,s.prototype),o.prototype._new=function(e){return new o(e)},o.prototype._write=function(e,t,r){this._appendBuffer(e),"function"==typeof r&&r()},o.prototype._read=function(e){if(!this.length)return this.push(null);e=Math.min(e,this.length),this.push(this.slice(0,e)),this.consume(e)},o.prototype.end=function(e){n.prototype.end.call(this,e),this._callback&&(this._callback(null,this.slice()),this._callback=null)},o.prototype._destroy=function(e,t){this._bufs.length=0,this.length=0,t(e)},o.prototype._isBufferList=function(e){return e instanceof o||e instanceof s||o.isBufferList(e)},o.isBufferList=s.isBufferList,t.exports=o,t.exports.BufferListStream=o,t.exports.BufferList=s},{"./BufferList":76,inherits:51,"readable-stream":92}],78:[function(e,t,r){arguments[4][33][0].apply(r,arguments)},{dup:33}],79:[function(e,t,r){arguments[4][34][0].apply(r,arguments)},{"./_stream_readable":81,"./_stream_writable":83,_process:102,dup:34,inherits:51}],80:[function(e,t,r){arguments[4][35][0].apply(r,arguments)},{"./_stream_transform":82,dup:35,inherits:51}],81:[function(e,t,r){arguments[4][36][0].apply(r,arguments)},{"../errors":78,"./_stream_duplex":79,"./internal/streams/async_iterator":84,"./internal/streams/buffer_list":85,"./internal/streams/destroy":86,"./internal/streams/from":88,"./internal/streams/state":90,"./internal/streams/stream":91,_process:102,buffer:29,dup:36,events:49,inherits:51,"string_decoder/":136,util:26}],82:[function(e,t,r){arguments[4][37][0].apply(r,arguments)},{"../errors":78,"./_stream_duplex":79,dup:37,inherits:51}],83:[function(e,t,r){arguments[4][38][0].apply(r,arguments)},{"../errors":78,"./_stream_duplex":79,"./internal/streams/destroy":86,"./internal/streams/state":90,"./internal/streams/stream":91,_process:102,buffer:29,dup:38,inherits:51,"util-deprecate":139}],84:[function(e,t,r){arguments[4][39][0].apply(r,arguments)},{"./end-of-stream":87,_process:102,dup:39}],85:[function(e,t,r){arguments[4][40][0].apply(r,arguments)},{buffer:29,dup:40,util:26}],86:[function(e,t,r){arguments[4][41][0].apply(r,arguments)},{_process:102,dup:41}],87:[function(e,t,r){arguments[4][42][0].apply(r,arguments)},{"../../../errors":78,dup:42}],88:[function(e,t,r){arguments[4][43][0].apply(r,arguments)},{dup:43}],89:[function(e,t,r){arguments[4][44][0].apply(r,arguments)},{"../../../errors":78,"./end-of-stream":87,dup:44}],90:[function(e,t,r){arguments[4][45][0].apply(r,arguments)},{"../../../errors":78,dup:45}],91:[function(e,t,r){arguments[4][46][0].apply(r,arguments)},{dup:46,events:49}],92:[function(e,t,r){arguments[4][47][0].apply(r,arguments)},{"./lib/_stream_duplex.js":79,"./lib/_stream_passthrough.js":80,"./lib/_stream_readable.js":81,"./lib/_stream_transform.js":82,"./lib/_stream_writable.js":83,"./lib/internal/streams/end-of-stream.js":87,"./lib/internal/streams/pipeline.js":89,dup:47}],93:[function(e,t,r){const{Buffer:n}=e("buffer"),i={},s=n.isBuffer(n.from([1,2]).subarray(0,1));function o(e){const t=n.allocUnsafe(2);return t.writeUInt8(e>>8,0),t.writeUInt8(255&e,1),t}t.exports={cache:i,generateCache:function(){for(let e=0;e<65536;e++)i[e]=o(e)},generateNumber:o,genBufVariableByteInt:function(e){let t=0,r=0;const i=n.allocUnsafe(4);do{t=e%128|0,(e=e/128|0)>0&&(t|=128),i.writeUInt8(t,r++)}while(e>0&&r<4);return e>0&&(r=0),s?i.subarray(0,r):i.slice(0,r)},generate4ByteBuffer:function(e){const t=n.allocUnsafe(4);return t.writeUInt32BE(e,0),t}}},{buffer:29}],94:[function(e,t,r){t.exports=class{constructor(){this.cmd=null,this.retain=!1,this.qos=0,this.dup=!1,this.length=-1,this.topic=null,this.payload=null}}},{}],95:[function(e,t,r){const n=e("bl"),i=e("events"),s=e("./packet"),o=e("./constants"),a=e("debug")("mqtt-packet:parser");class l extends i{constructor(){super(),this.parser=this.constructor.parser}static parser(e){return this instanceof l?(this.settings=e||{},this._states=["_parseHeader","_parseLength","_parsePayload","_newPacket"],this._resetState(),this):(new l).parser(e)}_resetState(){a("_resetState: resetting packet, error, _list, and _stateCounter"),this.packet=new s,this.error=null,this._list=n(),this._stateCounter=0}parse(e){for(this.error&&this._resetState(),this._list.append(e),a("parse: current state: %s",this._states[this._stateCounter]);(-1!==this.packet.length||this._list.length>0)&&this[this._states[this._stateCounter]]()&&!this.error;)this._stateCounter++,a("parse: state complete. _stateCounter is now: %d",this._stateCounter),a("parse: packet.length: %d, buffer list length: %d",this.packet.length,this._list.length),this._stateCounter>=this._states.length&&(this._stateCounter=0);return a("parse: exited while loop. packet: %d, buffer list length: %d",this.packet.length,this._list.length),this._list.length}_parseHeader(){const e=this._list.readUInt8(0),t=e>>o.CMD_SHIFT;this.packet.cmd=o.types[t];const r=15&e,n=o.requiredHeaderFlags[t];return null!=n&&r!==n?this._emitError(new Error(o.requiredHeaderFlagsErrors[t])):(this.packet.retain=0!=(e&o.RETAIN_MASK),this.packet.qos=e>>o.QOS_SHIFT&o.QOS_MASK,this.packet.qos>2?this._emitError(new Error("Packet must not have both QoS bits set to 1")):(this.packet.dup=0!=(e&o.DUP_MASK),a("_parseHeader: packet: %o",this.packet),this._list.consume(1),!0))}_parseLength(){const e=this._parseVarByteNum(!0);return e&&(this.packet.length=e.value,this._list.consume(e.bytes)),a("_parseLength %d",e.value),!!e}_parsePayload(){a("_parsePayload: payload %O",this._list);let e=!1;if(0===this.packet.length||this._list.length>=this.packet.length){switch(this._pos=0,this.packet.cmd){case"connect":this._parseConnect();break;case"connack":this._parseConnack();break;case"publish":this._parsePublish();break;case"puback":case"pubrec":case"pubrel":case"pubcomp":this._parseConfirmation();break;case"subscribe":this._parseSubscribe();break;case"suback":this._parseSuback();break;case"unsubscribe":this._parseUnsubscribe();break;case"unsuback":this._parseUnsuback();break;case"pingreq":case"pingresp":break;case"disconnect":this._parseDisconnect();break;case"auth":this._parseAuth();break;default:this._emitError(new Error("Not supported"))}e=!0}return a("_parsePayload complete result: %s",e),e}_parseConnect(){let e,t,r,n;a("_parseConnect");const i={},s=this.packet,l=this._parseString();if(null===l)return this._emitError(new Error("Cannot parse protocolId"));if("MQTT"!==l&&"MQIsdp"!==l)return this._emitError(new Error("Invalid protocolId"));if(s.protocolId=l,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(s.protocolVersion=this._list.readUInt8(this._pos),s.protocolVersion>=128&&(s.bridgeMode=!0,s.protocolVersion=s.protocolVersion-128),3!==s.protocolVersion&&4!==s.protocolVersion&&5!==s.protocolVersion)return this._emitError(new Error("Invalid protocol version"));if(this._pos++,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(1&this._list.readUInt8(this._pos))return this._emitError(new Error("Connect flag bit 0 must be 0, but got 1"));i.username=this._list.readUInt8(this._pos)&o.USERNAME_MASK,i.password=this._list.readUInt8(this._pos)&o.PASSWORD_MASK,i.will=this._list.readUInt8(this._pos)&o.WILL_FLAG_MASK;const u=!!(this._list.readUInt8(this._pos)&o.WILL_RETAIN_MASK),c=(this._list.readUInt8(this._pos)&o.WILL_QOS_MASK)>>o.WILL_QOS_SHIFT;if(i.will)s.will={},s.will.retain=u,s.will.qos=c;else{if(u)return this._emitError(new Error("Will Retain Flag must be set to zero when Will Flag is set to 0"));if(c)return this._emitError(new Error("Will QoS must be set to zero when Will Flag is set to 0"))}if(s.clean=0!=(this._list.readUInt8(this._pos)&o.CLEAN_SESSION_MASK),this._pos++,s.keepalive=this._parseNum(),-1===s.keepalive)return this._emitError(new Error("Packet too short"));if(5===s.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(s.properties=e)}const h=this._parseString();if(null===h)return this._emitError(new Error("Packet too short"));if(s.clientId=h,a("_parseConnect: packet.clientId: %s",s.clientId),i.will){if(5===s.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(s.will.properties=e)}if(e=this._parseString(),null===e)return this._emitError(new Error("Cannot parse will topic"));if(s.will.topic=e,a("_parseConnect: packet.will.topic: %s",s.will.topic),t=this._parseBuffer(),null===t)return this._emitError(new Error("Cannot parse will payload"));s.will.payload=t,a("_parseConnect: packet.will.paylaod: %s",s.will.payload)}if(i.username){if(n=this._parseString(),null===n)return this._emitError(new Error("Cannot parse username"));s.username=n,a("_parseConnect: packet.username: %s",s.username)}if(i.password){if(r=this._parseBuffer(),null===r)return this._emitError(new Error("Cannot parse password"));s.password=r}return this.settings=s,a("_parseConnect: complete"),s}_parseConnack(){a("_parseConnack");const e=this.packet;if(this._list.length<1)return null;const t=this._list.readUInt8(this._pos++);if(t>1)return this._emitError(new Error("Invalid connack flags, bits 7-1 must be set to 0"));if(e.sessionPresent=!!(t&o.SESSIONPRESENT_MASK),5===this.settings.protocolVersion)this._list.length>=2?e.reasonCode=this._list.readUInt8(this._pos++):e.reasonCode=0;else{if(this._list.length<2)return null;e.returnCode=this._list.readUInt8(this._pos++)}if(-1===e.returnCode||-1===e.reasonCode)return this._emitError(new Error("Cannot parse return code"));if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}a("_parseConnack: complete")}_parsePublish(){a("_parsePublish");const e=this.packet;if(e.topic=this._parseString(),null===e.topic)return this._emitError(new Error("Cannot parse topic"));if(!(e.qos>0)||this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}e.payload=this._list.slice(this._pos,e.length),a("_parsePublish: payload from buffer list: %o",e.payload)}}_parseSubscribe(){a("_parseSubscribe");const e=this.packet;let t,r,n,i,s,l,u;if(e.subscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}if(e.length<=0)return this._emitError(new Error("Malformed subscribe, no payload specified"));for(;this._pos<e.length;){if(t=this._parseString(),null===t)return this._emitError(new Error("Cannot parse topic"));if(this._pos>=e.length)return this._emitError(new Error("Malformed Subscribe Payload"));if(r=this._parseByte(),5===this.settings.protocolVersion){if(192&r)return this._emitError(new Error("Invalid subscribe topic flag bits, bits 7-6 must be 0"))}else if(252&r)return this._emitError(new Error("Invalid subscribe topic flag bits, bits 7-2 must be 0"));if(n=r&o.SUBSCRIBE_OPTIONS_QOS_MASK,n>2)return this._emitError(new Error("Invalid subscribe QoS, must be <= 2"));if(l=0!=(r>>o.SUBSCRIBE_OPTIONS_NL_SHIFT&o.SUBSCRIBE_OPTIONS_NL_MASK),s=0!=(r>>o.SUBSCRIBE_OPTIONS_RAP_SHIFT&o.SUBSCRIBE_OPTIONS_RAP_MASK),i=r>>o.SUBSCRIBE_OPTIONS_RH_SHIFT&o.SUBSCRIBE_OPTIONS_RH_MASK,i>2)return this._emitError(new Error("Invalid retain handling, must be <= 2"));u={topic:t,qos:n},5===this.settings.protocolVersion?(u.nl=l,u.rap=s,u.rh=i):this.settings.bridgeMode&&(u.rh=0,u.rap=!0,u.nl=!0),a("_parseSubscribe: push subscription `%s` to subscription",u),e.subscriptions.push(u)}}}_parseSuback(){a("_parseSuback");const e=this.packet;if(this.packet.granted=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}if(e.length<=0)return this._emitError(new Error("Malformed suback, no payload specified"));for(;this._pos<this.packet.length;){const e=this._list.readUInt8(this._pos++);if(5===this.settings.protocolVersion){if(!o.MQTT5_SUBACK_CODES[e])return this._emitError(new Error("Invalid suback code"))}else if(e>2&&128!==e)return this._emitError(new Error("Invalid suback QoS, must be 0, 1, 2 or 128"));this.packet.granted.push(e)}}}_parseUnsubscribe(){a("_parseUnsubscribe");const e=this.packet;if(e.unsubscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}if(e.length<=0)return this._emitError(new Error("Malformed unsubscribe, no payload specified"));for(;this._pos<e.length;){const t=this._parseString();if(null===t)return this._emitError(new Error("Cannot parse topic"));a("_parseUnsubscribe: push topic `%s` to unsubscriptions",t),e.unsubscriptions.push(t)}}}_parseUnsuback(){a("_parseUnsuback");const e=this.packet;if(!this._parseMessageId())return this._emitError(new Error("Cannot parse messageId"));if((3===this.settings.protocolVersion||4===this.settings.protocolVersion)&&2!==e.length)return this._emitError(new Error("Malformed unsuback, payload length must be 2"));if(e.length<=0)return this._emitError(new Error("Malformed unsuback, no payload specified"));if(5===this.settings.protocolVersion){const t=this._parseProperties();for(Object.getOwnPropertyNames(t).length&&(e.properties=t),e.granted=[];this._pos<this.packet.length;){const e=this._list.readUInt8(this._pos++);if(!o.MQTT5_UNSUBACK_CODES[e])return this._emitError(new Error("Invalid unsuback code"));this.packet.granted.push(e)}}}_parseConfirmation(){a("_parseConfirmation: packet.cmd: `%s`",this.packet.cmd);const e=this.packet;if(this._parseMessageId(),5===this.settings.protocolVersion){if(e.length>2){switch(e.reasonCode=this._parseByte(),this.packet.cmd){case"puback":case"pubrec":if(!o.MQTT5_PUBACK_PUBREC_CODES[e.reasonCode])return this._emitError(new Error("Invalid "+this.packet.cmd+" reason code"));break;case"pubrel":case"pubcomp":if(!o.MQTT5_PUBREL_PUBCOMP_CODES[e.reasonCode])return this._emitError(new Error("Invalid "+this.packet.cmd+" reason code"))}a("_parseConfirmation: packet.reasonCode `%d`",e.reasonCode)}else e.reasonCode=0;if(e.length>3){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}}return!0}_parseDisconnect(){const e=this.packet;if(a("_parseDisconnect"),5===this.settings.protocolVersion){this._list.length>0?(e.reasonCode=this._parseByte(),o.MQTT5_DISCONNECT_CODES[e.reasonCode]||this._emitError(new Error("Invalid disconnect reason code"))):e.reasonCode=0;const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}return a("_parseDisconnect result: true"),!0}_parseAuth(){a("_parseAuth");const e=this.packet;if(5!==this.settings.protocolVersion)return this._emitError(new Error("Not supported auth packet for this version MQTT"));if(e.reasonCode=this._parseByte(),!o.MQTT5_AUTH_CODES[e.reasonCode])return this._emitError(new Error("Invalid auth reason code"));const t=this._parseProperties();return Object.getOwnPropertyNames(t).length&&(e.properties=t),a("_parseAuth: result: true"),!0}_parseMessageId(){const e=this.packet;return e.messageId=this._parseNum(),null===e.messageId?(this._emitError(new Error("Cannot parse messageId")),!1):(a("_parseMessageId: packet.messageId %d",e.messageId),!0)}_parseString(e){const t=this._parseNum(),r=t+this._pos;if(-1===t||r>this._list.length||r>this.packet.length)return null;const n=this._list.toString("utf8",this._pos,r);return this._pos+=t,a("_parseString: result: %s",n),n}_parseStringPair(){return a("_parseStringPair"),{name:this._parseString(),value:this._parseString()}}_parseBuffer(){const e=this._parseNum(),t=e+this._pos;if(-1===e||t>this._list.length||t>this.packet.length)return null;const r=this._list.slice(this._pos,t);return this._pos+=e,a("_parseBuffer: result: %o",r),r}_parseNum(){if(this._list.length-this._pos<2)return-1;const e=this._list.readUInt16BE(this._pos);return this._pos+=2,a("_parseNum: result: %s",e),e}_parse4ByteNum(){if(this._list.length-this._pos<4)return-1;const e=this._list.readUInt32BE(this._pos);return this._pos+=4,a("_parse4ByteNum: result: %s",e),e}_parseVarByteNum(e){a("_parseVarByteNum");let t,r=0,n=1,i=0,s=!1;const l=this._pos?this._pos:0;for(;r<4&&l+r<this._list.length;){if(t=this._list.readUInt8(l+r++),i+=n*(t&o.VARBYTEINT_MASK),n*=128,0==(t&o.VARBYTEINT_FIN_MASK)){s=!0;break}if(this._list.length<=r)break}return!s&&4===r&&this._list.length>=r&&this._emitError(new Error("Invalid variable byte integer")),l&&(this._pos+=r),s=!!s&&(e?{bytes:r,value:i}:i),a("_parseVarByteNum: result: %o",s),s}_parseByte(){let e;return this._pos<this._list.length&&(e=this._list.readUInt8(this._pos),this._pos++),a("_parseByte: result: %o",e),e}_parseByType(e){switch(a("_parseByType: type: %s",e),e){case"byte":return 0!==this._parseByte();case"int8":return this._parseByte();case"int16":return this._parseNum();case"int32":return this._parse4ByteNum();case"var":return this._parseVarByteNum();case"string":return this._parseString();case"pair":return this._parseStringPair();case"binary":return this._parseBuffer()}}_parseProperties(){a("_parseProperties");const e=this._parseVarByteNum(),t=this._pos+e,r={};for(;this._pos<t;){const e=this._parseByte();if(!e)return this._emitError(new Error("Cannot parse property code type")),!1;const t=o.propertiesCodes[e];if(!t)return this._emitError(new Error("Unknown property")),!1;if("userProperties"!==t)r[t]?(Array.isArray(r[t])||(r[t]=[r[t]]),r[t].push(this._parseByType(o.propertiesTypes[t]))):r[t]=this._parseByType(o.propertiesTypes[t]);else{r[t]||(r[t]=Object.create(null));const e=this._parseByType(o.propertiesTypes[t]);if(r[t][e.name])if(Array.isArray(r[t][e.name]))r[t][e.name].push(e.value);else{const n=r[t][e.name];r[t][e.name]=[n],r[t][e.name].push(e.value)}else r[t][e.name]=e.value}}return r}_newPacket(){return a("_newPacket"),this.packet&&(this._list.consume(this.packet.length),a("_newPacket: parser emit packet: packet.cmd: %s, packet.payload: %s, packet.length: %d",this.packet.cmd,this.packet.payload,this.packet.length),this.emit("packet",this.packet)),a("_newPacket: new packet"),this.packet=new s,this._pos=0,!0}_emitError(e){a("_emitError",e),this.error=e,this.emit("error",e)}}t.exports=l},{"./constants":73,"./packet":94,bl:77,debug:30,events:49}],96:[function(e,t,r){const n=e("./constants"),{Buffer:i}=e("buffer"),s=i.allocUnsafe(0),o=i.from([0]),a=e("./numbers"),l=e("process-nextick-args").nextTick,u=e("debug")("mqtt-packet:writeToStream"),c=a.cache,h=a.generateNumber,f=a.generateCache,d=a.genBufVariableByteInt,p=a.generate4ByteBuffer;let b=E,g=!0;function m(e,t,r){switch(u("generate called"),t.cork&&(t.cork(),l(y,t)),g&&(g=!1,f()),u("generate: packet.cmd: %s",e.cmd),e.cmd){case"connect":return function(e,t,r){const s=e||{},o=s.protocolId||"MQTT";let a=s.protocolVersion||4;const l=s.will;let u=s.clean;const c=s.keepalive||0,h=s.clientId||"",f=s.username,d=s.password,p=s.properties;void 0===u&&(u=!0);let g,m,y=0;if(!o||"string"!=typeof o&&!i.isBuffer(o))return t.destroy(new Error("Invalid protocolId")),!1;y+=o.length+2;if(3!==a&&4!==a&&5!==a)return t.destroy(new Error("Invalid protocol version")),!1;y+=1;if(("string"==typeof h||i.isBuffer(h))&&(h||a>=4)&&(h||u))y+=i.byteLength(h)+2;else{if(a<4)return t.destroy(new Error("clientId must be supplied before 3.1.1")),!1;if(1*u==0)return t.destroy(new Error("clientId must be given if cleanSession set to 0")),!1}if("number"!=typeof c||c<0||c>65535||c%1!=0)return t.destroy(new Error("Invalid keepalive")),!1;y+=2;if(y+=1,5===a){if(g=T(t,p),!g)return!1;y+=g.length}if(l){if("object"!=typeof l)return t.destroy(new Error("Invalid will")),!1;if(!l.topic||"string"!=typeof l.topic)return t.destroy(new Error("Invalid will topic")),!1;if(y+=i.byteLength(l.topic)+2,y+=2,l.payload){if(!(l.payload.length>=0))return t.destroy(new Error("Invalid will payload")),!1;"string"==typeof l.payload?y+=i.byteLength(l.payload):y+=l.payload.length}if(m={},5===a){if(m=T(t,l.properties),!m)return!1;y+=m.length}}let _=!1;if(null!=f){if(!P(f))return t.destroy(new Error("Invalid username")),!1;_=!0,y+=i.byteLength(f)+2}if(null!=d){if(!_)return t.destroy(new Error("Username is required to use password")),!1;if(!P(d))return t.destroy(new Error("Invalid password")),!1;y+=C(d)+2}t.write(n.CONNECT_HEADER),w(t,y),k(t,o),s.bridgeMode&&(a+=128);t.write(131===a?n.VERSION131:132===a?n.VERSION132:4===a?n.VERSION4:5===a?n.VERSION5:n.VERSION3);let S=0;S|=null!=f?n.USERNAME_MASK:0,S|=null!=d?n.PASSWORD_MASK:0,S|=l&&l.retain?n.WILL_RETAIN_MASK:0,S|=l&&l.qos?l.qos<<n.WILL_QOS_SHIFT:0,S|=l?n.WILL_FLAG_MASK:0,S|=u?n.CLEAN_SESSION_MASK:0,t.write(i.from([S])),b(t,c),5===a&&g.write();k(t,h),l&&(5===a&&m.write(),v(t,l.topic),k(t,l.payload));null!=f&&k(t,f);null!=d&&k(t,d);return!0}(e,t);case"connack":return function(e,t,r){const s=r?r.protocolVersion:4,a=e||{},l=5===s?a.reasonCode:a.returnCode,u=a.properties;let c=2;if("number"!=typeof l)return t.destroy(new Error("Invalid return code")),!1;let h=null;if(5===s){if(h=T(t,u),!h)return!1;c+=h.length}t.write(n.CONNACK_HEADER),w(t,c),t.write(a.sessionPresent?n.SESSIONPRESENT_HEADER:o),t.write(i.from([l])),null!=h&&h.write();return!0}(e,t,r);case"publish":return function(e,t,r){u("publish: packet: %o",e);const o=r?r.protocolVersion:4,a=e||{},l=a.qos||0,c=a.retain?n.RETAIN_MASK:0,h=a.topic,f=a.payload||s,d=a.messageId,p=a.properties;let g=0;if("string"==typeof h)g+=i.byteLength(h)+2;else{if(!i.isBuffer(h))return t.destroy(new Error("Invalid topic")),!1;g+=h.length+2}i.isBuffer(f)?g+=f.length:g+=i.byteLength(f);if(l&&"number"!=typeof d)return t.destroy(new Error("Invalid messageId")),!1;l&&(g+=2);let m=null;if(5===o){if(m=T(t,p),!m)return!1;g+=m.length}t.write(n.PUBLISH_HEADER[l][a.dup?1:0][c?1:0]),w(t,g),b(t,C(h)),t.write(h),l>0&&b(t,d);null!=m&&m.write();return u("publish: payload: %o",f),t.write(f)}(e,t,r);case"puback":case"pubrec":case"pubrel":case"pubcomp":return function(e,t,r){const s=r?r.protocolVersion:4,o=e||{},a=o.cmd||"puback",l=o.messageId,u=o.dup&&"pubrel"===a?n.DUP_MASK:0;let c=0;const h=o.reasonCode,f=o.properties;let d=5===s?3:2;"pubrel"===a&&(c=1);if("number"!=typeof l)return t.destroy(new Error("Invalid messageId")),!1;let p=null;if(5===s&&"object"==typeof f){if(p=I(t,f,r,d),!p)return!1;d+=p.length}t.write(n.ACKS[a][c][u][0]),3===d&&(d+=0!==h?1:-1);w(t,d),b(t,l),5===s&&2!==d&&t.write(i.from([h]));null!==p?p.write():4===d&&t.write(i.from([0]));return!0}(e,t,r);case"subscribe":return function(e,t,r){u("subscribe: packet: ");const s=r?r.protocolVersion:4,o=e||{},a=o.dup?n.DUP_MASK:0,l=o.messageId,c=o.subscriptions,h=o.properties;let f=0;if("number"!=typeof l)return t.destroy(new Error("Invalid messageId")),!1;f+=2;let d=null;if(5===s){if(d=T(t,h),!d)return!1;f+=d.length}if("object"!=typeof c||!c.length)return t.destroy(new Error("Invalid subscriptions")),!1;for(let e=0;e<c.length;e+=1){const r=c[e].topic,n=c[e].qos;if("string"!=typeof r)return t.destroy(new Error("Invalid subscriptions - invalid topic")),!1;if("number"!=typeof n)return t.destroy(new Error("Invalid subscriptions - invalid qos")),!1;if(5===s){if("boolean"!=typeof(c[e].nl||!1))return t.destroy(new Error("Invalid subscriptions - invalid No Local")),!1;if("boolean"!=typeof(c[e].rap||!1))return t.destroy(new Error("Invalid subscriptions - invalid Retain as Published")),!1;const r=c[e].rh||0;if("number"!=typeof r||r>2)return t.destroy(new Error("Invalid subscriptions - invalid Retain Handling")),!1}f+=i.byteLength(r)+2+1}u("subscribe: writing to stream: %o",n.SUBSCRIBE_HEADER),t.write(n.SUBSCRIBE_HEADER[1][a?1:0][0]),w(t,f),b(t,l),null!==d&&d.write();let p=!0;for(const e of c){const r=e.topic,o=e.qos,a=+e.nl,l=+e.rap,u=e.rh;let c;v(t,r),c=n.SUBSCRIBE_OPTIONS_QOS[o],5===s&&(c|=a?n.SUBSCRIBE_OPTIONS_NL:0,c|=l?n.SUBSCRIBE_OPTIONS_RAP:0,c|=u?n.SUBSCRIBE_OPTIONS_RH[u]:0),p=t.write(i.from([c]))}return p}(e,t,r);case"suback":return function(e,t,r){const s=r?r.protocolVersion:4,o=e||{},a=o.messageId,l=o.granted,u=o.properties;let c=0;if("number"!=typeof a)return t.destroy(new Error("Invalid messageId")),!1;c+=2;if("object"!=typeof l||!l.length)return t.destroy(new Error("Invalid qos vector")),!1;for(let e=0;e<l.length;e+=1){if("number"!=typeof l[e])return t.destroy(new Error("Invalid qos vector")),!1;c+=1}let h=null;if(5===s){if(h=I(t,u,r,c),!h)return!1;c+=h.length}t.write(n.SUBACK_HEADER),w(t,c),b(t,a),null!==h&&h.write();return t.write(i.from(l))}(e,t,r);case"unsubscribe":return function(e,t,r){const s=r?r.protocolVersion:4,o=e||{},a=o.messageId,l=o.dup?n.DUP_MASK:0,u=o.unsubscriptions,c=o.properties;let h=0;if("number"!=typeof a)return t.destroy(new Error("Invalid messageId")),!1;h+=2;if("object"!=typeof u||!u.length)return t.destroy(new Error("Invalid unsubscriptions")),!1;for(let e=0;e<u.length;e+=1){if("string"!=typeof u[e])return t.destroy(new Error("Invalid unsubscriptions")),!1;h+=i.byteLength(u[e])+2}let f=null;if(5===s){if(f=T(t,c),!f)return!1;h+=f.length}t.write(n.UNSUBSCRIBE_HEADER[1][l?1:0][0]),w(t,h),b(t,a),null!==f&&f.write();let d=!0;for(let e=0;e<u.length;e++)d=v(t,u[e]);return d}(e,t,r);case"unsuback":return function(e,t,r){const s=r?r.protocolVersion:4,o=e||{},a=o.messageId,l=o.dup?n.DUP_MASK:0,u=o.granted,c=o.properties,h=o.cmd,f=0;let d=2;if("number"!=typeof a)return t.destroy(new Error("Invalid messageId")),!1;if(5===s){if("object"!=typeof u||!u.length)return t.destroy(new Error("Invalid qos vector")),!1;for(let e=0;e<u.length;e+=1){if("number"!=typeof u[e])return t.destroy(new Error("Invalid qos vector")),!1;d+=1}}let p=null;if(5===s){if(p=I(t,c,r,d),!p)return!1;d+=p.length}t.write(n.ACKS[h][f][l][0]),w(t,d),b(t,a),null!==p&&p.write();5===s&&t.write(i.from(u));return!0}(e,t,r);case"pingreq":case"pingresp":return function(e,t,r){return t.write(n.EMPTY[e.cmd])}(e,t);case"disconnect":return function(e,t,r){const s=r?r.protocolVersion:4,o=e||{},a=o.reasonCode,l=o.properties;let u=5===s?1:0,c=null;if(5===s){if(c=I(t,l,r,u),!c)return!1;u+=c.length}t.write(i.from([n.codes.disconnect<<4])),w(t,u),5===s&&t.write(i.from([a]));null!==c&&c.write();return!0}(e,t,r);case"auth":return function(e,t,r){const s=r?r.protocolVersion:4,o=e||{},a=o.reasonCode,l=o.properties;let u=5===s?1:0;5!==s&&t.destroy(new Error("Invalid mqtt version for auth packet"));const c=I(t,l,r,u);if(!c)return!1;u+=c.length,t.write(i.from([n.codes.auth<<4])),w(t,u),t.write(i.from([a])),null!==c&&c.write();return!0}(e,t,r);default:return t.destroy(new Error("Unknown command")),!1}}function y(e){e.uncork()}Object.defineProperty(m,"cacheNumbers",{get:()=>b===E,set(e){e?(c&&0!==Object.keys(c).length||(g=!0),b=E):(g=!1,b=A)}});const _={};function w(e,t){if(t>n.VARBYTEINT_MAX)return e.destroy(new Error(`Invalid variable byte integer: ${t}`)),!1;let r=_[t];return r||(r=d(t),t<16384&&(_[t]=r)),u("writeVarByteInt: writing to stream: %o",r),e.write(r)}function v(e,t){const r=i.byteLength(t);return b(e,r),u("writeString: %s",t),e.write(t,"utf8")}function S(e,t,r){v(e,t),v(e,r)}function E(e,t){return u("writeNumberCached: number: %d",t),u("writeNumberCached: %o",c[t]),e.write(c[t])}function A(e,t){const r=h(t);return u("writeNumberGenerated: %o",r),e.write(r)}function k(e,t){"string"==typeof t?v(e,t):t?(b(e,t.length),e.write(t)):b(e,0)}function T(e,t){if("object"!=typeof t||null!=t.length)return{length:1,write(){O(e,{},0)}};let r=0;function s(t,r){let s=0;switch(n.propertiesTypes[t]){case"byte":if("boolean"!=typeof r)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=2;break;case"int8":if("number"!=typeof r||r<0||r>255)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=2;break;case"binary":if(r&&null===r)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=1+i.byteLength(r)+2;break;case"int16":if("number"!=typeof r||r<0||r>65535)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=3;break;case"int32":if("number"!=typeof r||r<0||r>4294967295)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=5;break;case"var":if("number"!=typeof r||r<0||r>268435455)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=1+i.byteLength(d(r));break;case"string":if("string"!=typeof r)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=3+i.byteLength(r.toString());break;case"pair":if("object"!=typeof r)return e.destroy(new Error(`Invalid ${t}: ${r}`)),!1;s+=Object.getOwnPropertyNames(r).reduce(((e,t)=>{const n=r[t];return Array.isArray(n)?e+=n.reduce(((e,r)=>e+=3+i.byteLength(t.toString())+2+i.byteLength(r.toString())),0):e+=3+i.byteLength(t.toString())+2+i.byteLength(r[t].toString()),e}),0);break;default:return e.destroy(new Error(`Invalid property ${t}: ${r}`)),!1}return s}if(t)for(const e in t){let n=0,i=0;const o=t[e];if(Array.isArray(o))for(let t=0;t<o.length;t++){if(i=s(e,o[t]),!i)return!1;n+=i}else{if(i=s(e,o),!i)return!1;n=i}if(!n)return!1;r+=n}return{length:i.byteLength(d(r))+r,write(){O(e,t,r)}}}function I(e,t,r,n){const i=["reasonString","userProperties"],s=r&&r.properties&&r.properties.maximumPacketSize?r.properties.maximumPacketSize:0;let o=T(e,t);if(s)for(;n+o.length>s;){const r=i.shift();if(!r||!t[r])return!1;delete t[r],o=T(e,t)}return o}function R(e,t,r){switch(n.propertiesTypes[t]){case"byte":e.write(i.from([n.properties[t]])),e.write(i.from([+r]));break;case"int8":e.write(i.from([n.properties[t]])),e.write(i.from([r]));break;case"binary":e.write(i.from([n.properties[t]])),k(e,r);break;case"int16":e.write(i.from([n.properties[t]])),b(e,r);break;case"int32":e.write(i.from([n.properties[t]])),function(e,t){const r=p(t);u("write4ByteNumber: %o",r),e.write(r)}(e,r);break;case"var":e.write(i.from([n.properties[t]])),w(e,r);break;case"string":e.write(i.from([n.properties[t]])),v(e,r);break;case"pair":Object.getOwnPropertyNames(r).forEach((s=>{const o=r[s];Array.isArray(o)?o.forEach((r=>{e.write(i.from([n.properties[t]])),S(e,s.toString(),r.toString())})):(e.write(i.from([n.properties[t]])),S(e,s.toString(),o.toString()))}));break;default:return e.destroy(new Error(`Invalid property ${t} value: ${r}`)),!1}}function O(e,t,r){w(e,r);for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)&&null!==t[r]){const n=t[r];if(Array.isArray(n))for(let t=0;t<n.length;t++)R(e,r,n[t]);else R(e,r,n)}}function C(e){return e?e instanceof i?e.length:i.byteLength(e):0}function P(e){return"string"==typeof e||e instanceof i}t.exports=m},{"./constants":73,"./numbers":93,buffer:29,debug:30,"process-nextick-args":101}],97:[function(e,t,r){var n=1e3,i=60*n,s=60*i,o=24*s,a=7*o,l=365.25*o;function u(e,t,r,n){var i=t>=1.5*r;return Math.round(e/r)+" "+n+(i?"s":"")}t.exports=function(e,t){t=t||{};var r=typeof e;if("string"===r&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return r*l;case"weeks":case"week":case"w":return r*a;case"days":case"day":case"d":return r*o;case"hours":case"hour":case"hrs":case"hr":case"h":return r*s;case"minutes":case"minute":case"mins":case"min":case"m":return r*i;case"seconds":case"second":case"secs":case"sec":case"s":return r*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}(e);if("number"===r&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=o)return u(e,t,o,"day");if(t>=s)return u(e,t,s,"hour");if(t>=i)return u(e,t,i,"minute");if(t>=n)return u(e,t,n,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=o)return Math.round(e/o)+"d";if(t>=s)return Math.round(e/s)+"h";if(t>=i)return Math.round(e/i)+"m";if(t>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},{}],98:[function(e,t,r){const n=e("./lib/number-allocator.js");t.exports.NumberAllocator=n},{"./lib/number-allocator.js":99}],99:[function(e,t,r){"use strict";const n=e("js-sdsl").OrderedSet,i=e("debug")("number-allocator:trace"),s=e("debug")("number-allocator:error");function o(e,t){this.low=e,this.high=t}function a(e,t){if(!(this instanceof a))return new a(e,t);this.min=e,this.max=t,this.ss=new n([],((e,t)=>e.compare(t))),i("Create"),this.clear()}o.prototype.equals=function(e){return this.low===e.low&&this.high===e.high},o.prototype.compare=function(e){return this.low<e.low&&this.high<e.low?-1:e.low<this.low&&e.high<this.low?1:0},a.prototype.firstVacant=function(){return 0===this.ss.size()?null:this.ss.front().low},a.prototype.alloc=function(){if(0===this.ss.size())return i("alloc():empty"),null;const e=this.ss.begin(),t=e.pointer.low,r=e.pointer.high,n=t;return n+1<=r?this.ss.updateKeyByIterator(e,new o(t+1,r)):this.ss.eraseElementByPos(0),i("alloc():"+n),n},a.prototype.use=function(e){const t=new o(e,e),r=this.ss.lowerBound(t);if(!r.equals(this.ss.end())){const n=r.pointer.low,s=r.pointer.high;return r.pointer.equals(t)?(this.ss.eraseElementByIterator(r),i("use():"+e),!0):!(n>e)&&(n===e?(this.ss.updateKeyByIterator(r,new o(n+1,s)),i("use():"+e),!0):s===e?(this.ss.updateKeyByIterator(r,new o(n,s-1)),i("use():"+e),!0):(this.ss.updateKeyByIterator(r,new o(e+1,s)),this.ss.insert(new o(n,e-1)),i("use():"+e),!0))}return i("use():failed"),!1},a.prototype.free=function(e){if(e<this.min||e>this.max)return void s("free():"+e+" is out of range");const t=new o(e,e),r=this.ss.upperBound(t);if(r.equals(this.ss.end())){if(r.equals(this.ss.begin()))return void this.ss.insert(t);r.pre();const n=r.pointer.high;r.pointer.high+1===e?this.ss.updateKeyByIterator(r,new o(n,e)):this.ss.insert(t)}else if(r.equals(this.ss.begin()))if(e+1===r.pointer.low){const t=r.pointer.high;this.ss.updateKeyByIterator(r,new o(e,t))}else this.ss.insert(t);else{const n=r.pointer.low,i=r.pointer.high;r.pre();const s=r.pointer.low;r.pointer.high+1===e?e+1===n?(this.ss.eraseElementByIterator(r),this.ss.updateKeyByIterator(r,new o(s,i))):this.ss.updateKeyByIterator(r,new o(s,e)):e+1===n?(this.ss.eraseElementByIterator(r.next()),this.ss.insert(new o(e,i))):this.ss.insert(t)}i("free():"+e)},a.prototype.clear=function(){i("clear()"),this.ss.clear(),this.ss.insert(new o(this.min,this.max))},a.prototype.intervalCount=function(){return this.ss.size()},a.prototype.dump=function(){console.log("length:"+this.ss.size());for(const e of this.ss)console.log(e)},t.exports=a},{debug:30,"js-sdsl":69}],100:[function(e,t,r){var n=e("wrappy");function i(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function s(e){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},r=e.name||"Function wrapped with `once`";return t.onceError=r+" shouldn't be called more than once",t.called=!1,t}t.exports=n(i),t.exports.strict=n(s),i.proto=i((function(){Object.defineProperty(Function.prototype,"once",{value:function(){return i(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return s(this)},configurable:!0})}))},{wrappy:140}],101:[function(e,t,r){(function(e){(function(){"use strict";void 0===e||!e.version||0===e.version.indexOf("v0.")||0===e.version.indexOf("v1.")&&0!==e.version.indexOf("v1.8.")?t.exports={nextTick:function(t,r,n,i){if("function"!=typeof t)throw new TypeError('"callback" argument must be a function');var s,o,a=arguments.length;switch(a){case 0:case 1:return e.nextTick(t);case 2:return e.nextTick((function(){t.call(null,r)}));case 3:return e.nextTick((function(){t.call(null,r,n)}));case 4:return e.nextTick((function(){t.call(null,r,n,i)}));default:for(s=new Array(a-1),o=0;o<s.length;)s[o++]=arguments[o];return e.nextTick((function(){t.apply(null,s)}))}}}:t.exports=e}).call(this)}).call(this,e("_process"))},{_process:102}],102:[function(e,t,r){var n,i,s=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function l(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(e){i=a}}();var u,c=[],h=!1,f=-1;function d(){h&&u&&(h=!1,u.length?c=u.concat(c):f=-1,c.length&&p())}function p(){if(!h){var e=l(d);h=!0;for(var t=c.length;t;){for(u=c,c=[];++f<t;)u&&u[f].run();f=-1,t=c.length}u=null,h=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===a||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function b(e,t){this.fun=e,this.array=t}function g(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new b(e,t)),1!==c.length||h||l(p)},b.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=g,s.addListener=g,s.once=g,s.off=g,s.removeListener=g,s.removeAllListeners=g,s.emit=g,s.prependListener=g,s.prependOnceListener=g,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},{}],103:[function(e,t,r){(function(e){(function(){!function(n){var i="object"==typeof r&&r&&!r.nodeType&&r,s="object"==typeof t&&t&&!t.nodeType&&t,o="object"==typeof e&&e;o.global!==o&&o.window!==o&&o.self!==o||(n=o);var a,l,u=2147483647,c=36,h=1,f=26,d=38,p=700,b=72,g=128,m="-",y=/^xn--/,_=/[^\x20-\x7E]/,w=/[\x2E\u3002\uFF0E\uFF61]/g,v={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},S=c-h,E=Math.floor,A=String.fromCharCode;function k(e){throw new RangeError(v[e])}function T(e,t){for(var r=e.length,n=[];r--;)n[r]=t(e[r]);return n}function I(e,t){var r=e.split("@"),n="";return r.length>1&&(n=r[0]+"@",e=r[1]),n+T((e=e.replace(w,".")).split("."),t).join(".")}function R(e){for(var t,r,n=[],i=0,s=e.length;i<s;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<s?56320==(64512&(r=e.charCodeAt(i++)))?n.push(((1023&t)<<10)+(1023&r)+65536):(n.push(t),i--):n.push(t);return n}function O(e){return T(e,(function(e){var t="";return e>65535&&(t+=A((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=A(e)})).join("")}function C(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function P(e,t,r){var n=0;for(e=r?E(e/p):e>>1,e+=E(e/t);e>S*f>>1;n+=c)e=E(e/S);return E(n+(S+1)*e/(e+d))}function x(e){var t,r,n,i,s,o,a,l,d,p,y,_=[],w=e.length,v=0,S=g,A=b;for((r=e.lastIndexOf(m))<0&&(r=0),n=0;n<r;++n)e.charCodeAt(n)>=128&&k("not-basic"),_.push(e.charCodeAt(n));for(i=r>0?r+1:0;i<w;){for(s=v,o=1,a=c;i>=w&&k("invalid-input"),((l=(y=e.charCodeAt(i++))-48<10?y-22:y-65<26?y-65:y-97<26?y-97:c)>=c||l>E((u-v)/o))&&k("overflow"),v+=l*o,!(l<(d=a<=A?h:a>=A+f?f:a-A));a+=c)o>E(u/(p=c-d))&&k("overflow"),o*=p;A=P(v-s,t=_.length+1,0==s),E(v/t)>u-S&&k("overflow"),S+=E(v/t),v%=t,_.splice(v++,0,S)}return O(_)}function M(e){var t,r,n,i,s,o,a,l,d,p,y,_,w,v,S,T=[];for(_=(e=R(e)).length,t=g,r=0,s=b,o=0;o<_;++o)(y=e[o])<128&&T.push(A(y));for(n=i=T.length,i&&T.push(m);n<_;){for(a=u,o=0;o<_;++o)(y=e[o])>=t&&y<a&&(a=y);for(a-t>E((u-r)/(w=n+1))&&k("overflow"),r+=(a-t)*w,t=a,o=0;o<_;++o)if((y=e[o])<t&&++r>u&&k("overflow"),y==t){for(l=r,d=c;!(l<(p=d<=s?h:d>=s+f?f:d-s));d+=c)S=l-p,v=c-p,T.push(A(C(p+S%v,0))),l=E(S/v);T.push(A(C(l,0))),s=P(r,w,n==i),r=0,++n}++r,++t}return T.join("")}if(a={version:"1.4.1",ucs2:{decode:R,encode:O},decode:x,encode:M,toASCII:function(e){return I(e,(function(e){return _.test(e)?"xn--"+M(e):e}))},toUnicode:function(e){return I(e,(function(e){return y.test(e)?x(e.slice(4).toLowerCase()):e}))}},i&&s)if(t.exports==i)s.exports=a;else for(l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);else n.punycode=a}(this)}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],104:[function(e,t,r){"use strict";function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.exports=function(e,t,r,s){t=t||"&",r=r||"=";var o={};if("string"!=typeof e||0===e.length)return o;var a=/\+/g;e=e.split(t);var l=1e3;s&&"number"==typeof s.maxKeys&&(l=s.maxKeys);var u=e.length;l>0&&u>l&&(u=l);for(var c=0;c<u;++c){var h,f,d,p,b=e[c].replace(a,"%20"),g=b.indexOf(r);g>=0?(h=b.substr(0,g),f=b.substr(g+1)):(h=b,f=""),d=decodeURIComponent(h),p=decodeURIComponent(f),n(o,d)?i(o[d])?o[d].push(p):o[d]=[o[d],p]:o[d]=p}return o};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{}],105:[function(e,t,r){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};t.exports=function(e,t,r,a){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?s(o(e),(function(o){var a=encodeURIComponent(n(o))+r;return i(e[o])?s(e[o],(function(e){return a+encodeURIComponent(n(e))})).join(t):a+encodeURIComponent(n(e[o]))})).join(t):a?encodeURIComponent(n(a))+r+encodeURIComponent(n(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function s(e,t){if(e.map)return e.map(t);for(var r=[],n=0;n<e.length;n++)r.push(t(e[n],n));return r}var o=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t}},{}],106:[function(e,t,r){"use strict";r.decode=r.parse=e("./decode"),r.encode=r.stringify=e("./encode")},{"./decode":104,"./encode":105}],107:[function(e,t,r){"use strict";const{AbortError:n,codes:i}=e("../../ours/errors"),{isNodeStream:s,isWebStream:o,kControllerErrorFunction:a}=e("./utils"),l=e("./end-of-stream"),{ERR_INVALID_ARG_TYPE:u}=i;t.exports.addAbortSignal=function(e,r){if(((e,t)=>{if("object"!=typeof e||!("aborted"in e))throw new u(t,"AbortSignal",e)})(e,"signal"),!s(r)&&!o(r))throw new u("stream",["ReadableStream","WritableStream","Stream"],r);return t.exports.addAbortSignalNoValidate(e,r)},t.exports.addAbortSignalNoValidate=function(e,t){if("object"!=typeof e||!("aborted"in e))return t;const r=s(t)?()=>{t.destroy(new n(void 0,{cause:e.reason}))}:()=>{t[a](new n(void 0,{cause:e.reason}))};return e.aborted?r():(e.addEventListener("abort",r),l(t,(()=>e.removeEventListener("abort",r)))),t}},{"../../ours/errors":126,"./end-of-stream":113,"./utils":122}],108:[function(e,t,r){"use strict";const{StringPrototypeSlice:n,SymbolIterator:i,TypedArrayPrototypeSet:s,Uint8Array:o}=e("../../ours/primordials"),{Buffer:a}=e("buffer"),{inspect:l}=e("../../ours/util");t.exports=class{constructor(){this.head=null,this.tail=null,this.length=0}push(e){const t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}unshift(e){const t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}shift(){if(0===this.length)return;const e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}clear(){this.head=this.tail=null,this.length=0}join(e){if(0===this.length)return"";let t=this.head,r=""+t.data;for(;null!==(t=t.next);)r+=e+t.data;return r}concat(e){if(0===this.length)return a.alloc(0);const t=a.allocUnsafe(e>>>0);let r=this.head,n=0;for(;r;)s(t,r.data,n),n+=r.data.length,r=r.next;return t}consume(e,t){const r=this.head.data;if(e<r.length){const t=r.slice(0,e);return this.head.data=r.slice(e),t}return e===r.length?this.shift():t?this._getString(e):this._getBuffer(e)}first(){return this.head.data}*[i](){for(let e=this.head;e;e=e.next)yield e.data}_getString(e){let t="",r=this.head,i=0;do{const s=r.data;if(!(e>s.length)){e===s.length?(t+=s,++i,r.next?this.head=r.next:this.head=this.tail=null):(t+=n(s,0,e),this.head=r,r.data=n(s,e));break}t+=s,e-=s.length,++i}while(null!==(r=r.next));return this.length-=i,t}_getBuffer(e){const t=a.allocUnsafe(e),r=e;let n=this.head,i=0;do{const a=n.data;if(!(e>a.length)){e===a.length?(s(t,a,r-e),++i,n.next?this.head=n.next:this.head=this.tail=null):(s(t,new o(a.buffer,a.byteOffset,e),r-e),this.head=n,n.data=a.slice(e));break}s(t,a,r-e),e-=a.length,++i}while(null!==(n=n.next));return this.length-=i,t}[Symbol.for("nodejs.util.inspect.custom")](e,t){return l(this,{...t,depth:0,customInspect:!1})}}},{"../../ours/primordials":127,"../../ours/util":128,buffer:29}],109:[function(e,t,r){"use strict";const{pipeline:n}=e("./pipeline"),i=e("./duplex"),{destroyer:s}=e("./destroy"),{isNodeStream:o,isReadable:a,isWritable:l,isWebStream:u,isTransformStream:c,isWritableStream:h,isReadableStream:f}=e("./utils"),{AbortError:d,codes:{ERR_INVALID_ARG_VALUE:p,ERR_MISSING_ARGS:b}}=e("../../ours/errors"),g=e("./end-of-stream");t.exports=function(...e){if(0===e.length)throw new b("streams");if(1===e.length)return i.from(e[0]);const t=[...e];if("function"==typeof e[0]&&(e[0]=i.from(e[0])),"function"==typeof e[e.length-1]){const t=e.length-1;e[t]=i.from(e[t])}for(let r=0;r<e.length;++r)if(o(e[r])||u(e[r])){if(r<e.length-1&&!(a(e[r])||f(e[r])||c(e[r])))throw new p(`streams[${r}]`,t[r],"must be readable");if(r>0&&!(l(e[r])||h(e[r])||c(e[r])))throw new p(`streams[${r}]`,t[r],"must be writable")}let r,m,y,_,w;const v=e[0],S=n(e,(function(e){const t=_;_=null,t?t(e):e?w.destroy(e):A||E||w.destroy()})),E=!!(l(v)||h(v)||c(v)),A=!!(a(S)||f(S)||c(S));if(w=new i({writableObjectMode:!(null==v||!v.writableObjectMode),readableObjectMode:!(null==S||!S.writableObjectMode),writable:E,readable:A}),E){if(o(v))w._write=function(e,t,n){v.write(e,t)?n():r=n},w._final=function(e){v.end(),m=e},v.on("drain",(function(){if(r){const e=r;r=null,e()}}));else if(u(v)){const e=(c(v)?v.writable:v).getWriter();w._write=async function(t,r,n){try{await e.ready,e.write(t).catch((()=>{})),n()}catch(e){n(e)}},w._final=async function(t){try{await e.ready,e.close().catch((()=>{})),m=t}catch(e){t(e)}}}const e=c(S)?S.readable:S;g(e,(()=>{if(m){const e=m;m=null,e()}}))}if(A)if(o(S))S.on("readable",(function(){if(y){const e=y;y=null,e()}})),S.on("end",(function(){w.push(null)})),w._read=function(){for(;;){const e=S.read();if(null===e)return void(y=w._read);if(!w.push(e))return}};else if(u(S)){const e=(c(S)?S.readable:S).getReader();w._read=async function(){for(;;)try{const{value:t,done:r}=await e.read();if(!w.push(t))return;if(r)return void w.push(null)}catch{return}}}return w._destroy=function(e,t){e||null===_||(e=new d),y=null,r=null,m=null,null===_?t(e):(_=t,o(S)&&s(S,e))},w}},{"../../ours/errors":126,"./destroy":110,"./duplex":111,"./end-of-stream":113,"./pipeline":118,"./utils":122}],110:[function(e,t,r){"use strict";const n=e("process/"),{aggregateTwoErrors:i,codes:{ERR_MULTIPLE_CALLBACK:s},AbortError:o}=e("../../ours/errors"),{Symbol:a}=e("../../ours/primordials"),{kDestroyed:l,isDestroyed:u,isFinished:c,isServerRequest:h}=e("./utils"),f=a("kDestroy"),d=a("kConstruct");function p(e,t,r){e&&(e.stack,t&&!t.errored&&(t.errored=e),r&&!r.errored&&(r.errored=e))}function b(e,t,r){let i=!1;function s(t){if(i)return;i=!0;const s=e._readableState,o=e._writableState;p(t,o,s),o&&(o.closed=!0),s&&(s.closed=!0),"function"==typeof r&&r(t),t?n.nextTick(g,e,t):n.nextTick(m,e)}try{e._destroy(t||null,s)}catch(t){s(t)}}function g(e,t){y(e,t),m(e)}function m(e){const t=e._readableState,r=e._writableState;r&&(r.closeEmitted=!0),t&&(t.closeEmitted=!0),(null!=r&&r.emitClose||null!=t&&t.emitClose)&&e.emit("close")}function y(e,t){const r=e._readableState,n=e._writableState;null!=n&&n.errorEmitted||null!=r&&r.errorEmitted||(n&&(n.errorEmitted=!0),r&&(r.errorEmitted=!0),e.emit("error",t))}function _(e,t,r){const i=e._readableState,s=e._writableState;if(null!=s&&s.destroyed||null!=i&&i.destroyed)return this;null!=i&&i.autoDestroy||null!=s&&s.autoDestroy?e.destroy(t):t&&(t.stack,s&&!s.errored&&(s.errored=t),i&&!i.errored&&(i.errored=t),r?n.nextTick(y,e,t):y(e,t))}function w(e){let t=!1;function r(r){if(t)return void _(e,null!=r?r:new s);t=!0;const i=e._readableState,o=e._writableState,a=o||i;i&&(i.constructed=!0),o&&(o.constructed=!0),a.destroyed?e.emit(f,r):r?_(e,r,!0):n.nextTick(v,e)}try{e._construct((e=>{n.nextTick(r,e)}))}catch(e){n.nextTick(r,e)}}function v(e){e.emit(d)}function S(e){return(null==e?void 0:e.setHeader)&&"function"==typeof e.abort}function E(e){e.emit("close")}function A(e,t){e.emit("error",t),n.nextTick(E,e)}t.exports={construct:function(e,t){if("function"!=typeof e._construct)return;const r=e._readableState,i=e._writableState;r&&(r.constructed=!1),i&&(i.constructed=!1),e.once(d,t),e.listenerCount(d)>1||n.nextTick(w,e)},destroyer:function(e,t){e&&!u(e)&&(t||c(e)||(t=new o),h(e)?(e.socket=null,e.destroy(t)):S(e)?e.abort():S(e.req)?e.req.abort():"function"==typeof e.destroy?e.destroy(t):"function"==typeof e.close?e.close():t?n.nextTick(A,e,t):n.nextTick(E,e),e.destroyed||(e[l]=!0))},destroy:function(e,t){const r=this._readableState,n=this._writableState,s=n||r;return null!=n&&n.destroyed||null!=r&&r.destroyed?("function"==typeof t&&t(),this):(p(e,n,r),n&&(n.destroyed=!0),r&&(r.destroyed=!0),s.constructed?b(this,e,t):this.once(f,(function(r){b(this,i(r,e),t)})),this)},undestroy:function(){const e=this._readableState,t=this._writableState;e&&(e.constructed=!0,e.closed=!1,e.closeEmitted=!1,e.destroyed=!1,e.errored=null,e.errorEmitted=!1,e.reading=!1,e.ended=!1===e.readable,e.endEmitted=!1===e.readable),t&&(t.constructed=!0,t.destroyed=!1,t.closed=!1,t.closeEmitted=!1,t.errored=null,t.errorEmitted=!1,t.finalCalled=!1,t.prefinished=!1,t.ended=!1===t.writable,t.ending=!1===t.writable,t.finished=!1===t.writable)},errorOrDestroy:_}},{"../../ours/errors":126,"../../ours/primordials":127,"./utils":122,"process/":102}],111:[function(e,t,r){"use strict";const{ObjectDefineProperties:n,ObjectGetOwnPropertyDescriptor:i,ObjectKeys:s,ObjectSetPrototypeOf:o}=e("../../ours/primordials");t.exports=u;const a=e("./readable"),l=e("./writable");o(u.prototype,a.prototype),o(u,a);{const e=s(l.prototype);for(let t=0;t<e.length;t++){const r=e[t];u.prototype[r]||(u.prototype[r]=l.prototype[r])}}function u(e){if(!(this instanceof u))return new u(e);a.call(this,e),l.call(this,e),e?(this.allowHalfOpen=!1!==e.allowHalfOpen,!1===e.readable&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),!1===e.writable&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)):this.allowHalfOpen=!0}let c,h;function f(){return void 0===c&&(c={}),c}n(u.prototype,{writable:{__proto__:null,...i(l.prototype,"writable")},writableHighWaterMark:{__proto__:null,...i(l.prototype,"writableHighWaterMark")},writableObjectMode:{__proto__:null,...i(l.prototype,"writableObjectMode")},writableBuffer:{__proto__:null,...i(l.prototype,"writableBuffer")},writableLength:{__proto__:null,...i(l.prototype,"writableLength")},writableFinished:{__proto__:null,...i(l.prototype,"writableFinished")},writableCorked:{__proto__:null,...i(l.prototype,"writableCorked")},writableEnded:{__proto__:null,...i(l.prototype,"writableEnded")},writableNeedDrain:{__proto__:null,...i(l.prototype,"writableNeedDrain")},destroyed:{__proto__:null,get(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set(e){this._readableState&&this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}}}),u.fromWeb=function(e,t){return f().newStreamDuplexFromReadableWritablePair(e,t)},u.toWeb=function(e){return f().newReadableWritablePairFromDuplex(e)},u.from=function(t){return h||(h=e("./duplexify")),h(t,"body")}},{"../../ours/primordials":127,"./duplexify":112,"./readable":119,"./writable":123}],112:[function(e,t,r){const n=e("process/"),i=e("buffer"),{isReadable:s,isWritable:o,isIterable:a,isNodeStream:l,isReadableNodeStream:u,isWritableNodeStream:c,isDuplexNodeStream:h}=e("./utils"),f=e("./end-of-stream"),{AbortError:d,codes:{ERR_INVALID_ARG_TYPE:p,ERR_INVALID_RETURN_VALUE:b}}=e("../../ours/errors"),{destroyer:g}=e("./destroy"),m=e("./duplex"),y=e("./readable"),{createDeferredPromise:_}=e("../../ours/util"),w=e("./from"),v=globalThis.Blob||i.Blob,S=void 0!==v?function(e){return e instanceof v}:function(e){return!1},E=globalThis.AbortController||e("abort-controller").AbortController,{FunctionPrototypeCall:A}=e("../../ours/primordials");class k extends m{constructor(e){super(e),!1===(null==e?void 0:e.readable)&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),!1===(null==e?void 0:e.writable)&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)}}function T(e){const t=e.readable&&"function"!=typeof e.readable.read?y.wrap(e.readable):e.readable,r=e.writable;let n,i,a,l,u,c=!!s(t),h=!!o(r);function p(e){const t=l;l=null,t?t(e):e&&u.destroy(e)}return u=new k({readableObjectMode:!(null==t||!t.readableObjectMode),writableObjectMode:!(null==r||!r.writableObjectMode),readable:c,writable:h}),h&&(f(r,(e=>{h=!1,e&&g(t,e),p(e)})),u._write=function(e,t,i){r.write(e,t)?i():n=i},u._final=function(e){r.end(),i=e},r.on("drain",(function(){if(n){const e=n;n=null,e()}})),r.on("finish",(function(){if(i){const e=i;i=null,e()}}))),c&&(f(t,(e=>{c=!1,e&&g(t,e),p(e)})),t.on("readable",(function(){if(a){const e=a;a=null,e()}})),t.on("end",(function(){u.push(null)})),u._read=function(){for(;;){const e=t.read();if(null===e)return void(a=u._read);if(!u.push(e))return}}),u._destroy=function(e,s){e||null===l||(e=new d),a=null,n=null,i=null,null===l?s(e):(l=s,g(r,e),g(t,e))},u}t.exports=function e(t,r){if(h(t))return t;if(u(t))return T({readable:t});if(c(t))return T({writable:t});if(l(t))return T({writable:!1,readable:!1});if("function"==typeof t){const{value:e,write:i,final:s,destroy:o}=function(e){let{promise:t,resolve:r}=_();const i=new E,s=i.signal,o=e(async function*(){for(;;){const e=t;t=null;const{chunk:i,done:o,cb:a}=await e;if(n.nextTick(a),o)return;if(s.aborted)throw new d(void 0,{cause:s.reason});({promise:t,resolve:r}=_()),yield i}}(),{signal:s});return{value:o,write(e,t,n){const i=r;r=null,i({chunk:e,done:!1,cb:n})},final(e){const t=r;r=null,t({done:!0,cb:e})},destroy(e,t){i.abort(),t(e)}}}(t);if(a(e))return w(k,e,{objectMode:!0,write:i,final:s,destroy:o});const l=null==e?void 0:e.then;if("function"==typeof l){let t;const r=A(l,e,(e=>{if(null!=e)throw new b("nully","body",e)}),(e=>{g(t,e)}));return t=new k({objectMode:!0,readable:!1,write:i,final(e){s((async()=>{try{await r,n.nextTick(e,null)}catch(t){n.nextTick(e,t)}}))},destroy:o})}throw new b("Iterable, AsyncIterable or AsyncFunction",r,e)}if(S(t))return e(t.arrayBuffer());if(a(t))return w(k,t,{objectMode:!0,writable:!1});if("object"==typeof(null==t?void 0:t.writable)||"object"==typeof(null==t?void 0:t.readable)){return T({readable:null!=t&&t.readable?u(null==t?void 0:t.readable)?null==t?void 0:t.readable:e(t.readable):void 0,writable:null!=t&&t.writable?c(null==t?void 0:t.writable)?null==t?void 0:t.writable:e(t.writable):void 0})}const i=null==t?void 0:t.then;if("function"==typeof i){let e;return A(i,t,(t=>{null!=t&&e.push(t),e.push(null)}),(t=>{g(e,t)})),e=new k({objectMode:!0,writable:!1,read(){}})}throw new p(r,["Blob","ReadableStream","WritableStream","Stream","Iterable","AsyncIterable","Function","{ readable, writable } pair","Promise"],t)}},{"../../ours/errors":126,"../../ours/primordials":127,"../../ours/util":128,"./destroy":110,"./duplex":111,"./end-of-stream":113,"./from":114,"./readable":119,"./utils":122,"abort-controller":24,buffer:29,"process/":102}],113:[function(e,t,r){const n=e("process/"),{AbortError:i,codes:s}=e("../../ours/errors"),{ERR_INVALID_ARG_TYPE:o,ERR_STREAM_PREMATURE_CLOSE:a}=s,{kEmptyObject:l,once:u}=e("../../ours/util"),{validateAbortSignal:c,validateFunction:h,validateObject:f,validateBoolean:d}=e("../validators"),{Promise:p,PromisePrototypeThen:b}=e("../../ours/primordials"),{isClosed:g,isReadable:m,isReadableNodeStream:y,isReadableStream:_,isReadableFinished:w,isReadableErrored:v,isWritable:S,isWritableNodeStream:E,isWritableStream:A,isWritableFinished:k,isWritableErrored:T,isNodeStream:I,willEmitClose:R,kIsClosedPromise:O}=e("./utils");const C=()=>{};function P(e,t,r){var s,d;if(2===arguments.length?(r=t,t=l):null==t?t=l:f(t,"options"),h(r,"callback"),c(t.signal,"options.signal"),r=u(r),_(e)||A(e))return function(e,t,r){let s=!1,o=C;if(t.signal)if(o=()=>{s=!0,r.call(e,new i(void 0,{cause:t.signal.reason}))},t.signal.aborted)n.nextTick(o);else{const n=r;r=u(((...r)=>{t.signal.removeEventListener("abort",o),n.apply(e,r)})),t.signal.addEventListener("abort",o)}const a=(...t)=>{s||n.nextTick((()=>r.apply(e,t)))};return b(e[O].promise,a,a),C}(e,t,r);if(!I(e))throw new o("stream",["ReadableStream","WritableStream","Stream"],e);const p=null!==(s=t.readable)&&void 0!==s?s:y(e),P=null!==(d=t.writable)&&void 0!==d?d:E(e),x=e._writableState,M=e._readableState,B=()=>{e.writable||N()};let L=R(e)&&y(e)===p&&E(e)===P,j=k(e,!1);const N=()=>{j=!0,e.destroyed&&(L=!1),(!L||e.readable&&!p)&&(p&&!U||r.call(e))};let U=w(e,!1);const D=()=>{U=!0,e.destroyed&&(L=!1),(!L||e.writable&&!P)&&(P&&!j||r.call(e))},F=t=>{r.call(e,t)};let W=g(e);const q=()=>{W=!0;const t=T(e)||v(e);return t&&"boolean"!=typeof t?r.call(e,t):p&&!U&&y(e,!0)&&!w(e,!1)?r.call(e,new a):!P||j||k(e,!1)?void r.call(e):r.call(e,new a)},H=()=>{W=!0;const t=T(e)||v(e);if(t&&"boolean"!=typeof t)return r.call(e,t);r.call(e)},z=()=>{e.req.on("finish",N)};!function(e){return e.setHeader&&"function"==typeof e.abort}(e)?P&&!x&&(e.on("end",B),e.on("close",B)):(e.on("complete",N),L||e.on("abort",q),e.req?z():e.on("request",z)),L||"boolean"!=typeof e.aborted||e.on("aborted",q),e.on("end",D),e.on("finish",N),!1!==t.error&&e.on("error",F),e.on("close",q),W?n.nextTick(q):null!=x&&x.errorEmitted||null!=M&&M.errorEmitted?L||n.nextTick(H):(p||L&&!m(e)||!j&&!1!==S(e))&&(P||L&&!S(e)||!U&&!1!==m(e))?M&&e.req&&e.aborted&&n.nextTick(H):n.nextTick(H);const V=()=>{r=C,e.removeListener("aborted",q),e.removeListener("complete",N),e.removeListener("abort",q),e.removeListener("request",z),e.req&&e.req.removeListener("finish",N),e.removeListener("end",B),e.removeListener("close",B),e.removeListener("finish",N),e.removeListener("end",D),e.removeListener("error",F),e.removeListener("close",q)};if(t.signal&&!W){const s=()=>{const n=r;V(),n.call(e,new i(void 0,{cause:t.signal.reason}))};if(t.signal.aborted)n.nextTick(s);else{const n=r;r=u(((...r)=>{t.signal.removeEventListener("abort",s),n.apply(e,r)})),t.signal.addEventListener("abort",s)}}return V}t.exports=P,t.exports.finished=function(e,t){var r;let n=!1;return null===t&&(t=l),null!==(r=t)&&void 0!==r&&r.cleanup&&(d(t.cleanup,"cleanup"),n=t.cleanup),new p(((r,i)=>{const s=P(e,t,(e=>{n&&s(),e?i(e):r()}))}))}},{"../../ours/errors":126,"../../ours/primordials":127,"../../ours/util":128,"../validators":124,"./utils":122,"process/":102}],114:[function(e,t,r){"use strict";const n=e("process/"),{PromisePrototypeThen:i,SymbolAsyncIterator:s,SymbolIterator:o}=e("../../ours/primordials"),{Buffer:a}=e("buffer"),{ERR_INVALID_ARG_TYPE:l,ERR_STREAM_NULL_VALUES:u}=e("../../ours/errors").codes;t.exports=function(e,t,r){let c,h;if("string"==typeof t||t instanceof a)return new e({objectMode:!0,...r,read(){this.push(t),this.push(null)}});if(t&&t[s])h=!0,c=t[s]();else{if(!t||!t[o])throw new l("iterable",["Iterable"],t);h=!1,c=t[o]()}const f=new e({objectMode:!0,highWaterMark:1,...r});let d=!1;return f._read=function(){d||(d=!0,async function(){for(;;){try{const{value:e,done:t}=h?await c.next():c.next();if(t)f.push(null);else{const t=e&&"function"==typeof e.then?await e:e;if(null===t)throw d=!1,new u;if(f.push(t))continue;d=!1}}catch(e){f.destroy(e)}break}}())},f._destroy=function(e,t){i(async function(e){const t=null!=e,r="function"==typeof c.throw;if(t&&r){const{value:t,done:r}=await c.throw(e);if(await t,r)return}if("function"==typeof c.return){const{value:e}=await c.return();await e}}(e),(()=>n.nextTick(t,e)),(r=>n.nextTick(t,r||e)))},f}},{"../../ours/errors":126,"../../ours/primordials":127,buffer:29,"process/":102}],115:[function(e,t,r){"use strict";const{ArrayIsArray:n,ObjectSetPrototypeOf:i}=e("../../ours/primordials"),{EventEmitter:s}=e("events");function o(e){s.call(this,e)}function a(e,t,r){if("function"==typeof e.prependListener)return e.prependListener(t,r);e._events&&e._events[t]?n(e._events[t])?e._events[t].unshift(r):e._events[t]=[r,e._events[t]]:e.on(t,r)}i(o.prototype,s.prototype),i(o,s),o.prototype.pipe=function(e,t){const r=this;function n(t){e.writable&&!1===e.write(t)&&r.pause&&r.pause()}function i(){r.readable&&r.resume&&r.resume()}r.on("data",n),e.on("drain",i),e._isStdio||t&&!1===t.end||(r.on("end",l),r.on("close",u));let o=!1;function l(){o||(o=!0,e.end())}function u(){o||(o=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){h(),0===s.listenerCount(this,"error")&&this.emit("error",e)}function h(){r.removeListener("data",n),e.removeListener("drain",i),r.removeListener("end",l),r.removeListener("close",u),r.removeListener("error",c),e.removeListener("error",c),r.removeListener("end",h),r.removeListener("close",h),e.removeListener("close",h)}return a(r,"error",c),a(e,"error",c),r.on("end",h),r.on("close",h),e.on("close",h),e.emit("pipe",r),e},t.exports={Stream:o,prependListener:a}},{"../../ours/primordials":127,events:49}],116:[function(e,t,r){"use strict";const n=globalThis.AbortController||e("abort-controller").AbortController,{codes:{ERR_INVALID_ARG_VALUE:i,ERR_INVALID_ARG_TYPE:s,ERR_MISSING_ARGS:o,ERR_OUT_OF_RANGE:a},AbortError:l}=e("../../ours/errors"),{validateAbortSignal:u,validateInteger:c,validateObject:h}=e("../validators"),f=e("../../ours/primordials").Symbol("kWeak"),{finished:d}=e("./end-of-stream"),p=e("./compose"),{addAbortSignalNoValidate:b}=e("./add-abort-signal"),{isWritable:g,isNodeStream:m}=e("./utils"),{ArrayPrototypePush:y,MathFloor:_,Number:w,NumberIsNaN:v,Promise:S,PromiseReject:E,PromisePrototypeThen:A,Symbol:k}=e("../../ours/primordials"),T=k("kEmpty"),I=k("kEof");function R(e,t){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);null!=t&&h(t,"options"),null!=(null==t?void 0:t.signal)&&u(t.signal,"options.signal");let r=1;return null!=(null==t?void 0:t.concurrency)&&(r=_(t.concurrency)),c(r,"concurrency",1),async function*(){var i,s;const o=new n,a=this,u=[],c=o.signal,h={signal:c},f=()=>o.abort();let d,p;null!=t&&null!==(i=t.signal)&&void 0!==i&&i.aborted&&f(),null==t||null===(s=t.signal)||void 0===s||s.addEventListener("abort",f);let b=!1;function g(){b=!0}!async function(){try{for await(let t of a){var n;if(b)return;if(c.aborted)throw new l;try{t=e(t,h)}catch(e){t=E(e)}t!==T&&("function"==typeof(null===(n=t)||void 0===n?void 0:n.catch)&&t.catch(g),u.push(t),d&&(d(),d=null),!b&&u.length&&u.length>=r&&await new S((e=>{p=e})))}u.push(I)}catch(e){const t=E(e);A(t,void 0,g),u.push(t)}finally{var i;b=!0,d&&(d(),d=null),null==t||null===(i=t.signal)||void 0===i||i.removeEventListener("abort",f)}}();try{for(;;){for(;u.length>0;){const e=await u[0];if(e===I)return;if(c.aborted)throw new l;e!==T&&(yield e),u.shift(),p&&(p(),p=null)}await new S((e=>{d=e}))}}finally{o.abort(),b=!0,p&&(p(),p=null)}}.call(this)}async function O(e,t=void 0){for await(const r of C.call(this,e,t))return!0;return!1}function C(e,t){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);return R.call(this,(async function(t,r){return await e(t,r)?t:T}),t)}class P extends o{constructor(){super("reduce"),this.message="Reduce of an empty stream requires an initial value"}}function x(e){if(e=w(e),v(e))return 0;if(e<0)throw new a("number",">= 0",e);return e}t.exports.streamReturningOperators={asIndexedPairs:function(e=void 0){return null!=e&&h(e,"options"),null!=(null==e?void 0:e.signal)&&u(e.signal,"options.signal"),async function*(){let t=0;for await(const n of this){var r;if(null!=e&&null!==(r=e.signal)&&void 0!==r&&r.aborted)throw new l({cause:e.signal.reason});yield[t++,n]}}.call(this)},drop:function(e,t=void 0){return null!=t&&h(t,"options"),null!=(null==t?void 0:t.signal)&&u(t.signal,"options.signal"),e=x(e),async function*(){var r;if(null!=t&&null!==(r=t.signal)&&void 0!==r&&r.aborted)throw new l;for await(const r of this){var n;if(null!=t&&null!==(n=t.signal)&&void 0!==n&&n.aborted)throw new l;e--<=0&&(yield r)}}.call(this)},filter:C,flatMap:function(e,t){const r=R.call(this,e,t);return async function*(){for await(const e of r)yield*e}.call(this)},map:R,take:function(e,t=void 0){return null!=t&&h(t,"options"),null!=(null==t?void 0:t.signal)&&u(t.signal,"options.signal"),e=x(e),async function*(){var r;if(null!=t&&null!==(r=t.signal)&&void 0!==r&&r.aborted)throw new l;for await(const r of this){var n;if(null!=t&&null!==(n=t.signal)&&void 0!==n&&n.aborted)throw new l;if(!(e-- >0))return;yield r}}.call(this)},compose:function(e,t){if(null!=t&&h(t,"options"),null!=(null==t?void 0:t.signal)&&u(t.signal,"options.signal"),m(e)&&!g(e))throw new i("stream",e,"must be writable");const r=p(this,e);return null!=t&&t.signal&&b(t.signal,r),r}},t.exports.promiseReturningOperators={every:async function(e,t=void 0){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);return!await O.call(this,(async(...t)=>!await e(...t)),t)},forEach:async function(e,t){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);for await(const r of R.call(this,(async function(t,r){return await e(t,r),T}),t));},reduce:async function(e,t,r){var i;if("function"!=typeof e)throw new s("reducer",["Function","AsyncFunction"],e);null!=r&&h(r,"options"),null!=(null==r?void 0:r.signal)&&u(r.signal,"options.signal");let o=arguments.length>1;if(null!=r&&null!==(i=r.signal)&&void 0!==i&&i.aborted){const e=new l(void 0,{cause:r.signal.reason});throw this.once("error",(()=>{})),await d(this.destroy(e)),e}const a=new n,c=a.signal;if(null!=r&&r.signal){const e={once:!0,[f]:this};r.signal.addEventListener("abort",(()=>a.abort()),e)}let p=!1;try{for await(const n of this){var b;if(p=!0,null!=r&&null!==(b=r.signal)&&void 0!==b&&b.aborted)throw new l;o?t=await e(t,n,{signal:c}):(t=n,o=!0)}if(!p&&!o)throw new P}finally{a.abort()}return t},toArray:async function(e){null!=e&&h(e,"options"),null!=(null==e?void 0:e.signal)&&u(e.signal,"options.signal");const t=[];for await(const n of this){var r;if(null!=e&&null!==(r=e.signal)&&void 0!==r&&r.aborted)throw new l(void 0,{cause:e.signal.reason});y(t,n)}return t},some:O,find:async function(e,t){for await(const r of C.call(this,e,t))return r}}},{"../../ours/errors":126,"../../ours/primordials":127,"../validators":124,"./add-abort-signal":107,"./compose":109,"./end-of-stream":113,"./utils":122,"abort-controller":24}],117:[function(e,t,r){"use strict";const{ObjectSetPrototypeOf:n}=e("../../ours/primordials");t.exports=s;const i=e("./transform");function s(e){if(!(this instanceof s))return new s(e);i.call(this,e)}n(s.prototype,i.prototype),n(s,i),s.prototype._transform=function(e,t,r){r(null,e)}},{"../../ours/primordials":127,"./transform":121}],118:[function(e,t,r){const n=e("process/"),{ArrayIsArray:i,Promise:s,SymbolAsyncIterator:o}=e("../../ours/primordials"),a=e("./end-of-stream"),{once:l}=e("../../ours/util"),u=e("./destroy"),c=e("./duplex"),{aggregateTwoErrors:h,codes:{ERR_INVALID_ARG_TYPE:f,ERR_INVALID_RETURN_VALUE:d,ERR_MISSING_ARGS:p,ERR_STREAM_DESTROYED:b,ERR_STREAM_PREMATURE_CLOSE:g},AbortError:m}=e("../../ours/errors"),{validateFunction:y,validateAbortSignal:_}=e("../validators"),{isIterable:w,isReadable:v,isReadableNodeStream:S,isNodeStream:E,isTransformStream:A,isWebStream:k,isReadableStream:T,isReadableEnded:I}=e("./utils"),R=globalThis.AbortController||e("abort-controller").AbortController;let O,C;function P(e,t,r){let n=!1;e.on("close",(()=>{n=!0}));return{destroy:t=>{n||(n=!0,u.destroyer(e,t||new b("pipe")))},cleanup:a(e,{readable:t,writable:r},(e=>{n=!e}))}}function x(t){if(w(t))return t;if(S(t))return async function*(t){C||(C=e("./readable"));yield*C.prototype[o].call(t)}(t);throw new f("val",["Readable","Iterable","AsyncIterable"],t)}async function M(e,t,r,{end:n}){let i,o=null;const l=e=>{if(e&&(i=e),o){const e=o;o=null,e()}},u=()=>new s(((e,t)=>{i?t(i):o=()=>{i?t(i):e()}}));t.on("drain",l);const c=a(t,{readable:!1},l);try{t.writableNeedDrain&&await u();for await(const r of e)t.write(r)||await u();n&&t.end(),await u(),r()}catch(e){r(i!==e?h(i,e):e)}finally{c(),t.off("drain",l)}}async function B(e,t,r,{end:n}){A(t)&&(t=t.writable);const i=t.getWriter();try{for await(const t of e)await i.ready,i.write(t).catch((()=>{}));await i.ready,n&&await i.close(),r()}catch(e){try{await i.abort(e),r(e)}catch(e){r(e)}}}function L(t,r,s){if(1===t.length&&i(t[0])&&(t=t[0]),t.length<2)throw new p("streams");const o=new R,a=o.signal,l=null==s?void 0:s.signal,u=[];function h(){N(new m)}let b,g;_(l,"options.signal"),null==l||l.addEventListener("abort",h);const y=[];let I,C=0;function L(e){N(e,0==--C)}function N(e,t){if(!e||b&&"ERR_STREAM_PREMATURE_CLOSE"!==b.code||(b=e),b||t){for(;y.length;)y.shift()(b);null==l||l.removeEventListener("abort",h),o.abort(),t&&(b||u.forEach((e=>e())),n.nextTick(r,b,g))}}for(let W=0;W<t.length;W++){const q=t[W],H=W<t.length-1,z=W>0,V=H||!1!==(null==s?void 0:s.end),$=W===t.length-1;if(E(q)){if(V){const{destroy:K,cleanup:G}=P(q,H,z);y.push(K),v(q)&&$&&u.push(G)}function U(e){e&&"AbortError"!==e.name&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code&&L(e)}q.on("error",U),v(q)&&$&&u.push((()=>{q.removeListener("error",U)}))}if(0===W)if("function"==typeof q){if(I=q({signal:a}),!w(I))throw new d("Iterable, AsyncIterable or Stream","source",I)}else I=w(q)||S(q)||A(q)?q:c.from(q);else if("function"==typeof q){var D;if(A(I))I=x(null===(D=I)||void 0===D?void 0:D.readable);else I=x(I);if(I=q(I,{signal:a}),H){if(!w(I,!0))throw new d("AsyncIterable",`transform[${W-1}]`,I)}else{var F;O||(O=e("./passthrough"));const Q=new O({objectMode:!0}),Y=null===(F=I)||void 0===F?void 0:F.then;if("function"==typeof Y)C++,Y.call(I,(e=>{g=e,null!=e&&Q.write(e),V&&Q.end(),n.nextTick(L)}),(e=>{Q.destroy(e),n.nextTick(L,e)}));else if(w(I,!0))C++,M(I,Q,L,{end:V});else{if(!T(I)&&!A(I))throw new d("AsyncIterable or Promise","destination",I);{const X=I.readable||I;C++,M(X,Q,L,{end:V})}}I=Q;const{destroy:J,cleanup:Z}=P(I,!1,!0);y.push(J),$&&u.push(Z)}}else if(E(q)){if(S(I)){C+=2;const ee=j(I,q,L,{end:V});v(q)&&$&&u.push(ee)}else if(A(I)||T(I)){const te=I.readable||I;C++,M(te,q,L,{end:V})}else{if(!w(I))throw new f("val",["Readable","Iterable","AsyncIterable","ReadableStream","TransformStream"],I);C++,M(I,q,L,{end:V})}I=q}else if(k(q)){if(S(I))C++,B(x(I),q,L,{end:V});else if(T(I)||w(I))C++,B(I,q,L,{end:V});else{if(!A(I))throw new f("val",["Readable","Iterable","AsyncIterable","ReadableStream","TransformStream"],I);C++,B(I.readable,q,L,{end:V})}I=q}else I=c.from(q)}return(null!=a&&a.aborted||null!=l&&l.aborted)&&n.nextTick(h),I}function j(e,t,r,{end:i}){let s=!1;if(t.on("close",(()=>{s||r(new g)})),e.pipe(t,{end:!1}),i){function o(){s=!0,t.end()}I(e)?n.nextTick(o):e.once("end",o)}else r();return a(e,{readable:!0,writable:!1},(t=>{const n=e._readableState;t&&"ERR_STREAM_PREMATURE_CLOSE"===t.code&&n&&n.ended&&!n.errored&&!n.errorEmitted?e.once("end",r).once("error",r):r(t)})),a(t,{readable:!1,writable:!0},r)}t.exports={pipelineImpl:L,pipeline:function(...e){return L(e,l(function(e){return y(e[e.length-1],"streams[stream.length - 1]"),e.pop()}(e)))}}},{"../../ours/errors":126,"../../ours/primordials":127,"../../ours/util":128,"../validators":124,"./destroy":110,"./duplex":111,"./end-of-stream":113,"./passthrough":117,"./readable":119,"./utils":122,"abort-controller":24,"process/":102}],119:[function(e,t,r){const n=e("process/"),{ArrayPrototypeIndexOf:i,NumberIsInteger:s,NumberIsNaN:o,NumberParseInt:a,ObjectDefineProperties:l,ObjectKeys:u,ObjectSetPrototypeOf:c,Promise:h,SafeSet:f,SymbolAsyncIterator:d,Symbol:p}=e("../../ours/primordials");t.exports=D,D.ReadableState=U;const{EventEmitter:b}=e("events"),{Stream:g,prependListener:m}=e("./legacy"),{Buffer:y}=e("buffer"),{addAbortSignal:_}=e("./add-abort-signal"),w=e("./end-of-stream");let v=e("../../ours/util").debuglog("stream",(e=>{v=e}));const S=e("./buffer_list"),E=e("./destroy"),{getHighWaterMark:A,getDefaultHighWaterMark:k}=e("./state"),{aggregateTwoErrors:T,codes:{ERR_INVALID_ARG_TYPE:I,ERR_METHOD_NOT_IMPLEMENTED:R,ERR_OUT_OF_RANGE:O,ERR_STREAM_PUSH_AFTER_EOF:C,ERR_STREAM_UNSHIFT_AFTER_END_EVENT:P}}=e("../../ours/errors"),{validateObject:x}=e("../validators"),M=p("kPaused"),{StringDecoder:B}=e("string_decoder"),L=e("./from");c(D.prototype,g.prototype),c(D,g);const j=()=>{},{errorOrDestroy:N}=E;function U(t,r,n){"boolean"!=typeof n&&(n=r instanceof e("./duplex")),this.objectMode=!(!t||!t.objectMode),n&&(this.objectMode=this.objectMode||!(!t||!t.readableObjectMode)),this.highWaterMark=t?A(this,t,"readableHighWaterMark",n):k(!1),this.buffer=new S,this.length=0,this.pipes=[],this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.constructed=!0,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this[M]=null,this.errorEmitted=!1,this.emitClose=!t||!1!==t.emitClose,this.autoDestroy=!t||!1!==t.autoDestroy,this.destroyed=!1,this.errored=null,this.closed=!1,this.closeEmitted=!1,this.defaultEncoding=t&&t.defaultEncoding||"utf8",this.awaitDrainWriters=null,this.multiAwaitDrain=!1,this.readingMore=!1,this.dataEmitted=!1,this.decoder=null,this.encoding=null,t&&t.encoding&&(this.decoder=new B(t.encoding),this.encoding=t.encoding)}function D(t){if(!(this instanceof D))return new D(t);const r=this instanceof e("./duplex");this._readableState=new U(t,this,r),t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.construct&&(this._construct=t.construct),t.signal&&!r&&_(t.signal,this)),g.call(this,t),E.construct(this,(()=>{this._readableState.needReadable&&V(this,this._readableState)}))}function F(e,t,r,n){v("readableAddChunk",t);const i=e._readableState;let s;if(i.objectMode||("string"==typeof t?(r=r||i.defaultEncoding,i.encoding!==r&&(n&&i.encoding?t=y.from(t,r).toString(i.encoding):(t=y.from(t,r),r=""))):t instanceof y?r="":g._isUint8Array(t)?(t=g._uint8ArrayToBuffer(t),r=""):null!=t&&(s=new I("chunk",["string","Buffer","Uint8Array"],t))),s)N(e,s);else if(null===t)i.reading=!1,function(e,t){if(v("onEofChunk"),t.ended)return;if(t.decoder){const e=t.decoder.end();e&&e.length&&(t.buffer.push(e),t.length+=t.objectMode?1:e.length)}t.ended=!0,t.sync?H(e):(t.needReadable=!1,t.emittedReadable=!0,z(e))}(e,i);else if(i.objectMode||t&&t.length>0)if(n)if(i.endEmitted)N(e,new P);else{if(i.destroyed||i.errored)return!1;W(e,i,t,!0)}else if(i.ended)N(e,new C);else{if(i.destroyed||i.errored)return!1;i.reading=!1,i.decoder&&!r?(t=i.decoder.write(t),i.objectMode||0!==t.length?W(e,i,t,!1):V(e,i)):W(e,i,t,!1)}else n||(i.reading=!1,V(e,i));return!i.ended&&(i.length<i.highWaterMark||0===i.length)}function W(e,t,r,n){t.flowing&&0===t.length&&!t.sync&&e.listenerCount("data")>0?(t.multiAwaitDrain?t.awaitDrainWriters.clear():t.awaitDrainWriters=null,t.dataEmitted=!0,e.emit("data",r)):(t.length+=t.objectMode?1:r.length,n?t.buffer.unshift(r):t.buffer.push(r),t.needReadable&&H(e)),V(e,t)}D.prototype.destroy=E.destroy,D.prototype._undestroy=E.undestroy,D.prototype._destroy=function(e,t){t(e)},D.prototype[b.captureRejectionSymbol]=function(e){this.destroy(e)},D.prototype.push=function(e,t){return F(this,e,t,!1)},D.prototype.unshift=function(e,t){return F(this,e,t,!0)},D.prototype.isPaused=function(){const e=this._readableState;return!0===e[M]||!1===e.flowing},D.prototype.setEncoding=function(e){const t=new B(e);this._readableState.decoder=t,this._readableState.encoding=this._readableState.decoder.encoding;const r=this._readableState.buffer;let n="";for(const e of r)n+=t.write(e);return r.clear(),""!==n&&r.push(n),this._readableState.length=n.length,this};function q(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:o(e)?t.flowing&&t.length?t.buffer.first().length:t.length:e<=t.length?e:t.ended?t.length:0}function H(e){const t=e._readableState;v("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(v("emitReadable",t.flowing),t.emittedReadable=!0,n.nextTick(z,e))}function z(e){const t=e._readableState;v("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||t.errored||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,Y(e)}function V(e,t){!t.readingMore&&t.constructed&&(t.readingMore=!0,n.nextTick($,e,t))}function $(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){const r=t.length;if(v("maybeReadMore read 0"),e.read(0),r===t.length)break}t.readingMore=!1}function K(e){const t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!1===t[M]?t.flowing=!0:e.listenerCount("data")>0?e.resume():t.readableListening||(t.flowing=null)}function G(e){v("readable nexttick read 0"),e.read(0)}function Q(e,t){v("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),Y(e),t.flowing&&!t.reading&&e.read(0)}function Y(e){const t=e._readableState;for(v("flow",t.flowing);t.flowing&&null!==e.read(););}function J(e,t){"function"!=typeof e.read&&(e=D.wrap(e,{objectMode:!0}));const r=async function*(e,t){let r,n=j;function i(t){this===e?(n(),n=j):n=t}e.on("readable",i);const s=w(e,{writable:!1},(e=>{r=e?T(r,e):null,n(),n=j}));try{for(;;){const t=e.destroyed?null:e.read();if(null!==t)yield t;else{if(r)throw r;if(null===r)return;await new h(i)}}}catch(e){throw r=T(r,e),r}finally{!r&&!1===(null==t?void 0:t.destroyOnReturn)||void 0!==r&&!e._readableState.autoDestroy?(e.off("readable",i),s()):E.destroyer(e,null)}}(e,t);return r.stream=e,r}function Z(e,t){if(0===t.length)return null;let r;return t.objectMode?r=t.buffer.shift():!e||e>=t.length?(r=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):r=t.buffer.consume(e,t.decoder),r}function X(e){const t=e._readableState;v("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,n.nextTick(ee,t,e))}function ee(e,t){if(v("endReadableNT",e.endEmitted,e.length),!e.errored&&!e.closeEmitted&&!e.endEmitted&&0===e.length)if(e.endEmitted=!0,t.emit("end"),t.writable&&!1===t.allowHalfOpen)n.nextTick(te,t);else if(e.autoDestroy){const e=t._writableState;(!e||e.autoDestroy&&(e.finished||!1===e.writable))&&t.destroy()}}function te(e){e.writable&&!e.writableEnded&&!e.destroyed&&e.end()}let re;function ne(){return void 0===re&&(re={}),re}D.prototype.read=function(e){v("read",e),void 0===e?e=NaN:s(e)||(e=a(e,10));const t=this._readableState,r=e;if(e>t.highWaterMark&&(t.highWaterMark=function(e){if(e>1073741824)throw new O("size","<= 1GiB",e);return e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,++e}(e)),0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return v("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?X(this):H(this),null;if(0===(e=q(e,t))&&t.ended)return 0===t.length&&X(this),null;let n,i=t.needReadable;if(v("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&(i=!0,v("length less than watermark",i)),t.ended||t.reading||t.destroyed||t.errored||!t.constructed)i=!1,v("reading, ended or constructing",i);else if(i){v("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0);try{this._read(t.highWaterMark)}catch(e){N(this,e)}t.sync=!1,t.reading||(e=q(r,t))}return n=e>0?Z(e,t):null,null===n?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.multiAwaitDrain?t.awaitDrainWriters.clear():t.awaitDrainWriters=null),0===t.length&&(t.ended||(t.needReadable=!0),r!==e&&t.ended&&X(this)),null===n||t.errorEmitted||t.closeEmitted||(t.dataEmitted=!0,this.emit("data",n)),n},D.prototype._read=function(e){throw new R("_read()")},D.prototype.pipe=function(e,t){const r=this,i=this._readableState;1===i.pipes.length&&(i.multiAwaitDrain||(i.multiAwaitDrain=!0,i.awaitDrainWriters=new f(i.awaitDrainWriters?[i.awaitDrainWriters]:[]))),i.pipes.push(e),v("pipe count=%d opts=%j",i.pipes.length,t);const s=(!t||!1!==t.end)&&e!==n.stdout&&e!==n.stderr?a:g;function o(t,n){v("onunpipe"),t===r&&n&&!1===n.hasUnpiped&&(n.hasUnpiped=!0,function(){v("cleanup"),e.removeListener("close",p),e.removeListener("finish",b),l&&e.removeListener("drain",l);e.removeListener("error",d),e.removeListener("unpipe",o),r.removeListener("end",a),r.removeListener("end",g),r.removeListener("data",h),u=!0,l&&i.awaitDrainWriters&&(!e._writableState||e._writableState.needDrain)&&l()}())}function a(){v("onend"),e.end()}let l;i.endEmitted?n.nextTick(s):r.once("end",s),e.on("unpipe",o);let u=!1;function c(){u||(1===i.pipes.length&&i.pipes[0]===e?(v("false write response, pause",0),i.awaitDrainWriters=e,i.multiAwaitDrain=!1):i.pipes.length>1&&i.pipes.includes(e)&&(v("false write response, pause",i.awaitDrainWriters.size),i.awaitDrainWriters.add(e)),r.pause()),l||(l=function(e,t){return function(){const r=e._readableState;r.awaitDrainWriters===t?(v("pipeOnDrain",1),r.awaitDrainWriters=null):r.multiAwaitDrain&&(v("pipeOnDrain",r.awaitDrainWriters.size),r.awaitDrainWriters.delete(t)),r.awaitDrainWriters&&0!==r.awaitDrainWriters.size||!e.listenerCount("data")||e.resume()}}(r,e),e.on("drain",l))}function h(t){v("ondata");const r=e.write(t);v("dest.write",r),!1===r&&c()}function d(t){if(v("onerror",t),g(),e.removeListener("error",d),0===e.listenerCount("error")){const r=e._writableState||e._readableState;r&&!r.errorEmitted?N(e,t):e.emit("error",t)}}function p(){e.removeListener("finish",b),g()}function b(){v("onfinish"),e.removeListener("close",p),g()}function g(){v("unpipe"),r.unpipe(e)}return r.on("data",h),m(e,"error",d),e.once("close",p),e.once("finish",b),e.emit("pipe",r),!0===e.writableNeedDrain?i.flowing&&c():i.flowing||(v("pipe resume"),r.resume()),e},D.prototype.unpipe=function(e){const t=this._readableState;if(0===t.pipes.length)return this;if(!e){const e=t.pipes;t.pipes=[],this.pause();for(let t=0;t<e.length;t++)e[t].emit("unpipe",this,{hasUnpiped:!1});return this}const r=i(t.pipes,e);return-1===r||(t.pipes.splice(r,1),0===t.pipes.length&&this.pause(),e.emit("unpipe",this,{hasUnpiped:!1})),this},D.prototype.on=function(e,t){const r=g.prototype.on.call(this,e,t),i=this._readableState;return"data"===e?(i.readableListening=this.listenerCount("readable")>0,!1!==i.flowing&&this.resume()):"readable"===e&&(i.endEmitted||i.readableListening||(i.readableListening=i.needReadable=!0,i.flowing=!1,i.emittedReadable=!1,v("on readable",i.length,i.reading),i.length?H(this):i.reading||n.nextTick(G,this))),r},D.prototype.addListener=D.prototype.on,D.prototype.removeListener=function(e,t){const r=g.prototype.removeListener.call(this,e,t);return"readable"===e&&n.nextTick(K,this),r},D.prototype.off=D.prototype.removeListener,D.prototype.removeAllListeners=function(e){const t=g.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||n.nextTick(K,this),t},D.prototype.resume=function(){const e=this._readableState;return e.flowing||(v("resume"),e.flowing=!e.readableListening,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,n.nextTick(Q,e,t))}(this,e)),e[M]=!1,this},D.prototype.pause=function(){return v("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(v("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState[M]=!0,this},D.prototype.wrap=function(e){let t=!1;e.on("data",(r=>{!this.push(r)&&e.pause&&(t=!0,e.pause())})),e.on("end",(()=>{this.push(null)})),e.on("error",(e=>{N(this,e)})),e.on("close",(()=>{this.destroy()})),e.on("destroy",(()=>{this.destroy()})),this._read=()=>{t&&e.resume&&(t=!1,e.resume())};const r=u(e);for(let t=1;t<r.length;t++){const n=r[t];void 0===this[n]&&"function"==typeof e[n]&&(this[n]=e[n].bind(e))}return this},D.prototype[d]=function(){return J(this)},D.prototype.iterator=function(e){return void 0!==e&&x(e,"options"),J(this,e)},l(D.prototype,{readable:{__proto__:null,get(){const e=this._readableState;return!(!e||!1===e.readable||e.destroyed||e.errorEmitted||e.endEmitted)},set(e){this._readableState&&(this._readableState.readable=!!e)}},readableDidRead:{__proto__:null,enumerable:!1,get:function(){return this._readableState.dataEmitted}},readableAborted:{__proto__:null,enumerable:!1,get:function(){return!(!1===this._readableState.readable||!this._readableState.destroyed&&!this._readableState.errored||this._readableState.endEmitted)}},readableHighWaterMark:{__proto__:null,enumerable:!1,get:function(){return this._readableState.highWaterMark}},readableBuffer:{__proto__:null,enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}},readableFlowing:{__proto__:null,enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}},readableLength:{__proto__:null,enumerable:!1,get(){return this._readableState.length}},readableObjectMode:{__proto__:null,enumerable:!1,get(){return!!this._readableState&&this._readableState.objectMode}},readableEncoding:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.encoding:null}},errored:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.errored:null}},closed:{__proto__:null,get(){return!!this._readableState&&this._readableState.closed}},destroyed:{__proto__:null,enumerable:!1,get(){return!!this._readableState&&this._readableState.destroyed},set(e){this._readableState&&(this._readableState.destroyed=e)}},readableEnded:{__proto__:null,enumerable:!1,get(){return!!this._readableState&&this._readableState.endEmitted}}}),l(U.prototype,{pipesCount:{__proto__:null,get(){return this.pipes.length}},paused:{__proto__:null,get(){return!1!==this[M]},set(e){this[M]=!!e}}}),D._fromList=Z,D.from=function(e,t){return L(D,e,t)},D.fromWeb=function(e,t){return ne().newStreamReadableFromReadableStream(e,t)},D.toWeb=function(e,t){return ne().newReadableStreamFromStreamReadable(e,t)},D.wrap=function(e,t){var r,n;return new D({objectMode:null===(r=null!==(n=e.readableObjectMode)&&void 0!==n?n:e.objectMode)||void 0===r||r,...t,destroy(t,r){E.destroyer(e,t),r(t)}}).wrap(e)}},{"../../ours/errors":126,"../../ours/primordials":127,"../../ours/util":128,"../validators":124,"./add-abort-signal":107,"./buffer_list":108,"./destroy":110,"./duplex":111,"./end-of-stream":113,"./from":114,"./legacy":115,"./state":120,buffer:29,events:49,"process/":102,string_decoder:28}],120:[function(e,t,r){"use strict";const{MathFloor:n,NumberIsInteger:i}=e("../../ours/primordials"),{ERR_INVALID_ARG_VALUE:s}=e("../../ours/errors").codes;function o(e){return e?16:16384}t.exports={getHighWaterMark:function(e,t,r,a){const l=function(e,t,r){return null!=e.highWaterMark?e.highWaterMark:t?e[r]:null}(t,a,r);if(null!=l){if(!i(l)||l<0){throw new s(a?`options.${r}`:"options.highWaterMark",l)}return n(l)}return o(e.objectMode)},getDefaultHighWaterMark:o}},{"../../ours/errors":126,"../../ours/primordials":127}],121:[function(e,t,r){"use strict";const{ObjectSetPrototypeOf:n,Symbol:i}=e("../../ours/primordials");t.exports=u;const{ERR_METHOD_NOT_IMPLEMENTED:s}=e("../../ours/errors").codes,o=e("./duplex"),{getHighWaterMark:a}=e("./state");n(u.prototype,o.prototype),n(u,o);const l=i("kCallback");function u(e){if(!(this instanceof u))return new u(e);const t=e?a(this,e,"readableHighWaterMark",!0):null;0===t&&(e={...e,highWaterMark:null,readableHighWaterMark:t,writableHighWaterMark:e.writableHighWaterMark||0}),o.call(this,e),this._readableState.sync=!1,this[l]=null,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",h)}function c(e){"function"!=typeof this._flush||this.destroyed?(this.push(null),e&&e()):this._flush(((t,r)=>{t?e?e(t):this.destroy(t):(null!=r&&this.push(r),this.push(null),e&&e())}))}function h(){this._final!==c&&c.call(this)}u.prototype._final=c,u.prototype._transform=function(e,t,r){throw new s("_transform()")},u.prototype._write=function(e,t,r){const n=this._readableState,i=this._writableState,s=n.length;this._transform(e,t,((e,t)=>{e?r(e):(null!=t&&this.push(t),i.ended||s===n.length||n.length<n.highWaterMark?r():this[l]=r)}))},u.prototype._read=function(){if(this[l]){const e=this[l];this[l]=null,e()}}},{"../../ours/errors":126,"../../ours/primordials":127,"./duplex":111,"./state":120}],122:[function(e,t,r){"use strict";const{Symbol:n,SymbolAsyncIterator:i,SymbolIterator:s,SymbolFor:o}=e("../../ours/primordials"),a=n("kDestroyed"),l=n("kIsErrored"),u=n("kIsReadable"),c=n("kIsDisturbed"),h=o("nodejs.webstream.isClosedPromise"),f=o("nodejs.webstream.controllerErrorFunction");function d(e,t=!1){var r;return!(!e||"function"!=typeof e.pipe||"function"!=typeof e.on||t&&("function"!=typeof e.pause||"function"!=typeof e.resume)||e._writableState&&!1===(null===(r=e._readableState)||void 0===r?void 0:r.readable)||e._writableState&&!e._readableState)}function p(e){var t;return!(!e||"function"!=typeof e.write||"function"!=typeof e.on||e._readableState&&!1===(null===(t=e._writableState)||void 0===t?void 0:t.writable))}function b(e){return e&&(e._readableState||e._writableState||"function"==typeof e.write&&"function"==typeof e.on||"function"==typeof e.pipe&&"function"==typeof e.on)}function g(e){return!(!e||b(e)||"function"!=typeof e.pipeThrough||"function"!=typeof e.getReader||"function"!=typeof e.cancel)}function m(e){return!(!e||b(e)||"function"!=typeof e.getWriter||"function"!=typeof e.abort)}function y(e){return!(!e||b(e)||"object"!=typeof e.readable||"object"!=typeof e.writable)}function _(e){if(!b(e))return null;const t=e._writableState,r=e._readableState,n=t||r;return!!(e.destroyed||e[a]||null!=n&&n.destroyed)}function w(e){if(!p(e))return null;if(!0===e.writableEnded)return!0;const t=e._writableState;return(null==t||!t.errored)&&("boolean"!=typeof(null==t?void 0:t.ended)?null:t.ended)}function v(e,t){if(!d(e))return null;const r=e._readableState;return(null==r||!r.errored)&&("boolean"!=typeof(null==r?void 0:r.endEmitted)?null:!!(r.endEmitted||!1===t&&!0===r.ended&&0===r.length))}function S(e){return e&&null!=e[u]?e[u]:"boolean"!=typeof(null==e?void 0:e.readable)?null:!_(e)&&(d(e)&&e.readable&&!v(e))}function E(e){return"boolean"!=typeof(null==e?void 0:e.writable)?null:!_(e)&&(p(e)&&e.writable&&!w(e))}function A(e){return"boolean"==typeof e._closed&&"boolean"==typeof e._defaultKeepAlive&&"boolean"==typeof e._removedConnection&&"boolean"==typeof e._removedContLen}function k(e){return"boolean"==typeof e._sent100&&A(e)}t.exports={kDestroyed:a,isDisturbed:function(e){var t;return!(!e||!(null!==(t=e[c])&&void 0!==t?t:e.readableDidRead||e.readableAborted))},kIsDisturbed:c,isErrored:function(e){var t,r,n,i,s,o,a,u,c,h;return!(!e||!(null!==(t=null!==(r=null!==(n=null!==(i=null!==(s=null!==(o=e[l])&&void 0!==o?o:e.readableErrored)&&void 0!==s?s:e.writableErrored)&&void 0!==i?i:null===(a=e._readableState)||void 0===a?void 0:a.errorEmitted)&&void 0!==n?n:null===(u=e._writableState)||void 0===u?void 0:u.errorEmitted)&&void 0!==r?r:null===(c=e._readableState)||void 0===c?void 0:c.errored)&&void 0!==t?t:null===(h=e._writableState)||void 0===h?void 0:h.errored))},kIsErrored:l,isReadable:S,kIsReadable:u,kIsClosedPromise:h,kControllerErrorFunction:f,isClosed:function(e){if(!b(e))return null;if("boolean"==typeof e.closed)return e.closed;const t=e._writableState,r=e._readableState;return"boolean"==typeof(null==t?void 0:t.closed)||"boolean"==typeof(null==r?void 0:r.closed)?(null==t?void 0:t.closed)||(null==r?void 0:r.closed):"boolean"==typeof e._closed&&A(e)?e._closed:null},isDestroyed:_,isDuplexNodeStream:function(e){return!(!e||"function"!=typeof e.pipe||!e._readableState||"function"!=typeof e.on||"function"!=typeof e.write)},isFinished:function(e,t){return b(e)?!!_(e)||(!1===(null==t?void 0:t.readable)||!S(e))&&(!1===(null==t?void 0:t.writable)||!E(e)):null},isIterable:function(e,t){return null!=e&&(!0===t?"function"==typeof e[i]:!1===t?"function"==typeof e[s]:"function"==typeof e[i]||"function"==typeof e[s])},isReadableNodeStream:d,isReadableStream:g,isReadableEnded:function(e){if(!d(e))return null;if(!0===e.readableEnded)return!0;const t=e._readableState;return!(!t||t.errored)&&("boolean"!=typeof(null==t?void 0:t.ended)?null:t.ended)},isReadableFinished:v,isReadableErrored:function(e){var t,r;return b(e)?e.readableErrored?e.readableErrored:null!==(t=null===(r=e._readableState)||void 0===r?void 0:r.errored)&&void 0!==t?t:null:null},isNodeStream:b,isWebStream:function(e){return g(e)||m(e)||y(e)},isWritable:E,isWritableNodeStream:p,isWritableStream:m,isWritableEnded:w,isWritableFinished:function(e,t){if(!p(e))return null;if(!0===e.writableFinished)return!0;const r=e._writableState;return(null==r||!r.errored)&&("boolean"!=typeof(null==r?void 0:r.finished)?null:!!(r.finished||!1===t&&!0===r.ended&&0===r.length))},isWritableErrored:function(e){var t,r;return b(e)?e.writableErrored?e.writableErrored:null!==(t=null===(r=e._writableState)||void 0===r?void 0:r.errored)&&void 0!==t?t:null:null},isServerRequest:function(e){var t;return"boolean"==typeof e._consuming&&"boolean"==typeof e._dumped&&void 0===(null===(t=e.req)||void 0===t?void 0:t.upgradeOrConnect)},isServerResponse:k,willEmitClose:function(e){if(!b(e))return null;const t=e._writableState,r=e._readableState,n=t||r;return!n&&k(e)||!!(n&&n.autoDestroy&&n.emitClose&&!1===n.closed)},isTransformStream:y}},{"../../ours/primordials":127}],123:[function(e,t,r){const n=e("process/"),{ArrayPrototypeSlice:i,Error:s,FunctionPrototypeSymbolHasInstance:o,ObjectDefineProperty:a,ObjectDefineProperties:l,ObjectSetPrototypeOf:u,StringPrototypeToLowerCase:c,Symbol:h,SymbolHasInstance:f}=e("../../ours/primordials");t.exports=B,B.WritableState=x;const{EventEmitter:d}=e("events"),p=e("./legacy").Stream,{Buffer:b}=e("buffer"),g=e("./destroy"),{addAbortSignal:m}=e("./add-abort-signal"),{getHighWaterMark:y,getDefaultHighWaterMark:_}=e("./state"),{ERR_INVALID_ARG_TYPE:w,ERR_METHOD_NOT_IMPLEMENTED:v,ERR_MULTIPLE_CALLBACK:S,ERR_STREAM_CANNOT_PIPE:E,ERR_STREAM_DESTROYED:A,ERR_STREAM_ALREADY_FINISHED:k,ERR_STREAM_NULL_VALUES:T,ERR_STREAM_WRITE_AFTER_END:I,ERR_UNKNOWN_ENCODING:R}=e("../../ours/errors").codes,{errorOrDestroy:O}=g;function C(){}u(B.prototype,p.prototype),u(B,p);const P=h("kOnFinished");function x(t,r,n){"boolean"!=typeof n&&(n=r instanceof e("./duplex")),this.objectMode=!(!t||!t.objectMode),n&&(this.objectMode=this.objectMode||!(!t||!t.writableObjectMode)),this.highWaterMark=t?y(this,t,"writableHighWaterMark",n):_(!1),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;const i=!(!t||!1!==t.decodeStrings);this.decodeStrings=!i,this.defaultEncoding=t&&t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=U.bind(void 0,r),this.writecb=null,this.writelen=0,this.afterWriteTickInfo=null,M(this),this.pendingcb=0,this.constructed=!0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!t||!1!==t.emitClose,this.autoDestroy=!t||!1!==t.autoDestroy,this.errored=null,this.closed=!1,this.closeEmitted=!1,this[P]=[]}function M(e){e.buffered=[],e.bufferedIndex=0,e.allBuffers=!0,e.allNoop=!0}function B(t){const r=this instanceof e("./duplex");if(!r&&!o(B,this))return new B(t);this._writableState=new x(t,this,r),t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final),"function"==typeof t.construct&&(this._construct=t.construct),t.signal&&m(t.signal,this)),p.call(this,t),g.construct(this,(()=>{const e=this._writableState;e.writing||q(this,e),V(this,e)}))}function L(e,t,r,i){const s=e._writableState;if("function"==typeof r)i=r,r=s.defaultEncoding;else{if(r){if("buffer"!==r&&!b.isEncoding(r))throw new R(r)}else r=s.defaultEncoding;"function"!=typeof i&&(i=C)}if(null===t)throw new T;if(!s.objectMode)if("string"==typeof t)!1!==s.decodeStrings&&(t=b.from(t,r),r="buffer");else if(t instanceof b)r="buffer";else{if(!p._isUint8Array(t))throw new w("chunk",["string","Buffer","Uint8Array"],t);t=p._uint8ArrayToBuffer(t),r="buffer"}let o;return s.ending?o=new I:s.destroyed&&(o=new A("write")),o?(n.nextTick(i,o),O(e,o,!0),o):(s.pendingcb++,function(e,t,r,n,i){const s=t.objectMode?1:r.length;t.length+=s;const o=t.length<t.highWaterMark;o||(t.needDrain=!0);t.writing||t.corked||t.errored||!t.constructed?(t.buffered.push({chunk:r,encoding:n,callback:i}),t.allBuffers&&"buffer"!==n&&(t.allBuffers=!1),t.allNoop&&i!==C&&(t.allNoop=!1)):(t.writelen=s,t.writecb=i,t.writing=!0,t.sync=!0,e._write(r,n,t.onwrite),t.sync=!1);return o&&!t.errored&&!t.destroyed}(e,s,t,r,i))}function j(e,t,r,n,i,s,o){t.writelen=n,t.writecb=o,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new A("write")):r?e._writev(i,t.onwrite):e._write(i,s,t.onwrite),t.sync=!1}function N(e,t,r,n){--t.pendingcb,n(r),W(t),O(e,r)}function U(e,t){const r=e._writableState,i=r.sync,s=r.writecb;"function"==typeof s?(r.writing=!1,r.writecb=null,r.length-=r.writelen,r.writelen=0,t?(t.stack,r.errored||(r.errored=t),e._readableState&&!e._readableState.errored&&(e._readableState.errored=t),i?n.nextTick(N,e,r,t,s):N(e,r,t,s)):(r.buffered.length>r.bufferedIndex&&q(e,r),i?null!==r.afterWriteTickInfo&&r.afterWriteTickInfo.cb===s?r.afterWriteTickInfo.count++:(r.afterWriteTickInfo={count:1,cb:s,stream:e,state:r},n.nextTick(D,r.afterWriteTickInfo)):F(e,r,1,s))):O(e,new S)}function D({stream:e,state:t,count:r,cb:n}){return t.afterWriteTickInfo=null,F(e,t,r,n)}function F(e,t,r,n){for(!t.ending&&!e.destroyed&&0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"));r-- >0;)t.pendingcb--,n();t.destroyed&&W(t),V(e,t)}function W(e){if(e.writing)return;for(let r=e.bufferedIndex;r<e.buffered.length;++r){var t;const{chunk:n,callback:i}=e.buffered[r],s=e.objectMode?1:n.length;e.length-=s,i(null!==(t=e.errored)&&void 0!==t?t:new A("write"))}const r=e[P].splice(0);for(let t=0;t<r.length;t++){var n;r[t](null!==(n=e.errored)&&void 0!==n?n:new A("end"))}M(e)}function q(e,t){if(t.corked||t.bufferProcessing||t.destroyed||!t.constructed)return;const{buffered:r,bufferedIndex:n,objectMode:s}=t,o=r.length-n;if(!o)return;let a=n;if(t.bufferProcessing=!0,o>1&&e._writev){t.pendingcb-=o-1;const n=t.allNoop?C:e=>{for(let t=a;t<r.length;++t)r[t].callback(e)},s=t.allNoop&&0===a?r:i(r,a);s.allBuffers=t.allBuffers,j(e,t,!0,t.length,s,"",n),M(t)}else{do{const{chunk:n,encoding:i,callback:o}=r[a];r[a++]=null;j(e,t,!1,s?1:n.length,n,i,o)}while(a<r.length&&!t.writing);a===r.length?M(t):a>256?(r.splice(0,a),t.bufferedIndex=0):t.bufferedIndex=a}t.bufferProcessing=!1}function H(e){return e.ending&&!e.destroyed&&e.constructed&&0===e.length&&!e.errored&&0===e.buffered.length&&!e.finished&&!e.writing&&!e.errorEmitted&&!e.closeEmitted}function z(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.finalCalled=!0,function(e,t){let r=!1;function i(i){if(r)O(e,null!=i?i:S());else if(r=!0,t.pendingcb--,i){const r=t[P].splice(0);for(let e=0;e<r.length;e++)r[e](i);O(e,i,t.sync)}else H(t)&&(t.prefinished=!0,e.emit("prefinish"),t.pendingcb++,n.nextTick($,e,t))}t.sync=!0,t.pendingcb++;try{e._final(i)}catch(e){i(e)}t.sync=!1}(e,t)))}function V(e,t,r){H(t)&&(z(e,t),0===t.pendingcb&&(r?(t.pendingcb++,n.nextTick(((e,t)=>{H(t)?$(e,t):t.pendingcb--}),e,t)):H(t)&&(t.pendingcb++,$(e,t))))}function $(e,t){t.pendingcb--,t.finished=!0;const r=t[P].splice(0);for(let e=0;e<r.length;e++)r[e]();if(e.emit("finish"),t.autoDestroy){const t=e._readableState;(!t||t.autoDestroy&&(t.endEmitted||!1===t.readable))&&e.destroy()}}x.prototype.getBuffer=function(){return i(this.buffered,this.bufferedIndex)},a(x.prototype,"bufferedRequestCount",{__proto__:null,get(){return this.buffered.length-this.bufferedIndex}}),a(B,f,{__proto__:null,value:function(e){return!!o(this,e)||this===B&&(e&&e._writableState instanceof x)}}),B.prototype.pipe=function(){O(this,new E)},B.prototype.write=function(e,t,r){return!0===L(this,e,t,r)},B.prototype.cork=function(){this._writableState.corked++},B.prototype.uncork=function(){const e=this._writableState;e.corked&&(e.corked--,e.writing||q(this,e))},B.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=c(e)),!b.isEncoding(e))throw new R(e);return this._writableState.defaultEncoding=e,this},B.prototype._write=function(e,t,r){if(!this._writev)throw new v("_write()");this._writev([{chunk:e,encoding:t}],r)},B.prototype._writev=null,B.prototype.end=function(e,t,r){const i=this._writableState;let o;if("function"==typeof e?(r=e,e=null,t=null):"function"==typeof t&&(r=t,t=null),null!=e){const r=L(this,e,t);r instanceof s&&(o=r)}return i.corked&&(i.corked=1,this.uncork()),o||(i.errored||i.ending?i.finished?o=new k("end"):i.destroyed&&(o=new A("end")):(i.ending=!0,V(this,i,!0),i.ended=!0)),"function"==typeof r&&(o||i.finished?n.nextTick(r,o):i[P].push(r)),this},l(B.prototype,{closed:{__proto__:null,get(){return!!this._writableState&&this._writableState.closed}},destroyed:{__proto__:null,get(){return!!this._writableState&&this._writableState.destroyed},set(e){this._writableState&&(this._writableState.destroyed=e)}},writable:{__proto__:null,get(){const e=this._writableState;return!(!e||!1===e.writable||e.destroyed||e.errored||e.ending||e.ended)},set(e){this._writableState&&(this._writableState.writable=!!e)}},writableFinished:{__proto__:null,get(){return!!this._writableState&&this._writableState.finished}},writableObjectMode:{__proto__:null,get(){return!!this._writableState&&this._writableState.objectMode}},writableBuffer:{__proto__:null,get(){return this._writableState&&this._writableState.getBuffer()}},writableEnded:{__proto__:null,get(){return!!this._writableState&&this._writableState.ending}},writableNeedDrain:{__proto__:null,get(){const e=this._writableState;return!!e&&(!e.destroyed&&!e.ending&&e.needDrain)}},writableHighWaterMark:{__proto__:null,get(){return this._writableState&&this._writableState.highWaterMark}},writableCorked:{__proto__:null,get(){return this._writableState?this._writableState.corked:0}},writableLength:{__proto__:null,get(){return this._writableState&&this._writableState.length}},errored:{__proto__:null,enumerable:!1,get(){return this._writableState?this._writableState.errored:null}},writableAborted:{__proto__:null,enumerable:!1,get:function(){return!(!1===this._writableState.writable||!this._writableState.destroyed&&!this._writableState.errored||this._writableState.finished)}}});const K=g.destroy;let G;function Q(){return void 0===G&&(G={}),G}B.prototype.destroy=function(e,t){const r=this._writableState;return!r.destroyed&&(r.bufferedIndex<r.buffered.length||r[P].length)&&n.nextTick(W,r),K.call(this,e,t),this},B.prototype._undestroy=g.undestroy,B.prototype._destroy=function(e,t){t(e)},B.prototype[d.captureRejectionSymbol]=function(e){this.destroy(e)},B.fromWeb=function(e,t){return Q().newStreamWritableFromWritableStream(e,t)},B.toWeb=function(e){return Q().newWritableStreamFromStreamWritable(e)}},{"../../ours/errors":126,"../../ours/primordials":127,"./add-abort-signal":107,"./destroy":110,"./duplex":111,"./legacy":115,"./state":120,buffer:29,events:49,"process/":102}],124:[function(e,t,r){"use strict";const{ArrayIsArray:n,ArrayPrototypeincs:i,ArrayPrototypeJoin:s,ArrayPrototypeMap:o,NumberIsInteger:a,NumberIsNaN:l,NumberMAX_SAFE_INTEGER:u,NumberMIN_SAFE_INTEGER:c,NumberParseInt:h,ObjectPrototypeHasOwnProperty:f,RegExpPrototypeExec:d,String:p,StringPrototypeToUpperCase:b,StringPrototypeTrim:g}=e("../ours/primordials"),{hideStackFrames:m,codes:{ERR_SOCKET_BAD_PORT:y,ERR_INVALID_ARG_TYPE:_,ERR_INVALID_ARG_VALUE:w,ERR_OUT_OF_RANGE:v,ERR_UNKNOWN_SIGNAL:S}}=e("../ours/errors"),{normalizeEncoding:E}=e("../ours/util"),{isAsyncFunction:A,isArrayBufferView:k}=e("../ours/util").types,T={};const I=/^[0-7]+$/;const R=m(((e,t,r=c,n=u)=>{if("number"!=typeof e)throw new _(t,"number",e);if(!a(e))throw new v(t,"an integer",e);if(e<r||e>n)throw new v(t,`>= ${r} && <= ${n}`,e)})),O=m(((e,t,r=-2147483648,n=2147483647)=>{if("number"!=typeof e)throw new _(t,"number",e);if(!a(e))throw new v(t,"an integer",e);if(e<r||e>n)throw new v(t,`>= ${r} && <= ${n}`,e)})),C=m(((e,t,r=!1)=>{if("number"!=typeof e)throw new _(t,"number",e);if(!a(e))throw new v(t,"an integer",e);const n=r?1:0,i=4294967295;if(e<n||e>i)throw new v(t,`>= ${n} && <= ${i}`,e)}));function P(e,t){if("string"!=typeof e)throw new _(t,"string",e)}const x=m(((e,t,r)=>{if(!i(r,e)){const n=s(o(r,(e=>"string"==typeof e?`'${e}'`:p(e))),", ");throw new w(t,e,"must be one of: "+n)}}));function M(e,t){if("boolean"!=typeof e)throw new _(t,"boolean",e)}function B(e,t,r){return null!=e&&f(e,t)?e[t]:r}const L=m(((e,t,r=null)=>{const i=B(r,"allowArray",!1),s=B(r,"allowFunction",!1);if(!B(r,"nullable",!1)&&null===e||!i&&n(e)||"object"!=typeof e&&(!s||"function"!=typeof e))throw new _(t,"Object",e)})),j=m(((e,t)=>{if(null!=e&&"object"!=typeof e&&"function"!=typeof e)throw new _(t,"a dictionary",e)})),N=m(((e,t,r=0)=>{if(!n(e))throw new _(t,"Array",e);if(e.length<r){throw new w(t,e,`must be longer than ${r}`)}}));const U=m(((e,t="buffer")=>{if(!k(e))throw new _(t,["Buffer","TypedArray","DataView"],e)}));const D=m(((e,t)=>{if(void 0!==e&&(null===e||"object"!=typeof e||!("aborted"in e)))throw new _(t,"AbortSignal",e)})),F=m(((e,t)=>{if("function"!=typeof e)throw new _(t,"Function",e)})),W=m(((e,t)=>{if("function"!=typeof e||A(e))throw new _(t,"Function",e)})),q=m(((e,t)=>{if(void 0!==e)throw new _(t,"undefined",e)}));const H=/^(?:<[^>]*>)(?:\s*;\s*[^;"\s]+(?:=(")?[^;"\s]*\1)?)*$/;function z(e,t){if(void 0===e||!d(H,e))throw new w(t,e,'must be an array or string of format "</styles.css>; rel=preload; as=style"')}t.exports={isInt32:function(e){return e===(0|e)},isUint32:function(e){return e===e>>>0},parseFileMode:function(e,t,r){if(void 0===e&&(e=r),"string"==typeof e){if(null===d(I,e))throw new w(t,e,"must be a 32-bit unsigned integer or an octal string");e=h(e,8)}return C(e,t),e},validateArray:N,validateStringArray:function(e,t){N(e,t);for(let r=0;r<e.length;r++)P(e[r],`${t}[${r}]`)},validateBooleanArray:function(e,t){N(e,t);for(let r=0;r<e.length;r++)M(e[r],`${t}[${r}]`)},validateBoolean:M,validateBuffer:U,validateDictionary:j,validateEncoding:function(e,t){const r=E(t),n=e.length;if("hex"===r&&n%2!=0)throw new w("encoding",t,`is invalid for data of length ${n}`)},validateFunction:F,validateInt32:O,validateInteger:R,validateNumber:function(e,t,r=void 0,n){if("number"!=typeof e)throw new _(t,"number",e);if(null!=r&&e<r||null!=n&&e>n||(null!=r||null!=n)&&l(e))throw new v(t,`${null!=r?`>= ${r}`:""}${null!=r&&null!=n?" && ":""}${null!=n?`<= ${n}`:""}`,e)},validateObject:L,validateOneOf:x,validatePlainFunction:W,validatePort:function(e,t="Port",r=!0){if("number"!=typeof e&&"string"!=typeof e||"string"==typeof e&&0===g(e).length||+e!=+e>>>0||e>65535||0===e&&!r)throw new y(t,e,r);return 0|e},validateSignalName:function(e,t="signal"){if(P(e,t),void 0===T[e]){if(void 0!==T[b(e)])throw new S(e+" (signals must use all capital letters)");throw new S(e)}},validateString:P,validateUint32:C,validateUndefined:q,validateUnion:function(e,t,r){if(!i(r,e))throw new _(t,`('${s(r,"|")}')`,e)},validateAbortSignal:D,validateLinkHeaderValue:function(e){if("string"==typeof e)return z(e,"hints"),e;if(n(e)){const t=e.length;let r="";if(0===t)return r;for(let n=0;n<t;n++){const i=e[n];z(i,"hints"),r+=i,n!==t-1&&(r+=", ")}return r}throw new w("hints",e,'must be an array or string of format "</styles.css>; rel=preload; as=style"')}}},{"../ours/errors":126,"../ours/primordials":127,"../ours/util":128}],125:[function(e,t,r){"use strict";const n=e("../stream"),i=e("../stream/promises"),s=n.Readable.destroy;t.exports=n.Readable,t.exports._uint8ArrayToBuffer=n._uint8ArrayToBuffer,t.exports._isUint8Array=n._isUint8Array,t.exports.isDisturbed=n.isDisturbed,t.exports.isErrored=n.isErrored,t.exports.isReadable=n.isReadable,t.exports.Readable=n.Readable,t.exports.Writable=n.Writable,t.exports.Duplex=n.Duplex,t.exports.Transform=n.Transform,t.exports.PassThrough=n.PassThrough,t.exports.addAbortSignal=n.addAbortSignal,t.exports.finished=n.finished,t.exports.destroy=n.destroy,t.exports.destroy=s,t.exports.pipeline=n.pipeline,t.exports.compose=n.compose,Object.defineProperty(n,"promises",{configurable:!0,enumerable:!0,get:()=>i}),t.exports.Stream=n.Stream,t.exports.default=t.exports},{"../stream":129,"../stream/promises":130}],126:[function(e,t,r){"use strict";const{format:n,inspect:i,AggregateError:s}=e("./util"),o=globalThis.AggregateError||s,a=Symbol("kIsNodeError"),l=["string","function","number","object","Function","Object","boolean","bigint","symbol"],u=/^([A-Z][a-z0-9]*)+$/,c={};function h(e,t){if(!e)throw new c.ERR_INTERNAL_ASSERTION(t)}function f(e){let t="",r=e.length;const n="-"===e[0]?1:0;for(;r>=n+4;r-=3)t=`_${e.slice(r-3,r)}${t}`;return`${e.slice(0,r)}${t}`}function d(e,t,r){r||(r=Error);class i extends r{constructor(...r){super(function(e,t,r){if("function"==typeof t)return h(t.length<=r.length,`Code: ${e}; The provided arguments length (${r.length}) does not match the required ones (${t.length}).`),t(...r);const i=(t.match(/%[dfijoOs]/g)||[]).length;return h(i===r.length,`Code: ${e}; The provided arguments length (${r.length}) does not match the required ones (${i}).`),0===r.length?t:n(t,...r)}(e,t,r))}toString(){return`${this.name} [${e}]: ${this.message}`}}Object.defineProperties(i.prototype,{name:{value:r.name,writable:!0,enumerable:!1,configurable:!0},toString:{value(){return`${this.name} [${e}]: ${this.message}`},writable:!0,enumerable:!1,configurable:!0}}),i.prototype.code=e,i.prototype[a]=!0,c[e]=i}function p(e){const t="__node_internal_"+e.name;return Object.defineProperty(e,"name",{value:t}),e}class b extends Error{constructor(e="The operation was aborted",t=void 0){if(void 0!==t&&"object"!=typeof t)throw new c.ERR_INVALID_ARG_TYPE("options","Object",t);super(e,t),this.code="ABORT_ERR",this.name="AbortError"}}d("ERR_ASSERTION","%s",Error),d("ERR_INVALID_ARG_TYPE",((e,t,r)=>{h("string"==typeof e,"'name' must be a string"),Array.isArray(t)||(t=[t]);let n="The ";e.endsWith(" argument")?n+=`${e} `:n+=`"${e}" ${e.includes(".")?"property":"argument"} `,n+="must be ";const s=[],o=[],a=[];for(const e of t)h("string"==typeof e,"All expected entries have to be of type string"),l.includes(e)?s.push(e.toLowerCase()):u.test(e)?o.push(e):(h("object"!==e,'The value "object" should be written as "Object"'),a.push(e));if(o.length>0){const e=s.indexOf("object");-1!==e&&(s.splice(s,e,1),o.push("Object"))}if(s.length>0){switch(s.length){case 1:n+=`of type ${s[0]}`;break;case 2:n+=`one of type ${s[0]} or ${s[1]}`;break;default:{const e=s.pop();n+=`one of type ${s.join(", ")}, or ${e}`}}(o.length>0||a.length>0)&&(n+=" or ")}if(o.length>0){switch(o.length){case 1:n+=`an instance of ${o[0]}`;break;case 2:n+=`an instance of ${o[0]} or ${o[1]}`;break;default:{const e=o.pop();n+=`an instance of ${o.join(", ")}, or ${e}`}}a.length>0&&(n+=" or ")}switch(a.length){case 0:break;case 1:a[0].toLowerCase()!==a[0]&&(n+="an "),n+=`${a[0]}`;break;case 2:n+=`one of ${a[0]} or ${a[1]}`;break;default:{const e=a.pop();n+=`one of ${a.join(", ")}, or ${e}`}}if(null==r)n+=`. Received ${r}`;else if("function"==typeof r&&r.name)n+=`. Received function ${r.name}`;else if("object"==typeof r){var c;if(null!==(c=r.constructor)&&void 0!==c&&c.name)n+=`. Received an instance of ${r.constructor.name}`;else{n+=`. Received ${i(r,{depth:-1})}`}}else{let e=i(r,{colors:!1});e.length>25&&(e=`${e.slice(0,25)}...`),n+=`. Received type ${typeof r} (${e})`}return n}),TypeError),d("ERR_INVALID_ARG_VALUE",((e,t,r="is invalid")=>{let n=i(t);n.length>128&&(n=n.slice(0,128)+"...");return`The ${e.includes(".")?"property":"argument"} '${e}' ${r}. Received ${n}`}),TypeError),d("ERR_INVALID_RETURN_VALUE",((e,t,r)=>{var n;return`Expected ${e} to be returned from the "${t}" function but got ${null!=r&&null!==(n=r.constructor)&&void 0!==n&&n.name?`instance of ${r.constructor.name}`:"type "+typeof r}.`}),TypeError),d("ERR_MISSING_ARGS",((...e)=>{let t;h(e.length>0,"At least one arg needs to be specified");const r=e.length;switch(e=(Array.isArray(e)?e:[e]).map((e=>`"${e}"`)).join(" or "),r){case 1:t+=`The ${e[0]} argument`;break;case 2:t+=`The ${e[0]} and ${e[1]} arguments`;break;default:{const r=e.pop();t+=`The ${e.join(", ")}, and ${r} arguments`}}return`${t} must be specified`}),TypeError),d("ERR_OUT_OF_RANGE",((e,t,r)=>{let n;return h(t,'Missing "range" argument'),Number.isInteger(r)&&Math.abs(r)>2**32?n=f(String(r)):"bigint"==typeof r?(n=String(r),(r>2n**32n||r<-(2n**32n))&&(n=f(n)),n+="n"):n=i(r),`The value of "${e}" is out of range. It must be ${t}. Received ${n}`}),RangeError),d("ERR_MULTIPLE_CALLBACK","Callback called multiple times",Error),d("ERR_METHOD_NOT_IMPLEMENTED","The %s method is not implemented",Error),d("ERR_STREAM_ALREADY_FINISHED","Cannot call %s after a stream was finished",Error),d("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable",Error),d("ERR_STREAM_DESTROYED","Cannot call %s after a stream was destroyed",Error),d("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),d("ERR_STREAM_PREMATURE_CLOSE","Premature close",Error),d("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF",Error),d("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event",Error),d("ERR_STREAM_WRITE_AFTER_END","write after end",Error),d("ERR_UNKNOWN_ENCODING","Unknown encoding: %s",TypeError),t.exports={AbortError:b,aggregateTwoErrors:p((function(e,t){if(e&&t&&e!==t){if(Array.isArray(t.errors))return t.errors.push(e),t;const r=new o([t,e],t.message);return r.code=t.code,r}return e||t})),hideStackFrames:p,codes:c}},{"./util":128}],127:[function(e,t,r){"use strict";t.exports={ArrayIsArray:e=>Array.isArray(e),ArrayPrototypeincs:(e,t)=>e.includes(t),ArrayPrototypeIndexOf:(e,t)=>e.indexOf(t),ArrayPrototypeJoin:(e,t)=>e.join(t),ArrayPrototypeMap:(e,t)=>e.map(t),ArrayPrototypePop:(e,t)=>e.pop(t),ArrayPrototypePush:(e,t)=>e.push(t),ArrayPrototypeSlice:(e,t,r)=>e.slice(t,r),Error:Error,FunctionPrototypeCall:(e,t,...r)=>e.call(t,...r),FunctionPrototypeSymbolHasInstance:(e,t)=>Function.prototype[Symbol.hasInstance].call(e,t),MathFloor:Math.floor,Number:Number,NumberIsInteger:Number.isInteger,NumberIsNaN:Number.isNaN,NumberMAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,NumberMIN_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,NumberParseInt:Number.parseInt,ObjectDefineProperties:(e,t)=>Object.defineProperties(e,t),ObjectDefineProperty:(e,t,r)=>Object.defineProperty(e,t,r),ObjectGetOwnPropertyDescriptor:(e,t)=>Object.getOwnPropertyDescriptor(e,t),ObjectKeys:e=>Object.keys(e),ObjectSetPrototypeOf:(e,t)=>Object.setPrototypeOf(e,t),Promise:Promise,PromisePrototypeCatch:(e,t)=>e.catch(t),PromisePrototypeThen:(e,t,r)=>e.then(t,r),PromiseReject:e=>Promise.reject(e),ReflectApply:Reflect.apply,RegExpPrototypeTest:(e,t)=>e.test(t),SafeSet:Set,String:String,StringPrototypeSlice:(e,t,r)=>e.slice(t,r),StringPrototypeToLowerCase:e=>e.toLowerCase(),StringPrototypeToUpperCase:e=>e.toUpperCase(),StringPrototypeTrim:e=>e.trim(),Symbol:Symbol,SymbolFor:Symbol.for,SymbolAsyncIterator:Symbol.asyncIterator,SymbolHasInstance:Symbol.hasInstance,SymbolIterator:Symbol.iterator,TypedArrayPrototypeSet:(e,t,r)=>e.set(t,r),Uint8Array:Uint8Array}},{}],128:[function(e,t,r){"use strict";const n=e("buffer"),i=Object.getPrototypeOf((async function(){})).constructor,s=globalThis.Blob||n.Blob,o=void 0!==s?function(e){return e instanceof s}:function(e){return!1};class a extends Error{constructor(e){if(!Array.isArray(e))throw new TypeError("Expected input to be an Array, got "+typeof e);let t="";for(let r=0;r<e.length;r++)t+=`    ${e[r].stack}\n`;super(t),this.name="AggregateError",this.errors=e}}t.exports={AggregateError:a,kEmptyObject:Object.freeze({}),once(e){let t=!1;return function(...r){t||(t=!0,e.apply(this,r))}},createDeferredPromise:function(){let e,t;return{promise:new Promise(((r,n)=>{e=r,t=n})),resolve:e,reject:t}},promisify:e=>new Promise(((t,r)=>{e(((e,...n)=>e?r(e):t(...n)))})),debuglog:()=>function(){},format:(e,...t)=>e.replace(/%([sdifj])/g,(function(...[e,r]){const n=t.shift();if("f"===r)return n.toFixed(6);if("j"===r)return JSON.stringify(n);if("s"===r&&"object"==typeof n){return`${n.constructor!==Object?n.constructor.name:""} {}`.trim()}return n.toString()})),inspect(e){switch(typeof e){case"string":if(e.includes("'")){if(!e.includes('"'))return`"${e}"`;if(!e.includes("`")&&!e.includes("${"))return`\`${e}\``}return`'${e}'`;case"number":return isNaN(e)?"NaN":Object.is(e,-0)?String(e):e;case"bigint":return`${String(e)}n`;case"boolean":case"undefined":return String(e);case"object":return"{}"}},types:{isAsyncFunction:e=>e instanceof i,isArrayBufferView:e=>ArrayBuffer.isView(e)},isBlob:o},t.exports.promisify.custom=Symbol.for("nodejs.util.promisify.custom")},{buffer:29}],129:[function(e,t,r){const{Buffer:n}=e("buffer"),{ObjectDefineProperty:i,ObjectKeys:s,ReflectApply:o}=e("./ours/primordials"),{promisify:{custom:a}}=e("./ours/util"),{streamReturningOperators:l,promiseReturningOperators:u}=e("./internal/streams/operators"),{codes:{ERR_ILLEGAL_CONSTRUCTOR:c}}=e("./ours/errors"),h=e("./internal/streams/compose"),{pipeline:f}=e("./internal/streams/pipeline"),{destroyer:d}=e("./internal/streams/destroy"),p=e("./internal/streams/end-of-stream"),b=e("./stream/promises"),g=e("./internal/streams/utils"),m=t.exports=e("./internal/streams/legacy").Stream;m.isDisturbed=g.isDisturbed,m.isErrored=g.isErrored,m.isReadable=g.isReadable,m.Readable=e("./internal/streams/readable");for(const w of s(l)){const v=l[w];function y(...e){if(new.target)throw c();return m.Readable.from(o(v,this,e))}i(y,"name",{__proto__:null,value:v.name}),i(y,"length",{__proto__:null,value:v.length}),i(m.Readable.prototype,w,{__proto__:null,value:y,enumerable:!1,configurable:!0,writable:!0})}for(const S of s(u)){const E=u[S];function y(...e){if(new.target)throw c();return o(E,this,e)}i(y,"name",{__proto__:null,value:E.name}),i(y,"length",{__proto__:null,value:E.length}),i(m.Readable.prototype,S,{__proto__:null,value:y,enumerable:!1,configurable:!0,writable:!0})}m.Writable=e("./internal/streams/writable"),m.Duplex=e("./internal/streams/duplex"),m.Transform=e("./internal/streams/transform"),m.PassThrough=e("./internal/streams/passthrough"),m.pipeline=f;const{addAbortSignal:_}=e("./internal/streams/add-abort-signal");m.addAbortSignal=_,m.finished=p,m.destroy=d,m.compose=h,i(m,"promises",{__proto__:null,configurable:!0,enumerable:!0,get:()=>b}),i(f,a,{__proto__:null,enumerable:!0,get:()=>b.pipeline}),i(p,a,{__proto__:null,enumerable:!0,get:()=>b.finished}),m.Stream=m,m._isUint8Array=function(e){return e instanceof Uint8Array},m._uint8ArrayToBuffer=function(e){return n.from(e.buffer,e.byteOffset,e.byteLength)}},{"./internal/streams/add-abort-signal":107,"./internal/streams/compose":109,"./internal/streams/destroy":110,"./internal/streams/duplex":111,"./internal/streams/end-of-stream":113,"./internal/streams/legacy":115,"./internal/streams/operators":116,"./internal/streams/passthrough":117,"./internal/streams/pipeline":118,"./internal/streams/readable":119,"./internal/streams/transform":121,"./internal/streams/utils":122,"./internal/streams/writable":123,"./ours/errors":126,"./ours/primordials":127,"./ours/util":128,"./stream/promises":130,buffer:29}],130:[function(e,t,r){"use strict";const{ArrayPrototypePop:n,Promise:i}=e("../ours/primordials"),{isIterable:s,isNodeStream:o,isWebStream:a}=e("../internal/streams/utils"),{pipelineImpl:l}=e("../internal/streams/pipeline"),{finished:u}=e("../internal/streams/end-of-stream");e("../../lib/stream.js"),t.exports={finished:u,pipeline:function(...e){return new i(((t,r)=>{let i,u;const c=e[e.length-1];if(c&&"object"==typeof c&&!o(c)&&!s(c)&&!a(c)){const t=n(e);i=t.signal,u=t.end}l(e,((e,n)=>{e?r(e):t(n)}),{signal:i,end:u})}))}}},{"../../lib/stream.js":129,"../internal/streams/end-of-stream":113,"../internal/streams/pipeline":118,"../internal/streams/utils":122,"../ours/primordials":127}],131:[function(e,t,r){"use strict";function n(e,t,r){var n=this;this._callback=e,this._args=r,this._interval=setInterval(e,t,this._args),this.reschedule=function(e){e||(e=n._interval),n._interval&&clearInterval(n._interval),n._interval=setInterval(n._callback,e,n._args)},this.clear=function(){n._interval&&(clearInterval(n._interval),n._interval=void 0)},this.destroy=function(){n._interval&&clearInterval(n._interval),n._callback=void 0,n._interval=void 0,n._args=void 0}}t.exports=function(){if("function"!=typeof arguments[0])throw new Error("callback needed");if("number"!=typeof arguments[1])throw new Error("interval needed");var e;if(arguments.length>0){e=new Array(arguments.length-2);for(var t=0;t<e.length;t++)e[t]=arguments[t+2]}return new n(arguments[0],arguments[1],e)}},{}],132:[function(e,t,r){"use strict";t.exports=e("./index.js")()},{"./index.js":133}],133:[function(e,t,r){(function(e){(function(){"use strict";function r(t){return t instanceof e?e.from(t):new t.constructor(t.buffer.slice(),t.byteOffset,t.length)}t.exports=function(e){return(e=e||{}).circles?function(e){var t=[],n=[];return e.proto?function e(s){if("object"!=typeof s||null===s)return s;if(s instanceof Date)return new Date(s);if(Array.isArray(s))return i(s,e);if(s instanceof Map)return new Map(i(Array.from(s),e));if(s instanceof Set)return new Set(i(Array.from(s),e));var o={};for(var a in t.push(s),n.push(o),s){var l=s[a];if("object"!=typeof l||null===l)o[a]=l;else if(l instanceof Date)o[a]=new Date(l);else if(l instanceof Map)o[a]=new Map(i(Array.from(l),e));else if(l instanceof Set)o[a]=new Set(i(Array.from(l),e));else if(ArrayBuffer.isView(l))o[a]=r(l);else{var u=t.indexOf(l);o[a]=-1!==u?n[u]:e(l)}}return t.pop(),n.pop(),o}:function e(s){if("object"!=typeof s||null===s)return s;if(s instanceof Date)return new Date(s);if(Array.isArray(s))return i(s,e);if(s instanceof Map)return new Map(i(Array.from(s),e));if(s instanceof Set)return new Set(i(Array.from(s),e));var o={};for(var a in t.push(s),n.push(o),s)if(!1!==Object.hasOwnProperty.call(s,a)){var l=s[a];if("object"!=typeof l||null===l)o[a]=l;else if(l instanceof Date)o[a]=new Date(l);else if(l instanceof Map)o[a]=new Map(i(Array.from(l),e));else if(l instanceof Set)o[a]=new Set(i(Array.from(l),e));else if(ArrayBuffer.isView(l))o[a]=r(l);else{var u=t.indexOf(l);o[a]=-1!==u?n[u]:e(l)}}return t.pop(),n.pop(),o};function i(e,i){for(var s=Object.keys(e),o=new Array(s.length),a=0;a<s.length;a++){var l=s[a],u=e[l];if("object"!=typeof u||null===u)o[l]=u;else if(u instanceof Date)o[l]=new Date(u);else if(ArrayBuffer.isView(u))o[l]=r(u);else{var c=t.indexOf(u);o[l]=-1!==c?n[c]:i(u)}}return o}}(e):e.proto?function e(n){if("object"!=typeof n||null===n)return n;if(n instanceof Date)return new Date(n);if(Array.isArray(n))return t(n,e);if(n instanceof Map)return new Map(t(Array.from(n),e));if(n instanceof Set)return new Set(t(Array.from(n),e));var i={};for(var s in n){var o=n[s];"object"!=typeof o||null===o?i[s]=o:o instanceof Date?i[s]=new Date(o):o instanceof Map?i[s]=new Map(t(Array.from(o),e)):o instanceof Set?i[s]=new Set(t(Array.from(o),e)):ArrayBuffer.isView(o)?i[s]=r(o):i[s]=e(o)}return i}:function e(n){if("object"!=typeof n||null===n)return n;if(n instanceof Date)return new Date(n);if(Array.isArray(n))return t(n,e);if(n instanceof Map)return new Map(t(Array.from(n),e));if(n instanceof Set)return new Set(t(Array.from(n),e));var i={};for(var s in n)if(!1!==Object.hasOwnProperty.call(n,s)){var o=n[s];"object"!=typeof o||null===o?i[s]=o:o instanceof Date?i[s]=new Date(o):o instanceof Map?i[s]=new Map(t(Array.from(o),e)):o instanceof Set?i[s]=new Set(t(Array.from(o),e)):ArrayBuffer.isView(o)?i[s]=r(o):i[s]=e(o)}return i};function t(e,t){for(var n=Object.keys(e),i=new Array(n.length),s=0;s<n.length;s++){var o=n[s],a=e[o];"object"!=typeof a||null===a?i[o]=a:a instanceof Date?i[o]=new Date(a):ArrayBuffer.isView(a)?i[o]=r(a):i[o]=t(a)}return i}}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:29}],134:[function(e,t,r){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var n=e("buffer"),i=n.Buffer;function s(e,t){for(var r in e)t[r]=e[r]}function o(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?t.exports=n:(s(n,r),r.Buffer=o),o.prototype=Object.create(i.prototype),s(i,o),o.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,r)},o.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:29}],135:[function(e,t,r){t.exports=function(e){var t=e._readableState;return t?t.objectMode||"number"==typeof e._duplexState?e.read():e.read(function(e){if(e.buffer.length)return e.buffer.head?e.buffer.head.data.length:e.buffer[0].length;return e.length}(t)):null}},{}],136:[function(e,t,r){arguments[4][28][0].apply(r,arguments)},{dup:28,"safe-buffer":134}],137:[function(e,t,r){"use strict";var n=e("punycode"),i=e("./util");function s(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}r.parse=_,r.resolve=function(e,t){return _(e,!1,!0).resolve(t)},r.resolveObject=function(e,t){return e?_(e,!1,!0).resolveObject(t):t},r.format=function(e){i.isString(e)&&(e=_(e));return e instanceof s?e.format():s.prototype.format.call(e)},r.Url=s;var o=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,l=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,u=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),c=["'"].concat(u),h=["%","/","?",";","#"].concat(c),f=["/","?","#"],d=/^[+a-z0-9A-Z_-]{0,63}$/,p=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,b={javascript:!0,"javascript:":!0},g={javascript:!0,"javascript:":!0},m={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},y=e("querystring");function _(e,t,r){if(e&&i.isObject(e)&&e instanceof s)return e;var n=new s;return n.parse(e,t,r),n}s.prototype.parse=function(e,t,r){if(!i.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var s=e.indexOf("?"),a=-1!==s&&s<e.indexOf("#")?"?":"#",u=e.split(a);u[0]=u[0].replace(/\\/g,"/");var _=e=u.join(a);if(_=_.trim(),!r&&1===e.split("#").length){var w=l.exec(_);if(w)return this.path=_,this.href=_,this.pathname=w[1],w[2]?(this.search=w[2],this.query=t?y.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var v=o.exec(_);if(v){var S=(v=v[0]).toLowerCase();this.protocol=S,_=_.substr(v.length)}if(r||v||_.match(/^\/\/[^@\/]+@[^@\/]+/)){var E="//"===_.substr(0,2);!E||v&&g[v]||(_=_.substr(2),this.slashes=!0)}if(!g[v]&&(E||v&&!m[v])){for(var A,k,T=-1,I=0;I<f.length;I++){-1!==(R=_.indexOf(f[I]))&&(-1===T||R<T)&&(T=R)}-1!==(k=-1===T?_.lastIndexOf("@"):_.lastIndexOf("@",T))&&(A=_.slice(0,k),_=_.slice(k+1),this.auth=decodeURIComponent(A)),T=-1;for(I=0;I<h.length;I++){var R;-1!==(R=_.indexOf(h[I]))&&(-1===T||R<T)&&(T=R)}-1===T&&(T=_.length),this.host=_.slice(0,T),_=_.slice(T),this.parseHost(),this.hostname=this.hostname||"";var O="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!O)for(var C=this.hostname.split(/\./),P=(I=0,C.length);I<P;I++){var x=C[I];if(x&&!x.match(d)){for(var M="",B=0,L=x.length;B<L;B++)x.charCodeAt(B)>127?M+="x":M+=x[B];if(!M.match(d)){var j=C.slice(0,I),N=C.slice(I+1),U=x.match(p);U&&(j.push(U[1]),N.unshift(U[2])),N.length&&(_="/"+N.join(".")+_),this.hostname=j.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),O||(this.hostname=n.toASCII(this.hostname));var D=this.port?":"+this.port:"",F=this.hostname||"";this.host=F+D,this.href+=this.host,O&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==_[0]&&(_="/"+_))}if(!b[S])for(I=0,P=c.length;I<P;I++){var W=c[I];if(-1!==_.indexOf(W)){var q=encodeURIComponent(W);q===W&&(q=escape(W)),_=_.split(W).join(q)}}var H=_.indexOf("#");-1!==H&&(this.hash=_.substr(H),_=_.slice(0,H));var z=_.indexOf("?");if(-1!==z?(this.search=_.substr(z),this.query=_.substr(z+1),t&&(this.query=y.parse(this.query)),_=_.slice(0,z)):t&&(this.search="",this.query={}),_&&(this.pathname=_),m[S]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){D=this.pathname||"";var V=this.search||"";this.path=D+V}return this.href=this.format(),this},s.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",s=!1,o="";this.host?s=e+this.host:this.hostname&&(s=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(s+=":"+this.port)),this.query&&i.isObject(this.query)&&Object.keys(this.query).length&&(o=y.stringify(this.query));var a=this.search||o&&"?"+o||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||m[t])&&!1!==s?(s="//"+(s||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):s||(s=""),n&&"#"!==n.charAt(0)&&(n="#"+n),a&&"?"!==a.charAt(0)&&(a="?"+a),t+s+(r=r.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+n},s.prototype.resolve=function(e){return this.resolveObject(_(e,!1,!0)).format()},s.prototype.resolveObject=function(e){if(i.isString(e)){var t=new s;t.parse(e,!1,!0),e=t}for(var r=new s,n=Object.keys(this),o=0;o<n.length;o++){var a=n[o];r[a]=this[a]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var l=Object.keys(e),u=0;u<l.length;u++){var c=l[u];"protocol"!==c&&(r[c]=e[c])}return m[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!m[e.protocol]){for(var h=Object.keys(e),f=0;f<h.length;f++){var d=h[f];r[d]=e[d]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||g[e.protocol])r.pathname=e.pathname;else{for(var p=(e.pathname||"").split("/");p.length&&!(e.host=p.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==p[0]&&p.unshift(""),p.length<2&&p.unshift(""),r.pathname=p.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var b=r.pathname||"",y=r.search||"";r.path=b+y}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var _=r.pathname&&"/"===r.pathname.charAt(0),w=e.host||e.pathname&&"/"===e.pathname.charAt(0),v=w||_||r.host&&e.pathname,S=v,E=r.pathname&&r.pathname.split("/")||[],A=(p=e.pathname&&e.pathname.split("/")||[],r.protocol&&!m[r.protocol]);if(A&&(r.hostname="",r.port=null,r.host&&(""===E[0]?E[0]=r.host:E.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===p[0]?p[0]=e.host:p.unshift(e.host)),e.host=null),v=v&&(""===p[0]||""===E[0])),w)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,E=p;else if(p.length)E||(E=[]),E.pop(),E=E.concat(p),r.search=e.search,r.query=e.query;else if(!i.isNullOrUndefined(e.search)){if(A)r.hostname=r.host=E.shift(),(O=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=O.shift(),r.host=r.hostname=O.shift());return r.search=e.search,r.query=e.query,i.isNull(r.pathname)&&i.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!E.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var k=E.slice(-1)[0],T=(r.host||e.host||E.length>1)&&("."===k||".."===k)||""===k,I=0,R=E.length;R>=0;R--)"."===(k=E[R])?E.splice(R,1):".."===k?(E.splice(R,1),I++):I&&(E.splice(R,1),I--);if(!v&&!S)for(;I--;I)E.unshift("..");!v||""===E[0]||E[0]&&"/"===E[0].charAt(0)||E.unshift(""),T&&"/"!==E.join("/").substr(-1)&&E.push("");var O,C=""===E[0]||E[0]&&"/"===E[0].charAt(0);A&&(r.hostname=r.host=C?"":E.length?E.shift():"",(O=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=O.shift(),r.host=r.hostname=O.shift()));return(v=v||r.host&&E.length)&&!C&&E.unshift(""),E.length?r.pathname=E.join("/"):(r.pathname=null,r.path=null),i.isNull(r.pathname)&&i.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},s.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},{"./util":138,punycode:103,querystring:106}],138:[function(e,t,r){"use strict";t.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},{}],139:[function(e,t,r){(function(e){(function(){function r(t){try{if(!e.localStorage)return!1}catch(e){return!1}var r=e.localStorage[t];return null!=r&&"true"===String(r).toLowerCase()}t.exports=function(e,t){if(r("noDeprecation"))return e;var n=!1;return function(){if(!n){if(r("throwDeprecation"))throw new Error(t);r("traceDeprecation")?console.trace(t):console.warn(t),n=!0}return e.apply(this,arguments)}}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],140:[function(e,t,r){t.exports=function e(t,r){if(t&&r)return e(t)(r);if("function"!=typeof t)throw new TypeError("need wrapper function");return Object.keys(t).forEach((function(e){n[e]=t[e]})),n;function n(){for(var e=new Array(arguments.length),r=0;r<e.length;r++)e[r]=arguments[r];var n=t.apply(this,e),i=e[e.length-1];return"function"==typeof n&&n!==i&&Object.keys(i).forEach((function(e){n[e]=i[e]})),n}}},{}],141:[function(e,t,r){"use strict";t.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},{}]},{},[23])(23)}));
/*/NON-ESP*/
const HubErrors={None:0,OpenFile:1,FreeSpace:2,CrcMiss:3,SizeMiss:4,Start:5,Write:6,End:7,Abort:8,Timeout:9,Busy:10,Memory:11,WrongClient:12,Forbidden:13,Disabled:14,FsBusy:15,Cancelled:16,};const HubCodes=['api_v','id','client','type','update','updates','get','last','crc32','discover','name','prefix','icon','PIN','version','max_upl','http_t','ota_t','ws_port','modules','total','used','code','OK','ack','info','controls','ui','files','notice','alert','push','script','refresh','print','error','fs_err','ota_next','ota_done','ota_err','fetch_start','fetch_chunk','fetch_err','upload_next','upload_done','upload_err','ota_url_err','ota_url_ok','value','maxlen','rows','regex','align','min','max','step','dec','unit','fsize','action','nolabel','suffix','notab','square','disable','hint','len','wwidth','wheight','data','func','keep','exp','plugin','js','css','ui_file','stream','port','canvas','width','height','active','html','dummy','menu','gauge','gauge_r','gauge_l','led','log','table','image','text','display','text_f','label','title','dpad','joy','flags','tabs','switch_t','switch_i','button','color','select','spinner','slider','datetime','date','time','confirm','prompt','area','pass','input','hook','row','col','space','platform',];
class BluetoothJS{async onopen(){}
async onmessage(data){}
async onclose(){}
async onerror(e){}
getName(){return this.state()?this._device.name:null;}
state(){return(this._device!=null);}
async open(){try{if(this._device)throw"Already open";await this._connectToDevice(this._device);this.onopen();}catch(e){this.onerror(e)}}
async close(){await this._disconnectFromDevice(this._device);if(this._characteristic){this._characteristic.removeEventListener('characteristicvaluechanged',this._change_h);this._characteristic=null;}
if(this._device)this.onclose();this._device=null;}
async send(data){if(!this._characteristic)return this.onerror('No device');this._txbuf.push(data);if(!this._txflag)this._send();}
_maxlen=20;_device=null;_characteristic=null;_serviceUuid=0xFFE0;_characteristicUuid=0xFFE1;_disconnect_h=this._handleDisconnection.bind(this);_change_h=this._btchanged.bind(this);_txbuf=[];_txflag=false;async _send(){this._txflag=true;while(this._txbuf.length){let data=this._txbuf[0];let size=Math.ceil(data.length/this._maxlen);let offset=0;for(let i=0;i<size;i++){if(!this._characteristic){this.onerror('Device has been disconnected');this._txbuf=[];break;}
try{await this._characteristic.writeValue(new TextEncoder().encode(data.substr(offset,this._maxlen)));}catch(e){this.onerror(e);}
offset+=this._maxlen;}
this._txbuf.shift();}
this._txflag=false;}
async _connectToDevice(device){if(!device)device=await this._requestBluetoothDevice();let characteristic=await this._connect(device);await this._startNotifications(characteristic);}
async _disconnectFromDevice(device){if(!device)return;device.removeEventListener('gattserverdisconnected',this._disconnect_h);if(device.gatt.connected)await device.gatt.disconnect();}
async _requestBluetoothDevice(){this._device=await navigator.bluetooth.requestDevice({filters:[{services:[this._serviceUuid]}],});this._device.addEventListener('gattserverdisconnected',this._disconnect_h);return this._device;}
async _connect(device){if(device.gatt.connected&&this._characteristic){return this._characteristic;}
const server=await device.gatt.connect();const service=await server.getPrimaryService(this._serviceUuid);this._characteristic=await service.getCharacteristic(this._characteristicUuid);return this._characteristic;}
async _startNotifications(characteristic){await characteristic.startNotifications();characteristic.addEventListener('characteristicvaluechanged',this._change_h);}
async _stopNotifications(characteristic){await characteristic.stopNotifications();characteristic.removeEventListener('characteristicvaluechanged',this._change_h);}
async _handleDisconnection(event){const device=event.target;this.onclose();try{const characteristic=await this._connect(device);await this._startNotifications(characteristic);}catch(e){this.onerror(e);}}
async _btchanged(event){const value=new TextDecoder().decode(event.target.value);if(value)this.onmessage(value);}}
class Bot{onpoll(){}
onerror(e){}
async onmessage(data){}
timeout=10;period=100;setToken(token){this._token=token;}
start(){this._state=true;this._offset=-1;this._poll();}
stop(){this._state=false;if(this._tout)clearTimeout(this._tout);this._tout=null;}
state(){return this._state&&this._token.length;}
async send(chat,text,params={}){params.chat_id=chat;params.text=text;params.disable_notification=true;let resp=await fetch(`https://api.telegram.org/bot${this._token}/sendMessage`,{method:'POST',body:JSON.stringify(params),headers:{'Content-Type':'application/json;charset=utf-8'},});let data=await resp.json();return data.ok;}
async _poll(){this._tout=null;let data=null;try{let resp=await fetch(`https://api.telegram.org/bot${this._token}/getUpdates?offset=${this._offset}&timeout=${this.timeout}`);data=await resp.json();}catch(e){}
if(data){if(data.ok){for(let upd of data.result){this.onmessage(upd);this._offset=upd.update_id+1;}
if(this._state)this.onpoll();}else{if('description'in data)this.onerror(data.description);else this.onerror('Error');}}else{this.onerror('Error');}
if(this._state)this._tout=setTimeout(()=>this._poll(),this.period);}
_offset=-1;_state=false;_token='';_tout=null;};
class SerialJS{async onportchange(selected){}
async onopen(){}
async onmessage(data){}
async onclose(){}
async onerror(e){}
state(){return(this._port!=null);}
getName(){let id=this._ncport?this._ncport.getInfo().usbProductId:null;switch(id){case 0x7584:return'CH340S';case 0x55d3:return'CH343';case 0x7522:case 0x7523:return'CH340';case 0x5512:case 0x5523:case 0x5584:return'CH341';case 0x9500:case 0x0102:case 0x0501:case 0x80a9:case 0xea60:case 0xea61:case 0xea63:return'CP210x';case 0x0402:case 0x0403:case 0x0404:case 0x0405:case 0x6001:case 0x0602:case 0x6010:return'FT232';case null:return'none';default:return'unknown';}}
async hasPort(){await this.update();return this._ncport!=null;}
async update(){const ports=await navigator.serial.getPorts();this._ncport=ports.length?ports[0]:null;}
async select(){await this.close();const ports=await navigator.serial.getPorts();for(let port of ports)await port.forget();try{await navigator.serial.requestPort();await this.update();await this.onportchange(true);}catch(e){this.onerror(e);await this.update();await this.onportchange(false);}}
async open(baud){try{if(this._port)throw"Already open";const ports=await navigator.serial.getPorts();if(!ports.length)throw"No port";this._port=ports[0];try{await this._port.open({baudRate:baud});this.onopen();await this._readLoop();}finally{await this._port.close();this._port=null;this.onclose();}}catch(e){this.onerror(e);}}
async close(){this._closing=true;if(this._reader)await this._reader.cancel();}
async send(text){if(!this._port)return this.onerror("Not open");try{const encoder=new TextEncoder();const writer=this._port.writable.getWriter();await writer.write(encoder.encode(text));writer.releaseLock();}catch(e){this.onerror(e);}}
async toggle(baud){if(this.state())await this.close();else await this.open(baud);}
_port=null;_reader=null;_closing=false;_ncport=null;async _readLoop(){this._closing=false;while(this._port.readable&&!this._closing){this._reader=this._port.readable.getReader();try{while(true){const read=await this._reader.read();if(read.done)break;const data=new TextDecoder().decode(read.value);this.onmessage(data);}}finally{this._reader.releaseLock();this._reader=null;}}}}
const Conn={SERIAL:0,BT:1,HTTP:2,MQTT:3,NONE:4,names:['Serial','BT','HTTP','MQTT','TG','None'],};const Modules={UI:(1<<0),INFO:(1<<1),SET:(1<<2),READ:(1<<3),GET:(1<<4),DATA:(1<<5),REBOOT:(1<<6),FILES:(1<<7),FORMAT:(1<<8),DELETE:(1<<9),RENAME:(1<<10),CREATE:(1<<11),FETCH:(1<<12),UPLOAD:(1<<13),OTA:(1<<14),OTA_URL:(1<<15),MQTT:(1<<16),};function http_get(url,tout){return new Promise((res,rej)=>{try{let xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200)res(xhr.responseText);else rej("Error");}}
xhr.ontimeout=()=>rej("Timeout");xhr.onerror=()=>rej("Error");xhr.timeout=tout;xhr.open('GET',url,true);xhr.send();}catch(e){rej(e);}});}
function http_fetch(url,onprogress,tout){return new Promise((res,rej)=>{onprogress(0);let xhr=new XMLHttpRequest();xhr.onprogress=(e)=>{onprogress(Math.round(e.loaded*100/e.total));};xhr.onloadend=(e)=>{if(e.loaded&&e.loaded==e.total)res(xhr.responseText);else rej(xhr.responseText);}
xhr.timeout=tout;xhr.ontimeout=(e)=>rej(HubErrors.Timeout);xhr.open('GET',url,true);xhr.send();});}
function http_fetch_blob(url,onprogress,tout){return new Promise((res,rej)=>{onprogress(0);let xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onprogress=(e)=>{onprogress(Math.round(e.loaded*100/e.total));};xhr.onloadend=(e)=>{if(e.loaded==e.total&&xhr.status==200){let reader=new FileReader();reader.readAsDataURL(xhr.response);reader.onloadend=()=>res(reader.result.split('base64,')[1]);}else{if(xhr.response){xhr.response.text().then(res=>rej(res)).catch(e=>rej(e))}else{rej();}}}
xhr.timeout=tout;xhr.ontimeout=(e)=>rej(HubErrors.Timeout);xhr.open('GET',url,true);xhr.send();});}
function http_post(url,data){return new Promise((res,rej)=>{let xhr=new XMLHttpRequest();xhr.onreadystatechange=()=>{if(xhr.readyState==4){if(xhr.status==200)res(xhr.responseText);else rej(xhr.responseText);}}
xhr.open('POST',url,true);xhr.send(data);});}
function checkIP(ip){return Boolean(ip&&ip.match(/^((25[0-5]|(2[0-4]|1[0-9]|[1-9]|)[0-9])(\.(?!$)|$)){4}$/));}
function getIPs(ip,netmask){if(!checkIP(ip)){asyncAlert(lang.wrong_ip);return null;}
let ip_a=ip.split('.');let sum_ip=(ip_a[0]<<24)|(ip_a[1]<<16)|(ip_a[2]<<8)|ip_a[3];let cidr=Number(netmask);let mask=~(0xffffffff>>>cidr);let network=0,broadcast=0,start_ip=0,end_ip=0;if(cidr===32){network=sum_ip;broadcast=network;start_ip=network;end_ip=network;}else{network=sum_ip&mask;broadcast=network+(~mask);if(cidr===31){start_ip=network;end_ip=broadcast;}else{start_ip=network+1;end_ip=broadcast-1;}}
let ips=['192.168.4.1'];for(let ip=start_ip;ip<=end_ip;ip++){ips.push(`${(ip >>> 24) & 0xff}.${(ip >>> 16) & 0xff}.${(ip >>> 8) & 0xff}.${ip & 0xff}`);}
return ips;}
class PacketBuffer{constructor(hub,conn,byletter=false,timeout=600){this._hub=hub;this._conn=conn;this._byletter=byletter;this.timeout=timeout;}
process(data){if(this._tout)clearTimeout(this._tout);this._tout=setTimeout(()=>this._buf='',this.timeout);if(this._byletter){for(let t of data){this._buf+=t;this.check();}}else{this._buf+=data;this.check();}}
check(){if((this._buf.startsWith('\n{')&&this._buf.endsWith('}\n'))||(this._buf.startsWith('#{')&&this._buf.endsWith('}#'))){this._hub._parsePacket(this._conn,this._buf);this._buf='';if(this._tout)clearTimeout(this._tout);this._tout=null;}}
_buf='';_tout=null;};
class Discover{discovering=false;constructor(hub){this._hub=hub;}
_discoverTimer(tout){this.discovering=true;setTimeout(()=>{this.discovering=false;this._hub._checkDiscoverEnd();},tout);}}
class BTconn extends Discover{tout=1000;onConnChange(state){}
getName(){return this.bt.getName();}
constructor(hub){super(hub);this.buf=new PacketBuffer(hub,Conn.BT,true);this.bt=new BluetoothJS();this.bt.onopen=()=>{this.log('Connected');this.onConnChange('open');}
this.bt.onclose=()=>{this.log('Disconnected');this.onConnChange('close');}
this.bt.onerror=(e)=>{this.onConnChange('close');this.err(e);}
this.bt.onmessage=(data)=>this.buf.process(data);}
async discover(){if(this.discovering||!this.bt.state())return;for(let pref of this._hub._preflist())await this.send(pref);this._discoverTimer(this.tout);}
async search(){if(this.discovering||!this.bt.state())return;await this.send(this._hub.cfg.prefix);this._discoverTimer(this.tout);}
async open(){if(!this.bt.state()){this.log('Connecting');this.onConnChange('connecting');await this.bt.open();}}
async close(){await this.bt.close();}
async send(text){await this.bt.send(text+'\0');}
log(t){this._hub.log('[BT] '+t);}
err(e){this._hub.err('[BT] '+e);}}
class TGconn extends Discover{tout=1000;onConnChange(state){}
constructor(hub){super(hub);this.bot=new Bot();this.bot.onpoll=()=>{this._reconnect=true;this.onConnChange(1);}
this.bot.onerror=(e)=>{this.onConnChange(0);this.err(e);this.bot.stop();}
this.bot.onmessage=(data)=>{try{if(data.channel_post.text=='/start'){let msg='Channel *'+data.channel_post.chat.title+'* id: `'+data.channel_post.chat.id+'`';this.bot.send(data.channel_post.chat.id,msg,{parse_mode:"MarkdownV2"});return;}}catch(e){}
try{if(data.channel_post.chat.id!=this._hub.cfg.tg_chat)return;let[id,...rest]=data.channel_post.text.split(':');let data=rest.join(':');if(!this._buffers.hasOwnProperty(id)){this._buffers[id]=new PacketBuffer(this._hub,Conn.TG,false,1500);}
this._buffers[id].process(text);}catch(e){}};setInterval(()=>{if(this._hub.cfg.use_tg&&!this.bot.state()&&this._reconnect)this.start()},3000);}
async discover(){if(this.discovering||!this.bot.state())return;for(let pref of this._hub._preflist())await this.send(pref);this._discoverTimer(this.tout);}
async search(){if(this.discovering||!this.bot.state())return;await this.send(this._hub.cfg.prefix);this._discoverTimer(this.tout);}
async start(){this.bot.setToken(this._hub.cfg.tg_token);this.bot.start();}
async stop(){this.bot.stop();this._reconnect=false;this.onConnChange(0);}
send(text){if(this._hub.cfg.tg_chat.length)this.bot.send(this._hub.cfg.tg_chat,'app:'+text);}
_reconnect=false;_buffers={};log(t){this._hub.log('[TG] '+t);}
err(e){this._hub.err('[TG] '+e);}}
class HTTPconn extends Discover{tout_btw=15;tout=3300;constructor(hub){super(hub);}
discover(){if(this.discovering)return;for(let i in this._hub.devices){setTimeout(()=>{let dev=this._hub.devices[i].info;if(dev.ip)this.send(dev.ip,dev.http_port,`hub/${dev.prefix}/${dev.id}`);},this.tout_btw*i);}
this._discoverTimer(this.tout_btw*this._hub.devices.length+this.tout);}
discover_ip(ip,port){if(!checkIP(ip))return false;if(this.discovering)return false;this.send(ip,port,`hub/${this._hub.cfg.prefix}`);this._discoverTimer(this.tout);return true;}
search(){if(this.discovering)return;let ips=getIPs(this._hub.cfg.local_ip,this._hub.cfg.netmask);if(!ips)return;for(let i in ips){setTimeout(()=>{this.send(ips[i],this._hub.cfg.http_port,`hub/${this._hub.cfg.prefix}`);},this.tout_btw*i);}
this._discoverTimer(this.tout_btw*ips.length+this.tout);}
send(ip,port,uri){http_get(`http://${ip}:${port}/${uri}`,this.tout).then(res=>{if(res.length)this._hub._parsePacket(Conn.HTTP,res,ip,port);}).catch(e=>{});}
log(t){log('[HTTP] '+t);}
err(e){err('[HTTP] '+e);}};
class MQTTconn extends Discover{tout=1500;onConnChange(state){}
constructor(hub){super(hub);setInterval(()=>{if(this._hub.cfg.use_mqtt&&!this.state()&&this._reconnect)this.start()},3000);}
discover(){if(this.discovering)return;if(!this.state()){this._discover_f=true;return;}
for(let dev of this._hub.devices){this.send(dev.info.prefix+'/'+dev.info.id,this._hub.cfg.client_id);}
this._discoverTimer(this.tout);}
search(){if(this.discovering||!this.state())return;this._upd_prefix(this._hub.cfg.prefix);this.send(this._hub.cfg.prefix,this._hub.cfg.client_id);this._discoverTimer(this.tout);}
send(topic,msg=''){if(this.state())this._client.publish(topic,msg);}
state(){return(this._client&&this._client.connected);}
stop(){this._reconnect=false;if(this.state())this._client.end();}
start(){this._reconnect=true;if(this._connecting||this.state()||!this._hub.cfg.mq_host||!this._hub.cfg.mq_port||!this._hub.cfg.use_mqtt)return;const url='wss://'+this._hub.cfg.mq_host+':'+this._hub.cfg.mq_port+'/mqtt';const options={keepalive:60,clientId:'HUB-'+Math.round(Math.random()*0xffffffff).toString(16),username:this._hub.cfg.mq_login,password:this._hub.cfg.mq_pass,protocolId:'MQTT',protocolVersion:4,clean:true,reconnectPeriod:3000,connectTimeout:10*1000}
try{this.log('Connecting');this._client=mqtt.connect(url,options);}catch(e){this.err('Connection fail');this.onConnChange(false);return;}
this._connecting=true;this._client.on('connect',()=>{this._connecting=false;this.log('Connected');this.onConnChange(true);this._preflist=[];this._upd_prefix(this._hub.cfg.prefix);for(let dev of this._hub.devices)this._sub_device(dev.info.prefix,dev.info.id);if(this._discover_f){this._discover_f=false;this.discover();}});this._client.on('error',()=>{this._connecting=false;this.onConnChange(false);this._client.end();this.err('Error');});this._client.on('close',()=>{this._connecting=false;this.onConnChange(false);this._client.end();this.log('Close');});this._client.on('message',(topic,text)=>{topic=topic.toString();text=text.toString();let parts=topic.split('/');if(parts.length<2)return;for(let pref of this._preflist){if(parts[0]!=pref||parts[1]!='hub')continue;if(parts.length==2){this._hub._parsePacket(Conn.MQTT,text);return;}else if(parts.length==4&&parts[2]==this._hub.cfg.client_id){let dev=this._hub.dev(parts[3]);if(dev)dev.mq_buf.process(text);else this._hub._parsePacket(Conn.MQTT,text);return;}else if(parts.length==5&&parts[3]=='get'){let dev=this._hub.dev(parts[2]);if(dev){let upd={};upd[parts[4]]={value:text};dev._checkUpdates(upd);}
return;}}});}
_sub_device(prefix,id){if(!this.state())return;this._client.subscribe(prefix+'/hub/'+id+'/get/#');this._upd_prefix(prefix);}
_upd_prefix(prefix){if(!this._preflist.includes(prefix)){this._preflist.push(prefix);this._client.subscribe(prefix+'/hub');this._client.subscribe(prefix+'/hub/'+this._hub.cfg.client_id+'/#');}}
_connecting=false;_client=null;_discover_f=false;_preflist=[];_reconnect=false;log(t){this._hub.log('[MQTT] '+t);}
err(e){this._hub.err('[MQTT] '+e);}};
class SERIALconn extends Discover{tout=500;onConnChange(state){}
onPortChange(selected){}
constructor(hub){super(hub);this.buf=new PacketBuffer(hub,Conn.SERIAL,true);this.ser=new SerialJS();this.ser.onportchange=(selected)=>this.onPortChange(selected);this.ser.onopen=()=>{this.log('Connected');this.onConnChange(true);}
this.ser.onclose=()=>{this.log('Disconnected');this.onConnChange(false);}
this.ser.onerror=(e)=>this.err(e);this.ser.onmessage=(data)=>this.buf.process(data);}
async discover(){if(this.discovering||!this.ser.state())return;for(let pref of this._hub._preflist())await this.send(pref);this._discoverTimer(this.tout);}
async search(){if(this.discovering||!this.ser.state())return;await this.send(this._hub.cfg.prefix);this._discoverTimer(this.tout);}
getName(){return this.ser.getName();}
async hasPort(){return await this.ser.hasPort();}
async select(){await this.ser.select();}
async open(){await this.ser.open(this._hub.cfg.baudrate);}
async close(){await this.ser.close();}
async send(text){await this.ser.send(text+'\0');}
log(t){this._hub.log('[SERIAL] '+t);}
err(e){this._hub.err('[SERIAL] '+e);}}
class WSconn{constructor(device){this.device=device;}
get info(){return this.device.info;}
start(){this._reconnect=true;if(this._ws)return;this._ws=new WebSocket(`ws://${this.info.ip}:${this.info.ws_port}/`,['hub']);this._ws.onopen=()=>{this.log(`${this.info.id} opened`);if(!this._reconnect)this._ws.close();this.device._hub.onWsConnChange(this.info.id,true);};this._ws.onclose=()=>{this.log(`${this.info.id} closed`);this._ws=null;if(this._reconnect)setTimeout(()=>{if(this._reconnect)this.start()},500);this.device._hub.onWsConnChange(this.info.id,false);};this._ws.onerror=()=>{this.log(`${this.info.id} error`);};this._ws.onmessage=(e)=>{this.device.ws_buf.process(e.data);};}
stop(){this._reconnect=false;if(!this._ws||this._ws.readyState>=2)return;this.log(`${this.info.id} close...`);this._ws.close();}
state(){return(this._ws&&this._ws.readyState==1);}
send(text){if(this.state())this._ws.send(text.toString());}
_ws=null;_reconnect=false;log(t){this.device._hub.log('[WS] '+t);}
err(e){this.device._hub.err('[WS] '+e);}}
class Device{constructor(hub){this._hub=hub;this.ws=new WSconn(this);this.mq_buf=new PacketBuffer(hub,Conn.MQTT);this.ws_buf=new PacketBuffer(hub,Conn.HTTP);}
info={id:'undefined',prefix:'undefined',name:'undefined',icon:'п€›',PIN:0,version:'',max_upl:200,modules:0,ota_t:'.bin',ip:null,http_port:null,ws_port:81,http_t:1,api_v:0,platform:'',};connected(){return!this.conn_lost;}
module(mod){return!(this.info.modules&mod);}
post(cmd,name='',value=''){cmd=cmd.toString();name=name.toString();value=value.toString();if(cmd=='set'){if(!this.module(Modules.SET))return;if(name){if(this.prev_set[name])clearTimeout(this.prev_set[name]);this.prev_set[name]=setTimeout(()=>delete this.prev_set[name],this._hub.skip_prd);}}
let uri0=this.info.prefix+'/'+this.info.id+'/'+this._hub.cfg.client_id+'/'+cmd;let uri=uri0;if(name){uri+='/'+name;if(value)uri+='='+value;}
switch(this.conn){case Conn.HTTP:if(this.ws.state())this.ws.send(uri);else this._hub.http.send(this.info.ip,this.info.http_port,`hub/${uri}`);break;case Conn.SERIAL:this._hub.serial.send(uri);break;case Conn.BT:this._hub.bt.send(uri);break;case Conn.TG:this._hub.tg.send(uri);break;case Conn.MQTT:this._hub.mqtt.send(uri0+(name.length?('/'+name):''),value);break;}
if(this.focused){this._reset_ping();this._reset_tout();}}
focus(){this.focused=true;this.post('ui');if(this.conn==Conn.HTTP&&this.info.ws_port){this.ws.start();setTimeout(()=>{if(!this.ws.state())this.ws.stop();},this._hub.tout_prd);}}
unfocus(){this.focused=false;this._stop_ping();this._stop_tout();this.post('unfocus');if(this.conn==Conn.HTTP)this.ws.stop();}
fsStop(){if(this.fs_mode)this.post('fs_abort',this.fs_mode);this._fsEnd();}
fsBusy(){return!!this.fs_mode;}
async upload(file,path){if(!this.module(Modules.UPLOAD))return;if(this.fsBusy()){this._hub.onFsUploadError(this.info.id,HubErrors.FsBusy);return;}
let reader=new FileReader();reader.readAsArrayBuffer(file);reader.onload=async(e)=>{if(!e.target.result)return;let buffer=new Uint8Array(e.target.result);if(!path.startsWith('/'))path='/'+path;if(!path.endsWith('/'))path+='/';path+=file.name;const res=await asyncConfirm(lang.fs_upload+' '+path+' ('+buffer.length+' bytes)?');if(!res){this._hub.onFsUploadError(this.info.id,HubErrors.Cancelled);return;}
this._hub.onFsUploadStart(this.info.id);this.fs_mode='upload';this.crc32=crc32(buffer);if(this.conn==Conn.HTTP&&this.info.http_t){let formData=new FormData();formData.append('upload',file);http_post(`http://${this.info.ip}:${this.info.http_port}/hub/upload?path=${path}&crc32=${this.crc32}&client_id=${this._hub.cfg.client_id}&size=${buffer.length}`,formData).then(()=>{this._hub.onFsUploadEnd(this.info.id);this._fsEnd();this.post('files');}).catch((e)=>this._hub.onFsUploadError(this.info.id,e)).finally(()=>this._fsEnd());}else{this.upl_bytes=Array.from(buffer);this.upl_size=this.upl_bytes.length;this.post('upload',path,this.upl_size);this._fsToutStart();}}}
async uploadOta(file,type){if(!this.module(Modules.OTA))return;if(this.fsBusy()){this._hub.onOtaError(this.info.id,HubErrors.FsBusy);return;}
if(!file.name.endsWith(this.info.ota_t)){asyncAlert(lang.wrong_ota+' .'+this.info.ota_t);return;}
const res=await asyncConfirm(lang.fs_upload+' OTA '+type+'?');if(!res)return;let reader=new FileReader();reader.readAsArrayBuffer(file);reader.onload=(e)=>{if(!e.target.result)return;this._hub.onOtaStart(this.info.id);this.fs_mode='ota';if(this.conn==Conn.HTTP&&this.info.http_t){let formData=new FormData();formData.append(type,file);http_post(`http://${this.info.ip}:${this.info.http_port}/hub/ota?type=${type}&client_id=${this._hub.cfg.client_id}`,formData).then(()=>this._hub.onOtaEnd(this.info.id)).catch((e)=>this._hub.onOtaError(this.info.id,e)).finally(()=>this._fsEnd());}else{let buffer=new Uint8Array(e.target.result);this.upl_bytes=Array.from(buffer);this.upl_size=this.upl_bytes.length;this.post('ota',type);this._fsToutStart();}}}
fetch(idx,path){if(!this.module(Modules.FETCH))return;let id=this.info.id;if(this.fsBusy()){this._hub.onFsFetchError(id,idx,HubErrors.FsBusy);return;}
this.fs_mode='fetch';this.fet_name=path.split('/').pop();this.fet_index=idx;if(this.conn==Conn.HTTP&&this.info.http_t){http_fetch_blob(`http://${this.info.ip}:${this.info.http_port}/hub/fetch?path=${path}&client_id=${this._hub.cfg.client_id}`,perc=>this._hub.onFsFetchPerc(id,idx,perc),this._hub.http.tout).then(res=>this._hub.onFsFetchEnd(id,this.fet_name,idx,res)).catch(e=>this._hub.onFsFetchError(id,idx,e)).finally(()=>this._fsEnd());}else{this.post('fetch',path);this._fsToutStart();}
this._hub.onFsFetchStart(id,idx);}
resetFiles(){this.files=[];this.file_flag=false;}
addFile(name,path,data){let has=this.files.some(f=>f.name==name);if(!has)this.files.push({name:name,path:path,data:data});if(this.file_flag&&this.files.length==1)this._fetchNextFile();}
checkFiles(){this.file_flag=true;this._fetchNextFile();}
_fetchNextFile(){if(!this.files.length)return;let id=this.info.id;let file=this.files[0];if(this.fsBusy()){this._hub.onFetchError(id,file.name,file.data,HubErrors.FsBusy);return;}
this.fs_mode='fetch_file';this._hub.onFetchStart(id,file.name);if(this.conn==Conn.HTTP&&this.info.http_t){http_fetch_blob(`http://${this.info.ip}:${this.info.http_port}/hub/fetch?path=${file.path}`,perc=>this._hub.onFetchPerc(id,file.name,perc),this._hub.http.tout).then(res=>this._hub.onFetchEnd(id,file.name,file.data,`data:${getMime(file.path)};base64,${res}`)).catch(e=>this._hub.onFetchError(id,file.name,file.data,Number(e))).finally(()=>{this._fsEnd();this._nextFile();});}else{post('fetch',file.path);}}
_fsEnd(){this.fs_mode=null;this._fsToutEnd();}
_nextFile(){this.files.shift();this._fetchNextFile();}
_checkUpdates(updates){if(typeof(updates)!='object')return;for(let name in updates){if(name.includes(';')){name.split(';').forEach(n=>updates[n]=updates[name]);delete updates[name];}}
for(let name in updates){if('value'in updates[name]&&this.prev_set[name])delete updates[name].value;if(Object.keys(updates[name]).length)this._hub.onUpdate(this.info.id,name,updates[name]);}}
_parse(type,data){let id=this.info.id;this._stop_tout();if(this.conn_lost){this.conn_lost=false;this._hub.onPingLost(id);if(this.focused)this._hub.onDeviceConnChange(id,true);}
switch(type){case'OK':break;case'update':this._checkUpdates(data.updates);break;case'fetch_start':if(this.fs_mode!='fetch'&&this.fs_mode!='fetch_file')break;this.fet_len=data.len;this.fet_buf='';this.post('fetch_next');this._fsToutStart();if(this.fs_mode=='fetch'){this._hub.onFsFetchPerc(id,this.fet_index,0);}else{this._hub.onFetchPerc(id,this.files[0].name,0);}
break;case'fetch_chunk':if((this.fs_mode!='fetch'&&this.fs_mode!='fetch_file')||this.fet_buf==null)break;this.fet_buf+=atob(data.data);if(data.last==1){let crc=crc32(this.fet_buf);if(this.fet_buf.length==this.fet_len&&crc==data.crc32){let b64=btoa(this.fet_buf);if(this.fs_mode=='fetch'){this._hub.onFsFetchEnd(id,this.fet_name,this.fet_index,b64);}else{let file=this.files[0];this._hub.onFetchEnd(id,file.name,file.data,`data:${getMime(file.path)};base64,${b64}`);}}else{let code=(crc!=data.crc32)?HubErrors.CrcMiss:HubErrors.SizeMiss;if(this.fs_mode=='fetch'){this._hub.onFsFetchError(id,this.fet_index,code);}else{this._hub.onFetchError(id,this.files[0].name,this.files[0].data,code);}}
this.fet_buf=null;if(this.fs_mode=='fetch_file'){this._fsEnd();this._nextFile();}else{this._fsEnd();}}else{let perc=Math.round(this.fet_buf.length/this.fet_len*100);if(this.fs_mode=='fetch'){this._hub.onFsFetchPerc(id,this.fet_index,perc);}else{this._hub.onFetchPerc(id,this.files[0].name,perc);}
this.post('fetch_next');this._fsToutStart();}
break;case'fetch_err':if(this.fs_mode!='fetch'&&this.fs_mode!='fetch_file')break;this.fet_buf=null;if(this.fs_mode=='fetch'){this._hub.onFsFetchError(id,this.fet_index,data.code);this._fsEnd();}else{this._hub.onFetchError(id,this.files[0].name,this.files[0].data,data.code);this._fsEnd();this._nextFile();}
break;case'upload_next':if(this.fs_mode!='upload')break;this._uploadNextChunk();this._fsToutStart();break;case'upload_done':if(this.fs_mode!='upload')break;this._hub.onFsUploadEnd(id);this._fsEnd();this.post('files');break;case'upload_err':if(this.fs_mode!='upload')break;this._hub.onFsUploadError(id,data.code);this._fsEnd();break;case'ota_next':if(this.fs_mode!='ota')break;this._otaNextChunk();this._fsToutStart();break;case'ota_done':if(this.fs_mode!='ota')break;this._hub.onOtaEnd(id);this._fsEnd();break;case'ota_err':if(this.fs_mode!='ota')break;this._hub.onOtaError(id,data.code);this._fsEnd();break;}}
_stop_tout(){if(this.tout){this._hub.onWaitAnswer(this.info.id,false);clearTimeout(this.tout);this.tout=null;}}
_reset_tout(){if(this.tout)return;this._hub.onWaitAnswer(this.info.id,true);this.tout=setTimeout(()=>{if(this.focused)this._hub.onDeviceConnChange(this.info.id,false);this.conn_lost=true;this._stop_tout();},this._hub.tout_prd);}
_stop_ping(){if(this.ping)clearInterval(this.ping);this.ping=null;}
_reset_ping(){this._stop_ping();this.ping=setInterval(()=>{if(this.conn_lost)this._hub.onPingLost(this.info.id);else this.post('ping');},this._hub.ping_prd);}
_otaNextChunk(){let i=0;let data='';while(true){if(!this.upl_bytes.length)break;data+=String.fromCharCode(this.upl_bytes.shift());if(++i>=this.info.max_upl*3/4-60)break;}
this._hub.onOtaPerc(this.info.id,Math.round((this.upl_size-this.upl_bytes.length)/this.upl_size*100));this.post('ota_chunk',(this.upl_bytes.length)?'next':'last',window.btoa(data));}
_uploadNextChunk(){if(this.crc32!==null){this.post('upload_chunk','crc',this.crc32);this.crc32=null;return;}
let i=0;let data='';while(true){if(!this.upl_bytes.length)break;data+=String.fromCharCode(this.upl_bytes.shift());if(++i>=this.info.max_upl*3/4-60)break;}
this._hub.onFsUploadPerc(this.info.id,Math.round((this.upl_size-this.upl_bytes.length)/this.upl_size*100));this.post('upload_chunk',(this.upl_bytes.length)?'next':'last',window.btoa(data));}
_fsToutStart(){this._fsToutEnd();this.fs_tout=setTimeout(()=>{switch(this.fs_mode){case'upload':this._hub.onFsUploadError(this.info.id,HubErrors.Timeout);break;case'fetch':this._hub.onFsFetchError(this.info.id,this.fet_index,HubErrors.Timeout);this.fet_buf=null;break;case'fetch_file':if(!this.files[0])return;this._hub.onFetchError(this.info.id,this.files[0].name,this.files[0].data,HubErrors.Timeout);this.fet_buf=null;this._nextFile();break;case'ota':this._hub.onOtaError(this.info.id,HubErrors.Timeout);break;}
this.fsStop();},this._hub.tout_prd);}
_fsToutEnd(){if(this.fs_tout)clearTimeout(this.fs_tout);}
_log(t){this._hub.log(this.info.name+' '+t);}
_err(e){this._hub.log(this.info.name+' '+e);}
conn=Conn.NONE;conn_arr=[0,0,0,0,0];granted=false;focused=false;tout=null;ping=null;conn_lost=false;prev_set={};fs_mode=null;fs_tout=null;crc32=null;upl_bytes=null;upl_size=null;fet_name='';fet_index=0;fet_buf=null;fet_len=0;files=[];file_flag=false;cfg_flag=false;};
class GyverHub{onHubError(text){}
onSaveDevices(){}
onAddDevice(dev){}
onUpdDevice(dev){}
onDiscoverEnd(){}
onDiscover(id,conn){}
onUpdate(id,name,data){}
onInfo(id,info){}
onFsbr(id,fs,total,used){}
onPrint(id,text,color){}
onUi(id,controls){}
onData(id,data){}
onAlert(id,text){}
onNotice(id,text,color){}
onPush(id,text){}
onAck(id,name){}
onDeviceConnChange(id,state){}
onWsConnChange(id,state){}
onWaitAnswer(id,state){}
onPingLost(id){}
onError(id,code){}
onFsError(id){}
onFsUploadStart(id){}
onFsUploadEnd(id){}
onFsUploadError(id,code){}
onFsUploadPerc(id,perc){}
onOtaStart(id){}
onOtaEnd(id){}
onOtaError(id,code){}
onOtaPerc(id,perc){}
onOtaUrlEnd(id){}
onOtaUrlError(id,code){}
onFsFetchStart(id,index){}
onFsFetchEnd(id,name,index,data){}
onFsFetchError(id,index,code){}
onFsFetchPerc(id,index,perc){}
onFetchStart(id,name){}
onFetchEnd(id,name,data,file){}
onFetchError(id,name,data,code){}
onFetchPerc(id,name,perc){}
devices=[];cfg={prefix:'MyDevices',client_id:new Date().getTime().toString(16).slice(-8),use_local:false,local_ip:'192.168.1.1',netmask:24,http_port:80,use_bt:false,use_serial:false,baudrate:115200,use_mqtt:false,mq_host:'test.mosquitto.org',mq_port:'8081',mq_login:'',mq_pass:'',use_tg:false,tg_token:'',tg_chat:'',api_ver:3};api_v=1;skip_prd=1000;tout_prd=2500;ping_prd=3000;constructor(){this.http=new HTTPconn(this);this.mqtt=new MQTTconn(this);this.tg=new TGconn(this);this.serial=new SERIALconn(this);this.bt=new BTconn(this);}
begin(){if(this.cfg.use_mqtt)this.mqtt.start();if(this.cfg.use_tg)this.tg.start();}
post(id,cmd,name='',value=''){this.dev(id).post(cmd,name,value);}
discover(){for(let dev of this.devices){dev.conn=Conn.NONE;dev.conn_arr=[0,0,0,0];}
if(this.cfg.use_mqtt)this.mqtt.discover();if(this.cfg.use_tg)this.tg.discover();if(this.cfg.use_serial&&"serial"in navigator)this.serial.discover();if(this.cfg.use_bt&&"bluetooth"in navigator)this.bt.discover();if(this.cfg.use_local&&wifiAllowed())this.http.discover();this._checkDiscoverEnd();}
search(){if(this.cfg.use_mqtt)this.mqtt.search();if(this.cfg.use_tg)this.tg.search();if(this.cfg.use_serial&&"serial"in navigator)this.serial.search();if(this.cfg.use_bt&&"bluetooth"in navigator)this.bt.search();if(this.cfg.use_local&&wifiAllowed())this.http.search();this._checkDiscoverEnd();}
dev(id){if(!id)return null;for(let d of this.devices){if(d.info.id==id)return d;}
return null;}
export(){let devs=[];for(let d of this.devices){devs.push(d.info);}
return JSON.stringify(devs);}
import(str){let devsi=JSON.parse(str);this.devices=[];for(let di of devsi){let dev=new Device(this);for(let key in di){dev.info[key]=di[key];}
this.devices.push(dev);}}
delete(id){for(let i in this.devices){if(this.devices[i].info.id==id){this.devices.splice(i,1);this.onSaveDevices();return;}}}
addDevice(data,conn=Conn.NONE){let device=this.dev(data.id);let flag=false;if(device){for(let key in data){if(device.info[key]!=data[key]){device.info[key]=data[key];flag=true;}}
device.conn_arr[conn]=1;if(device.conn>conn){device.conn=conn;flag=true;}
if(flag)this.onUpdDevice(device.info);}else{device=new Device(this);for(let key in data){device.info[key]=data[key];}
device.conn=conn;this.devices.push(device);this.onAddDevice(device.info);flag=true;}
if(flag){this.mqtt._sub_device(device.info.prefix,device.info.id);this.onSaveDevices();}}
moveDevice(id,dir){if(this.devices.length==1)return;let idx=0;for(let d of this.devices){if(d.info.id==id)break;idx++;}
if((dir==1&&idx<=this.devices.length-2)||(dir==-1&&idx>=1)){let b=this.devices[idx];this.devices[idx]=this.devices[idx+dir];this.devices[idx+dir]=b;}}
log(t){console.log('Log: '+t);}
err(e){console.log('Error: '+e.toString());this.onHubError(e.toString());}
_checkDiscoverEnd(){if(!this._discovering())this.onDiscoverEnd();}
_discovering(){return(this.http.discovering||this.mqtt.discovering||this.tg.discovering||this.serial.discovering||this.bt.discovering);return this.http.discovering;}
_preflist(){let list=[this.cfg.prefix];for(let dev of this.devices){if(!list.includes(dev.info.prefix))list.push(dev.info.prefix);}
return list;}
_parsePacket(conn,data,ip=null,port=null){if(!data||!data.length)return;data=data.trim().replaceAll("#{","{").replaceAll("}#","}").replaceAll(/([^\\])\\([^\"\\nrt])/ig,"$1\\\\$2").replaceAll(/\t/ig,"\\t").replaceAll(/\n/ig,"\\n").replaceAll(/\r/ig,"\\r");for(let code in HubCodes){const re=new RegExp(`(#${Number(code).toString(16)})([:,\\]\\}])`,"ig");data=data.replaceAll(re,`"${HubCodes[code]}"$2`);}
const re=new RegExp(`(#[0-9a-f][0-9a-f])([:,\\]\\}])`,"ig");if(data.match(re)){this.err('Device has newer API version. Update App!');return;}
try{data=JSON.parse(data);}catch(e){console.log('Wrong packet (JSON): '+e+' in: '+data);return;}
if(!data.id)return this.err('Wrong packet (ID)');if(data.client&&this.cfg.client_id!=data.client)return;let type=data.type;delete data.type;if(type=='discover'&&this._discovering()){if(conn==Conn.HTTP){data.ip=ip;data.http_port=port;}
this.addDevice(data,conn);}
let device=this.dev(data.id);if(device){device._parse(type,data);let id=data.id;switch(type){case'error':this.onError(id,data.code);break;case'refresh':this.post(id,'ui');break;case'script':eval(data.script);break;case'ack':this.onAck(id,data.name);break;case'fs_err':this.onFsError(id);break;case'info':this.onInfo(id,data.info);break;case'files':this.onFsbr(id,data.fs,data.total,data.used);break;case'print':this.onPrint(id,data.text,data.color);break;case'discover':if(this._discovering())this.onDiscover(id,conn);break;case'ui':if(device.module(Modules.UI))this.onUi(id,data.controls);this.post(id,'unix',Math.floor(new Date().getTime()/1000));break;case'data':if(device.module(Modules.DATA))this.onData(id,data.data);break;case'alert':this.onAlert(id,data.text);break;case'notice':this.onNotice(id,data.text,intToCol(data.color));break;case'push':this.onPush(id,data.text);break;case'ota_url_ok':this.onOtaUrlEnd(id);break;case'ota_url_err':this.onOtaUrlError(id,data.code);break;}}}};
/*NON-ESP*/var QRCode;!function(){function a(a){this.mode=c.MODE_8BIT_BYTE,this.data=a,this.parsedData=[];for(var b=[],d=0,e=this.data.length;e>d;d++){var f=this.data.charCodeAt(d);f>65536?(b[0]=240|(1835008&f)>>>18,b[1]=128|(258048&f)>>>12,b[2]=128|(4032&f)>>>6,b[3]=128|63&f):f>2048?(b[0]=224|(61440&f)>>>12,b[1]=128|(4032&f)>>>6,b[2]=128|63&f):f>128?(b[0]=192|(1984&f)>>>6,b[1]=128|63&f):b[0]=f,this.parsedData=this.parsedData.concat(b)}this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function b(a,b){this.typeNumber=a,this.errorCorrectLevel=b,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function i(a,b){if(void 0==a.length)throw new Error(a.length+"/"+b);for(var c=0;c<a.length&&0==a[c];)c++;this.num=new Array(a.length-c+b);for(var d=0;d<a.length-c;d++)this.num[d]=a[d+c]}function j(a,b){this.totalCount=a,this.dataCount=b}function k(){this.buffer=[],this.length=0}function m(){return"undefined"!=typeof CanvasRenderingContext2D}function n(){var a=!1,b=navigator.userAgent;return/android/i.test(b)&&(a=!0,aMat=b.toString().match(/android ([0-9]\.[0-9])/i),aMat&&aMat[1]&&(a=parseFloat(aMat[1]))),a}function r(a,b){for(var c=1,e=s(a),f=0,g=l.length;g>=f;f++){var h=0;switch(b){case d.L:h=l[f][0];break;case d.M:h=l[f][1];break;case d.Q:h=l[f][2];break;case d.H:h=l[f][3]}if(h>=e)break;c++}if(c>l.length)throw new Error("Too long data");return c}function s(a){var b=encodeURI(a).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return b.length+(b.length!=a?3:0)}a.prototype={getLength:function(){return this.parsedData.length},write:function(a){for(var b=0,c=this.parsedData.length;c>b;b++)a.put(this.parsedData[b],8)}},b.prototype={addData:function(b){var c=new a(b);this.dataList.push(c),this.dataCache=null},isDark:function(a,b){if(0>a||this.moduleCount<=a||0>b||this.moduleCount<=b)throw new Error(a+","+b);return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,c){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var d=0;d<this.moduleCount;d++){this.modules[d]=new Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++)this.modules[d][e]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(a,c),this.typeNumber>=7&&this.setupTypeNumber(a),null==this.dataCache&&(this.dataCache=b.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,c)},setupPositionProbePattern:function(a,b){for(var c=-1;7>=c;c++)if(!(-1>=a+c||this.moduleCount<=a+c))for(var d=-1;7>=d;d++)-1>=b+d||this.moduleCount<=b+d||(this.modules[a+c][b+d]=c>=0&&6>=c&&(0==d||6==d)||d>=0&&6>=d&&(0==c||6==c)||c>=2&&4>=c&&d>=2&&4>=d?!0:!1)},getBestMaskPattern:function(){for(var a=0,b=0,c=0;8>c;c++){this.makeImpl(!0,c);var d=f.getLostPoint(this);(0==c||a>d)&&(a=d,b=c)}return b},createMovieClip:function(a,b,c){var d=a.createEmptyMovieClip(b,c),e=1;this.make();for(var f=0;f<this.modules.length;f++)for(var g=f*e,h=0;h<this.modules[f].length;h++){var i=h*e,j=this.modules[f][h];j&&(d.beginFill(0,100),d.moveTo(i,g),d.lineTo(i+e,g),d.lineTo(i+e,g+e),d.lineTo(i,g+e),d.endFill())}return d},setupTimingPattern:function(){for(var a=8;a<this.moduleCount-8;a++)null==this.modules[a][6]&&(this.modules[a][6]=0==a%2);for(var b=8;b<this.moduleCount-8;b++)null==this.modules[6][b]&&(this.modules[6][b]=0==b%2)},setupPositionAdjustPattern:function(){for(var a=f.getPatternPosition(this.typeNumber),b=0;b<a.length;b++)for(var c=0;c<a.length;c++){var d=a[b],e=a[c];if(null==this.modules[d][e])for(var g=-2;2>=g;g++)for(var h=-2;2>=h;h++)this.modules[d+g][e+h]=-2==g||2==g||-2==h||2==h||0==g&&0==h?!0:!1}},setupTypeNumber:function(a){for(var b=f.getBCHTypeNumber(this.typeNumber),c=0;18>c;c++){var d=!a&&1==(1&b>>c);this.modules[Math.floor(c/3)][c%3+this.moduleCount-8-3]=d}for(var c=0;18>c;c++){var d=!a&&1==(1&b>>c);this.modules[c%3+this.moduleCount-8-3][Math.floor(c/3)]=d}},setupTypeInfo:function(a,b){for(var c=this.errorCorrectLevel<<3|b,d=f.getBCHTypeInfo(c),e=0;15>e;e++){var g=!a&&1==(1&d>>e);6>e?this.modules[e][8]=g:8>e?this.modules[e+1][8]=g:this.modules[this.moduleCount-15+e][8]=g}for(var e=0;15>e;e++){var g=!a&&1==(1&d>>e);8>e?this.modules[8][this.moduleCount-e-1]=g:9>e?this.modules[8][15-e-1+1]=g:this.modules[8][15-e-1]=g}this.modules[this.moduleCount-8][8]=!a},mapData:function(a,b){for(var c=-1,d=this.moduleCount-1,e=7,g=0,h=this.moduleCount-1;h>0;h-=2)for(6==h&&h--;;){for(var i=0;2>i;i++)if(null==this.modules[d][h-i]){var j=!1;g<a.length&&(j=1==(1&a[g]>>>e));var k=f.getMask(b,d,h-i);k&&(j=!j),this.modules[d][h-i]=j,e--,-1==e&&(g++,e=7)}if(d+=c,0>d||this.moduleCount<=d){d-=c,c=-c;break}}}},b.PAD0=236,b.PAD1=17,b.createData=function(a,c,d){for(var e=j.getRSBlocks(a,c),g=new k,h=0;h<d.length;h++){var i=d[h];g.put(i.mode,4),g.put(i.getLength(),f.getLengthInBits(i.mode,a)),i.write(g)}for(var l=0,h=0;h<e.length;h++)l+=e[h].dataCount;if(g.getLengthInBits()>8*l)throw new Error("code length overflow. ("+g.getLengthInBits()+">"+8*l+")");for(g.getLengthInBits()+4<=8*l&&g.put(0,4);0!=g.getLengthInBits()%8;)g.putBit(!1);for(;;){if(g.getLengthInBits()>=8*l)break;if(g.put(b.PAD0,8),g.getLengthInBits()>=8*l)break;g.put(b.PAD1,8)}return b.createBytes(g,e)},b.createBytes=function(a,b){for(var c=0,d=0,e=0,g=new Array(b.length),h=new Array(b.length),j=0;j<b.length;j++){var k=b[j].dataCount,l=b[j].totalCount-k;d=Math.max(d,k),e=Math.max(e,l),g[j]=new Array(k);for(var m=0;m<g[j].length;m++)g[j][m]=255&a.buffer[m+c];c+=k;var n=f.getErrorCorrectPolynomial(l),o=new i(g[j],n.getLength()-1),p=o.mod(n);h[j]=new Array(n.getLength()-1);for(var m=0;m<h[j].length;m++){var q=m+p.getLength()-h[j].length;h[j][m]=q>=0?p.get(q):0}}for(var r=0,m=0;m<b.length;m++)r+=b[m].totalCount;for(var s=new Array(r),t=0,m=0;d>m;m++)for(var j=0;j<b.length;j++)m<g[j].length&&(s[t++]=g[j][m]);for(var m=0;e>m;m++)for(var j=0;j<b.length;j++)m<h[j].length&&(s[t++]=h[j][m]);return s};for(var c={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},d={L:1,M:0,Q:3,H:2},e={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7},f={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(a){for(var b=a<<10;f.getBCHDigit(b)-f.getBCHDigit(f.G15)>=0;)b^=f.G15<<f.getBCHDigit(b)-f.getBCHDigit(f.G15);return(a<<10|b)^f.G15_MASK},getBCHTypeNumber:function(a){for(var b=a<<12;f.getBCHDigit(b)-f.getBCHDigit(f.G18)>=0;)b^=f.G18<<f.getBCHDigit(b)-f.getBCHDigit(f.G18);return a<<12|b},getBCHDigit:function(a){for(var b=0;0!=a;)b++,a>>>=1;return b},getPatternPosition:function(a){return f.PATTERN_POSITION_TABLE[a-1]},getMask:function(a,b,c){switch(a){case e.PATTERN000:return 0==(b+c)%2;case e.PATTERN001:return 0==b%2;case e.PATTERN010:return 0==c%3;case e.PATTERN011:return 0==(b+c)%3;case e.PATTERN100:return 0==(Math.floor(b/2)+Math.floor(c/3))%2;case e.PATTERN101:return 0==b*c%2+b*c%3;case e.PATTERN110:return 0==(b*c%2+b*c%3)%2;case e.PATTERN111:return 0==(b*c%3+(b+c)%2)%2;default:throw new Error("bad maskPattern:"+a)}},getErrorCorrectPolynomial:function(a){for(var b=new i([1],0),c=0;a>c;c++)b=b.multiply(new i([1,g.gexp(c)],0));return b},getLengthInBits:function(a,b){if(b>=1&&10>b)switch(a){case c.MODE_NUMBER:return 10;case c.MODE_ALPHA_NUM:return 9;case c.MODE_8BIT_BYTE:return 8;case c.MODE_KANJI:return 8;default:throw new Error("mode:"+a)}else if(27>b)switch(a){case c.MODE_NUMBER:return 12;case c.MODE_ALPHA_NUM:return 11;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 10;default:throw new Error("mode:"+a)}else{if(!(41>b))throw new Error("type:"+b);switch(a){case c.MODE_NUMBER:return 14;case c.MODE_ALPHA_NUM:return 13;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 12;default:throw new Error("mode:"+a)}}},getLostPoint:function(a){for(var b=a.getModuleCount(),c=0,d=0;b>d;d++)for(var e=0;b>e;e++){for(var f=0,g=a.isDark(d,e),h=-1;1>=h;h++)if(!(0>d+h||d+h>=b))for(var i=-1;1>=i;i++)0>e+i||e+i>=b||(0!=h||0!=i)&&g==a.isDark(d+h,e+i)&&f++;f>5&&(c+=3+f-5)}for(var d=0;b-1>d;d++)for(var e=0;b-1>e;e++){var j=0;a.isDark(d,e)&&j++,a.isDark(d+1,e)&&j++,a.isDark(d,e+1)&&j++,a.isDark(d+1,e+1)&&j++,(0==j||4==j)&&(c+=3)}for(var d=0;b>d;d++)for(var e=0;b-6>e;e++)a.isDark(d,e)&&!a.isDark(d,e+1)&&a.isDark(d,e+2)&&a.isDark(d,e+3)&&a.isDark(d,e+4)&&!a.isDark(d,e+5)&&a.isDark(d,e+6)&&(c+=40);for(var e=0;b>e;e++)for(var d=0;b-6>d;d++)a.isDark(d,e)&&!a.isDark(d+1,e)&&a.isDark(d+2,e)&&a.isDark(d+3,e)&&a.isDark(d+4,e)&&!a.isDark(d+5,e)&&a.isDark(d+6,e)&&(c+=40);for(var k=0,e=0;b>e;e++)for(var d=0;b>d;d++)a.isDark(d,e)&&k++;var l=Math.abs(100*k/b/b-50)/5;return c+=10*l}},g={glog:function(a){if(1>a)throw new Error("glog("+a+")");return g.LOG_TABLE[a]},gexp:function(a){for(;0>a;)a+=255;for(;a>=256;)a-=255;return g.EXP_TABLE[a]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},h=0;8>h;h++)g.EXP_TABLE[h]=1<<h;for(var h=8;256>h;h++)g.EXP_TABLE[h]=g.EXP_TABLE[h-4]^g.EXP_TABLE[h-5]^g.EXP_TABLE[h-6]^g.EXP_TABLE[h-8];for(var h=0;255>h;h++)g.LOG_TABLE[g.EXP_TABLE[h]]=h;i.prototype={get:function(a){return this.num[a]},getLength:function(){return this.num.length},multiply:function(a){for(var b=new Array(this.getLength()+a.getLength()-1),c=0;c<this.getLength();c++)for(var d=0;d<a.getLength();d++)b[c+d]^=g.gexp(g.glog(this.get(c))+g.glog(a.get(d)));return new i(b,0)},mod:function(a){if(this.getLength()-a.getLength()<0)return this;for(var b=g.glog(this.get(0))-g.glog(a.get(0)),c=new Array(this.getLength()),d=0;d<this.getLength();d++)c[d]=this.get(d);for(var d=0;d<a.getLength();d++)c[d]^=g.gexp(g.glog(a.get(d))+b);return new i(c,0).mod(a)}},j.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],j.getRSBlocks=function(a,b){var c=j.getRsBlockTable(a,b);if(void 0==c)throw new Error("bad rs block @ typeNumber:"+a+"/errorCorrectLevel:"+b);for(var d=c.length/3,e=[],f=0;d>f;f++)for(var g=c[3*f+0],h=c[3*f+1],i=c[3*f+2],k=0;g>k;k++)e.push(new j(h,i));return e},j.getRsBlockTable=function(a,b){switch(b){case d.L:return j.RS_BLOCK_TABLE[4*(a-1)+0];case d.M:return j.RS_BLOCK_TABLE[4*(a-1)+1];case d.Q:return j.RS_BLOCK_TABLE[4*(a-1)+2];case d.H:return j.RS_BLOCK_TABLE[4*(a-1)+3];default:return void 0}},k.prototype={get:function(a){var b=Math.floor(a/8);return 1==(1&this.buffer[b]>>>7-a%8)},put:function(a,b){for(var c=0;b>c;c++)this.putBit(1==(1&a>>>b-c-1))},getLengthInBits:function(){return this.length},putBit:function(a){var b=Math.floor(this.length/8);this.buffer.length<=b&&this.buffer.push(0),a&&(this.buffer[b]|=128>>>this.length%8),this.length++}};var l=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]],o=function(){var a=function(a,b){this._el=a,this._htOption=b};return a.prototype.draw=function(a){function g(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);return c}var b=this._htOption,c=this._el,d=a.getModuleCount();Math.floor(b.width/d),Math.floor(b.height/d),this.clear();var h=g("svg",{viewBox:"0 0 "+String(d)+" "+String(d),width:"100%",height:"100%",fill:b.colorLight});h.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),c.appendChild(h),h.appendChild(g("rect",{fill:b.colorDark,width:"1",height:"1",id:"template"}));for(var i=0;d>i;i++)for(var j=0;d>j;j++)if(a.isDark(i,j)){var k=g("use",{x:String(i),y:String(j)});k.setAttributeNS("http://www.w3.org/1999/xlink","href","#template"),h.appendChild(k)}},a.prototype.clear=function(){for(;this._el.hasChildNodes();)this._el.removeChild(this._el.lastChild)},a}(),p="svg"===document.documentElement.tagName.toLowerCase(),q=p?o:m()?function(){function a(){this._elImage.src=this._elCanvas.toDataURL("image/png"),this._elImage.style.display="block",this._elCanvas.style.display="none"}function d(a,b){var c=this;if(c._fFail=b,c._fSuccess=a,null===c._bSupportDataURI){var d=document.createElement("img"),e=function(){c._bSupportDataURI=!1,c._fFail&&_fFail.call(c)},f=function(){c._bSupportDataURI=!0,c._fSuccess&&c._fSuccess.call(c)};return d.onabort=e,d.onerror=e,d.onload=f,d.src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==",void 0}c._bSupportDataURI===!0&&c._fSuccess?c._fSuccess.call(c):c._bSupportDataURI===!1&&c._fFail&&c._fFail.call(c)}if(this._android&&this._android<=2.1){var b=1/window.devicePixelRatio,c=CanvasRenderingContext2D.prototype.drawImage;CanvasRenderingContext2D.prototype.drawImage=function(a,d,e,f,g,h,i,j){if("nodeName"in a&&/img/i.test(a.nodeName))for(var l=arguments.length-1;l>=1;l--)arguments[l]=arguments[l]*b;else"undefined"==typeof j&&(arguments[1]*=b,arguments[2]*=b,arguments[3]*=b,arguments[4]*=b);c.apply(this,arguments)}}var e=function(a,b){this._bIsPainted=!1,this._android=n(),this._htOption=b,this._elCanvas=document.createElement("canvas"),this._elCanvas.width=b.width,this._elCanvas.height=b.height,a.appendChild(this._elCanvas),this._el=a,this._oContext=this._elCanvas.getContext("2d"),this._bIsPainted=!1,this._elImage=document.createElement("img"),this._elImage.style.display="none",this._el.appendChild(this._elImage),this._bSupportDataURI=null};return e.prototype.draw=function(a){var b=this._elImage,c=this._oContext,d=this._htOption,e=a.getModuleCount(),f=d.width/e,g=d.height/e,h=Math.round(f),i=Math.round(g);b.style.display="none",this.clear();for(var j=0;e>j;j++)for(var k=0;e>k;k++){var l=a.isDark(j,k),m=k*f,n=j*g;c.strokeStyle=l?d.colorDark:d.colorLight,c.lineWidth=1,c.fillStyle=l?d.colorDark:d.colorLight,c.fillRect(m,n,f,g),c.strokeRect(Math.floor(m)+.5,Math.floor(n)+.5,h,i),c.strokeRect(Math.ceil(m)-.5,Math.ceil(n)-.5,h,i)}this._bIsPainted=!0},e.prototype.makeImage=function(){this._bIsPainted&&d.call(this,a)},e.prototype.isPainted=function(){return this._bIsPainted},e.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},e.prototype.round=function(a){return a?Math.floor(1e3*a)/1e3:a},e}():function(){var a=function(a,b){this._el=a,this._htOption=b};return a.prototype.draw=function(a){for(var b=this._htOption,c=this._el,d=a.getModuleCount(),e=Math.floor(b.width/d),f=Math.floor(b.height/d),g=['<table style="border:0;border-collapse:collapse;">'],h=0;d>h;h++){g.push("<tr>");for(var i=0;d>i;i++)g.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+e+"px;height:"+f+"px;background-color:"+(a.isDark(h,i)?b.colorDark:b.colorLight)+';"></td>');g.push("</tr>")}g.push("</table>"),c.innerHTML=g.join("");var j=c.childNodes[0],k=(b.width-j.offsetWidth)/2,l=(b.height-j.offsetHeight)/2;k>0&&l>0&&(j.style.margin=l+"px "+k+"px")},a.prototype.clear=function(){this._el.innerHTML=""},a}();QRCode=function(a,b){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:d.H},"string"==typeof b&&(b={text:b}),b)for(var c in b)this._htOption[c]=b[c];"string"==typeof a&&(a=document.getElementById(a)),this._android=n(),this._el=a,this._oQRCode=null,this._oDrawing=new q(this._el,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)},QRCode.prototype.makeCode=function(a){this._oQRCode=new b(r(a,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(a),this._oQRCode.make(),this._el.title=a,this._oDrawing.draw(this._oQRCode),this.makeImage()},QRCode.prototype.makeImage=function(){"function"==typeof this._oDrawing.makeImage&&(!this._android||this._android>=3)&&this._oDrawing.makeImage()},QRCode.prototype.clear=function(){this._oDrawing.clear()},QRCode.CorrectLevel=d}();/*/NON-ESP*/
(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";window.sortPaths=require("./sort-paths.js");
},{"./sort-paths.js":3}],2:[function(require,module,exports){
"use strict";function splitRetain(e,t,r){if(r=defaults(r,{}),r.leadingSeparator=defaults(r.leadingSeparator,!1),assert.type(e,"string","`string` is not a string"),assert("string"==typeof t||t instanceof RegExp,"invalid `separator` type"),assert.type(r,"object","invalid `options` type"),assert.type(r.leadingSeparator,"boolean","invalid `options.leadingSeparator` type"),0===e.length)return[""];t=separatorToRegex(t);var n=e.split(t);if(1===n.length)return n;var s=[];for(r.leadingSeparator&&s.push(n.shift());n.length>0;)1===n.length?s.push(n.shift()):s.push(n.shift()+n.shift());return""===s[0]&&s.shift(),""===s[s.length-1]&&s.pop(),s}function separatorToRegex(e){return e instanceof RegExp?e:new RegExp("("+escapeRegex(e)+")","g")}function escapeRegex(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function assert(e,t){if(!e)throw new Error(t)}function defaults(e,t){return void 0===e?t:e}exports=module.exports=splitRetain,splitRetain.VERSION="1.0.1",assert.type=function(e,t,r){if(typeof e!==t)throw new Error(r)};
},{}],3:[function(require,module,exports){
"use strict";function sortPaths(t){assert(arguments.length>=2,"too few arguments"),assert(arguments.length<=3,"too many arguments");var r,e;2===arguments.length?(r=identity,e=arguments[1]):(r=arguments[1],e=arguments[2]),assert(isArray(t),"items is not an list"),assert(isFunction(r),"iteratee is not a function"),assert("string"==typeof e,"dirSeparator is not a String"),assert(1===e.length,"dirSeparator must be a single character");var n=t.map(function(t){var n=r(t);return assert("string"==typeof n,"item or iteratee(item) must be a String"),{item:t,pathTokens:splitRetain(n,e)}});return n.sort(createItemDTOComparator(e)),n.map(function(t){return t.item})}function createItemDTOComparator(t){return function(r,e){for(var n=r.pathTokens,a=e.pathTokens,o=0,i=Math.max(n.length,a.length);o<i;o++){if(!(o in n))return-1;if(!(o in a))return 1;var s=n[o].toLowerCase(),u=a[o].toLowerCase();if(s!==u){var c=s[s.length-1]===t;return c===(u[u.length-1]===t)?s<u?-1:1:c?1:-1}}return 0}}function assert(t,r){if(!t)throw new Error(r)}function identity(t){return t}function isFunction(t){return Boolean(t)&&"[object Function]"===Object.prototype.toString.call(t)}function isArray(t){return Boolean(t)&&"[object Array]"===Object.prototype.toString.call(t)}var splitRetain=require("split-retain");module.exports=sortPaths,sortPaths.VERSION="1.1.1";
},{"split-retain":2}]},{},[1]);
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Pickr=e():t.Pickr=e()}(self,(function(){return(()=>{"use strict";var t={d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.d(e,{default:()=>L});var o={};function n(t,e,o,n,i={}){e instanceof HTMLCollection||e instanceof NodeList?e=Array.from(e):Array.isArray(e)||(e=[e]),Array.isArray(o)||(o=[o]);for(const s of e)for(const e of o)s[t](e,n,{capture:!1,...i});return Array.prototype.slice.call(arguments,1)}t.r(o),t.d(o,{adjustableInputNumbers:()=>p,createElementFromString:()=>r,createFromTemplate:()=>a,eventPath:()=>l,off:()=>s,on:()=>i,resolveElement:()=>c});const i=n.bind(null,"addEventListener"),s=n.bind(null,"removeEventListener");function r(t){const e=document.createElement("div");return e.innerHTML=t.trim(),e.firstElementChild}function a(t){const e=(t,e)=>{const o=t.getAttribute(e);return t.removeAttribute(e),o},o=(t,n={})=>{const i=e(t,":obj"),s=e(t,":ref"),r=i?n[i]={}:n;s&&(n[s]=t);for(const n of Array.from(t.children)){const t=e(n,":arr"),i=o(n,t?{}:r);t&&(r[t]||(r[t]=[])).push(Object.keys(i).length?i:n)}return n};return o(r(t))}function l(t){let e=t.path||t.composedPath&&t.composedPath();if(e)return e;let o=t.target.parentElement;for(e=[t.target,o];o=o.parentElement;)e.push(o);return e.push(document,window),e}function c(t){return t instanceof Element?t:"string"==typeof t?t.split(/>>/g).reduce(((t,e,o,n)=>(t=t.querySelector(e),o<n.length-1?t.shadowRoot:t)),document):null}function p(t,e=(t=>t)){function o(o){const n=[.001,.01,.1][Number(o.shiftKey||2*o.ctrlKey)]*(o.deltaY<0?1:-1);let i=0,s=t.selectionStart;t.value=t.value.replace(/[\d.]+/g,((t,o)=>o<=s&&o+t.length>=s?(s=o,e(Number(t),n,i)):(i++,t))),t.focus(),t.setSelectionRange(s,s),o.preventDefault(),t.dispatchEvent(new Event("input"))}i(t,"focus",(()=>i(window,"wheel",o,{passive:!1}))),i(t,"blur",(()=>s(window,"wheel",o)))}const{min:u,max:h,floor:d,round:m}=Math;function f(t,e,o){e/=100,o/=100;const n=d(t=t/360*6),i=t-n,s=o*(1-e),r=o*(1-i*e),a=o*(1-(1-i)*e),l=n%6;return[255*[o,r,s,s,a,o][l],255*[a,o,o,r,s,s][l],255*[s,s,a,o,o,r][l]]}function v(t,e,o){const n=(2-(e/=100))*(o/=100)/2;return 0!==n&&(e=1===n?0:n<.5?e*o/(2*n):e*o/(2-2*n)),[t,100*e,100*n]}function b(t,e,o){const n=u(t/=255,e/=255,o/=255),i=h(t,e,o),s=i-n;let r,a;if(0===s)r=a=0;else{a=s/i;const n=((i-t)/6+s/2)/s,l=((i-e)/6+s/2)/s,c=((i-o)/6+s/2)/s;t===i?r=c-l:e===i?r=1/3+n-c:o===i&&(r=2/3+l-n),r<0?r+=1:r>1&&(r-=1)}return[360*r,100*a,100*i]}function y(t,e,o,n){e/=100,o/=100;return[...b(255*(1-u(1,(t/=100)*(1-(n/=100))+n)),255*(1-u(1,e*(1-n)+n)),255*(1-u(1,o*(1-n)+n)))]}function g(t,e,o){e/=100;const n=2*(e*=(o/=100)<.5?o:1-o)/(o+e)*100,i=100*(o+e);return[t,isNaN(n)?0:n,i]}function _(t){return b(...t.match(/.{2}/g).map((t=>parseInt(t,16))))}function w(t){t=t.match(/^[a-zA-Z]+$/)?function(t){if("black"===t.toLowerCase())return"#000";const e=document.createElement("canvas").getContext("2d");return e.fillStyle=t,"#000"===e.fillStyle?null:e.fillStyle}(t):t;const e={cmyk:/^cmyk[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)/i,rgba:/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,hsla:/^((hsla)|hsl)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,hsva:/^((hsva)|hsv)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,hexa:/^#?(([\dA-Fa-f]{3,4})|([\dA-Fa-f]{6})|([\dA-Fa-f]{8}))$/i},o=t=>t.map((t=>/^(|\d+)\.\d+|\d+$/.test(t)?Number(t):void 0));let n;t:for(const i in e){if(!(n=e[i].exec(t)))continue;const s=t=>!!n[2]==("number"==typeof t);switch(i){case"cmyk":{const[,t,e,s,r]=o(n);if(t>100||e>100||s>100||r>100)break t;return{values:y(t,e,s,r),type:i}}case"rgba":{const[,,,t,e,r,a]=o(n);if(t>255||e>255||r>255||a<0||a>1||!s(a))break t;return{values:[...b(t,e,r),a],a,type:i}}case"hexa":{let[,t]=n;4!==t.length&&3!==t.length||(t=t.split("").map((t=>t+t)).join(""));const e=t.substring(0,6);let o=t.substring(6);return o=o?parseInt(o,16)/255:void 0,{values:[..._(e),o],a:o,type:i}}case"hsla":{const[,,,t,e,r,a]=o(n);if(t>360||e>100||r>100||a<0||a>1||!s(a))break t;return{values:[...g(t,e,r),a],a,type:i}}case"hsva":{const[,,,t,e,r,a]=o(n);if(t>360||e>100||r>100||a<0||a>1||!s(a))break t;return{values:[t,e,r,a],a,type:i}}}}return{values:null,type:null}}function A(t=0,e=0,o=0,n=1){const i=(t,e)=>(o=-1)=>e(~o?t.map((t=>Number(t.toFixed(o)))):t),s={h:t,s:e,v:o,a:n,toHSVA(){const t=[s.h,s.s,s.v,s.a];return t.toString=i(t,(t=>`hsva(${t[0]}, ${t[1]}%, ${t[2]}%, ${s.a})`)),t},toHSLA(){const t=[...v(s.h,s.s,s.v),s.a];return t.toString=i(t,(t=>`hsla(${t[0]}, ${t[1]}%, ${t[2]}%, ${s.a})`)),t},toRGBA(){const t=[...f(s.h,s.s,s.v),s.a];return t.toString=i(t,(t=>`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${s.a})`)),t},toCMYK(){const t=function(t,e,o){const n=f(t,e,o),i=n[0]/255,s=n[1]/255,r=n[2]/255,a=u(1-i,1-s,1-r);return[100*(1===a?0:(1-i-a)/(1-a)),100*(1===a?0:(1-s-a)/(1-a)),100*(1===a?0:(1-r-a)/(1-a)),100*a]}(s.h,s.s,s.v);return t.toString=i(t,(t=>`cmyk(${t[0]}%, ${t[1]}%, ${t[2]}%, ${t[3]}%)`)),t},toHEXA(){const t=function(t,e,o){return f(t,e,o).map((t=>m(t).toString(16).padStart(2,"0")))}(s.h,s.s,s.v),e=s.a>=1?"":Number((255*s.a).toFixed(0)).toString(16).toUpperCase().padStart(2,"0");return e&&t.push(e),t.toString=()=>`#${t.join("").toUpperCase()}`,t},clone:()=>A(s.h,s.s,s.v,s.a)};return s}const C=t=>Math.max(Math.min(t,1),0);function $(t){const e={options:Object.assign({lock:null,onchange:()=>0,onstop:()=>0},t),_keyboard(t){const{options:o}=e,{type:n,key:i}=t;if(document.activeElement===o.wrapper){const{lock:o}=e.options,s="ArrowUp"===i,r="ArrowRight"===i,a="ArrowDown"===i,l="ArrowLeft"===i;if("keydown"===n&&(s||r||a||l)){let n=0,i=0;"v"===o?n=s||r?1:-1:"h"===o?n=s||r?-1:1:(i=s?-1:a?1:0,n=l?-1:r?1:0),e.update(C(e.cache.x+.01*n),C(e.cache.y+.01*i)),t.preventDefault()}else i.startsWith("Arrow")&&(e.options.onstop(),t.preventDefault())}},_tapstart(t){i(document,["mouseup","touchend","touchcancel"],e._tapstop),i(document,["mousemove","touchmove"],e._tapmove),t.cancelable&&t.preventDefault(),e._tapmove(t)},_tapmove(t){const{options:o,cache:n}=e,{lock:i,element:s,wrapper:r}=o,a=r.getBoundingClientRect();let l=0,c=0;if(t){const e=t&&t.touches&&t.touches[0];l=t?(e||t).clientX:0,c=t?(e||t).clientY:0,l<a.left?l=a.left:l>a.left+a.width&&(l=a.left+a.width),c<a.top?c=a.top:c>a.top+a.height&&(c=a.top+a.height),l-=a.left,c-=a.top}else n&&(l=n.x*a.width,c=n.y*a.height);"h"!==i&&(s.style.left=`calc(${l/a.width*100}% - ${s.offsetWidth/2}px)`),"v"!==i&&(s.style.top=`calc(${c/a.height*100}% - ${s.offsetHeight/2}px)`),e.cache={x:l/a.width,y:c/a.height};const p=C(l/a.width),u=C(c/a.height);switch(i){case"v":return o.onchange(p);case"h":return o.onchange(u);default:return o.onchange(p,u)}},_tapstop(){e.options.onstop(),s(document,["mouseup","touchend","touchcancel"],e._tapstop),s(document,["mousemove","touchmove"],e._tapmove)},trigger(){e._tapmove()},update(t=0,o=0){const{left:n,top:i,width:s,height:r}=e.options.wrapper.getBoundingClientRect();"h"===e.options.lock&&(o=t),e._tapmove({clientX:n+s*t,clientY:i+r*o})},destroy(){const{options:t,_tapstart:o,_keyboard:n}=e;s(document,["keydown","keyup"],n),s([t.wrapper,t.element],"mousedown",o),s([t.wrapper,t.element],"touchstart",o,{passive:!1})}},{options:o,_tapstart:n,_keyboard:r}=e;return i([o.wrapper,o.element],"mousedown",n),i([o.wrapper,o.element],"touchstart",n,{passive:!1}),i(document,["keydown","keyup"],r),e}function k(t={}){t=Object.assign({onchange:()=>0,className:"",elements:[]},t);const e=i(t.elements,"click",(e=>{t.elements.forEach((o=>o.classList[e.target===o?"add":"remove"](t.className))),t.onchange(e),e.stopPropagation()}));return{destroy:()=>s(...e)}}const S={variantFlipOrder:{start:"sme",middle:"mse",end:"ems"},positionFlipOrder:{top:"tbrl",right:"rltb",bottom:"btrl",left:"lrbt"},position:"bottom",margin:8},O=(t,e,o)=>{const{container:n,margin:i,position:s,variantFlipOrder:r,positionFlipOrder:a}={container:document.documentElement.getBoundingClientRect(),...S,...o},{left:l,top:c}=e.style;e.style.left="0",e.style.top="0";const p=t.getBoundingClientRect(),u=e.getBoundingClientRect(),h={t:p.top-u.height-i,b:p.bottom+i,r:p.right+i,l:p.left-u.width-i},d={vs:p.left,vm:p.left+p.width/2+-u.width/2,ve:p.left+p.width-u.width,hs:p.top,hm:p.bottom-p.height/2-u.height/2,he:p.bottom-u.height},[m,f="middle"]=s.split("-"),v=a[m],b=r[f],{top:y,left:g,bottom:_,right:w}=n;for(const t of v){const o="t"===t||"b"===t,n=h[t],[i,s]=o?["top","left"]:["left","top"],[r,a]=o?[u.height,u.width]:[u.width,u.height],[l,c]=o?[_,w]:[w,_],[p,m]=o?[y,g]:[g,y];if(!(n<p||n+r>l))for(const r of b){const l=d[(o?"v":"h")+r];if(!(l<m||l+a>c))return e.style[s]=l-u[s]+"px",e.style[i]=n-u[i]+"px",t+r}}return e.style.left=l,e.style.top=c,null};function E(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}class L{constructor(t){E(this,"_initializingActive",!0),E(this,"_recalc",!0),E(this,"_nanopop",null),E(this,"_root",null),E(this,"_color",A()),E(this,"_lastColor",A()),E(this,"_swatchColors",[]),E(this,"_setupAnimationFrame",null),E(this,"_eventListener",{init:[],save:[],hide:[],show:[],clear:[],change:[],changestop:[],cancel:[],swatchselect:[]}),this.options=t=Object.assign({...L.DEFAULT_OPTIONS},t);const{swatches:e,components:o,theme:n,sliders:i,lockOpacity:s,padding:r}=t;["nano","monolith"].includes(n)&&!i&&(t.sliders="h"),o.interaction||(o.interaction={});const{preview:a,opacity:l,hue:c,palette:p}=o;o.opacity=!s&&l,o.palette=p||a||l||c,this._preBuild(),this._buildComponents(),this._bindEvents(),this._finalBuild(),e&&e.length&&e.forEach((t=>this.addSwatch(t)));const{button:u,app:h}=this._root;this._nanopop=((t,e,o)=>{const n="object"!=typeof t||t instanceof HTMLElement?{reference:t,popper:e,...o}:t;return{update(t=n){const{reference:e,popper:o}=Object.assign(n,t);if(!o||!e)throw new Error("Popper- or reference-element missing.");return O(e,o,n)}}})(u,h,{margin:r}),u.setAttribute("role","button"),u.setAttribute("aria-label",this._t("btn:toggle"));const d=this;this._setupAnimationFrame=requestAnimationFrame((function e(){if(!h.offsetWidth)return requestAnimationFrame(e);d.setColor(t.default),d._rePositioningPicker(),t.defaultRepresentation&&(d._representation=t.defaultRepresentation,d.setColorRepresentation(d._representation)),t.showAlways&&d.show(),d._initializingActive=!1,d._emit("init")}))}_preBuild(){const{options:t}=this;for(const e of["el","container"])t[e]=c(t[e]);this._root=(t=>{const{components:e,useAsButton:o,inline:n,appClass:i,theme:s,lockOpacity:r}=t.options,l=t=>t?"":'style="display:none" hidden',c=e=>t._t(e),p=a(`\n      <div :ref="root" class="pickr">\n\n        ${o?"":'<button type="button" :ref="button" class="pcr-button"></button>'}\n\n        <div :ref="app" class="pcr-app ${i||""}" data-theme="${s}" ${n?'style="position: unset"':""} aria-label="${c("ui:dialog")}" role="window">\n          <div class="pcr-selection" ${l(e.palette)}>\n            <div :obj="preview" class="pcr-color-preview" ${l(e.preview)}>\n              <button type="button" :ref="lastColor" class="pcr-last-color" aria-label="${c("btn:last-color")}"></button>\n              <div :ref="currentColor" class="pcr-current-color"></div>\n            </div>\n\n            <div :obj="palette" class="pcr-color-palette">\n              <div :ref="picker" class="pcr-picker"></div>\n              <div :ref="palette" class="pcr-palette" tabindex="0" aria-label="${c("aria:palette")}" role="listbox"></div>\n            </div>\n\n            <div :obj="hue" class="pcr-color-chooser" ${l(e.hue)}>\n              <div :ref="picker" class="pcr-picker"></div>\n              <div :ref="slider" class="pcr-hue pcr-slider" tabindex="0" aria-label="${c("aria:hue")}" role="slider"></div>\n            </div>\n\n            <div :obj="opacity" class="pcr-color-opacity" ${l(e.opacity)}>\n              <div :ref="picker" class="pcr-picker"></div>\n              <div :ref="slider" class="pcr-opacity pcr-slider" tabindex="0" aria-label="${c("aria:opacity")}" role="slider"></div>\n            </div>\n          </div>\n\n          <div class="pcr-swatches ${e.palette?"":"pcr-last"}" :ref="swatches"></div>\n\n          <div :obj="interaction" class="pcr-interaction" ${l(Object.keys(e.interaction).length)}>\n            <input :ref="result" class="pcr-result" type="text" spellcheck="false" ${l(e.interaction.input)} aria-label="${c("aria:input")}">\n\n            <input :arr="options" class="pcr-type" data-type="HEXA" value="${r?"HEX":"HEXA"}" type="button" ${l(e.interaction.hex)}>\n            <input :arr="options" class="pcr-type" data-type="RGBA" value="${r?"RGB":"RGBA"}" type="button" ${l(e.interaction.rgba)}>\n            <input :arr="options" class="pcr-type" data-type="HSLA" value="${r?"HSL":"HSLA"}" type="button" ${l(e.interaction.hsla)}>\n            <input :arr="options" class="pcr-type" data-type="HSVA" value="${r?"HSV":"HSVA"}" type="button" ${l(e.interaction.hsva)}>\n            <input :arr="options" class="pcr-type" data-type="CMYK" value="CMYK" type="button" ${l(e.interaction.cmyk)}>\n\n            <input :ref="save" class="pcr-save" value="${c("btn:save")}" type="button" ${l(e.interaction.save)} aria-label="${c("aria:btn:save")}">\n            <input :ref="cancel" class="pcr-cancel" value="${c("btn:cancel")}" type="button" ${l(e.interaction.cancel)} aria-label="${c("aria:btn:cancel")}">\n            <input :ref="clear" class="pcr-clear" value="${c("btn:clear")}" type="button" ${l(e.interaction.clear)} aria-label="${c("aria:btn:clear")}">\n          </div>\n        </div>\n      </div>\n    `),u=p.interaction;return u.options.find((t=>!t.hidden&&!t.classList.add("active"))),u.type=()=>u.options.find((t=>t.classList.contains("active"))),p})(this),t.useAsButton&&(this._root.button=t.el),t.container.appendChild(this._root.root)}_finalBuild(){const t=this.options,e=this._root;if(t.container.removeChild(e.root),t.inline){const o=t.el.parentElement;t.el.nextSibling?o.insertBefore(e.app,t.el.nextSibling):o.appendChild(e.app)}else t.container.appendChild(e.app);t.useAsButton?t.inline&&t.el.remove():t.el.parentNode.replaceChild(e.root,t.el),t.disabled&&this.disable(),t.comparison||(e.button.style.transition="none",t.useAsButton||(e.preview.lastColor.style.transition="none")),this.hide()}_buildComponents(){const t=this,e=this.options.components,o=(t.options.sliders||"v").repeat(2),[n,i]=o.match(/^[vh]+$/g)?o:[],s=()=>this._color||(this._color=this._lastColor.clone()),r={palette:$({element:t._root.palette.picker,wrapper:t._root.palette.palette,onstop:()=>t._emit("changestop","slider",t),onchange(o,n){if(!e.palette)return;const i=s(),{_root:r,options:a}=t,{lastColor:l,currentColor:c}=r.preview;t._recalc&&(i.s=100*o,i.v=100-100*n,i.v<0&&(i.v=0),t._updateOutput("slider"));const p=i.toRGBA().toString(0);this.element.style.background=p,this.wrapper.style.background=`\n                        linear-gradient(to top, rgba(0, 0, 0, ${i.a}), transparent),\n                        linear-gradient(to left, hsla(${i.h}, 100%, 50%, ${i.a}), rgba(255, 255, 255, ${i.a}))\n                    `,a.comparison?a.useAsButton||t._lastColor||l.style.setProperty("--pcr-color",p):(r.button.style.setProperty("--pcr-color",p),r.button.classList.remove("clear"));const u=i.toHEXA().toString();for(const{el:e,color:o}of t._swatchColors)e.classList[u===o.toHEXA().toString()?"add":"remove"]("pcr-active");c.style.setProperty("--pcr-color",p)}}),hue:$({lock:"v"===i?"h":"v",element:t._root.hue.picker,wrapper:t._root.hue.slider,onstop:()=>t._emit("changestop","slider",t),onchange(o){if(!e.hue||!e.palette)return;const n=s();t._recalc&&(n.h=360*o),this.element.style.backgroundColor=`hsl(${n.h}, 100%, 50%)`,r.palette.trigger()}}),opacity:$({lock:"v"===n?"h":"v",element:t._root.opacity.picker,wrapper:t._root.opacity.slider,onstop:()=>t._emit("changestop","slider",t),onchange(o){if(!e.opacity||!e.palette)return;const n=s();t._recalc&&(n.a=Math.round(100*o)/100),this.element.style.background=`rgba(0, 0, 0, ${n.a})`,r.palette.trigger()}}),selectable:k({elements:t._root.interaction.options,className:"active",onchange(e){t._representation=e.target.getAttribute("data-type").toUpperCase(),t._recalc&&t._updateOutput("swatch")}})};this._components=r}_bindEvents(){const{_root:t,options:e}=this,o=[i(t.interaction.clear,"click",(()=>this._clearColor())),i([t.interaction.cancel,t.preview.lastColor],"click",(()=>{this.setHSVA(...(this._lastColor||this._color).toHSVA(),!0),this._emit("cancel")})),i(t.interaction.save,"click",(()=>{!this.applyColor()&&!e.showAlways&&this.hide()})),i(t.interaction.result,["keyup","input"],(t=>{this.setColor(t.target.value,!0)&&!this._initializingActive&&(this._emit("change",this._color,"input",this),this._emit("changestop","input",this)),t.stopImmediatePropagation()})),i(t.interaction.result,["focus","blur"],(t=>{this._recalc="blur"===t.type,this._recalc&&this._updateOutput(null)})),i([t.palette.palette,t.palette.picker,t.hue.slider,t.hue.picker,t.opacity.slider,t.opacity.picker],["mousedown","touchstart"],(()=>this._recalc=!0),{passive:!0})];if(!e.showAlways){const n=e.closeWithKey;o.push(i(t.button,"click",(()=>this.isOpen()?this.hide():this.show())),i(document,"keyup",(t=>this.isOpen()&&(t.key===n||t.code===n)&&this.hide())),i(document,["touchstart","mousedown"],(e=>{this.isOpen()&&!l(e).some((e=>e===t.app||e===t.button))&&this.hide()}),{capture:!0}))}if(e.adjustableNumbers){const e={rgba:[255,255,255,1],hsva:[360,100,100,1],hsla:[360,100,100,1],cmyk:[100,100,100,100]};p(t.interaction.result,((t,o,n)=>{const i=e[this.getColorRepresentation().toLowerCase()];if(i){const e=i[n],s=t+(e>=100?1e3*o:o);return s<=0?0:Number((s<e?s:e).toPrecision(3))}return t}))}if(e.autoReposition&&!e.inline){let t=null;const n=this;o.push(i(window,["scroll","resize"],(()=>{n.isOpen()&&(e.closeOnScroll&&n.hide(),null===t?(t=setTimeout((()=>t=null),100),requestAnimationFrame((function e(){n._rePositioningPicker(),null!==t&&requestAnimationFrame(e)}))):(clearTimeout(t),t=setTimeout((()=>t=null),100)))}),{capture:!0}))}this._eventBindings=o}_rePositioningPicker(){const{options:t}=this;if(!t.inline){if(!this._nanopop.update({container:document.body.getBoundingClientRect(),position:t.position})){const t=this._root.app,e=t.getBoundingClientRect();t.style.top=(window.innerHeight-e.height)/2+"px",t.style.left=(window.innerWidth-e.width)/2+"px"}}}_updateOutput(t){const{_root:e,_color:o,options:n}=this;if(e.interaction.type()){const t=`to${e.interaction.type().getAttribute("data-type")}`;e.interaction.result.value="function"==typeof o[t]?o[t]().toString(n.outputPrecision):""}!this._initializingActive&&this._recalc&&this._emit("change",o,t,this)}_clearColor(t=!1){const{_root:e,options:o}=this;o.useAsButton||e.button.style.setProperty("--pcr-color","rgba(0, 0, 0, 0.15)"),e.button.classList.add("clear"),o.showAlways||this.hide(),this._lastColor=null,this._initializingActive||t||(this._emit("save",null),this._emit("clear"))}_parseLocalColor(t){const{values:e,type:o,a:n}=w(t),{lockOpacity:i}=this.options,s=void 0!==n&&1!==n;return e&&3===e.length&&(e[3]=void 0),{values:!e||i&&s?null:e,type:o}}_t(t){return this.options.i18n[t]||L.I18N_DEFAULTS[t]}_emit(t,...e){this._eventListener[t].forEach((t=>t(...e,this)))}on(t,e){return this._eventListener[t].push(e),this}off(t,e){const o=this._eventListener[t]||[],n=o.indexOf(e);return~n&&o.splice(n,1),this}addSwatch(t){const{values:e}=this._parseLocalColor(t);if(e){const{_swatchColors:t,_root:o}=this,n=A(...e),s=r(`<button type="button" style="--pcr-color: ${n.toRGBA().toString(0)}" aria-label="${this._t("btn:swatch")}"/>`);return o.swatches.appendChild(s),t.push({el:s,color:n}),this._eventBindings.push(i(s,"click",(()=>{this.setHSVA(...n.toHSVA(),!0),this._emit("swatchselect",n),this._emit("change",n,"swatch",this)}))),!0}return!1}removeSwatch(t){const e=this._swatchColors[t];if(e){const{el:o}=e;return this._root.swatches.removeChild(o),this._swatchColors.splice(t,1),!0}return!1}applyColor(t=!1){const{preview:e,button:o}=this._root,n=this._color.toRGBA().toString(0);return e.lastColor.style.setProperty("--pcr-color",n),this.options.useAsButton||o.style.setProperty("--pcr-color",n),o.classList.remove("clear"),this._lastColor=this._color.clone(),this._initializingActive||t||this._emit("save",this._color),this}destroy(){cancelAnimationFrame(this._setupAnimationFrame),this._eventBindings.forEach((t=>s(...t))),Object.keys(this._components).forEach((t=>this._components[t].destroy()))}destroyAndRemove(){this.destroy();const{root:t,app:e}=this._root;t.parentElement&&t.parentElement.removeChild(t),e.parentElement.removeChild(e),Object.keys(this).forEach((t=>this[t]=null))}hide(){return!!this.isOpen()&&(this._root.app.classList.remove("visible"),this._emit("hide"),!0)}show(){return!this.options.disabled&&!this.isOpen()&&(this._root.app.classList.add("visible"),this._rePositioningPicker(),this._emit("show",this._color),this)}isOpen(){return this._root.app.classList.contains("visible")}setHSVA(t=360,e=0,o=0,n=1,i=!1){const s=this._recalc;if(this._recalc=!1,t<0||t>360||e<0||e>100||o<0||o>100||n<0||n>1)return!1;this._color=A(t,e,o,n);const{hue:r,opacity:a,palette:l}=this._components;return r.update(t/360),a.update(n),l.update(e/100,1-o/100),i||this.applyColor(),s&&this._updateOutput(),this._recalc=s,!0}setColor(t,e=!1){if(null===t)return this._clearColor(e),!0;const{values:o,type:n}=this._parseLocalColor(t);if(o){const t=n.toUpperCase(),{options:i}=this._root.interaction,s=i.find((e=>e.getAttribute("data-type")===t));if(s&&!s.hidden)for(const t of i)t.classList[t===s?"add":"remove"]("active");return!!this.setHSVA(...o,e)&&this.setColorRepresentation(t)}return!1}setColorRepresentation(t){return t=t.toUpperCase(),!!this._root.interaction.options.find((e=>e.getAttribute("data-type").startsWith(t)&&!e.click()))}getColorRepresentation(){return this._representation}getColor(){return this._color}getSelectedColor(){return this._lastColor}getRoot(){return this._root}disable(){return this.hide(),this.options.disabled=!0,this._root.button.classList.add("disabled"),this}enable(){return this.options.disabled=!1,this._root.button.classList.remove("disabled"),this}}return E(L,"utils",o),E(L,"version","1.8.2"),E(L,"I18N_DEFAULTS",{"ui:dialog":"color picker dialog","btn:toggle":"toggle color picker dialog","btn:swatch":"color swatch","btn:last-color":"use previous color","btn:save":"Save","btn:cancel":"Cancel","btn:clear":"Clear","aria:btn:save":"save and close","aria:btn:cancel":"cancel and close","aria:btn:clear":"clear and close","aria:input":"color input field","aria:palette":"color selection area","aria:hue":"hue selection slider","aria:opacity":"selection slider"}),E(L,"DEFAULT_OPTIONS",{appClass:null,theme:"classic",useAsButton:!1,padding:8,disabled:!1,comparison:!0,closeOnScroll:!1,outputPrecision:0,lockOpacity:!1,autoReposition:!0,container:"body",components:{interaction:{}},i18n:{},swatches:null,inline:!1,sliders:null,default:"#42445a",defaultRepresentation:null,position:"bottom-middle",adjustableNumbers:!0,showAlways:!1,closeWithKey:"Escape"}),E(L,"create",(t=>new L(t))),e=e.default})()}));
const app_title='GyverHub';const non_esp='__ESP__';const non_app='__APP__';const non_host='';const app_version='0.55b';const hub=new GyverHub();const colors={ORANGE:0xd55f30,YELLOW:0xd69d27,GREEN:0x37A93C,MINT:0x25b18f,AQUA:0x2ba1cd,BLUE:0x297bcd,VIOLET:0x825ae7,PINK:0xc8589a,};const themes={DARK:0,LIGHT:1};const theme_cols=[['#1b1c20','#26272c','#eee','#ccc','#141516','#444','#0e0e0e','dark','#222','#000'],['#eee','#fff','#111','#333','#ddd','#999','#bdbdbd','light','#fff','#000000a3']];function getError(code){return lang.errors[code];}
let deferredPrompt=null;let screen='main';let focused=null;let cfg_changed=false;let cfg={serial_offset:2000,use_pin:false,pin:'',theme:isDark()?'DARK':'LIGHT',maincolor:'GREEN',font:'monospace',check_upd:true,ui_width:450,lang:userLang(),app_plugin_css:'',app_plugin_js:'',api_ver:1,};function platform(){if(!non_host)return'host';if(!non_esp)return'esp';if('GyverHubDesktop'in window)return'desktop';if('flutter_inappwebview'in window)return'mobile';return'local';}
function isDark(){return window.matchMedia("(prefers-color-scheme: dark)").matches;}
function isSSL(){return window.location.protocol=='https:';}
function wifiAllowed(){return platform()!='host'||!isSSL();}
function isTouch(){return navigator.maxTouchPoints||'ontouchstart'in document.documentElement;}
function hasSerial(){return("serial"in navigator)||platform()=='mobile';}
function hasBT(){return("bluetooth"in navigator)||platform()=='mobile';}
function userLang(){switch(navigator.language||navigator.userLanguage){case'ru-RU':return'Russian';}
return'English';}
async function pwa_install(ssl){if(ssl&&!isSSL()){if(await asyncConfirm(lang.redirect+" HTTPS?"))window.location.href=window.location.href.replace('http:','https:');else return;}
if(!ssl&&isSSL()){if(await asyncConfirm(lang.redirect+" HTTP"))window.location.href=window.location.href.replace('https:','http:');else return;}
if(!('serviceWorker'in navigator)){asyncAlert(lang.error);return;}
if(deferredPrompt!==null){deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;if(outcome==='accepted')deferredPrompt=null;}}
function addIdRecursive(node,add){for(let i=0;i<node.childNodes.length;i++){let child=node.childNodes[i];addIdRecursive(child,add);if(child.id)child.id+=add;}}
function truncIdRecursive(node,trunc){for(let i=0;i<node.childNodes.length;i++){let child=node.childNodes[i];truncIdRecursive(child,trunc);if(child.id&&child.id.endsWith(trunc))child.id=child.id.split(trunc)[0];}}
function addDOM(el_id,tag,text,target){if(EL(el_id))EL(el_id).remove();let el=document.createElement(tag);el.textContent=text;el.id=el_id;target.appendChild(el);return el;}
function getErrColor(){return'#8e1414';}
function getDefColor(){return intToCol(colors[cfg.maincolor]);}
function dataTotext(data){return b64ToText(data.split('base64,')[1]);}
function b64ToText(base64){const binString=atob(base64);return new TextDecoder().decode(Uint8Array.from(binString,(m)=>m.codePointAt(0)));}
String.prototype.hashCode=function(){if(!this.length)return 0;let hash=new Uint32Array(1);for(let i=0;i<this.length;i++){hash[0]=((hash[0]<<5)-hash[0])+this.charCodeAt(i);}
return hash[0];}
function getMime(name){const mime_table={'avi':'video/x-msvideo','bin':'application/octet-stream','bmp':'image/bmp','css':'text/css','csv':'text/csv','gz':'application/gzip','gif':'image/gif','html':'text/html','jpeg':'image/jpeg','jpg':'image/jpeg','js':'text/javascript','json':'application/json','png':'image/png','svg':'image/svg+xml','txt':'text/plain','wav':'audio/wav','xml':'application/xml',};let ext=name.split('.').pop();if(ext in mime_table)return mime_table[ext];else return'text/plain';}
function openURL(url){window.open(url,'_blank').focus();}
function intToCol(val){if(val===null||val===undefined)return null;return"#"+Number(val).toString(16).padStart(6,'0');}
function intToColA(val){if(val===null||val===undefined)return null;return"#"+Number(val).toString(16).padStart(8,'0');}
function constrain(val,min,max){return val<min?min:(val>max?max:val);}
function colToInt(str){return parseInt(str.substr(1),16);}
function adjustColor(col,ratio){let intcol=0;col=col.toString();if(col.startsWith('#')){col=col.slice(1);if(col.length==3){col=col[0]+col[0]+col[1]+col[1]+col[2]+col[2];}
intcol=parseInt(col,16);}else if(col.startsWith("rgb(")){col.replace("rgb(","").replace(")","").replace(" ","").split(',').forEach(v=>intcol=(intcol<<8)|v);}else{intcol=Number(col);}
let newcol='#';for(let i=0;i<3;i++){let comp=(intcol&0xff0000)>>16;comp=Math.min(255,Math.floor((comp+1)*ratio));newcol+=comp.toString(16).padStart(2,'0');intcol<<=8;}
return newcol;}
function crc32(data){let crc=new Uint32Array(1);crc[0]=0;crc[0]=~crc[0];let str=(typeof(data)=='string');for(let i=0;i<data.length;i++){crc[0]^=str?data[i].charCodeAt(0):data[i];for(let i=0;i<8;i++)crc[0]=(crc[0]&1)?((crc[0]/2)^0x4C11DB7):(crc[0]/2);}
crc[0]=~crc[0];return crc[0];}
function random(min,max){return Math.floor(Math.random()*(max-min+1)+min)}
function parseCSV(str){const arr=[];let quote=false;for(let row=0,col=0,c=0;c<str.length;c++){let cc=str[c],nc=str[c+1];arr[row]=arr[row]||[];arr[row][col]=arr[row][col]||'';if(cc=='"'&&quote&&nc=='"'){arr[row][col]+=cc;++c;continue;}
if(cc=='"'){quote=!quote;continue;}
if(cc==';'&&!quote){++col;continue;}
if(cc=='\r'&&nc=='\n'&&!quote){++row;col=0;++c;continue;}
if(cc=='\n'&&!quote){++row;col=0;continue;}
if(cc=='\r'&&!quote){++row;col=0;continue;}
arr[row][col]+=cc;}
return arr;}
function openFile(src){let w=window.open();src=w.document.write('<iframe src="'+src+'" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');}
async function copyClip(text){try{await navigator.clipboard.writeText(text);showPopup(lang.clip_copy);}catch(e){showPopupError(lang.error);}}
function getIcon(icon){if(!icon)return'';return icon.length==1?icon:String.fromCharCode(Number('0x'+icon));}
function notSupported(){asyncAlert(lang.p_not_support);}
function browser(){if(navigator.userAgent.includes("Opera")||navigator.userAgent.includes('OPR'))return'opera';else if(navigator.userAgent.includes("Edg"))return'edge';else if(navigator.userAgent.includes("Chrome"))return'chrome';else if(navigator.userAgent.includes("Safari"))return'safari';else if(navigator.userAgent.includes("Firefox"))return'firefox';else if((navigator.userAgent.includes("MSIE"))||(!!document.documentMode==true))return'IE';else return'unknown';}
function ratio(){return window.devicePixelRatio;}
function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms));}
function EL(id){return document.getElementById(id);}
function ID(id){return'__'+id;}
function CMP(id){return EL(ID(id));}
function display(id,value){EL(id).style.display=value;}
function getUnix(arg){return Math.floor(arg.valueAsNumber/1000);}
function showNotif(name,text){if(!("Notification"in window)||Notification.permission!='granted')return;let descr=name+' ('+new Date(Date.now()).toLocaleString()+')';navigator.serviceWorker.getRegistration().then(function(reg){reg.showNotification(text,{body:descr,vibrate:true});}).catch(e=>console.log(e));}
function waitFrame(){return new Promise(requestAnimationFrame);}
async function wait2Frame(){await waitFrame();await waitFrame();}
async function waitRender(id){while(true){if(EL(id))return Promise.resolve(1);await waitFrame();}}
function window_ip(){let ip=window.location.href.split('/')[2].split(':')[0];return checkIP(ip)?ip:null;}
function getMaskList(){let list=[];for(let i=0;i<33;i++){let imask;if(i==32)imask=0xffffffff;else imask=~(0xffffffff>>>i);list.push(`${(imask >>> 24) & 0xff}.${(imask >>> 16) & 0xff}.${(imask >>> 8) & 0xff}.${imask & 0xff}`);}
return list;}
function getLocalIP(){return new Promise(function(resolve,reject){var RTCPeerConnection=window.webkitRTCPeerConnection||window.mozRTCPeerConnection;if(!RTCPeerConnection)reject('Auto local IP not supported');var rtc=new RTCPeerConnection({iceServers:[]});var addrs={};addrs["0.0.0.0"]=false;function grepSDP(sdp){var hosts=[];var finalIP='';sdp.split('\r\n').forEach(function(line){if(~line.indexOf("a=candidate")){var parts=line.split(' '),addr=parts[4],type=parts[7];if(type==='host'){finalIP=addr;}}else if(~line.indexOf("c=")){var parts=line.split(' '),addr=parts[2];finalIP=addr;}});return finalIP;}
if(1||window.mozRTCPeerConnection){rtc.createDataChannel('',{reliable:false});};rtc.onicecandidate=function(evt){if(evt.candidate){var addr=grepSDP("a="+evt.candidate.candidate);resolve(addr);}};rtc.createOffer(function(offerDesc){rtc.setLocalDescription(offerDesc);},function(e){return;});});}
class UiRender{contIdx=0;prevWidth=1;dup_names='';root=null;widgets={};add(type,w_class){this.widgets[type]=w_class;}
addWidget(type,wid,ctrl){let w=this.widgets[type];if(w&&w.render)w.render(wid,ctrl);}
updateWidget(type,id,data){let w=this.widgets[type];if(w&&w.update)w.update(id,data);}
clearWidgets(){for(let w of Object.values(this.widgets)){if(w.clear)w.clear();}}
resizeWidgets(){for(let w of Object.values(this.widgets)){if(w.resize)w.resize();}}
isHidden(type){let w=this.widgets[type];return(w&&w.hidden==1);}
reset(){this.contIdx=0;this.prevWidth=1;this.dup_names='';}
render(cont,type,data,single){let non_widgets=['menu','dummy','js','css','confirm','prompt','plugin','hook','ui_file'];switch(type){case'row':let sumw=0;for(let ctrl of data){if(!ctrl.type||non_widgets.includes(ctrl.type))continue;if(!ctrl.wwidth)ctrl.wwidth=this.prevWidth;else this.prevWidth=ctrl.wwidth;sumw+=ctrl.wwidth;}
for(let ctrl of data){if(!ctrl.type||non_widgets.includes(ctrl.type))continue;ctrl.wwidth_t=ctrl.wwidth*100/sumw;}
break;case'col':for(let ctrl of data){if(!ctrl.type||non_widgets.includes(ctrl.type))continue;ctrl.wwidth_t=100;}
break;}
for(let ctrl of data){if(!ctrl.type)continue;if(ctrl.type=='hook'){UiHook.bind(ctrl.id,ctrl.value);continue;}
if(ctrl.type=='row'||ctrl.type=='col'){if(single){this.render(cont,'col',ctrl.data,single);}else{this.contIdx++;let newCont='container#'+this.contIdx;cont.innerHTML+=`<div class="${'widget_' + ctrl.type}" id="${newCont}" style="width:${ctrl.wwidth_t}%"></div>`;this.render(EL(newCont),ctrl.type,ctrl.data,single);}}else{if(ctrl.id&&CMP(ctrl.id)){if(this.dup_names.length)this.dup_names+=', ';this.dup_names+=ctrl.id;continue;}
switch(ctrl.type){case'space':ctrl.nolabel=1;ctrl.notab=1;break;case'title':ctrl.nolabel=1;ctrl.notab=1;ctrl.square=0;break;case'menu':Menu.render(ctrl);continue;case'dummy':continue;case'ui_file':UiFile.render(cont,ctrl,type,single);continue;case'plugin':UiPlugin.render(this.root,ctrl);continue;case'js':UiJS.render(this.root,ctrl);continue;case'css':UiCSS.render(this.root,ctrl);continue;case'confirm':UiConfirm.render(cont,ctrl);continue;case'prompt':UiPrompt.render(cont,ctrl);continue;}
if(this.isHidden(ctrl.type)){this.addWidget(ctrl.type,null,ctrl);continue;}
let wid=new Widget(cont,ctrl,ctrl.wwidth_t);this.addWidget(ctrl.type,wid,ctrl);}}}}
class Menu{static render(ctrl){let inner='';let labels=[];if(ctrl!=null&&ctrl.text){labels=ctrl.text.toString().split(';');for(let i in labels){let sel=(i==ctrl.value)?'menu_act':'';inner+=`<div onclick="Menu.click(${i})" class="menu_item ${sel}">${labels[i].trim()}</div>`;}}
EL('menu_user').innerHTML=inner;EL('menu_system').innerHTML=`<div id="menu_cfg" class="menu_item" onclick="cfg_h()">${lang.m_config}</div>`;EL('menu_system').innerHTML+=`<div id="menu_info" class="menu_item" onclick="info_h()">${lang.m_info}</div>`;let count=2;let dev=hub.dev(focused);if(dev.module(Modules.FILES)){count++;EL('menu_system').innerHTML+=`<div id="menu_fsbr" class="menu_item" onclick="fsbr_h()">${lang.m_files}</div>`;}
if(dev.module(Modules.OTA)||dev.module(Modules.OTA_URL)){count++;EL('menu_system').innerHTML+=`<div id="menu_ota" class="menu_item" onclick="ota_h()">${lang.m_ota}</div>`;}
document.querySelector(':root').style.setProperty('--menu_h',((labels.length+count)*35+10)+'px');}
static clear(){Menu.render(null);}
static click(num){try{hub.dev(focused).fsStop();}catch(e){}
menu_show(0);Menu.deact();if(screen!='ui')show_screen('ui');post_set('_menu',num);}
static deact(){let els=Array.from(document.getElementById('menu_user').children).filter(el=>el.tagName=='DIV');els.push(EL('menu_cfg'),EL('menu_info'),EL('menu_fsbr'),EL('menu_ota'));for(let el in els)if(els[el])els[el].classList.remove('menu_act');}};
class Widget{constructor(cont,data,width){cont.innerHTML+=`
<div id="widget_main#${data.id}" class="widget_main ${data.square ? 'wsquare' : ''}" style="width:${width}%">
<div id="widget_inner#${data.id}" class="widget_inner ${(data.notab && data.notab == 1) ? 'widget_notab' : ''}">
<div id="wlabel_cont#${data.id}" class="widget_label ${data.nolabel ? 'wnolabel' : ''}">
<span id="whint#${data.id}" class="whint" onclick="asyncAlert(this.title)">?</span>
<span id="wlabel#${data.id}">${(data.label && data.label.length) ? data.label : data.type.toUpperCase()}</span>
<span id="plabel#${data.id}" class="plabel"></span>
<span id="wsuffix#${data.id}" class="wsuffix">${data.suffix ?? ''}</span>
</div>
<div id=widget#${data.id} class="widget_body ${data.disable ? 'widget_dsbl' : ''}" style="${(data.wheight && data.wheight > 25) ? ('min-height:' + data.wheight + 'px') : ''}"></div>
</div>
</div>
`;waitFrame().then(()=>Widget.hint(data.id,data.hint));return EL('widget#'+data.id);}
static update(type,id,data){if('label'in data){EL('wlabel#'+id).innerHTML=data.label.length?data.label:type.toUpperCase();}
if('suffix'in data){EL('wsuffix#'+id).innerHTML=data.suffix;}
if('nolabel'in data){if(data.nolabel)EL('wlabel_cont#'+id).classList.add('wnolabel');else EL('wlabel_cont#'+id).classList.remove('wnolabel');}
if('square'in data){if(data.square)EL('widget_main#'+id).classList.add('wsquare');else EL('widget_main#'+id).classList.remove('wsquare');}
if('notab'in data){if(data.notab)EL('widget_inner#'+id).classList.add('widget_notab');else EL('widget_inner#'+id).classList.remove('widget_notab');}
if('disable'in data){if(data.disable)EL('widget#'+id).classList.add('widget_dsbl');else EL('widget#'+id).classList.remove('widget_dsbl');}
if('hint'in data){Widget.hint(id,data.hint)}}
static hint(id,text){let htext='name: '+id+'\n'+(text??'');EL('wlabel#'+id).title=htext;let hint=EL('whint#'+id);hint.title=htext;hint.style.display=(text&&text.length)?'inline-block':'none';}
static disable(id,disable){let el=CMP(id);if(disable){el.setAttribute('disabled','1');el.classList.add('disable');}else{el.removeAttribute('disabled');el.classList.remove('disable');}}
static align(id,align){EL('widget#'+id).style.justifyContent=["flex-start","center","flex-end"][Number(align??1)];}
static setPlabel(id,text=null){let pl=EL('plabel#'+id);if(pl)pl.innerHTML=text??'';}};
class UiButton{static render(cont,data){cont.innerHTML=`<button data-type="${data.type}" id="${ID(data.id)}" style="font-size:${data.fsize ?? 45}px;color:${intToCol(data.color) ?? 'var(--prim)'}" class="icon w_btn" onclick="post_set('${data.id}',2)" onmousedown="if(!UiButton.touch)post_click('${data.id}',1)" onmouseup="if(!UiButton.touch&&UiButton.pressID)post_click('${data.id}',0)" onmouseleave="if(UiButton.pressID&&!UiButton.touch)post_click('${data.id}',0);" ontouchstart="UiButton.touch=1;post_click('${data.id}',1)" ontouchend="post_click('${data.id}',0)" data-color="${intToCol(data.color) ?? 'var(--prim)'}" data-size="${data.fsize ?? 45}px"></button>`;UiButton.setIcon(data.id,data.icon);Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('icon'in data){UiButton.setIcon(id,data.icon);}
if('color'in data){let col=intToCol(data.color);el.style.color=col;el.style.fill=col;el.setAttribute("data-color",col);}
if('fsize'in data){let size=data.fsize+'px';el.style.fontSize=size;if(!el.getAttribute("data-inline"))el.style.width=size;else el.style.width='unset';el.setAttribute("data-size",size);}
if('disable'in data){Widget.disable(id,data.disable);}}
static apply(id,icon){let el=CMP(id);el.innerHTML=icon;el.style.width=el.getAttribute("data-size");el.style.fill=el.getAttribute("data-color");}
static setIcon(id,text){let el=CMP(id);if(!el)return;let icon="";el.style.width='unset';if(text){if(text.includes(".svg")){hub.dev(focused).addFile(id,text,{type:"icon"});el.removeAttribute("data-inline");return;}else{icon=getIcon(text);}}
el.innerHTML=icon;el.setAttribute("data-inline",true);}
static pressID=null;static touch=0;};
class UiLabel{static render(cont,data){cont.innerHTML=`<div id=lbl_cont#${data.id} class='w_label' style="color:${intToCol(data.color) ?? 'unset'};font-size:${data.fsize ?? 33}px"><span id="lbl_icon#${data.id}" class="w_icon">${data.icon ? (getIcon(data.icon) + ' ') : ''}</span><label data-type="${data.type}" id='${ID(data.id)}'>${data.value ?? ''}</label></div>`;Widget.align(data.id,data.align);}
static update(id,data){let el=CMP(id);let cont=EL('lbl_cont#'+id);if('value'in data)el.innerHTML=data.value;if('color'in data)cont.style.color=intToCol(data.color);if('fsize'in data)cont.style.fontSize=data.fsize+'px';if('align'in data)Widget.align(id,data.align);if('icon'in data){EL('lbl_icon#'+id).innerHTML=data.icon?(getIcon(data.icon)+' '):'';}}};
class UiTitle{static render(cont,data){cont.innerHTML=`<div id=lbl_cont#${data.id} class='w_label' style="color:${intToCol(data.color) ?? 'unset'};font-size:${data.fsize ?? 35}px"><span id="lbl_icon#${data.id}" class="w_icon">${data.icon ? (getIcon(data.icon) + ' ') : ''}</span><label data-type="${data.type}" id='${ID(data.id)}'>${data.value ?? ''}</label></div>`;Widget.align(data.id,data.align);}
static update(id,data){let el=CMP(id);let cont=EL('lbl_cont#'+id);if('value'in data)el.innerHTML=data.value;if('color'in data)cont.style.color=intToCol(data.color);if('fsize'in data)cont.style.fontSize=data.fsize+'px';if('align'in data)Widget.align(id,data.align);if('icon'in data){EL('lbl_icon#'+id).innerHTML=data.icon?(getIcon(data.icon)+' '):'';}}};
class UiPlugin{static render(cont,data){let dev_id=focused;if(data.js&&data.js.length&&!EL(dev_id+'_script')){if(data.js.endsWith('.js')){hub.dev(dev_id).addFile('_script',data.js,{type:"plugin_js",cont:cont});}else{UiPlugin.applyScript(dev_id,data.js);}}
if(data.css&&data.css.length&&!EL(dev_id+'_style')){if(data.css.endsWith('.css')){hub.dev(dev_id).addFile('_style',data.css,{type:"plugin_css"});}else{UiPlugin.applyStyle(dev_id,data.css);}}}
static applyScript(dev_id,text){addDOM(dev_id+'_script','script',text.replaceAll('function ','function '+dev_id+'_'),document.body);}
static applyStyle(dev_id,text){addDOM(dev_id+'_style','style',text,document.body);}
static enableStyle(dev_id){let el=EL(dev_id+'_style');if(el)el.disabled=false;}
static disableStyle(dev_id){let el=EL(dev_id+'_style');if(el)el.disabled=true;}};
class UiSwitch{static render(cont,data){cont.innerHTML=`
<style id="style#${data.id}"></style>
<div class="switch_cont"><label id="swlabel_${data.id}" class="switch"><input type="checkbox" data-type="${data.type}" id='${ID(data.id)}' onclick="post_set('${data.id}',(this.checked ? 1 : 0))" ${data.value == '1' ? 'checked' : ''}><span class="slider"></span></label></div>`;UiSwitch.color(data.id,data.color);Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data)el.checked=(Number(data.value)==1);if('color'in data)UiSwitch.color(id,data.color);if('disable'in data)Widget.disable(id,data.disable);}
static color(id,color){if(color){EL('style#'+id).innerHTML=`#swlabel_${id} input:checked+.slider{background:${intToCol(color) ?? 'var(--prim)'}`;}}};
class UiSwicon{static render(cont,data){cont.innerHTML=`
<style id="style#${data.id}"></style>
<div data-type="${data.type}" id="${ID(data.id)}" style="font-size:${data.fsize ?? 45}px;width:${data.fsize ? data.fsize * 1.7 : 75}px" class="icon icon_btn_big w_swicon ${data.value == '1' ? 'w_swicon_on' : ''}" onclick="UiSwicon.click('${data.id}')">${data.icon ? getIcon(data.icon) : ''}</div>`;UiSwicon.color(data.id,intToCol(data.color)??getDefColor());Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data){if(Number(data.value)==1)el.classList.add('w_swicon_on');else el.classList.remove('w_swicon_on');}
if('fsize'in data){el.style.fontSize=data.fsize+'px';el.style.width=data.fsize*1.7+'px';}
if('icon'in data)el.innerHTML=getIcon(data.icon);if('color'in data)UiSwicon.color(id,intToCol(data.color));if('disable'in data)Widget.disable(id,data.disable);}
static click(id){let el=CMP(id);if(el.getAttribute('disabled'))return;el.classList.toggle('w_swicon_on');post_set(id,(el.classList.contains('w_swicon_on')?1:0));}
static color(id,color){if(color){EL('style#'+id).innerHTML=`
#${ID(id)}.w_swicon {
color: ${color};
border: 2px solid ${color};
}
#${ID(id)}.w_swicon_on {
color: var(--tab);
background: ${color};
`;}}};
class UiDisplay{static render(cont,data){cont.innerHTML=`<textarea data-type="${data.type}" id="${ID(data.id)}" onwheel="UiDisplay.wheel(event,this)" class="w_disp" style="font-size:${data.fsize ?? 20}px;background:${intToCol(data.color) ?? 'var(--prim)'}" rows="${data.rows ?? 2}" readonly>${data.value ?? ''}</textarea>`;}
static update(id,data){let el=CMP(id);if('value'in data)el.innerHTML=data.value;if('color'in data)el.style.background=intToCol(data.color);if('fsize'in data)el.style.fontSize=data.fsize+'px';if('rows'in data)el.rows=data.rows;}
static wheel(e,el){e.preventDefault();el.scrollLeft+=e.deltaY;}};
class UiImage{static render(cont,data){cont.innerHTML=`<div data-type="${data.type}" data-path="${data.value ?? ''}" id="${ID(data.id)}">${waiter()}</div>`;if(data.value)hub.dev(focused).addFile(data.id,data.value,{type:"img"});}
static update(id,data){let el=CMP(id);if('value'in data){hub.dev(focused).addFile(id,data.value,{type:"img"});el.setAttribute("data-path",data.value);}
if('action'in data){hub.dev(focused).addFile(id,el.getAttribute("data-path"),{type:"img"});}}
static apply(id,file){CMP(id).innerHTML=`<img style="width:100%" src="${file}">`;}};
class UiTable{static render(cont,data){if(!data.value)data.value='';let isFile=(!data.value.includes(';')&&data.value.endsWith(".csv"));cont.innerHTML=`<div data-type="${data.type}" data-align="${data.align ?? ''}" data-width="${data.width ?? ''}" id="${ID(data.id)}" style="display:contents" data-path="${isFile ? data.value : ''}" data-csv="${isFile ? '' : data.value}"></div>`;if(isFile){hub.dev(focused).addFile(data.id,data.value,{type:"csv"});CMP(data.id).innerHTML=waiter();}else{UiTable.show(data.id);}}
static update(id,data){let el=CMP(id);if('action'in data){hub.dev(focused).addFile(id,el.getAttribute("data-path"),{type:"csv"});}
if('value'in data){let val=data.value;if(!val.includes(';')&&val.endsWith(".csv")){hub.dev(focused).addFile(id,val,{type:"csv"});el.setAttribute("data-path",val);}else{el.setAttribute("data-csv",val);UiTable.show(id);}}
if('align'in data){el.setAttribute("data-align",data.align);UiTable.show(id);}
if('width'in data){el.setAttribute("data-width",data.width);UiTable.show(id);}}
static apply(id,csv){CMP(id).setAttribute("data-csv",csv);UiTable.show(id);}
static async show(id){let el=CMP(id);let aligns=el.getAttribute("data-align").split(';');let widths=el.getAttribute("data-width").split(';');let table=parseCSV(el.getAttribute("data-csv"));let inner=`<table class="w_table">`;for(let row of table){inner+='<tr>';for(let col in row){inner+=`<td width="${widths[col] ? (widths[col] + '%') : ''}" align="${aligns[col] ? aligns[col] : 'center'}">${row[col]}</td>`;}
inner+='</tr>';}
inner+='</table>';el.innerHTML=inner;}};
class UiDate{static render(cont,data){let date=new Date((data.value??0)*1000).toISOString().split('T')[0];cont.innerHTML=`<input data-type="${data.type}" id='${ID(data.id)}' class="w_date" style="color:${intToCol(data.color) ?? 'var(--prim)'}" type="date" value="${date}" onclick="this.showPicker()" onchange="post_set('${data.id}',getUnix(this))">`;Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data)el.value=new Date(data.value*1000).toISOString().split('T')[0];if('color'in data)el.style.color=intToCol(data.color);}};class UiTime{static render(cont,data){let time=new Date((data.value??0)*1000).toISOString().split('T')[1].split('.')[0];cont.innerHTML=`<input data-type="${data.type}" id='${ID(data.id)}' class="w_date" style="color:${intToCol(data.color) ?? 'var(--prim)'}" type="time" value="${time}" onclick="this.showPicker()" onchange="post_set('${data.id}',getUnix(this))" step="1">`;Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data)el.value=new Date(data.value*1000).toISOString().split('T')[1].split('.')[0];if('color'in data)el.style.color=intToCol(data.color);}};class UiDateTime{static render(cont,data){let datetime=new Date((data.value??0)*1000).toISOString().split('.')[0];cont.innerHTML=`<input data-type="${data.type}" id='${ID(data.id)}' class="w_date" style="color:${intToCol(data.color) ?? 'var(--prim)'}" type="datetime-local" value="${datetime}" onclick="this.showPicker()" onchange="post_set('${data.id}',getUnix(this))" step="1">`;Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data)el.value=new Date(data.value*1000).toISOString().split('.')[0];if('color'in data)el.style.color=intToCol(data.color);}};
class UiConfirm{static render(cont,data){cont.innerHTML+=`<div id="widget#${data.id}" style="display:none"><div data-type="${data.type}" id="${ID(data.id)}" data-text="${data.text ?? 'No text'}"></div></div>`;}
static async update(id,data){let el=CMP(id);if('action'in data){release_all();let res=await asyncConfirm(el.getAttribute("data-text"));post_set(id,res?1:0);}
if('text'in data){el.setAttribute("data-text",data.text);}}};class UiPrompt{static render(cont,data){cont.innerHTML+=`<div id="widget#${data.id}" style="display:none"><div data-type="${data.type}" id="${ID(data.id)}" data-text="${data.text ?? 'No text'}" data-value="${data.value ?? ''}"></div></div>`;}
static async update(id,data){let el=CMP(id);if('action'in data){release_all();let res=await asyncPrompt(el.getAttribute("data-text"),el.getAttribute("data-value"));if(res!==null){el.setAttribute("data-value",res);post_set(id,res);}}
if('value'in data){el.setAttribute("data-value",data.value);}
if('text'in data){el.setAttribute("data-text",data.text);}}};
class UiLog{static render(cont,data){cont.innerHTML=`<textarea data-type="${data.type}" id="${ID(data.id)}" style="color:var(--prim)" class="w_area w_area_passive" rows="${data.rows ?? 5}" readonly>${data.value ? data.value.trim() : ''}</textarea>`;waitFrame().then(()=>CMP(data.id).scrollTop=CMP(data.id).scrollHeight);}
static update(id,data){let el=CMP(id);if('value'in data){el.innerHTML=data.value.trim();el.scrollTop=el.scrollHeight;}
if('rows'in data){el.rows=data.rows;}}};
class UiText{static render(cont,data){cont.innerHTML=`<textarea data-type="${data.type}" id="${ID(data.id)}" class="w_area w_area_passive" rows="${data.rows ?? 5}" readonly>${data.value ?? ''}</textarea>`;}
static update(id,data){let el=CMP(id);if('value'in data)el.innerHTML=data.value;if('rows'in data)el.rows=data.rows;}};class UiText_f{static render(cont,data){cont.innerHTML=`<textarea data-type="${data.type}" id="${ID(data.id)}" data-path="${data.value ?? ''}" class="w_area w_area_passive" rows="${data.rows ?? 5}" readonly></textarea>`;if(data.value)hub.dev(focused).addFile(data.id,data.value,{type:"text"});}
static update(id,data){let el=CMP(id);if('action'in data){hub.dev(focused).addFile(id,el.getAttribute("data-path"),{type:"text"});}
if('value'in data){hub.dev(focused).addFile(id,data.value,{type:"text"});el.setAttribute("data-path",data.value);}
if('rows'in data){el.rows=data.rows;}}
static apply(id,text){CMP(id).innerHTML=text;}};
class UiInput{static render(cont,data){cont.innerHTML=`
<div class="w_inp_cont">
<input data-type="${data.type}" class="w_inp" type="text" value="${data.value ?? ''}" id="${ID(data.id)}" name="${data.id}" onkeydown="UiInput.checkDown(this,event)" oninput="UiInput.check(this)" data-regex="${data.regex ?? ''}" maxlength="${data.maxlen ?? ''}" onfocusout="UiInput.send(this)">
</div>
`;UiInput.color(data.id,data.color);Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('color'in data)UiInput.color(id,data.color);if('value'in data)el.value=data.value;if('regex'in data)el.setAttribute("data-regex",data.regex);if('maxlen'in data)el.maxlength=Math.ceil(data.maxlen);if('disable'in data)Widget.disable(id,data.disable);}
static color(id,color){if(color)CMP(id).style.boxShadow='0px 2px 0px 0px '+intToCol(color);}
static send(arg,force=false){let pattern=arg.getAttribute("data-regex");if(pattern.length){const r=new RegExp(pattern);if(!r.test(arg.value)){showPopupError(lang.wrong_text);return;}}
if(force||arg.getAttribute('data-changed')){arg.removeAttribute('data-changed');post_set(arg.name,arg.value);}}
static check(arg){Ack.set(arg.name);arg.setAttribute('data-changed','1');}
static checkDown(arg,event){if(event.key=='Enter')UiInput.send(arg,true);}};
class UiPass{static render(cont,data){cont.innerHTML=`
<div class="w_inp_cont">
<input data-type="${data.type}" class="w_inp" type="password" value="${data.value ?? ''}" id="${ID(data.id)}" name="${data.id}" onkeydown="UiInput.checkDown(this,event)" oninput="UiInput.check(this)" data-regex="${data.regex ?? ''}" maxlength="${data.maxlen ?? ''}" onfocusout="UiInput.send(this)">
<div class="btn_inp_block">
<button class="icon w_eye" onclick="UiPass.toggle('${data.id}')"></button>
</div>
</div>
`;UiInput.color(data.id,data.color);Widget.disable(data.id,data.disable);}
static toggle(id){let el=CMP(id);if(el.type=='text')el.type='password';else el.type='text';}
static update(id,data){let el=CMP(id);if('color'in data)UiInput.color(id,data.color);if('value'in data)el.value=data.value;if('regex'in data)el.setAttribute("data-regex",data.regex);if('maxlen'in data)el.maxlength=Math.ceil(data.maxlen);if('disable'in data)Widget.disable(id,data.disable);}}
class UiArea{static render(cont,data){cont.innerHTML=`<textarea data-type="${data.type}" class="w_area" id="${ID(data.id)}" name="${data.id}" onkeydown="UiInput.checkDown(this,event)" oninput="UiInput.check(this)" pattern="${data.regex ?? ''}" maxlength="${data.maxlen ?? ''}" onfocusout="UiInput.send(this)">${data.value ?? ''}</textarea>`;UiInput.color(ID(data.id),data.color);Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data)el.innerHTML=data.value;if('maxlen'in data)el.maxlength=Math.ceil(data.maxlen);if('rows'in data)el.rows=data.rows;if('disable'in data)Widget.disable(id,data.disable);}};
class UiSlider{static render(cont,data){cont.innerHTML=`<input data-type="${data.type}" name="${data.id}" id="${ID(data.id)}" oninput="UiSlider.move(this)" type="range" class="w_slider" value="${data.value ?? 0}" min="${data.min ?? 0}" max="${data.max ?? 100}" step="${data.step ?? 1}" data-dec="${data.dec ?? 0}" data-unit="${data.unit ?? ''}" onwheel="UiSlider.wheel(event,this)">
<div class="w_slider_out"><output id="out#${data.id}"></output></div>`;waitFrame().then(()=>UiSlider.move(CMP(data.id),false));UiSlider.color(data.id,data.color);Widget.disable(data.id,data.disable);}
static color(id,color){if(color)CMP(id).style.backgroundImage=`linear-gradient(${intToCol(color)}, ${intToCol(color)})`;}
static update(id,data){let el=CMP(id);if('value'in data)el.value=data.value;if('color'in data)UiSlider.color(id,data.color);if('min'in data)el.min=data.min;if('max'in data)el.max=data.max;if('step'in data)el.step=data.step;if('dec'in data)el.setAttribute("data-dec",data.dec);if('unit'in data)el.setAttribute("data-unit",data.unit);UiSlider.move(el,false);}
static move(el,send=true){el.style.backgroundSize=(Number(el.value)-Number(el.min))*100/(Number(el.max)-Number(el.min))+'% 100%';EL('out#'+el.name).innerHTML=Number(el.value).toFixed(Number(el.getAttribute("data-dec")))+el.getAttribute("data-unit");if(send)post_set_prd(el.name,el.value);}
static wheel(e,el){e.preventDefault();el.value=Number(el.value)-Math.sign(Number(e.deltaY))*Number(el.step);UiSlider.move(el);}}
class UiSpinner{static render(cont,data){cont.innerHTML=`
<div class="w_spinner_row">
<button class="icon icon_btn btn_no_pad" onclick="UiSpinner.spin('${data.id}',-1)"></button>
<div class="w_spinner_block">
<input data-type="${data.type}" id="${ID(data.id)}" class="w_spinner" type="number" oninput="UiSpinner.input('${data.id}')" onkeydown="UiSpinner.checkDown(event,'${data.id}')" value="${data.value ?? 0}" min="${data.min ?? 0}" max="${data.max ?? 100}" step="${data.step ?? 1}" data-dec="${data.dec ?? 0}" data-unit="${data.unit ?? ''}" onwheel="UiSpinner.wheel(event,'${data.id}')">
<label class="w_spinner_unit" id="unit#${data.id}" onwheel="UiSpinner.wheel(event,'${data.id}')"></label>
</div>
<button class="icon icon_btn btn_no_pad" onclick="UiSpinner.spin('${data.id}',1)"></button>
</div>
`;waitFrame().then(()=>UiSpinner.spin(data.id,0,false));Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data)el.value=data.value;if('min'in data)el.min=data.min;if('max'in data)el.max=data.max;if('step'in data)el.step=data.step;if('dec'in data)el.setAttribute("data-dec",data.dec);if('unit'in data)el.setAttribute("data-unit",data.unit);UiSpinner.spin(id,0,false);}
static spin(id,dir,send=true){let el=CMP(id);if(dir&&el.getAttribute("disabled"))return;let val=Number(el.value)+Number(el.step)*Math.sign(Number(dir));val=Math.max(Number(el.min),val);val=Math.min(Number(el.max),val);el.value=Number(val).toFixed(Number(el.getAttribute("data-dec")));el.style.width=el.value.length+'ch';EL('unit#'+id).innerHTML=el.getAttribute("data-unit");if(send)post_set_prd(id,el.value);}
static input(id){UiSpinner.spin(id,0);}
static wheel(e,id){e.preventDefault();UiSpinner.spin(id,-e.deltaY);}
static checkDown(e,id){if(e.key=='Enter'){e.preventDefault();UiSpinner.spin(id,0);}}};
class UiHTML{static render(cont,data){if(!data.value)return;if(data.value.endsWith('.html')){hub.dev(focused).addFile(data.id,data.value,{type:"html"});}else{UiHTML.apply(data.id,data.value);cont.setAttribute('data-custom-type','html');}}
static apply(id,text){EL('widget#'+id).innerHTML=text;}
static update(id,data){if(!data.value)return;if(data.value.endsWith('.html')){hub.dev(focused).addFile(id,data.value,{type:"html"});}else{UiHTML.apply(id,data.value);}}};class UiJS{static render(cont,data){if(!data.value)return;if(data.value.endsWith('.js')){hub.dev(focused).addFile(data.id,data.value,{type:"js",cont:cont});}else{UiJS.apply(data.id,data.value,cont);}}
static apply(id,text,cont){let el=addDOM('custom_script_'+id,'script',text,cont);el.setAttribute("data-custom-script",true);}
static disable(){document.querySelectorAll('[data-custom-script]').forEach(el=>el.remove());}};class UiCSS{static render(cont,data){if(!data.value)return;if(data.value.endsWith('.css')){hub.dev(focused).addFile(data.id,data.value,{type:"css",cont:cont});}else{UiCSS.apply(data.id,data.value,cont);}}
static apply(id,text,cont){let el=addDOM('custom_style_'+id,'style',text,cont);el.setAttribute("data-custom-style",true);}
static disable(){document.querySelectorAll('[data-custom-style]').forEach(el=>el.remove());}};
class UiFunc{static render(wid,data){wid.setAttribute("data-defaults",JSON.stringify(data));wid.setAttribute("data-func",focused+'_'+data.func);}
static show(cont){cont.querySelectorAll('[data-func]').forEach(wid=>{let func=wid.getAttribute("data-func");if(typeof window[func]!=="function")return;let data=wid.getAttribute("data-defaults");if(!data)return;try{data=JSON.parse(data);}catch(e){console.log("Plugin data error: "+func);return;}
wid.removeAttribute("data-defaults");try{wid.innerHTML=window[func](data.id,data);}catch(e){console.log("Plugin error: "+func);}});}
static update(dev_id,id,data){let func=dev_id+'_update_'+data.func;if(typeof window[func]==="function"){try{window[func](id,data);}catch(e){console.log("Plugin error: "+e);}}}};
class UiSelect{static render(cont,data){cont.innerHTML=`<select data-type="${data.type}" class="w_select" style="color:${intToCol(data.color) ?? 'var(--prim)'}" id='${ID(data.id)}' value="${data.value ?? ''}" onchange="post_set('${data.id}',this.value)"></select>`;waitFrame().then(()=>UiSelect.show(data.id,data.text,data.value??''));Widget.disable(data.id,data.disable);}
static async show(id,text,value){let el=CMP(id);while(el.options.length>0)el.remove(0);if(text){let ops=text.toString().split(';');for(let i in ops){let option=document.createElement('option');option.value=i;option.text=ops[i].trim();option.selected=(i==value);el.add(option);}}}
static update(id,data){let el=CMP(id);if('value'in data)el.value=data.value;if('text'in data)UiSelect.show(id,data.text,el.value);if('color'in data)el.style.color=intToCol(data.color);}};
class UiColor{static render(cont,data){cont.innerHTML=`
<div data-type="${data.type}" id="${ID(data.id)}" style="visibility:hidden">
<div id="picker#${data.id}"></div>
</div>
<button id="picker_btn#${data.id}" style="margin-left:-25px;color:${intToCol(data.value) ?? '#000'}" class="icon icon_btn_big" onclick="UiColor.open('${data.id}')"></button>
`;Widget.disable(data.id,data.disable);waitFrame().then(()=>{let el=EL('picker#'+data.id);if(!el)return;let p=Pickr.create({el:el,theme:'nano',default:intToCol(data.color)??'#000',defaultRepresentation:'HEXA',components:{preview:true,hue:true,interaction:{hex:false,input:true,save:true}}}).on('save',(color)=>{let col=color.toHEXA().toString();post_set(data.id,colToInt(col));EL('picker_btn#'+data.id).style.color=col;});UiColor.pickers[data.id]=p;});}
static update(id,data){let col=null;if('value'in data)col=intToCol(data.value);if('color'in data)col=intToCol(data.color);if(col){try{EL('picker_btn#'+id).style.color=col;UiColor.pickers[id].setColor(col);}catch(e){}}}
static open(id){let el=CMP(id);if(el.getAttribute("disabled"))return;el.getElementsByTagName('button')[0].click()}
static clear(){UiColor.pickers={};}
static pickers={};};
class UiLED{static render(cont,data){cont.innerHTML=`
<style id="style#${data.id}"></style>
<div data-type="${data.type}" id="${ID(data.id)}" class="w_led ${Number(data.value == 1) ? 'w_led_on' : ''}"></div>`;UiLED.color(data.id,intToCol(data.color)??getDefColor());Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data){if(Number(data.value))el.classList.add('w_led_on');else el.classList.remove('w_led_on');}
if('color'in data)UiLED.color(id,intToCol(data.color));}
static color(id,color){EL('style#'+id).innerHTML=`
#${ID(id)}.w_led_on {
background: ${color};
box-shadow: ${color} 0 0 9px 1px, inset 2px 3px 0px 0px #fff3;
}`;}};
class UiIcon{static render(cont,data){cont.innerHTML=`
<style id="style#${data.id}"></style>
<span data-type="${data.type}" id="${ID(data.id)}" style="font-size:${data.fsize ?? 35}px" class="w_icon w_icon_led ${Number(data.value ?? 0) ? 'w_icon_on' : ''}">${data.icon ? getIcon(data.icon) : ""}</span>`;UiIcon.color(data.id,intToCol(data.color)??getDefColor());Widget.disable(data.id,data.disable);}
static update(id,data){let el=CMP(id);if('value'in data){if(Number(data.value))el.classList.add('w_icon_on');else el.classList.remove('w_icon_on');}
if('icon'in data)el.innerHTML=getIcon(data.icon);if('fsize'in data)el.style.fontSize=data.fsize+'px';if('color'in data)UiIcon.color(id,intToCol(data.color));}
static color(id,color){EL('style#'+id).innerHTML=`
#${ID(id)}.w_icon_on {
color: ${color};
text-shadow: 0 0 10px ${color};
}`;}};
class UiFile{static render(cont,data,contType,single){let params={type:"ui_json",cont:cont,path:data.value,contType:contType,single:single};hub.dev(focused).addFile(data.id,data.value,params);}
static async apply(json,data){let controls=null;try{controls=JSON.parse('['+json+']');}catch(e){console.log('JSON parse error in ui_json from '+data.path);}
await ui_render.render(data.cont,data.contType,controls,data.single);UiHook.update();}};
class UiHook{static clear(){UiHook.hooks={};}
static bind(id,value){UiHook.hooks[id]={value:value};}
static update(){for(let id in UiHook.hooks)applyUpdate(id,UiHook.hooks[id]);}
static hooks;};
class UiGauge{static render(cont,data){cont.innerHTML=`<canvas data-type="${data.type}" id="${ID(data.id)}"></canvas>`;wait2Frame().then(()=>{let gauge=new Gauge(CMP(data.id),data);gauge.redraw();UiGauge.gauges[data.id]=gauge;});}
static update(id,data){let gauge=UiGauge.gauges[id];if(gauge)gauge.update(data);}
static resize(){for(let gag in UiGauge.gauges){UiGauge.gauges[gag].redraw();}}
static clear(){UiGauge.gauges={};}
static gauges={};};class Gauge{constructor(cv,data){this.perc=null;this.value=Number(data.value??0);this.min=Number(data.min??0);this.max=Number(data.max??100);this.dec=Number(data.dec??0);this.unit=data.unit??'';this.color=intToCol(data.color)??getDefColor();this.cv=cv;this.tout=null;this.redraw();}
stop(){if(this.tout)clearTimeout(this.tout);}
redraw(){let cv=this.cv;let rw=cv.parentNode.clientWidth;if(!rw)return;let rh=Math.floor(rw*0.47);cv.style.width=rw+'px';cv.style.height=rh+'px';cv.width=Math.floor(rw*ratio());cv.height=Math.floor(rh*ratio());let cx=cv.getContext("2d");let v=themes[cfg.theme];let perc=(this.value-this.min)*100/(this.max-this.min);if(perc<0)perc=0;if(perc>100)perc=100;if(this.perc==null)this.perc=perc;else{if(Math.abs(this.perc-perc)<=0.15)this.perc=perc;else this.perc+=(perc-this.perc)*0.15;if(this.perc!=perc)setTimeout(()=>this.redraw(),20);}
cx.clearRect(0,0,cv.width,cv.height);cx.lineWidth=cv.width/8;cx.strokeStyle=theme_cols[v][4];cx.beginPath();cx.arc(cv.width/2,cv.height*0.97,cv.width/2-cx.lineWidth,Math.PI*(1+this.perc/100),Math.PI*2);cx.stroke();cx.strokeStyle=this.color;cx.beginPath();cx.arc(cv.width/2,cv.height*0.97,cv.width/2-cx.lineWidth,Math.PI,Math.PI*(1+this.perc/100));cx.stroke();let font=cfg.font;font='Condensed';cx.fillStyle=this.color;cx.font='10px '+font;cx.textAlign="center";let text=this.unit;let len=Math.max((this.value.toFixed(this.dec)+text).length,(this.min.toFixed(this.dec)+text).length,(this.max.toFixed(this.dec)+text).length);if(len==1)text+='  ';else if(len==2)text+=' ';let w=Math.max(cx.measureText(this.value.toFixed(this.dec)+text).width,cx.measureText(this.min.toFixed(this.dec)+text).width,cx.measureText(this.max.toFixed(this.dec)+text).width);if(this.value>this.max||this.value<this.min)cx.fillStyle=getErrColor();else cx.fillStyle=theme_cols[v][3];cx.font=cv.width*0.43*10/w+'px '+font;cx.fillText(this.value.toFixed(this.dec)+this.unit,cv.width/2,cv.height*0.93);cx.font='10px '+font;w=Math.max(cx.measureText(Math.round(this.min)).width,cx.measureText(Math.round(this.max)).width);cx.fillStyle=theme_cols[v][2];cx.font=cx.lineWidth*0.55*10/w+'px '+font;cx.fillText(this.min,cx.lineWidth,cv.height*0.92);cx.fillText(this.max,cv.width-cx.lineWidth,cv.height*0.92);}
update(data){if('value'in data)this.value=Number(data.value);if('min'in data)this.min=Number(data.min);if('max'in data)this.max=Number(data.max);if('dec'in data)this.dec=Number(data.dec);if('unit'in data)this.unit=data.unit;if('color'in data)this.color=intToCol(data.color);this.redraw();}};
class UiGaugeR{static render(cont,data){cont.innerHTML=`<canvas data-type="${data.type}" id="${ID(data.id)}"></canvas>`;wait2Frame().then(()=>{let gauge=new GaugeR(CMP(data.id),data);gauge.redraw();UiGaugeR.gauges[data.id]=gauge;});}
static update(id,data){let gauge=UiGaugeR.gauges[id];if(gauge)gauge.update(data);}
static resize(){for(let gag in UiGaugeR.gauges){UiGaugeR.gauges[gag].redraw();}}
static clear(){UiGaugeR.gauges={};}
static gauges={};};class GaugeR{constructor(cv,data){this.perc=null;this.value=Number(data.value??0);this.min=Number(data.min??0);this.max=Number(data.max??100);this.dec=Number(data.dec??0);this.unit=data.unit??'';this.color=intToCol(data.color)??getDefColor();this.cv=cv;this.tout=null;this.redraw();}
stop(){if(this.tout)clearTimeout(this.tout);}
redraw(){let cv=this.cv;let rw=cv.parentNode.clientWidth;if(!rw)return;cv.style.width=rw+'px';cv.style.height=cv.style.width;cv.width=Math.floor(rw*ratio());cv.height=cv.width;let cx=cv.getContext("2d");let v=themes[cfg.theme];let perc=(this.value-this.min)*100/(this.max-this.min);if(perc<0)perc=0;if(perc>100)perc=100;if(this.perc==null)this.perc=perc;else{if(Math.abs(this.perc-perc)<=0.15)this.perc=perc;else this.perc+=(perc-this.perc)*0.15;if(this.perc!=perc)setTimeout(()=>this.redraw(),20);}
let joint=Math.PI*(0.5+2*(this.perc/100));cx.clearRect(0,0,cv.width,cv.height);cx.lineWidth=cv.width/8;cx.strokeStyle=theme_cols[v][4];cx.beginPath();cx.arc(cv.width/2,cv.height/2,cv.width/2-cx.lineWidth,joint,Math.PI*2.5);cx.stroke();cx.strokeStyle=this.color;cx.beginPath();cx.arc(cv.width/2,cv.height/2,cv.width/2-cx.lineWidth,Math.PI/2,joint);cx.stroke();let font=cfg.font;font='Condensed';cx.fillStyle=this.color;cx.font='10px '+font;cx.textAlign="center";cx.textBaseline="middle";let text=this.unit;let len=Math.max((this.value.toFixed(this.dec)+text).length,(this.min.toFixed(this.dec)+text).length,(this.max.toFixed(this.dec)+text).length);if(len==1)text+='  ';else if(len==2)text+=' ';let w=Math.max(cx.measureText(this.value.toFixed(this.dec)+text).width,cx.measureText(this.min.toFixed(this.dec)+text).width,cx.measureText(this.max.toFixed(this.dec)+text).width);if(this.value>this.max||this.value<this.min)cx.fillStyle=getErrColor();else cx.fillStyle=theme_cols[v][3];cx.font=cv.width*0.5*10/w+'px '+font;cx.fillText(this.value.toFixed(this.dec)+this.unit,cv.width/2,cv.height*0.52);}
update(data){if('value'in data)this.value=Number(data.value);if('min'in data)this.min=Number(data.min);if('max'in data)this.max=Number(data.max);if('dec'in data)this.dec=Number(data.dec);if('unit'in data)this.unit=data.unit;if('color'in data)this.color=intToCol(data.color);this.redraw();}};
class UiGaugeL{static render(cont,data){cont.innerHTML=`<canvas data-type="${data.type}" id="${ID(data.id)}"></canvas>`;wait2Frame().then(()=>{let gauge=new GaugeL(CMP(data.id),data);gauge.redraw();UiGaugeL.gauges[data.id]=gauge;});}
static update(id,data){let gauge=UiGaugeL.gauges[id];if(gauge)gauge.update(data);}
static resize(){for(let gag in UiGaugeL.gauges){UiGaugeL.gauges[gag].redraw();}}
static clear(){UiGaugeL.gauges={};}
static gauges={};};class GaugeL{constructor(cv,data){this.perc=null;this.value=Number(data.value??0);this.min=Number(data.min??0);this.max=Number(data.max??100);this.dec=Number(data.dec??0);this.unit=data.unit??'';this.icon=data.icon??'';this.color=intToCol(data.color)??getDefColor();this.cv=cv;this.tout=null;this.redraw();}
stop(){if(this.tout)clearTimeout(this.tout);}
redraw(){let cv=this.cv;let rw=cv.parentNode.clientWidth;if(!rw)return;let height=30;let r=ratio();let sw=2*r;let off=5*r;cv.style.width=rw+'px';cv.style.height=height+'px';cv.width=Math.floor(rw*r);cv.height=Math.floor(height*r);let cx=cv.getContext("2d");let v=themes[cfg.theme];let perc=(this.value-this.min)*100/(this.max-this.min);if(perc<0)perc=0;if(perc>100)perc=100;if(this.perc==null)this.perc=perc;else{if(Math.abs(this.perc-perc)<=0.15)this.perc=perc;else this.perc+=(perc-this.perc)*0.15;if(this.perc!=perc)setTimeout(()=>this.redraw(),20);}
let wid=cv.width-sw-off*2;cx.clearRect(0,0,cv.width,cv.height);cx.fillStyle=theme_cols[v][0];cx.beginPath();cx.roundRect(off+sw/2,sw/2,wid,cv.height-sw,5*r);cx.fill();cx.fillStyle=this.color;cx.beginPath();cx.roundRect(off+sw/2,sw/2,wid*this.perc/100,cv.height-sw,5*r);cx.fill();if(this.value>this.max||this.value<this.min)cx.fillStyle=getErrColor();else cx.fillStyle=theme_cols[v][2];cx.font=(19*r)+'px '+cfg.font;cx.textAlign="center";cx.textBaseline="middle";let txt=this.value.toFixed(this.dec)+this.unit;cx.fillText(txt,cv.width/2,cv.height*0.52);if(this.icon){let tw=cx.measureText(txt).width;cx.font=(20*r)+'px FA5';cx.textAlign="right";cx.fillText(getIcon(this.icon),cv.width/2-tw/2-off,cv.height*0.52);}
cx.fillStyle=theme_cols[v][2];cx.font=(12*r)+'px '+cfg.font;cx.textAlign="left";cx.fillText(this.min.toFixed(this.dec),off+sw/2+off,cv.height*0.52);cx.textAlign="right";cx.fillText(this.max.toFixed(this.dec),cv.width-(off+sw/2+off),cv.height*0.52);}
update(data){if('value'in data)this.value=Number(data.value);if('min'in data)this.min=Number(data.min);if('max'in data)this.max=Number(data.max);if('dec'in data)this.dec=Number(data.dec);if('unit'in data)this.unit=data.unit;if('icon'in data)this.icon=data.icon;if('color'in data)this.color=intToCol(data.color);this.redraw();}};
class UiJoy{static render(cont,data){cont.innerHTML=`<canvas data-type="${data.type}" id="${ID(data.id)}"></canvas>`;wait2Frame().then(()=>{let id=data.id;let cb=function(d){post_set_prd(id,((d.x+255)<<16)|(d.y+255));if(!UiJoy.joys[id].suffix){EL('wsuffix#'+id).innerHTML='['+d.x+','+d.y+']';}}
let joy=new Joy(CMP(id),data,cb);joy.redraw(false);UiJoy.joys[id]=joy;});Widget.disable(data.id,data.disable);}
static update(id,data){}
static clear(){for(let joy in UiJoy.joys)UiJoy.joys[joy].stop();UiJoy.joys={};}
static resize(){for(let joy in UiJoy.joys){UiJoy.joys[joy].reset();UiJoy.joys[joy].redraw(false);}}
static joys={};};class Joy{keep=0;exp=0;color=0;center=0;posX=null;posY=null;pressed=0;constructor(cv,data,cb){this.color=intToCol(data.color)??getDefColor();this.keep=data.keep??0;this.exp=data.exp??0;this.cv=cv;this.cb=cb;if("ontouchstart"in document.documentElement){cv.addEventListener("touchstart",this._onTouchStart,{passive:false});document.addEventListener("touchmove",this._onTouchMove,{passive:false});document.addEventListener("touchend",this._onTouchEnd);}else{cv.addEventListener("mousedown",this._onMouseDown);document.addEventListener("mousemove",this._onMouseMove);document.addEventListener("mouseup",this._onMouseUp);}}
stop(){if("ontouchstart"in document.documentElement){this.cv.removeEventListener("touchstart",this._onTouchStart);document.removeEventListener("touchmove",this._onTouchMove);document.removeEventListener("touchend",this._onTouchEnd);}else{this.cv.removeEventListener("mousedown",this._onMouseDown);document.removeEventListener("mousemove",this._onMouseMove);document.removeEventListener("mouseup",this._onMouseUp);}}
reset(){this.posX=null;this.posY=null;}
redraw(send=true){let cv=this.cv;let size=cv.parentNode.clientWidth;if(!size)return;cv.style.width=size+'px';cv.style.height=size+'px';size*=ratio();cv.width=size;cv.height=size;cv.style.cursor='pointer';let r=size*0.23;let R=size*0.4;this.center=size/2;if(this.posX===null)this.posX=this.center;if(this.posY===null)this.posY=this.center;this.posX=constrain(this.posX,r,size-r);this.posY=constrain(this.posY,r,size-r);let x=Math.round((this.posX-this.center)/(size/2-r)*255);let y=-Math.round((this.posY-this.center)/(size/2-r)*255);let cx=cv.getContext("2d");cx.clearRect(0,0,size,size);cx.beginPath();cx.arc(this.center,this.center,R,0,2*Math.PI,false);let grd=cx.createRadialGradient(this.center,this.center,R*2/3,this.center,this.center,R);grd.addColorStop(0,'#00000005');grd.addColorStop(1,'#00000030');cx.fillStyle=grd;cx.fill();cx.beginPath();cx.arc(this.posX,this.posY,r,0,2*Math.PI,false);grd=cx.createRadialGradient(this.posX,this.posY,0,this.posX,this.posY,r);grd.addColorStop(0,adjustColor(this.color,0.7));grd.addColorStop(1,adjustColor(this.color,this.pressed?1.3:1));cx.fillStyle=grd;cx.fill();if(this.exp){x=((x*x+255)>>8)*(x>0?1:-1);y=((y*y+255)>>8)*(y>0?1:-1);}
if(send)this.cb({x:x,y:y});}
_onTouchStart=(event)=>{if(this.disabled())return;event.preventDefault();this.pressed=1;}
_onTouchMove=(event)=>{if(this.pressed){event.preventDefault();let target=null;for(let t of event.changedTouches){if(t.target===this.cv)target=t;}
if(!target)return;this.posX=target.pageX;this.posY=target.pageY;if(this.cv.offsetParent.tagName.toUpperCase()==="BODY"){this.posX-=this.cv.offsetLeft;this.posY-=this.cv.offsetTop;}else{this.posX-=this.cv.offsetParent.offsetLeft;this.posY-=this.cv.offsetParent.offsetTop;}
this.posX*=ratio();this.posY*=ratio();this.redraw();}}
_onTouchEnd=(event)=>{if(this.pressed){let target=null;for(let t of event.changedTouches){if(t.target===this.cv)target=t;}
if(!target)return;this.pressed=0;if(!this.keep){this.posX=this.center;this.posY=this.center;}
this.redraw();}}
_onMouseDown=(event)=>{if(this.disabled())return;this.pressed=1;document.body.style.userSelect='none';}
_onMouseMove=(event)=>{if(this.pressed){this.posX=event.pageX;this.posY=event.pageY;if(this.cv.offsetParent.tagName.toUpperCase()==="BODY"){this.posX-=this.cv.offsetLeft;this.posY-=this.cv.offsetTop;}else{this.posX-=this.cv.offsetParent.offsetLeft;this.posY-=this.cv.offsetParent.offsetTop;}
this.posX*=ratio();this.posY*=ratio();this.redraw();}}
_onMouseUp=(event)=>{if(this.pressed){this.pressed=0;if(!this.keep){this.posX=this.center;this.posY=this.center;}
this.redraw();document.body.style.userSelect='unset';}}
disabled(){return this.cv.getAttribute('disabled');}};
class UiDpad{static render(cont,data){cont.innerHTML=`<canvas data-type="${data.type}" id="${ID(data.id)}"></canvas>`;waitFrame().then(()=>{let id=data.id;let cb=function(d){post_set_prd(id,((d.x+255)<<16)|(d.y+255));}
let pad=new Dpad(CMP(id),data,cb);pad.redraw(false);UiDpad.pads[id]=pad;});Widget.disable(data.id,data.disable);}
static update(id,data){}
static resize(){for(let pad in UiDpad.pads){UiDpad.pads[pad].redraw(false);}}
static clear(){for(let pad in UiDpad.pads)UiDpad.pads[pad].stop();UiDpad.pads={};}
static pads={};};class Dpad{color=0;posX=0;posY=0;pressed=0;constructor(cv,data,cb){this.color=intToCol(data.color)??getDefColor();this.cv=cv;this.cb=cb;if("ontouchstart"in document.documentElement){cv.addEventListener("touchstart",this._onTouchStart);document.addEventListener("touchend",this._onTouchEnd);}else{cv.addEventListener("mousedown",this._onMouseDown);document.addEventListener("mouseup",this._onMouseUp);}}
stop(){if("ontouchstart"in document.documentElement){this.cv.removeEventListener("touchstart",this._onTouchStart);document.removeEventListener("touchend",this._onTouchEnd);}else{this.cv.removeEventListener("mousedown",this._onMouseDown);document.removeEventListener("mouseup",this._onMouseUp);}}
redraw(send=true){let cv=this.cv;let size=cv.parentNode.clientWidth;if(!size)return;cv.style.width=size+'px';cv.style.height=size+'px';size*=ratio();let center=size/2;cv.width=size;cv.height=size;cv.style.cursor='pointer';let x=0;let y=0;if(this.pressed){x=Math.round((this.posX-center)/(size/2)*255);y=-Math.round((this.posY-center)/(size/2)*255);if(Math.abs(x)<50&&Math.abs(y)<50){x=0;y=0;}else{if(Math.abs(x)>Math.abs(y)){x=Math.sign(x);y=0;}else{x=0;y=Math.sign(y);}}}
let cx=cv.getContext("2d");cx.clearRect(0,0,size,size);cx.beginPath();cx.arc(center,center,size*0.44,0,2*Math.PI,false);cx.lineWidth=size*0.02;cx.strokeStyle=adjustColor(this.color,this.pressed?1.3:1);cx.stroke();cx.lineWidth=size*0.045;let rr=size*0.36;let cw=size*0.1;let ch=rr-cw;let sh=[[1,0],[-1,0],[0,1],[0,-1]];for(let i=0;i<4;i++){cx.beginPath();cx.strokeStyle=(x==sh[i][0]&&y==-sh[i][1])?adjustColor(this.color,1.3):this.color;cx.moveTo(center+ch*sh[i][0]-cw*sh[i][1],center+ch*sh[i][1]-cw*sh[i][0]);cx.lineTo(center+rr*sh[i][0],center+rr*sh[i][1]);cx.lineTo(center+ch*sh[i][0]+cw*sh[i][1],center+ch*sh[i][1]+cw*sh[i][0]);cx.stroke();}
if(send)this.cb({x:x,y:y});}
_onTouchStart=(event)=>{if(this.disabled())return;event.preventDefault();this.pressed=1;this.posX=(event.targetTouches[0].pageX-this.cv.offsetLeft)*ratio();this.posY=(event.targetTouches[0].pageY-this.cv.offsetTop)*ratio();this.redraw();}
_onTouchEnd=(event)=>{if(this.pressed){this.pressed=0;this.redraw();}}
_onMouseDown=(event)=>{if(this.disabled())return;this.pressed=1;this.posX=(event.pageX-this.cv.offsetLeft)*ratio();this.posY=(event.pageY-this.cv.offsetTop)*ratio();this.redraw();}
_onMouseUp=(event)=>{if(this.pressed){this.pressed=0;this.redraw();}}
disabled(){return this.cv.getAttribute('disabled');}};
class UiFlags{static render(cont,data){cont.innerHTML=`
<style id="style#${data.id}"></style>
<div data-type="${data.type}" id="${ID(data.id)}" class="w_flags_cont w_flags_cont_tab" data-text="${data.text ?? ''}" data-value="${data.value ?? 0}"></div>`;UiFlags.show(data.id);UiFlags.color(data.id,intToCol(data.color)??getDefColor());Widget.disable(data.id,data.disable);waitFrame().then(()=>UiFlags.refresh(data.id));}
static update(id,data){let el=CMP(id);if('value'in data)el.setAttribute("data-value",data.value);if('text'in data)el.setAttribute("data-text",data.text);if('color'in data)UiFlags.color(id,data.color);UiFlags.show(id);}
static show(id){let el=CMP(id);let val=Number(el.getAttribute("data-value"));let text=el.getAttribute("data-text");el.innerHTML="";let labels=text.split(';');for(let i=0;i<labels.length;i++){el.innerHTML+=`
<label id="flags_${id}" class="w_flags w_flags_txt">
<input name="${id}" type="checkbox" onclick="UiFlags.click('${id}',this)" ${(val & 1) ? 'checked' : ''}>
<span class="w_flags_s w_flags_span">${labels[i]}</span>
</label>`;val>>=1;}}
static color(id,color){if(color){EL('style#'+id).innerHTML=`
#flags_${id} input:checked+.w_flags_s{background:${color}}`;}}
static click(id,el){if(CMP(id).getAttribute("disabled"))return;let flags=document.getElementsByName(id);let encoded=0;flags.forEach((w,i)=>{if(w.checked)encoded|=(1<<flags.length);encoded>>=1;});post_set(id,encoded);}
static refresh(id){let txt=CMP(id).querySelectorAll(".w_flags_txt");let span=CMP(id).querySelectorAll(".w_flags_span");txt.forEach((ch,i)=>{let len=span[i].innerHTML.length+2;txt[i].style.width=(len+0.5)+'ch';span[i].style.width=len+'ch';});}};
class UiTabs{static render(cont,data){let tabs='';if(data.text){let labels=data.text.split(';');for(let i in labels){tabs+=`<li onclick="UiTabs.click('${data.id}',${i})">${labels[i].trim()}</li>`;}}
cont.innerHTML=`
<style id="style#${data.id}"></style>
<div data-type="${data.type}" id="${ID(data.id)}" class="w_tabs"><ul onwheel="UiTabs.wheel(event,this)">${tabs}</ul></div>`;UiTabs.color(data.id,intToCol(data.color)??getDefColor());waitFrame().then(()=>UiTabs.change(data.id,data.value??0));Widget.disable(data.id,data.disable);}
static click(id,num){if(CMP(id).getAttribute("disabled"))return;post_set(id,num);UiTabs.change(id,num,false);}
static change(id,num,move=true){let el=CMP(id);let list=el.children[0].children;for(let i=0;i<list.length;i++){if(i==num)list[i].classList.add('w_tab_act');else list[i].classList.remove('w_tab_act');}
if(move)el.children[0].scrollLeft=el.children[0].scrollWidth*num/list.length;}
static update(id,data){if('value'in data)UiTabs.change(id,Number(data.value));if('color'in data)UiTabs.color(id,data.color);}
static color(id,color){if(color){EL('style#'+id).innerHTML=`
#${ID(id)}.w_tabs>ul>li.w_tab_act {background: ${color} !important;}`;}}
static wheel(e,el){e.preventDefault();el.scrollLeft+=e.deltaY;}};
class UiCanvas{static render(cont,data){cont.innerHTML=`<div class="w_canvas"><canvas data-type="${data.type}" id="${ID(data.id)}" onclick="UiCanvas.click('${data.id}',event)"></canvas></div>`;wait2Frame().then(()=>{let cv=new Canvas(data.id,CMP(data.id),data.width,data.height,data.active);cv.update(data.data);cv.show();UiCanvas.canvases[data.id]=cv;});Widget.disable(data.id,data.disable);}
static update(id,data){let cv=UiCanvas.canvases[id];if(!cv)return;if('data'in data){cv.update(data.data);cv.show(data.data);}}
static clear(){UiCanvas.canvases={};}
static resize(){for(let cv in UiCanvas.canvases){UiCanvas.canvases[cv].resize();}}
static click(id,e){let cv=UiCanvas.canvases[id];if(!cv||!cv.active)return;let rect=CMP(id).getBoundingClientRect();let x=Math.round((e.clientX-rect.left)/cv.scale*ratio());if(x<0)x=0;let y=Math.round((e.clientY-rect.top)/cv.scale*ratio());if(y<0)y=0;post_set(id,(x<<16)|y);EL('wsuffix#'+id).innerHTML='['+x+','+y+']';}
static canvases={};};class Canvas{constructor(id,cv,w,h,active){this.data=[];this.id=id;this.cv=cv;this.width=w;this.height=h;this.scale=1;this.active=active;if(active)cv.style.cursor='pointer';this.resize();}
clear(){this.data=[];}
resize(){let rw=this.cv.parentNode.clientWidth;if(!rw)return;let scale=rw/this.width;this.scale=scale*ratio();let rh=Math.floor(this.height*scale);this.cv.style.width=rw+'px';this.cv.style.height=rh+'px';this.cv.width=Math.floor(rw*ratio());this.cv.height=Math.floor(rh*ratio());this.show(this.data);}
update(data){this.data=this.data.concat(data);}
show(data=null){if(!data)data=this.data;let cv=this.cv;let cx=cv.getContext("2d");let ev_str='';const cmd_list=['fillStyle','strokeStyle','shadowColor','shadowBlur','shadowOffsetX','shadowOffsetY','lineWidth','miterLimit','font','textAlign','textBaseline','lineCap','lineJoin','globalCompositeOperation','globalAlpha','scale','rotate','rect','fillRect','strokeRect','clearRect','moveTo','lineTo','quadraticCurveTo','bezierCurveTo','translate','arcTo','arc','fillText','strokeText','drawImage','roundRect','fill','stroke','beginPath','closePath','clip','save','restore'];const const_list=['butt','round','square','square','bevel','miter','start','end','center','left','right','alphabetic','top','hanging','middle','ideographic','bottom','source-over','source-atop','source-in','source-out','destination-over','destination-atop','destination-in','destination-out','lighter','copy','xor','top','bottom','middle','alphabetic'];let cv_map=(v,h)=>{v*=this.scale;return v>=0?v:(h?cv.height:cv.width)-v;}
let scale=()=>{return this.scale;}
for(let d of data){let div=d.indexOf(':');let cmd=parseInt(d,10);if(!isNaN(cmd)&&cmd<=37){if(div==1||div==2){let val=d.slice(div+1);let vals=val.split(',').map(v=>(v>0)?v=Number(v):v);if(cmd<=2)ev_str+=('cx.'+cmd_list[cmd]+'=\''+intToColA(val)+'\';');else if(cmd<=7)ev_str+=('cx.'+cmd_list[cmd]+'='+(val*scale())+';');else if(cmd<=13)ev_str+=('cx.'+cmd_list[cmd]+'=\''+const_list[val]+'\';');else if(cmd<=14)ev_str+=('cx.'+cmd_list[cmd]+'='+val+';');else if(cmd<=16)ev_str+=('cx.'+cmd_list[cmd]+'('+val+');');else if(cmd<=26){let str='cx.'+cmd_list[cmd]+'(';for(let i in vals){if(i>0)str+=',';str+=`cv_map(${vals[i]},${(i % 2)})`;}
ev_str+=(str+');');}else if(cmd==27){ev_str+=(`cx.${cmd_list[cmd]}(cv_map(${vals[0]},0),cv_map(${vals[1]},1),cv_map(${vals[2]},0),${vals[3]},${vals[4]},${vals[5]});`);}else if(cmd<=29){ev_str+=(`cx.${cmd_list[cmd]}(${vals[0]},cv_map(${vals[1]},0),cv_map(${vals[2]},1),${vals[3]});`);}else if(cmd==30){let img=new Image();for(let i in vals){if(i>0)vals[i]=cv_map(vals[i],!(i%2));}
if(vals[0].startsWith('http://')||vals[0].startsWith('https://')){img.src=vals[0];}else{hub.dev(focused).addFile(this.id,vals[0],{type:"cv_img",img:img});}
img.onload=function(){let ev='cx.drawImage(img';for(let i in vals){if(i>0)ev+=','+vals[i];}
if(vals.length-1==3){ev+=','+vals[3]*img.height/img.width;}
ev+=')';eval(ev);}}else if(cmd==31){let str='cx.'+cmd_list[cmd]+'(';for(let i=0;i<4;i++){if(i>0)str+=',';str+=`cv_map(${vals[i]},${(i % 2)})`;}
if(vals.length==5)str+=`,${vals[4] * scale()}`;else{str+=',[';for(let i=4;i<vals.length;i++){if(i>4)str+=',';str+=`cv_map(${vals[i]},${(i % 2)})`;}
str+=']';}
ev_str+=(str+');');}}else{if(cmd>=32)ev_str+=('cx.'+cmd_list[cmd]+'();');}}else{ev_str+=d+';';}}
eval(ev_str);}};
class UiStream{static render(cont,data){cont.innerHTML=`<div><img style="width:100%" src="http://${ip}:${port}/"></div>`;}
static update(id,data){}};
class UiPlot{static render(cont,data){cont.innerHTML=`<div class="w_canvas"><canvas data-type="${data.type}" id="${ID(data.id)}"></canvas></div>`;wait2Frame().then(()=>{let p=new Plot(data.id,CMP(data.id),data.height??150,data.text,data.type,true);p.update(data.data);p.redraw();UiPlot.plots[data.id]=p;});}
static update(id,data){let p=UiPlot.plots[id];if(!p)return;if('value'in data){}}
static clear(){for(let plot in UiPlot.plots)UiPlot.plots[plot].stop();UiPlot.plots={};}
static resize(){for(let p in UiPlot.plots){UiPlot.plots[p].resize();}}
static plots={};};class Plot{constructor(id,cv,height,labels,type,dark){this.id=id;this.cv=cv;this.height=height;this.labels=labels?labels.split(';'):null;this.type=type;this.dark=dark;this.data=[];this.resize();cv.onclick=(event)=>this._click(event);if("ontouchstart"in document.documentElement){document.addEventListener("touchmove",this._onTouchMove,{passive:false});}else{document.addEventListener("mousemove",this._onMouseMove);}}
stop(){if("ontouchstart"in document.documentElement){document.removeEventListener("touchmove",this._onTouchMove);}else{document.removeEventListener("mousemove",this._onMouseMove);}}
clear(){this.data=[];}
resize(){let cv=this.cv;let rw=cv.parentNode.clientWidth;if(!rw)return;let r=window.devicePixelRatio;cv.style.width=rw+'px';cv.style.height=this.height+'px';cv.width=Math.floor(rw*r);cv.height=Math.floor(this.height*r);this.redraw(this.data);}
update(data){this.data=this.data.concat(data);}
redraw(data=null){if(!data)data=this.data;let cv=this.cv;let cx=cv.getContext("2d");let r=window.devicePixelRatio;cx.fillRect(0,0,cv.width,cv.height);}
_click(e){let rect=this.cv.getBoundingClientRect();let x=Math.round(e.clientX-rect.left);if(x<0)x=0;let y=Math.round(e.clientY-rect.top);if(y<0)y=0;}
_onTouchMove=(event)=>{event.preventDefault();for(let t of event.changedTouches){if(t.target===this.cv)this._move(t);}}
_onMouseMove=(event)=>{if(event.target==this.cv)this._move(event);}
_move(rect){let x=rect.pageX;let y=rect.pageY;if(this.cv.offsetParent.tagName.toUpperCase()==="BODY"){x-=this.cv.offsetLeft;y-=this.cv.offsetTop;}else{x-=this.cv.offsetParent.offsetLeft;y-=this.cv.offsetParent.offsetTop;}
x=this._constrain(x,0,this.cv.width/window.devicePixelRatio);y=this._constrain(y,0,this.cv.height/window.devicePixelRatio);this.redraw();}
_constrain(x,min,max){if(x<min)return min;if(x>max)return max;return x;}};
function makeDialog(){let box=document.createElement('div');box.className='dialog_box';document.body.appendChild(box);return box;}
function asyncAlert(text,title=null){return new Promise(resolve=>{let box=makeDialog();let tit=title?`<div class="ui_row ui_head">${title}</div>`:'';box.innerHTML=`
<div class="ui_col ui_dialog">
${tit}
<div class="ui_row">
<label class="dialog_row">${text}</label>
</div>
<div class="ui_row">
<div></div>
<button id="alert_btn" class="ui_btn ui_btn_mini">OK</button>
</div>
</div>`;EL('alert_btn').onclick=()=>{document.body.removeChild(box);resolve(true);};});}
function asyncConfirm(text,title=null){return new Promise(resolve=>{let box=makeDialog();let tit=title?`<div class="ui_row ui_head">${title}</div>`:'';box.innerHTML=`
<div class="ui_col ui_dialog">
${tit}
<div class="ui_row">
<label class="dialog_row">${text}</label>
</div>
<div class="ui_row">
<div></div>
<div class="ui_btn_row">
<button id="dia_yes" class="ui_btn ui_btn_mini">${lang.pop_yes}</button>
<button id="dia_no" class="ui_btn ui_btn_mini">${lang.pop_no}</button>
</div>
</div>
</div>`;EL('dia_yes').onclick=()=>{document.body.removeChild(box);resolve(true);};EL('dia_no').onclick=()=>{document.body.removeChild(box);resolve(false);};});}
function asyncPrompt(text,placeh='',title=null){return new Promise(resolve=>{let box=makeDialog();let tit=title?`<div class="ui_row ui_head">${title}</div>`:'';box.innerHTML=`
<div class="ui_col ui_dialog">
${tit}
<div class="ui_row">
<label class="dialog_row">${text}</label>
</div>
<div class="ui_row">
<input id="dia_input" class="ui_inp" type="text" value="${placeh}">
</div>
<div class="ui_row">
<div></div>
<div class="ui_btn_row">
<button id="dia_ok" class="ui_btn ui_btn_mini">OK</button>
<button id="dia_cancel" class="ui_btn ui_btn_mini">${lang.cancel}</button>
</div>
</div>
</div>`;EL('dia_ok').onclick=()=>{let res=EL('dia_input').value;document.body.removeChild(box);resolve(res);};EL('dia_cancel').onclick=()=>{document.body.removeChild(box);resolve(null);};});}
class Ack{static set(id){Ack.clear(id);Ack.buf[id]=setTimeout(()=>{Widget.setPlabel(id,'['+lang.error.toUpperCase()+']');delete Ack.buf[id];},1500);}
static clear(id){Widget.setPlabel(id);if(Ack.buf[id]){clearTimeout(Ack.buf[id]);delete Ack.buf[id];}}
static clearAll(){for(let id in Ack.buf)Ack.clear(id);}
static buf={};};const set_prd=15;let set_prd_buf={};function post(cmd,name='',value=''){if(focused)hub.post(focused,cmd,name,value);}
function post_click(name,dir){UiButton.pressID=(dir==1)?name:null;post('set',name,dir);}
function post_set(name,value=''){post('set',name,value);Ack.set(name);}
function post_set_prd(name,value){if(!(name in set_prd_buf))set_prd_buf[name]={value:null,tout:null};if(!set_prd_buf[name].tout){post_set(name,value);set_prd_buf[name].tout=setTimeout(()=>{if(set_prd_buf[name]&&set_prd_buf[name].value!=null){post_set(name,set_prd_buf[name].value);}
delete set_prd_buf[name];},set_prd);}else{set_prd_buf[name].value=value;}}
function reboot_h(){post('reboot');}
function release_all(){if(UiButton.pressID)post('set',UiButton.pressID,0);UiButton.pressID=null;}
let render_busy=false;let ui_render=new UiRender();ui_render.add('hook',UiHook);ui_render.add('input',UiInput);ui_render.add('pass',UiPass);ui_render.add('area',UiArea);ui_render.add('button',UiButton);ui_render.add('switch_t',UiSwitch);ui_render.add('switch_i',UiSwicon);ui_render.add('label',UiLabel);ui_render.add('title',UiTitle);ui_render.add('display',UiDisplay);ui_render.add('text',UiText);ui_render.add('text_f',UiText_f);ui_render.add('image',UiImage);ui_render.add('table',UiTable);ui_render.add('log',UiLog);ui_render.add('date',UiDate);ui_render.add('time',UiTime);ui_render.add('datetime',UiDateTime);ui_render.add('slider',UiSlider);ui_render.add('spinner',UiSpinner);ui_render.add('select',UiSelect);ui_render.add('color',UiColor);ui_render.add('led',UiLED);ui_render.add('icon',UiIcon);ui_render.add('html',UiHTML);ui_render.add('gauge',UiGauge);ui_render.add('gauge_r',UiGaugeR);ui_render.add('gauge_l',UiGaugeL);ui_render.add('joy',UiJoy);ui_render.add('dpad',UiDpad);ui_render.add('flags',UiFlags);ui_render.add('tabs',UiTabs);ui_render.add('canvas',UiCanvas);ui_render.add('plot',UiPlot);ui_render.add('stream',UiStream);ui_render.add('confirm',UiConfirm);ui_render.add('prompt',UiPrompt);ui_render.add('js',UiJS);ui_render.add('css',UiCSS);ui_render.add('plugin',UiPlugin);function showControls(id,controls){Ack.clearAll();if(!controls)return;if(render_busy)return;render_busy=true;let dev=hub.dev(id);let cont=document.createElement("div");ui_render.root=cont;cont.classList.add('main_col');cont.style.visibility='hidden';cont.id='controls#'+id;cont.style.maxWidth=dev.info.main_width+'px';if(dev.info.ui_mode>=2){cont.style.display='grid';cont.style.gridTemplateColumns=`repeat(auto-fit, minmax(${dev.info.ui_block_width}px, 1fr))`;}else{cont.style.display='block';}
let excont=EL('controls#'+id);if(excont){cont.id+='_new';addIdRecursive(excont,'__old');}
EL('controls').appendChild(cont);set_prd_buf={};ui_render.clearWidgets();ui_render.reset();Menu.clear();dev.resetFiles();ui_render.render(cont,'col',controls,(dev.info.ui_mode==1||dev.info.ui_mode==3));UiFunc.show(cont);if(ui_render.dup_names.length)showPopupError(lang.dup_names+': '+ui_render.dup_names);hub.dev(focused).checkFiles();UiHook.update();wait2Frame().then(()=>{if(excont){excont.remove();cont.id='controls#'+id;}
cont.style.visibility='visible';render_busy=false;});}
const langBase={English:{errors:["not an error","open file error","not enough space","checksum error","size error","start error","write error","end error","aborted","timeout","busy","memory error","wrong client","forbidden","module disabled","FS busy","cancelled"],themes:["Dark","Light"],colors:["Orange","Yellow","Green","Mint","Aqua","Blue","Violet","Pink"],api_mis:"Device and App API version mismatch. Update library and App!",pop_yes:"Yes",pop_no:"No",cancel:"Отмена",done:"Done",error:"Error",upload:"Upload",fetch:"Fetch",connecting:"Connecting",connected:"Connected",connect:"Connect",disconnect:"Disconnect",disconnected:"Disconnected",not_conn:"Not connected",select:"Select",clip_copy:"Copied to clipboard",import_ok:"Import done",import_err:"Wrong data",config:"Config",wifi_ip:"Local IP",wifi_mask:"Netmask",wifi_port:"HTTP port",wifi_add:"Add by IP",mq_host:"Host",mq_port:"Port (WSS)",mq_login:"Login",mq_pass:"Password",sr_baud:"Baudrate",sr_offset:"Start offset, ms",sr_port:"Port",tg_token:"Bot token",tg_chat:"Chat ID",cfg_search:"Search",cfg_prefix:"Prefix",cfg_id:"Client ID",cfg_theme:"Theme",cfg_color:"Main Color",cfg_font:"Font",cfg_width:"App width",cfg_css:"Plugin CSS",cfg_js:"Plugin JS",cfg_updates:"Check updates",cfg_sett:"Settings",cfg_import:"Import",cfg_export:"Export",cfg_reset:"Reset",cfg_reset_conf:"Reset all settings?",m_config:"Config",m_info:"Info",m_files:"Files",m_ota:"OTA",i_settings:"Settings",i_console:"Console",i_mode:"UI mode",i_default:"Default",i_single:"Single row",i_resp:"Responsive",i_grid:"Grid",i_main:"UI width",i_block:"Block width",i_css:"Plugin CSS",i_js:"Plugin JS",i_reboot:"Reboot",i_link:"Link",i_topics:"Topics",i_version:"Version",i_net:"Network",i_memory:"Memory",i_system:"System",fs_fsbr:"FS browser",fs_used:"Used",fs_format:"Format",fs_upload_to:"Upload to",fs_upload:"Upload",fs_create_f:"Create file",fs_create:"Create",rename:"Rename",delete:"Delete",fetch:"Fetch",download:"Download",open:"Open",edit:"Edit",wrong_ota:"Wrong file! Use",p_add:"Add project",p_proj:"Projects",p_not_support:"Browser in not supported",p_use_https:"Use https version of website",p_has_upd:"Update available",p_upd:"Update firmware",p_install:"Install",wrong_text:"Wrong text!",wrong_ip:"Wrong IP",dup_names:"Duplicated names",redirect:"Redirect to",},Russian:{errors:["не ошибка","невозможно открыть файл","недостаточно места","ошибка контрольной суммы","ошибка размера","ошибка старта","ошибка записи","ошибка завершения","прервано","тайм-аут","занят","ошибка памяти","не тот клиент","запрещено","модуль отключен","файловая система занята","отменено"],themes:["Тёмная","Светлая"],colors:["Оранжевый","Жёлтый","Зелёный","Мятный","Бирюзовый","Синий","Фиолетовый","Розовый"],api_mis:"Разная версия API у устройства и приложения. Обнови приложение и библиотеку!",pop_yes:"Да",pop_no:"Нет",cancel:"Отмена",done:"Завершено",error:"Ошибка",upload:"Загрузка",fetch:"Скачивание",connecting:"Подключение",connected:"Подключено",connect:"Подключить",disconnect:"Отключить",disconnected:"Отключено",not_conn:"Не подключено",select:"Выбрать",clip_copy:"Скопировано в буфер обмена",import_ok:"Импорт завершён",import_err:"Некорректные данные",config:"Настройки",wifi_ip:"Мой IP",wifi_mask:"Маска сети",wifi_port:"HTTP порт",wifi_add:"Добавить по IP",mq_host:"Хост",mq_port:"Порт (WSS)",mq_login:"Логин",mq_pass:"Пароль",sr_baud:"Скорость",sr_offset:"Задержка запуска, мс",sr_port:"Порт",tg_token:"Токен бота",tg_chat:"ID чата",cfg_search:"Поиск",cfg_prefix:"Префикс",cfg_id:"ID клиента",cfg_theme:"Тема",cfg_color:"Цвет",cfg_font:"Шрифт",cfg_width:"Ширина окна",cfg_css:"Плагин CSS",cfg_js:"Плагин JS",cfg_updates:"Проверять обновления",cfg_sett:"Настройки",cfg_import:"Импорт",cfg_export:"Экспорт",cfg_reset:"Сброс",cfg_reset_conf:"Сбросить все настройки?",m_config:"Настройки",m_info:"Инфо",m_files:"Файлы",m_ota:"OTA",i_settings:"Настройки",i_console:"Консоль",i_mode:"Режим ПУ",i_default:"По умолчанию",i_single:"Один столбец",i_resp:"Адаптивный",i_grid:"Сетка",i_main:"Ширина ПУ",i_block:"Ширина блока",i_css:"Плагин CSS",i_js:"Плагин JS",i_reboot:"Перезагрузка",i_link:"Ссылка",i_topics:"Топики",i_version:"Версия",i_net:"Сеть",i_memory:"Память",i_system:"Система",fs_fsbr:"FS браузер",fs_used:"Занято",fs_format:"Форматировать",fs_upload_to:"Загрузить в",fs_upload:"Загрузить",fs_create_f:"Создать файл",fs_create:"Создать",rename:"Переименовать",delete:"Удалить",fetch:"Скачать",download:"Скачать",open:"Открыть",edit:"Редактировать",wrong_ota:"Некорректный файл! Используй",p_add:"Добавить проект",p_proj:"Проекты",p_not_support:"Браузер не поддерживается",p_use_https:"Используйте https версию сайта",p_has_upd:"Доступно обновление",p_upd:"Обновить прошивку",p_install:"Установить",wrong_text:"Некорректный текст!",wrong_ip:"Некорректный IP",dup_names:"Повторяющиеся имена",redirect:"Перейти на",}};let lang=langBase[userLang()];function updateLang(){lang=langBase[cfg.lang];}
function render_main(){document.body.innerHTML=`
<noscript>${lang.p_not_support}</noscript>
<div id="notice" class="notice"></div>
<div class="head" id="head_cont"></div>
<div class="test" id="test_cont"></div>
<div class="projects" id="projects_cont"></div>
<div class="main" id="main_cont"></div>
<div class="cli" id="cli_cont"></div>
<div class="footer" id="footer_cont" style="display:none"></div>
<div id="qrcode" style="display: none"></div>
`;head_cont.innerHTML=`
<div class="title" id="title_cont">
<div class="title_inn">
<div id="title_row" class="title_row" onclick="back_h()">
<span class="icon icon_head back_btn" id="back"></span>
<span><span id="title">${app_title}</span><sup id="conn"></sup></span>
<div id="conn_icons">
<span id='bt_ok' class="icon icon_ui icon_ok"></span>
<span id='mqtt_ok' class="icon icon_ui icon_ok"></span>
<span id='serial_ok' class="icon icon_ui icon_ok"></span>
<span id='tg_ok' class="icon icon_ui icon_ok"></span>
</div>
</div>
<div class="head_btns">
<span class="icon icon_head" id='icon_refresh' onclick="refresh_h()"></span>
<span class="icon icon_head" id='icon_cfg' style="display:none" onclick="config_h()"></span>
<span class="icon icon_head" id='icon_menu' style="display:none" onclick="menu_h()"></span>
</div>
</div>
</div>
`;test_cont.innerHTML=`
<div class="test_text">А тут пока ничего нет. Но будет онлайн-тест интерфейса, в котором можно будет поиграться и проверить свой билд без загрузки прошивки</div>
`;projects_cont.innerHTML=`
<div class="projects_inn">
<div id="projects" class="projects"></div>
<div class="projects">
<div class="proj">
<div class="proj_inn">
<div class="proj_name">
<a href="https://github.com/GyverLibs/GyverHub-projects" target="_blank">+ ${lang.p_add}</a>
</div>
</div>
</div>
</div>
</div>
`;cli_cont.innerHTML=`
<div class="cli_block">
<div class="cli_area" id="cli"></div>
<div class="cli_row">
<span class="icon cli_icon"></span>
<input type="text" class="ui_inp cli_inp" id="cli_input" onkeydown="checkCLI(event)">
<button class="icon icon_btn cli_icon cli_enter" onclick="sendCLI()"></button>
</div>
</div>
`;footer_cont.innerHTML=`
<div class="footer_inner">
<!--<a href="https://alexgyver.ru/support_alex/" target="_blank"><span class="icon icon_inline i_footer"></span>Support</a>-->
<a style="cursor:pointer" onclick="projects_h()"><span class="icon icon_inline i_footer"></span>${lang.p_proj}</a>
<!--<a style="cursor:pointer" onclick="test_h()"><span class="icon icon_inline i_footer"></span>Test</a>-->
<a style="cursor:pointer" onclick="window.open('https://hub.gyver.ru/old/')"><span class="icon icon_inline i_footer"></span>Old</a>
<a href="https://github.com/GyverLibs/GyverHub/wiki" target="_blank"><span class="icon icon_inline i_footer"></span>Wiki</a>
</div>
`;main_cont.innerHTML=`
<div id="menu_overlay" onclick="menu_show(0)"></div>
<div id="menu" class="main_col menu">
<div class="menu_inn">
<div id="menu_user"></div>
<div id="menu_system"></div>
</div>
</div>
<div class="main_inn">
<div id="plugins"></div>
<div id="app_plugins"></div>
<div id="devices" class="main_col"></div>
<div id="controls"></div>
<div id="dev_config" class="main_col">
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.i_settings}</label>
</div>
<div class="ui_row">
<label>${lang.i_console}</label>
<label class="switch"><input type="checkbox" id="info_cli_sw" onchange="showCLI(this.checked);save_devices()">
<span class="slider"></span></label>
</div>
<div class="ui_row">
<label>${lang.i_mode}</label>
<div class="ui_inp_row">
<select class="ui_inp ui_sel" id="ui_mode" onchange="ui_mode_h(this)">
<option value="0">${lang.i_default}</option>
<option value="1">${lang.i_single}</option>
<option value="2">${lang.i_resp}</option>
<option value="3">${lang.i_grid}</option>
</select>
</div>
</div>
<div class="ui_row" id="ui_block_width_cont">
<label class="ui_label">${lang.i_block}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="ui_block_width" onchange="ui_block_width_h(this)">
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.i_main}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="main_width" onchange="ui_width_h(this)">
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.i_css}</label>
<div class="ui_inp_row">
<textarea class="w_area" id="plugin_css" onchange="ui_plugin_css_h(this)"></textarea>
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.i_js}</label>
<div class="ui_inp_row">
<textarea class="w_area" id="plugin_js" onchange="ui_plugin_js_h(this)"></textarea>
</div>
</div>
<div class="ui_btn_row">
<button id="reboot_btn" class="ui_btn ui_btn_mini" onclick="reboot_h()"><span class="icon icon_inline"></span>${lang.i_reboot}</button>
<button id="devlink_btn" class="ui_btn ui_btn_mini" onclick="devlink_h()"><span class="icon icon_inline"></span>${lang.i_link}</button>
<!--NON-ESP-->
<button id="qr_btn" class="ui_btn ui_btn_mini" onclick="qr_h()"><span class="icon icon_inline"></span>QR</button>
<!--/NON-ESP-->
</div>
</div>
</div>
<div id="info" class="main_col">
<div class="ui_col" id="info_topics">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.i_topics}</label>
</div>
</div>
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.i_version}</label>
</div>
<div id="info_version"></div>
</div>
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.i_net}</label>
</div>
<div id="info_net"></div>
</div>
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.i_memory}</label>
</div>
<div id="info_memory"></div>
</div>
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.i_system}</label>
</div>
<div id="info_system"></div>
</div>
</div>
<div id="fsbr_edit" class="main_col">
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>Editor</label>
</div>
<div class="ui_row">
<label id="edit_path"></label>
</div>
<div class="ui_row">
<label>Wrap text</label>
<label class="switch">
<input type="checkbox" id="editor_wrap" onchange="this.checked?editor_area.classList.remove('w_area_wrap'):editor_area.classList.add('w_area_wrap')">
<span class="slider"></span>
</label>
</div>
<div class="ui_row">
<textarea rows=20 id="editor_area" class="ui_inp w_area w_area_wrap"></textarea>
</div>
<div class="ui_row">
<button id="editor_save" onclick="editor_save()" class="ui_btn ui_btn_mini">Save & Upload</button>
<button onclick="editor_cancel()" class="ui_btn ui_btn_mini">Cancel</button>
</div>
</div>
</div>
<div id="files" class="main_col">
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.fs_fsbr}</label>
</div>
<div id="fs_browser">
<div id="fsbr_inner"></div>
<div class="ui_row" id="fs_format_row">
<div>
<button id="fs_format" onclick="format_h()" class="ui_btn ui_btn_mini">${lang.fs_format}</button>
</div>
</div>
</div>
</div>
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.fs_upload_to}</label>
</div>
<div id="fs_upload">
<div class="upl_row">
<input class="ui_inp ui_inp_wbtn" type="text" id="file_upload_path" value="/">
<input type="file" id="file_upload" style="display:none" onchange="uploadFile(this.files[0], file_upload_path.value)">
<button id="file_upload_btn" onclick="file_upload.click()" class="ui_btn upl_btn">${lang.fs_upload}</button>
</div>
</div>
</div>
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>${lang.fs_create_f}</label>
</div>
<div id="fs_create">
<div class="upl_row">
<input class="ui_inp ui_inp_wbtn" type="text" id="file_create_path" value="/">
<button onclick="create_h()" class="ui_btn upl_btn">${lang.fs_create}</button>
</div>
</div>
</div>
</div>
<div id="ota" class="main_col">
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>OTA FILE</label>
</div>
<div id="fs_otaf">
<div class="ui_row">
<div>
<input type="file" id="ota_upload" style="display:none" onchange="uploadOta(this.files[0], 'flash')">
<button onclick="ota_upload.click()" class="ui_btn ui_btn_mini drop_area" ondrop="uploadOta(event.dataTransfer.files[0], 'flash')">Flash</button>
<input type="file" id="ota_upload_fs" style="display:none" onchange="uploadOta(this.files[0], 'fs')">
<button onclick="ota_upload_fs.click()" class="ui_btn ui_btn_mini drop_area" ondrop="uploadOta(event.dataTransfer.files[0], 'fs')">Filesystem</button>
</div>
<label style="font-size:18px" id="ota_label"></label>
</div>
</div>
</div>
<div class="ui_col">
<div class="ui_row ui_head">
<label><span class="icon icon_ui"></span>OTA URL</label>
</div>
<div id="fs_otaurl">
<div class="upl_row">
<input class="ui_inp ui_inp_wbtn" type="text" id="ota_url_f">
<button id="ota_url_btn" onclick="otaUrl(ota_url_f.value,'flash')" class="ui_btn upl_btn">Flash</button>
</div>
<div class="upl_row">
<input class="ui_inp ui_inp_wbtn" type="text" id="ota_url_fs">
<button id="ota_url_btn" onclick="otaUrl(ota_url_fs.value,'fs')" class="ui_btn upl_btn">FS</button>
</div>
</div>
</div>
</div>
<div id="config" class="cfg_inner">
<div class="ui_col">
<div class="ui_row ui_head ui_tab" onclick="use_local.click()">
<label class="ui_label ui_tab" id="local_label"><span class="icon icon_ui"></span>WiFi</label>
<input type="checkbox" id="use_local" onchange="update_cfg(this);save_cfg()" style="display:none">
</div>
<div id="local_block" style="display:none">
<div class="ui_row" id="http_only_http" style="display:none">
<span style="color:#c60000">Works only on <strong class="span_btn" onclick="window.location.href = window.location.href.replace('https', 'http')">HTTP</strong>!</span>
</div>
<div id="http_settings">
<div class="ui_row">
<label class="ui_label">${lang.wifi_ip}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="local_ip" onchange="update_cfg(this)">
<div class="btn_inp_block">
<button class="icon icon_btn" onclick="update_ip_h();update_cfg(EL('local_ip'))"></button>
</div>
</div>
</div>
<div class="ui_row">
<label>${lang.wifi_mask}</label>
<div class="ui_inp_row">
<select class="ui_inp ui_sel" id="netmask" onchange="update_cfg(this)"></select>
</div>
</div>
<div class="ui_row">
<label>${lang.wifi_port}</label>
<div class="ui_inp_row"><input class="ui_inp" type="text" id="http_port" onchange="update_cfg(this)">
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.wifi_add}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" value="192.168.1.1" id="local_add_ip">
<div class="btn_inp_block">
<button class="icon icon_btn" onclick="manual_ip_h(local_add_ip.value)"></button>
</div>
</div>
</div>
<!--APP-->
<span class="notice_block">Disable:
<u>${browser()}://flags/#block-insecure-private-network-requests</u></span>
<!--/APP-->
</div>
</div>
</div>
<!--NON-ESP-->
<div class="ui_col" id="mq_col">
<div class="ui_row ui_head ui_tab" onclick="use_mqtt.click()">
<label class="ui_label ui_tab" id="mqtt_label"><span class="icon icon_ui"></span>MQTT</label>
<input type="checkbox" id="use_mqtt" onchange="update_cfg(this);hub.mqtt.stop();save_cfg()" style="display:none">
</div>
<div id="mq_block" style="display:none">
<div class="ui_row">
<label class="ui_label">${lang.mq_host}</label>
<div class="ui_inp_row"><input class="ui_inp" type="text" id="mq_host" onchange="update_cfg(this);hub.mqtt.stop()"></div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.mq_port}</label>
<div class="ui_inp_row"><input class="ui_inp" type="number" id="mq_port" onchange="update_cfg(this);hub.mqtt.stop()"></div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.mq_login}</label>
<div class="ui_inp_row"><input class="ui_inp" type="text" id="mq_login" onchange="update_cfg(this);hub.mqtt.stop()"></div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.mq_pass}</label>
<div class="ui_inp_row"><input class="ui_inp" type="password" id="mq_pass" onchange="update_cfg(this);hub.mqtt.stop()">
</div>
</div>
<div class="ui_row">
<div></div>
<div class="ui_btn_row">
<button class="ui_btn ui_btn_mini" onclick="hub.mqtt.start()" id="mq_start">${lang.connect}</button>
<button class="ui_btn ui_btn_mini" onclick="hub.mqtt.stop()" id="mq_stop" style="display:none">${lang.disconnect}</button>
</div>
</div>
</div>
</div>
<div class="ui_col" id="tg_col">
<div class="ui_row ui_head ui_tab" onclick="use_tg.click()">
<label class="ui_label ui_tab" id="tg_label"><span class="icon icon_ui"></span>Telegram</label>
<input type="checkbox" id="use_tg" onchange="update_cfg(this);hub.tg.stop();save_cfg()" style="display:none">
</div>
<div id="tg_block" style="display:none">
<div class="ui_row">
<label class="ui_label">${lang.tg_token}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="tg_token" onchange="update_cfg(this);hub.tg.stop();hub.tg.bot.setToken(this.value)">
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.tg_chat}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="tg_chat" onchange="update_cfg(this)">
</div>
</div>
<div class="ui_row">
<div></div>
<div class="ui_btn_row">
<button class="ui_btn ui_btn_mini" onclick="hub.tg.start()" id="tg_start">${lang.connect}</button>
<button class="ui_btn ui_btn_mini" onclick="hub.tg.stop()" id="tg_stop" style="display:none">${lang.disconnect}</button>
</div>
</div>
</div>
</div>
<div class="ui_col" id="serial_col" ${hasSerial() ? '' : 'style="display:none"'}>
<div class="ui_row ui_head ui_tab" onclick="use_serial.click()">
<label class="ui_label ui_tab" id="serial_label"><span class="icon icon_ui"></span>Serial</label>
<input type="checkbox" id="use_serial" onchange="serial_toggle(this.checked);update_cfg(this);save_cfg()" style="display:none">
</div>
<div id="serial_block" style="display:none">
<div class="ui_row">
<label class="ui_label">${lang.sr_baud}</label>
<div class="ui_inp_row">
<select class="ui_inp ui_sel" id='baudrate' onchange="update_cfg(this)"></select>
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.sr_offset}</label>
<div class="ui_inp_row"><input class="ui_inp" type="text" id="serial_offset" onchange="update_cfg(this)">
</div>
</div>
<div class="ui_row">
<div><label class="ui_label">${lang.sr_port} </label><label class="ui_label" id="port_name"></label></div>
<div class="ui_btn_row">
<button class="ui_btn ui_btn_mini" onclick="hub.serial.select()">${lang.select}</button>
<button id="serial_open" class="ui_btn ui_btn_mini" onclick="hub.serial.open()" style="display:none">${lang.connect}</button>
<button id="serial_close" class="ui_btn ui_btn_mini" onclick="hub.serial.close()" style="display:none">${lang.disconnect}</button>
</div>
</div>
</div>
</div>
<div class="ui_col" id="bt_col" ${hasBT() ? '' : 'style="display:none"'}>
<div class="ui_row ui_head ui_tab" onclick="use_bt.click()">
<label class="ui_label ui_tab" id="bt_label"><span class="icon icon_ui"></span>Bluetooth</label>
<input type="checkbox" id="use_bt" onchange="update_cfg(this);save_cfg()" style="display:none">
</div>
<div id="bt_block" style="display:none">
<div class="ui_row">
<label class="ui_label" id="bt_device">${lang.not_conn}</label>
<div class="ui_btn_row">
<button id="bt_open" class="ui_btn ui_btn_mini" onclick="hub.bt.open()">${lang.connect}</button>
<button id="bt_close" class="ui_btn ui_btn_mini" onclick="hub.bt.close()" style="display:none">${lang.disconnect}</button>
</div>
</div>
</div>
</div>
<!--/NON-ESP-->
<div class="ui_col">
<div class="ui_row ui_head">
<label class="ui_label"><span class="icon icon_ui"></span>${lang.cfg_sett}</label>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_search}</label>
<button class="icon icon_btn_big" onclick="search();back_h();" title="Find new devices"></button>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_prefix}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="prefix" onchange="update_cfg(this)">
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_id}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="client_id" onchange="update_cfg(this)" oninput="if(this.value.length>8)this.value=this.value.slice(0,-1)">
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_theme}</label>
<div class="ui_inp_row">
<select class="ui_inp ui_sel" id='theme' onchange="update_cfg(this)"></select>
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_color}</label>
<div class="ui_inp_row">
<select class="ui_inp ui_sel" id='maincolor' onchange="update_cfg(this)"></select>
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_font}</label>
<div class="ui_inp_row">
<select class="ui_inp ui_sel" id='font' onchange="update_cfg(this)"></select>
</div>
</div>
<div class="ui_row">
<label class="ui_label">Language</label>
<div class="ui_inp_row">
<select class="ui_inp ui_sel" id='lang' onchange="update_cfg(this)"></select>
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_width}</label>
<div class="ui_inp_row">
<input class="ui_inp" type="text" id="ui_width" onchange="update_cfg(this);update_theme()">
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_css}</label>
<div class="ui_inp_row">
<textarea class="w_area" id="app_plugin_css" onchange="update_cfg(this);update_theme()"></textarea>
</div>
</div>
<div class="ui_row">
<label class="ui_label">${lang.cfg_js}</label>
<div class="ui_inp_row">
<textarea class="w_area" id="app_plugin_js" onchange="update_cfg(this);update_theme()"></textarea>
</div>
</div>
<div class="ui_row">
<label>${lang.cfg_updates}</label>
<label class="switch"><input type="checkbox" id="check_upd" onchange="update_cfg(this)"><span class="slider"></span></label>
</div>
<div class="ui_btn_row">
<button class="ui_btn ui_btn_mini" onclick="cfg_export()">${lang.cfg_export}</button>
<button class="ui_btn ui_btn_mini" onclick="cfg_import()">${lang.cfg_import}</button>
<button class="ui_btn ui_btn_mini" onclick="cfg_reset()">${lang.cfg_reset}</button>
</div>
</div>
<div class="ui_col">
<div class="ui_row ui_head ui_tab" onclick="use_pin.click()">
<label id="pin_label" class="ui_label ui_tab"><span class="icon icon_ui"></span>PIN</label>
<input type="checkbox" id="use_pin" onchange="update_cfg(this)" style="display:none">
</div>
<div id="pin_block" style="display:none">
<div class="ui_row">
<label class="ui_label">PIN</label>
<div class="ui_inp_row"><input class="ui_inp" type="password" pattern="[0-9]*" inputmode="numeric" id="pin" onchange="make_pin(this);update_cfg(this)" oninput="check_type(this)">
</div>
</div>
</div>
</div>
<!--NON-ESP-->
<div class="ui_col" id="pwa_block">
<div class="ui_row ui_head">
<label class="ui_label"><span class="icon icon_ui"></span>Web App</label>
<div class="ui_btn_row">
<button class="ui_btn ui_btn_mini ${isSSL() ? 'ui_btn_dis' : ''}" onclick="pwa_install(false)">HTTP</button>
<button class="ui_btn ui_btn_mini ${!isSSL() ? 'ui_btn_dis' : ''}" onclick="pwa_install(true)">HTTPS</button>
</div>
</div>
<span class="notice_block" id="pwa_unsafe">Enable <u>${browser()}://flags/#unsafely-treat-insecure-origin-as-secure</u> and add <u>${window.location.href}</u> to list</span>
</div>
<!--/NON-ESP-->
<div class="ui_col" id="app_block" style="display:none">
<div class="ui_row ui_head">
<label class="ui_label"><span class="icon icon_ui"></span>App</label>
<div class="ui_btn_row">
<button class="ui_btn ui_btn_mini" onclick="openURL('https://play.google.com/store/apps/details?id=ru.alexgyver.GyverHub')">Android</button>
<button class="ui_btn ui_btn_mini" onclick="openURL('https://github.com/GyverLibs/GyverHub-app/releases/download/0.1/app-release.apk')">.apk</button>
</div>
</div>
</div>
<div class="ui_col">
<div class="cfg_info" id="hub_stat"></div>
<div class="cfg_info">
Contribution:
<a href="https://github.com/Simonwep/pickr" target="_blank">Pickr</a>
<a href="https://github.com/mqttjs/MQTT.js" target="_blank">MQTT.js</a>
<a href="https://github.com/ghornich/sort-paths" target="_blank">sort-paths</a>
<a href="https://fontawesome.com/v5/search?o=r&m=free&s=solid" target="_blank">Fontawesome</a>
<a href="https://github.com/loginov-rocks/Web-Bluetooth-Terminal" target="_blank">Bluetooth Terminal</a>
<a href="https://github.com/davidshimjs/qrcodejs" target="_blank">QRCode.js</a>
<a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>
</div>
</div>
</div>
<div id="password" class="main_col">
<div class="pass_inp_inner">
<input class="ui_inp pass_inp" type="number" pattern="[0-9]*" inputmode="numeric" id="pass_inp" oninput="pass_type('')">
</div>
<div class="ui_row pin_inner">
<button class="ui_btn pin_btn" onclick="pass_type(1)">1</button>
<button class="ui_btn pin_btn" onclick="pass_type(2)">2</button>
<button class="ui_btn pin_btn" onclick="pass_type(3)">3</button>
</div>
<div class="ui_row pin_inner">
<button class="ui_btn pin_btn" onclick="pass_type(4)">4</button>
<button class="ui_btn pin_btn" onclick="pass_type(5)">5</button>
<button class="ui_btn pin_btn" onclick="pass_type(6)">6</button>
</div>
<div class="ui_row pin_inner">
<button class="ui_btn pin_btn" onclick="pass_type(7)">7</button>
<button class="ui_btn pin_btn" onclick="pass_type(8)">8</button>
<button class="ui_btn pin_btn" onclick="pass_type(9)">9</button>
</div>
<div class="ui_row pin_inner">
<button class="ui_btn pin_btn pin_no_btn"></button>
<button class="ui_btn pin_btn" onclick="pass_type(0)">0</button>
<button class="ui_btn pin_btn pin_red_btn" onclick="pass_inp.value=pass_inp.value.slice(0, -1)">&lt;</button>
</div>
</div>
</div>
<div id="bottom_space"></div>
`;}
function render_selects(){const baudrates=[4800,9600,19200,38400,57600,74880,115200,230400,250000,500000,1000000,2000000];for(let baud of baudrates){EL('baudrate').innerHTML+=`
<option value="${baud}">${baud}</option>`;}
let i=0;for(let color in colors){EL('maincolor').innerHTML+=`
<option value="${color}">${lang.colors[i++]}</option>`;}
const langs={English:0,Russian:1,};for(let lang in langs){EL('lang').innerHTML+=`
<option value="${lang}">${lang}</option>`;}
const fonts=['monospace','system-ui','cursive','Arial','Verdana','Tahoma','Trebuchet MS','Georgia','Garamond',];for(let font of fonts){EL('font').innerHTML+=`
<option value="${font}">${font}</option>`;}
for(let theme in themes){EL('theme').innerHTML+=`
<option value="${theme}">${lang.themes[themes[theme]]}</option>`;}
let masks=getMaskList();for(let mask in masks){EL('netmask').innerHTML+=`<option value="${mask}">${masks[mask]}</option>`;}}
function render_info(){const info_labels_topics={info_id:'ID',info_set:'Set',info_read:'Read',info_get:'Get',info_status:'Status',};for(let id in info_labels_topics){EL('info_topics').innerHTML+=`
<div class="ui_row info">
<label>${info_labels_topics[id]}</label>
<label id="${id}" class="info_label info_label_small">-</label>
</div>`;}}
function add_device(dev){let icon=dev.icon;if(icon.length&&platform()=='esp')icon='';EL('devices').innerHTML+=`
<div class="device ${dev.conn == Conn.NONE ? 'offline' : ''}" id="device#${dev.id}" onclick="device_h('${dev.id}')" title="${dev.id} [${dev.prefix}]">
<div class="device_inner">
<div id="d_head#${dev.id}" style="display:contents">
<div class="d_icon ${icon.length ? '' : 'd_icon_empty'}"><span class="icon icon_min ${icon.length ? '' : 'd_icon_none'}" id="icon#${dev.id}">${getIcon(icon)}</span></div>
<div class="d_title">
<span><span class="d_name" id="name#${dev.id}">${dev.name}</span><sup class="conn_dev" id="Serial#${dev.id}">S</sup><sup class="conn_dev" id="BT#${dev.id}">B</sup><sup class="conn_dev" id="HTTP#${dev.id}">W</sup><sup class="conn_dev" id="MQTT#${dev.id}">M</sup><sup class="conn_dev" id="TG#${dev.id}">T</sup></span>
</div>
</div>
<div id="d_cfg#${dev.id}" class="d_btn_cont">
<div class="icon d_btn_red" onclick="delete_h('${dev.id}');event.stopPropagation()"></div>
<div class="icon d_btn_green" onclick="dev_up_h('${dev.id}');event.stopPropagation()"></div>
<div class="icon d_btn_green" onclick="dev_down_h('${dev.id}');event.stopPropagation()"></div>
</div>
<span class="icon d_btn_cfg" onclick="dev_cfg_h('${dev.id}');event.stopPropagation()"></span>
</div>
</div>`;let device=hub.dev(dev.id);EL('d_head#'+dev.id).style.display=device.cfg_flag?'none':'contents';EL('d_cfg#'+dev.id).style.display=device.cfg_flag?'flex':'none';}
function render_devices(){EL('devices').innerHTML='';for(let dev of hub.devices){add_device(dev.info);for(let i in dev.conn_arr){if(dev.conn_arr[i])display(`${Conn.names[i]}#${dev.info.id}`,'inline-block');}}}
function dev_cfg_h(id){let dev=hub.dev(id);dev.cfg_flag=!dev.cfg_flag;EL('d_head#'+id).style.display=dev.cfg_flag?'none':'contents';EL('d_cfg#'+id).style.display=dev.cfg_flag?'flex':'none';}
let popupT1=null,popupT2=null;function showPopup(text,color='#37a93c'){if(popupT1)clearTimeout(popupT1);if(popupT2)clearTimeout(popupT2);EL('notice').innerHTML=text;EL('notice').style.background=color;display('notice','block');EL('notice').style.animation="fade-in 0.5s forwards";popupT1=setTimeout(()=>{popupT1=null;display('notice','none');},3500);popupT2=setTimeout(()=>{popupT2=null;EL('notice').style.animation="fade-out 0.5s forwards"},3000);}
function showPopupError(text){showPopup(text,'#a93737');}
function errorBar(v){EL('head_cont').style.background=v?'var(--err)':'var(--prim)';}
function spinArrows(val){if(val)EL('icon_refresh').classList.add('spinning');else EL('icon_refresh').classList.remove('spinning');}
function waiter(size=50,col='var(--prim)',block=true){return`<div class="waiter ${block ? 'waiter_b' : ''}"><span style="font-size:${size}px;color:${col}" class="icon spinning"></span></div>`;}
function mq_change(opened){display('mq_start',opened?'none':'inline-block');display('mq_stop',opened?'inline-block':'none');}
function bt_show_ok(state){display('bt_ok',state?'inline-block':'none');}
function bt_change(opened){display('bt_open',opened?'none':'inline-block');display('bt_close',opened?'inline-block':'none');}
function serial_show_ok(state){display('serial_ok',state?'inline-block':'none');}
function serial_change(opened){display('serial_open',opened?'none':'inline-block');display('serial_close',opened?'inline-block':'none');}
async function serial_toggle(state){serial_show_ok(false);serial_change(false);if(!state)hub.serial.close();serial_check_ports();}
async function serial_check_ports(){if(!hasSerial())return;const res=await hub.serial.hasPort();display('serial_open',res?'inline-block':'none');serial_update_name();}
function serial_update_name(){EL('port_name').innerHTML=hub.serial.getName();}
function tg_change(opened){display('tg_start',opened?'none':'inline-block');display('tg_stop',opened?'inline-block':'none');}
function showInfo(info){function addInfo(el,label,value,title=''){EL(el).innerHTML+=`
<div class="ui_row info">
<label>${label}</label>
<label title="${title}" class="info_label">${value}</label>
</div>`;}
EL('info_version').innerHTML='';EL('info_net').innerHTML='';EL('info_memory').innerHTML='';EL('info_system').innerHTML='';for(let i in info.version)addInfo('info_version',i,info.version[i]);for(let i in info.net)addInfo('info_net',i,info.net[i]);for(let i in info.memory){if(typeof(info.memory[i])=='object'){let used=info.memory[i][0];let total=info.memory[i][1];let mem=(used/1000).toFixed(1)+' kB';if(total)mem+=' ['+(used/total*100).toFixed(0)+'%]';addInfo('info_memory',i,mem,`Total ${(total / 1000).toFixed(1)} kB`);}else{addInfo('info_memory',i,info.memory[i]);}}
for(let i in info.system){if(i=='Uptime'){let sec=info.system[i];let upt=Math.floor(sec/86400)+':'+new Date(sec*1000).toISOString().slice(11,19);let d=new Date();let utc=d.getTime()-(d.getTimezoneOffset()*60000);addInfo('info_system',i,upt);addInfo('info_system','Started',new Date(utc-sec*1000).toISOString().split('.')[0].replace('T',' '));continue;}
addInfo('info_system',i,info.system[i]);}}
function update_cfg(el){if(el.type=='text')el.value=el.value.trim();let val=(el.type=='checkbox')?el.checked:el.value;if(el.id in cfg)cfg[el.id]=val;else if(el.id in hub.cfg)hub.cfg[el.id]=val;cfg_changed=true;update_theme();}
function save_cfg(){if(cfg.pin.length<4)cfg.use_pin=false;localStorage.setItem('app_config',JSON.stringify(cfg));localStorage.setItem('hub_config',JSON.stringify(hub.cfg));}
function load_cfg(){if(localStorage.hasOwnProperty('app_config')){let cfg_r=JSON.parse(localStorage.getItem('app_config'));if(cfg.api_ver===cfg_r.api_ver){cfg=cfg_r;return;}}
localStorage.setItem('app_config',JSON.stringify(cfg));}
function load_cfg_hub(){if(localStorage.hasOwnProperty('hub_config')){let cfg_r=JSON.parse(localStorage.getItem('hub_config'));if(hub.cfg.api_ver===cfg_r.api_ver){hub.cfg=cfg_r;return;}else{localStorage.setItem('devices','[]');}}
localStorage.setItem('hub_config',JSON.stringify(hub.cfg));}
function apply_cfg(){if(cfg.pin.length<4)cfg.use_pin=false;for(let key in cfg){let el=EL(key);if(el==undefined)continue;if(el.type=='checkbox')el.checked=cfg[key];else el.value=cfg[key];}
for(let key in hub.cfg){let el=EL(key);if(el==undefined)continue;if(el.type=='checkbox')el.checked=hub.cfg[key];else el.value=hub.cfg[key];}}
async function cfg_export(){await copyClip(btoa(JSON.stringify(cfg))+';'+btoa(JSON.stringify(hub.cfg))+';'+btoa(encodeURIComponent(hub.export())));}
async function cfg_import(){try{let text=await navigator.clipboard.readText();text=text.split(';');try{cfg=JSON.parse(atob(text[0]));}catch(e){}
try{hub.cfg=JSON.parse(atob(text[1]));}catch(e){}
try{hub.import(decodeURIComponent(atob(text[2])));}catch(e){}
save_cfg();save_devices();showPopup(lang.import_ok);setTimeout(()=>location.reload(),500);}catch(e){showPopupError(lang.import_err);}}
async function cfg_reset(){if(await asyncConfirm(lang.cfg_reset_conf)){localStorage.removeItem("app_config");localStorage.removeItem("hub_config");localStorage.removeItem("devices");setTimeout(()=>location.reload(),500);}}
function update_theme(){let v=themes[cfg.theme];let r=document.querySelector(':root');r.style.setProperty('--back',theme_cols[v][0]);r.style.setProperty('--tab',theme_cols[v][1]);r.style.setProperty('--font',theme_cols[v][2]);r.style.setProperty('--font2',theme_cols[v][3]);r.style.setProperty('--dark',theme_cols[v][4]);r.style.setProperty('--thumb',theme_cols[v][5]);r.style.setProperty('--black',theme_cols[v][6]);r.style.setProperty('--scheme',theme_cols[v][7]);r.style.setProperty('--font_inv',theme_cols[v][8]);r.style.setProperty('--shad',theme_cols[v][9]);r.style.setProperty('--ui_width',cfg.ui_width+'px');r.style.setProperty('--prim',intToCol(colors[cfg.maincolor]));r.style.setProperty('--font_f',cfg.font);EL('app_plugins').innerHTML='';addDOM('app_css','style',cfg.app_plugin_css,EL('app_plugins'));addDOM('app_js','script',cfg.app_plugin_js,EL('app_plugins'));let b='block';let n='none';let f='var(--font)';let f3='var(--font3)';display('local_block',hub.cfg.use_local?b:n);EL('local_label').style.color=hub.cfg.use_local?f:f3;display('pin_block',cfg.use_pin?b:n);EL('pin_label').style.color=cfg.use_pin?f:f3;updateLang();display('mq_block',hub.cfg.use_mqtt?b:n);EL('mqtt_label').style.color=hub.cfg.use_mqtt?f:f3;display('tg_block',hub.cfg.use_tg?b:n);EL('tg_label').style.color=hub.cfg.use_tg?f:f3;let bt=hub.cfg.use_bt&&hasBT();display('bt_block',bt?b:n);EL('bt_label').style.color=bt?f:f3;let ser=hub.cfg.use_serial&&hasSerial();display('serial_block',ser?b:n);EL('serial_label').style.color=ser?f:f3;}
function save_devices(){localStorage.setItem('devices',hub.export());}
function load_devices(){if(localStorage.hasOwnProperty('devices')){hub.import(localStorage.getItem('devices'));}}
let updates_list=[];async function checkUpdates(id){if(!cfg.check_upd)return;if(updates_list.includes(id))return;let ver=hub.dev(id).info.version;if(!ver.includes('@'))return;let namever=ver.split('@');let proj;try{const resp=await fetch(`https://raw.githubusercontent.com/${namever[0]}/main/project.json`,{cache:"no-store"});proj=await resp.text();proj=JSON.parse(proj);}catch(e){return;}
if(!('builds'in proj)||!('version'in proj))return;if(proj.version==namever[1])return;if(id!=focused)return;updates_list.push(id);const platform=hub.dev(id).info.platform;for(build of proj.builds){if(build.chipFamily==platform){const text=`${namever[0]} v${proj.version}:\n${proj.notes}\n\n${lang.p_upd}?`;if(await asyncConfirm(text,lang.p_has_upd+'!'))otaUrl(build.parts[0].path,'flash');break;}}}
async function loadProjects(){const resp=await fetch("https://raw.githubusercontent.com/GyverLibs/GyverHub-projects/main/projects.txt",{cache:"no-store"});let projects=await resp.text();projects=projects.split('\n');for(let proj of projects){if(!proj)continue;let rep=proj.split('https://github.com/')[1];if(!rep)continue;loadProj(rep);}}
async function loadProj(rep){try{const manifest=`https://raw.githubusercontent.com/${rep}/main/project.json`;const resp=await fetch(manifest,{cache:"no-store"});let proj=await resp.json();if(!('name'in proj)||!('version'in proj)||!('about'in proj))return;let name=proj.name;let repname=rep.split('/')[1];if(name.length>30)name=name.slice(0,30)+'..';let allowInstall=(platform()=='host'||platform()=='desktop');const btn=allowInstall?`<button title="${lang.p_install}" class="icon icon_btn_big" style="font-size:15px" onclick="EL('proj_${repname}').click()"></button>`:'';EL('projects').innerHTML+=`
<div class="proj">
<div class="proj_inn">
<div class="proj_name">
<a href="${'https://github.com/' + rep}" target="_blank" title="${rep} v${proj.version}">${name}</a>
${btn}
</div>
<div class="proj_about">${proj.about}</div>
</div>
</div>`;if(allowInstall)EL('projects').innerHTML+=`
<esp-web-install-button manifest="${manifest}" style="display:none">
<button id="proj_${repname}" slot="activate"></button>
<span slot="unsupported">${lang.p_not_support}</span>
<span slot="not-allowed">${lang.p_use_https}</span>
</esp-web-install-button>`;}catch(e){return;}}
let menu_f=false;let pin_id=null;async function show_screen(nscreen){if(focused)hub.dev(focused).fsStop();spinArrows(false);screen=nscreen;show_keypad(false);['conn_icons','test_cont','projects_cont','config','devices','controls','info','icon_menu','icon_cfg','files','ota','back','icon_refresh','footer_cont','conn','dev_config'].forEach(e=>display(e,'none'));display('main_cont','block');EL('title').innerHTML=app_title;EL('title_row').style.cursor='pointer';let dev=hub.dev(focused);switch(screen){case'main':display('conn_icons','inline-block');display('devices','grid');display('icon_cfg','inline-block');display('icon_refresh','inline-block');display('footer_cont','block');EL('title_row').style.cursor='unset';showCLI(false);break;case'test':display('main_cont','none');display('test_cont','block');display('back','inline-block');EL('title').innerHTML='UI Test';break;case'projects':display('main_cont','none');display('projects_cont','block');display('back','inline-block');EL('title').innerHTML=lang.p_proj;break;case'ui':display('controls','block');display('icon_menu','inline-block');display('back','inline-block');display('icon_refresh','inline-block');display('conn','inline-block');EL('title').innerHTML=dev.info.name;break;case'config':display('conn_icons','inline-block');display('config','block');display('icon_cfg','inline-block');display('back','inline-block');EL('title').innerHTML=lang.config;break;case'info':display('info','block');display('icon_menu','inline-block');display('back','inline-block');display('conn','inline-block');display('icon_refresh','inline-block');EL('title').innerHTML=dev.info.name+'/info';show_info();break;case'files':display('files','block');display('icon_menu','inline-block');display('back','inline-block');display('conn','inline-block');display('icon_refresh','inline-block');EL('title').innerHTML=dev.info.name+'/fs';EL('file_upload_btn').innerHTML=lang.fs_upload;break;case'ota':display('ota','block');display('icon_menu','inline-block');display('back','inline-block');display('conn','inline-block');EL('title').innerHTML=dev.info.name+'/ota';break;case'dev_config':display('dev_config','block');display('icon_menu','inline-block');display('back','inline-block');display('conn','inline-block');EL('title').innerHTML=dev.info.name+'/cfg';show_cfg();break;case'pin':display('back','inline-block');show_keypad(true);break;}}
function show_cfg(){let dev=hub.dev(focused);EL('ui_mode').value=dev.info.ui_mode;EL('main_width').value=dev.info.main_width;EL('ui_block_width').value=dev.info.ui_block_width;display('ui_block_width_cont',dev.info.ui_mode>=2?'flex':'none');EL('info_cli_sw').checked=EL('cli_cont').style.display=='block';EL('plugin_css').value=dev.info.plugin_css;EL('plugin_js').value=dev.info.plugin_js;}
function show_info(){let dev=hub.dev(focused);EL('info_id').innerHTML=focused;EL('info_set').innerHTML=dev.info.prefix+'/'+focused+'/ID/set/*';EL('info_read').innerHTML=dev.info.prefix+'/'+focused+'/ID/read/*';EL('info_get').innerHTML=dev.info.prefix+'/hub/'+focused+'/get/*';EL('info_status').innerHTML=dev.info.prefix+'/hub/'+focused+'/status';display('reboot_btn',dev.module(Modules.REBOOT)?'block':'none');display('info_topics',dev.module(Modules.MQTT)?'block':'none');EL('info_version').innerHTML='';EL('info_net').innerHTML='';EL('info_memory').innerHTML='';EL('info_system').innerHTML='';}
function resize_h(){ui_render.resizeWidgets();}
function test_h(){show_screen('test');}
function projects_h(){EL('projects').innerHTML='';show_screen('projects');loadProjects();}
function refresh_h(){if(focused)post(screen);else discover();}
async function back_h(){if(focused){let dev=hub.dev(focused);if(dev.fsBusy()){showPopupError(dev.fs_mode+' '+getError(HubErrors.Abort));dev.fsStop();}}
if(EL('fsbr_edit').style.display=='block'){editor_cancel();return;}
if(menu_f){Menu.deact();menu_show(0);return;}
switch(screen){case'ui':release_all();close_device();break;case'dev_config':case'info':case'files':case'ota':Menu.deact();show_screen('ui');post('ui');break;case'config':config_h();break;case'pin':case'projects':case'test':show_screen('main');break;}}
function config_h(){if(screen=='config'){show_screen('main');if(cfg_changed){save_cfg();discover();}
cfg_changed=false;}else{show_screen('config');}}
function info_h(){Menu.deact();menu_show(0);if(hub.dev(focused).module(Modules.INFO))post('info');show_screen('info');EL('menu_info').classList.add('menu_act');}
function cfg_h(){Menu.deact();menu_show(0);show_screen('dev_config');EL('menu_cfg').classList.add('menu_act');}
function fsbr_h(){Menu.deact();menu_show(0);if(hub.dev(focused).module(Modules.FILES)){post('files');EL('fsbr_inner').innerHTML=waiter();}
display('fs_browser',hub.dev(focused).module(Modules.FILES)?'block':'none');display('fs_upload',hub.dev(focused).module(Modules.UPLOAD)?'block':'none');display('fs_create',hub.dev(focused).module(Modules.CREATE)?'block':'none');display('fs_format_row',hub.dev(focused).module(Modules.FORMAT)?'flex':'none');show_screen('files');EL('menu_fsbr').classList.add('menu_act');}
async function format_h(){if(await asyncConfirm(lang.fs_format+'?'))post('format');}
function ota_h(){Menu.deact();menu_show(0);show_screen('ota');EL('menu_ota').classList.add('menu_act');let ota_t='.'+hub.dev(focused).info.ota_t;EL('ota_upload').accept=ota_t;EL('ota_upload_fs').accept=ota_t;EL('ota_url_f').value="http://flash"+ota_t;EL('ota_url_fs').value="http://filesystem"+ota_t;display('fs_otaf',hub.dev(focused).module(Modules.OTA)?'block':'none');display('fs_otaurl',hub.dev(focused).module(Modules.OTA_URL)?'block':'none');}
function manual_ip_h(ip){if(hub.http.discover_ip(ip,hub.cfg.http_port)){save_cfg();show_screen('main');}else showPopupError(lang.wrong_ip);}
function update_ip_h(){if(!Boolean(window.webkitRTCPeerConnection||window.mozRTCPeerConnection))notSupported();else getLocalIP().then((ip)=>{if(ip.indexOf("local")>0)asyncAlert(`Disable WEB RTC anonymizer: ${browser()}://flags/#enable-webrtc-hide-local-ips-with-mdns`);else EL('local_ip').value=ip;});if(platform()=='esp')EL('local_ip').value=window_ip();}
function menu_h(){menu_show(!menu_f);}
function devlink_h(){copyClip(devLink());}
function qr_h(){let qr=EL("qrcode");new QRCode(qr,devLink());setTimeout(()=>openFile(qr.children[1].src),100);}
function devLink(){let qs=window.location.origin+window.location.pathname+'?';let info=hub.dev(focused).info;["id","prefix","ip","http_port"].forEach(x=>{if(info[x])qs+=`${x}=${info[x]}&`;});return qs.slice(0,-1);}
function ui_mode_h(el){hub.dev(focused).info.ui_mode=el.value;save_devices();display('ui_block_width_cont',el.value>=2?'flex':'none');}
function ui_width_h(el){hub.dev(focused).info.main_width=el.value;save_devices();}
function ui_block_width_h(el){hub.dev(focused).info.ui_block_width=el.value;save_devices();}
function ui_plugin_css_h(el){hub.dev(focused).info.plugin_css=el.value;save_devices();addDOM('device_css','style',el.value,EL('plugins'));}
function ui_plugin_js_h(el){hub.dev(focused).info.plugin_js=el.value;save_devices();addDOM('device_js','script',el.value,EL('plugins'));}
function menu_show(state){menu_f=state;let cl=EL('menu').classList;if(menu_f)cl.add('menu_show');else cl.remove('menu_show');EL('icon_menu').innerHTML=menu_f?'':'';display('menu_overlay',menu_f?'block':'none');}
function device_h(id){let dev=hub.dev(id);if(!dev||dev.conn==Conn.NONE)return;if(!dev.info.api_v||dev.info.api_v!=hub.api_v)asyncAlert(lang.api_mis);if(dev.info.PIN&&!dev.granted){pin_id=id;show_screen('pin');}else{open_device(id);}}
function open_device(id){checkUpdates(id);focused=id;let dev=hub.dev(id)
EL('menu_user').innerHTML='';EL('conn').innerHTML=Conn.names[dev.conn];UiPlugin.enableStyle(id);addDOM('device_css','style',dev.info.plugin_css,EL('plugins'));addDOM('device_js','script',dev.info.plugin_js,EL('plugins'));let ctrls=EL('controls#'+id);if(ctrls){ctrls.style.display='block';truncIdRecursive(ctrls,'__old');}
show_screen('ui');dev.focus();}
function close_device(){Ack.clearAll();ui_render.clearWidgets();UiPlugin.disableStyle(focused);UiJS.disable();UiCSS.disable();EL('plugins').innerHTML='';let ctrls=EL('controls#'+focused);if(ctrls){ctrls.style.display='none';addIdRecursive(ctrls,'__old');}
EL('ota_label').innerHTML="";errorBar(false);hub.dev(focused).unfocus();focused=null;show_screen('main');}
async function delete_h(id){if(await asyncConfirm(lang.delete+' '+id+'?')){hub.delete(id);EL(`device#${id}`).remove();}}
function dev_up_h(id){hub.moveDevice(id,-1);render_devices();}
function dev_down_h(id){hub.moveDevice(id,1);render_devices();}
function showCLI(v){EL('bottom_space').style.height=v?'170px':'50px';display('cli_cont',v?'block':'none');if(v)EL('cli_input').focus();EL('info_cli_sw').checked=v;}
function printCLI(text,color){if(EL('cli_cont').style.display=='block'){if(EL('cli').innerHTML)EL('cli').innerHTML+='\n';let st=color?`style="color:${intToCol(color)}"`:'';EL('cli').innerHTML+=`<span ${st}>${text}</span>`;EL('cli').scrollTop=EL('cli').scrollHeight;}}
function toggleCLI(){EL('cli').innerHTML="";EL('cli_input').value="";showCLI(!(EL('cli_cont').style.display=='block'));}
function checkCLI(event){if(event.key=='Enter')sendCLI();}
function sendCLI(){post('cli','cli',EL('cli_input').value);EL('cli').innerHTML+="\n>"+EL('cli_input').value;EL('cli').scrollTop=EL('cli').scrollHeight;EL('cli_input').value="";}
function make_pin(arg){if(arg.value.length>=4)arg.value=arg.value.hashCode();else arg.value='';}
function pass_type(v){EL('pass_inp').value+=v;let hash=EL('pass_inp').value.hashCode();if(pin_id){if(hash==hub.dev(pin_id).info.PIN){open_device(pin_id);EL('pass_inp').value='';hub.dev(pin_id).granted=true;}}else{if(hash==cfg.pin){display('password','none');startup();EL('pass_inp').value='';}}}
function check_type(arg){if(arg.value.length>0){let c=arg.value[arg.value.length-1];if(c<'0'||c>'9')arg.value=arg.value.slice(0,-1);}}
function show_keypad(v){if(v){display('password','block');EL('pass_inp').focus();}else{display('password','none');}}
let fs_arr=[];function showFsbr(fs,total,used){fs_arr=[];for(let path in fs)fs_arr.push(path);fs_arr=sortPaths(fs_arr,'/');let inner='';for(let i in fs_arr){if(fs_arr[i].endsWith('/')){inner+=`<div class="fs_file fs_folder drop_area" onclick="file_upload_path.value='${fs_arr[i]}'/*;file_upload_btn.click()*/" ondrop="file_upload_path.value='${fs_arr[i]}';uploadFile(event.dataTransfer.files[0],'${fs_arr[i]}')">${fs_arr[i]}</div>`;}else{let none="style='display:none'";inner+=`<div class="fs_file" onclick="openFSctrl(${i})">${fs_arr[i]}<div class="fs_weight">${(fs[fs_arr[i]] / 1000).toFixed(2)} kB</div></div>
<div id="fs#${i}" class="fs_controls">
<button ${hub.dev(focused).module(Modules.RENAME) ? '' : none} title="${lang.rename}" class="icon icon_btn_big" onclick="renameFile(${i})"></button>
<button ${hub.dev(focused).module(Modules.DELETE) ? '' : none} title="${lang.delete}" class="icon icon_btn_big" onclick="deleteFile(${i})"></button>
<button ${hub.dev(focused).module(Modules.FETCH) ? '' : none} title="${lang.fetch}" class="icon icon_btn_big" onclick="fetchFile(${i},'${fs_arr[i]}')"></button>
<label id="process#${i}"></label>
<a id="download#${i}" title="${lang.download}" class="icon icon_btn_big" href="" download="" style="display:none"></a>
<button id="open#${i}" title="${lang.open}" class="icon icon_btn_big" onclick="openFile(EL('download#${i}').href)" style="display:none"></button>
<button ${hub.dev(focused).module(Modules.UPLOAD) ? '' : none} id="edit#${i}" title="${lang.edit}" class="icon icon_btn_big" onclick="editFile(EL('download#${i}').href,'${i}')" style="display:none"></button>
</div>`;}}
if(total){let color=adjustColor(getDefColor(),0.9);let style=`background-repeat: no-repeat;background-image:linear-gradient(${color},${color});background-size: ${used / total * 100}% 100%;`;inner+=`<div style="${style}" class="fs_info">${lang.fs_used} ${(used / 1000).toFixed(2)}/${(total / 1000).toFixed(2)} kB [${Math.round(used / total * 100)}%]</div>`;}else{inner+=`<div class="fs_info">${lang.fs_used} ${(used / 1000).toFixed(2)} kB</div>`;}
EL('fsbr_inner').innerHTML=inner;}
function openFSctrl(i){let current=EL(`fs#${i}`).style.display=='flex';document.querySelectorAll('.fs_controls').forEach(el=>el.style.display='none');if(!current)display(`fs#${i}`,'flex');}
function create_h(){post('mkfile',EL('file_create_path').value);}
function uploadFile(file,path){hub.dev(focused).upload(file,path);EL('file_upload').value='';}
function fetchFile(index,path){hub.dev(focused).fetch(index,path);}
function uploadOta(file,type){hub.dev(focused).uploadOta(file,type);EL('ota_upload').value='';EL('ota_upload_fs').value='';}
async function deleteFile(i){if(hub.dev(focused).fsBusy()){showPopupError(getError(HubErrors.FsBusy));return;}
if(await asyncConfirm(lang.delete+' '+fs_arr[i]+'?')){post('delete',fs_arr[i]);}}
async function renameFile(i){if(hub.dev(focused).fsBusy()){showPopupError(getError(HubErrors.FsBusy));return;}
let path=fs_arr[i];let res=await asyncPrompt(lang.rename+' '+path+':',path);if(res&&res!=path)post('rename',path,res);}
let edit_idx=0;function editFile(data,idx){EL('editor_area').value=dataTotext(data);EL('editor_area').scrollTop=0;EL('edit_path').innerHTML=fs_arr[idx];display('files','none');display('fsbr_edit','block');edit_idx=idx;}
function editor_cancel(){display('files','block');display('fsbr_edit','none');}
function editor_save(){editor_cancel();let div=fs_arr[edit_idx].lastIndexOf('/');let path=fs_arr[edit_idx].slice(0,div);let name=fs_arr[edit_idx].slice(div+1);uploadFile(new File([EL('editor_area').value],name,{type:getMime(name),lastModified:new Date()}),path);}
async function otaUrl(url,type){if(await asyncConfirm(lang.fs_upload+' OTA?')){post('ota_url',type,url);showPopup('OTA start');}}
window.onload=()=>{load_cfg();load_cfg_hub();updateLang();render_main();EL('hub_stat').innerHTML='GyverHub v'+app_version+' '+platform();if(platform()=='esp')hub.cfg.use_local=true;update_ip();update_theme();set_drop();key_change();handle_back();register_SW();if(cfg.use_pin&&cfg.pin.length)show_keypad(true);else startup();function register_SW(){if('serviceWorker'in navigator&&platform()=='host'){navigator.serviceWorker.register('sw.js');window.addEventListener('beforeinstallprompt',(e)=>deferredPrompt=e);}}
function set_drop(){function preventDrop(e){e.preventDefault()
e.stopPropagation()}
['dragenter','dragover','dragleave','drop'].forEach(e=>{document.body.addEventListener(e,preventDrop,false);});['dragenter','dragover'].forEach(e=>{document.body.addEventListener(e,function(){document.querySelectorAll('.drop_area').forEach((el)=>{el.classList.add('active');});},false);});['dragleave','drop'].forEach(e=>{document.body.addEventListener(e,function(){document.querySelectorAll('.drop_area').forEach((el)=>{el.classList.remove('active');});},false);});}
function key_change(){document.addEventListener('keydown',function(e){switch(e.keyCode){case 116:if(!e.ctrlKey){e.preventDefault();refresh_h();}
break;case 192:break;if(focused){e.preventDefault();toggleCLI();}
break;default:break;}});}
function handle_back(){window.history.pushState({page:1},"","");window.onpopstate=function(e){window.history.pushState({page:1},"","");back_h();}}
function update_ip(){if(platform()=='esp'||window_ip()){EL('local_ip').value=window_ip();hub.cfg.local_ip=window_ip();}
else if(!Boolean(window.webkitRTCPeerConnection||window.mozRTCPeerConnection))return;getLocalIP().then((ip)=>{if(ip.indexOf("local")<0){EL('local_ip').value=ip;hub.cfg.local_ip=ip;}
return;}).catch(e=>console.log(e));}}
function startup(){render_selects();render_info();apply_cfg();update_theme();show_screen('main');if('Notification'in window&&Notification.permission=='default')Notification.requestPermission();load_devices();let qs=window.location.search;if(qs){let params=new URLSearchParams(qs).entries();let data={};for(let param of params)data[param[0]]=param[1];if(!hub.dev(data.id))hub.addDevice(data);}
setTimeout(()=>{let ver=localStorage.getItem('version');if(!ver||ver!=app_version){asyncAlert(lang.i_version+' '+app_version+'!\n'+'Внимание, это новая версия! Старая версия библиотеки (old) несовместима с приложением! Читайте обновлённую wiki. Старая версия приложения доступна на http://hub.gyver.ru/old/');localStorage.setItem('version',app_version);}},1000);render_devices();hub.begin();discover();if(!wifiAllowed()){display('http_only_http','block');display('http_settings','none');display('pwa_unsafe','none');}
if(platform()!='host'){display('pwa_block','none');display('devlink_btn','none');display('qr_btn','none');}
if(platform()=='host'){display('app_block','block');}
serial_check_ports();if(platform()=='esp'){for(let dev of hub.devices){if(window.location.href.includes(dev.info.ip)){dev.conn=Conn.HTTP;dev.conn_arr[Conn.HTTP]=1;device_h(dev.info.id);return;}}}}
function discover(){spinArrows(true);for(let dev of hub.devices){let id=dev.info.id;EL(`device#${id}`).className="device offline";display(`Serial#${id}`,'none');display(`BT#${id}`,'none');display(`HTTP#${id}`,'none');display(`MQTT#${id}`,'none');}
if(platform()=='esp'){hub.http.discover_ip(window_ip(),window.location.port.length?window.location.port:80);}else{hub.discover();}}
function search(){spinArrows(true);hub.search();}
function applyUpdate(id,data){if(data.func){let wid=EL('widget#'+id);if(wid&&wid.getAttribute("data-func")){UiFunc.update(focused,id,data);}
return;}
let el=CMP(id);if(el){let type=el.getAttribute('data-type');Widget.update(type,id,data);ui_render.updateWidget(type,id,data);}else{let wid=EL('widget#'+id);if(wid){let type=wid.getAttribute('data-custom-type');Widget.update(type,id,data);switch(type){case'html':UiHTML.update(id,data);break;}}else{}}}
hub.mqtt.onConnChange=(state)=>{display('mqtt_ok',state?'inline-block':'none');mq_change(state);}
hub.bt.onConnChange=(state)=>{switch(state){case'connecting':EL('bt_device').innerHTML=lang.connecting;break;case'open':bt_change(true);EL('bt_device').innerHTML=hub.bt.getName();bt_show_ok(true);hub.bt.discover();break;case'close':bt_change(false);EL('bt_device').innerHTML=lang.disconnected;bt_show_ok(false);break;}}
hub.serial.onConnChange=(state)=>{serial_show_ok(state);serial_change(state);if(state){setTimeout(()=>hub.serial.discover(),cfg.serial_offset);}}
hub.serial.onPortChange=(selected)=>{display('serial_open',selected?'inline-block':'none');serial_update_name();}
hub.tg.onConnChange=(state)=>{display('tg_ok',state?'inline-block':'none');tg_change(state);}
hub.onWsConnChange=(id,state)=>{if(id==focused){EL('conn').innerHTML=state?'HTTP/WS':'HTTP';}}
hub.onDeviceConnChange=(id,state)=>{if(id==focused)errorBar(!state);}
hub.onWaitAnswer=(id,state)=>{if(id==focused)spinArrows(state);}
hub.onPingLost=(id)=>{if(id==focused){let cmd='';switch(screen){case'ui':cmd='ui';break;case'info':cmd='info';break;case'files':cmd='files';break;default:cmd='ping';break;}
hub.dev(id).post(cmd);}}
hub.onSaveDevices=()=>{save_devices();}
hub.onAddDevice=(dev)=>{dev.ui_mode=0;dev.main_width=450;dev.ui_block_width=250;dev.plugin_css='';dev.plugin_js='';add_device(dev);}
hub.onUpdDevice=(dev)=>{EL(`name#${dev.id}`).innerHTML=dev.name?dev.name:'Unknown';EL(`device#${dev.id}`).title=`${dev.id} [${dev.prefix}]`;}
hub.onDiscoverEnd=()=>{if(screen=='main')spinArrows(false);}
hub.onDiscover=(id,conn)=>{EL(`device#${id}`).className="device";display(`${Conn.names[conn]}#${id}`,'inline-block');}
hub.onFsUploadStart=(id)=>{if(id!=focused)return;EL('file_upload_btn').innerHTML=waiter(22,'var(--font_inv)',false);}
hub.onFsUploadPerc=(id,perc)=>{if(id!=focused)return;showPopup(lang.upload+'... '+perc+'%');}
hub.onFsUploadEnd=(id)=>{if(id!=focused)return;EL('file_upload_btn').innerHTML=lang.upload;showPopup(`[${lang.upload}] `+lang.done);}
hub.onFsUploadError=(id,code)=>{if(id!=focused)return;EL('file_upload_btn').innerHTML=lang.upload;showPopupError(`[${lang.upload}] `+getError(code));}
hub.onFsFetchStart=(id,index)=>{if(id!=focused)return;display('download#'+index,'none');display('edit#'+index,'none');display('open#'+index,'none');display('process#'+index,'unset');EL('process#'+index).innerHTML='';}
hub.onFsFetchPerc=(id,index,perc)=>{if(id!=focused)return;EL('process#'+index).innerHTML=perc+'%';}
hub.onFsFetchEnd=(id,name,index,data)=>{if(id!=focused)return;display('download#'+index,'inline-block');EL('download#'+index).href=('data:'+getMime(name)+';base64,'+data);EL('download#'+index).download=name;display('edit#'+index,'inline-block');display('process#'+index,'none');if(platform()!='mobile')display('open#'+index,'inline-block');}
hub.onFsFetchError=(id,index,code)=>{if(id!=focused)return;showPopupError(`[${lang.fetch}] `+getError(code));EL('process#'+index).innerHTML=lang.error;}
hub.onFetchStart=(id,name)=>{if(id==focused)Widget.setPlabel(name,'[FETCH...]');}
hub.onFetchPerc=(id,name,perc)=>{if(id==focused)Widget.setPlabel(name,`[${perc}%]`);}
hub.onFetchEnd=(id,name,data,file)=>{if(id!=focused)return;switch(data.type){case'img':UiImage.apply(name,file);Widget.setPlabel(name);break;case'csv':UiTable.apply(name,dataTotext(file).replaceAll(/\\n/ig,"\n"));Widget.setPlabel(name);break;case'cv_img':data.img.src=file;Widget.setPlabel(name);break;case'text':UiText_f.apply(name,dataTotext(file));Widget.setPlabel(name);break;case'plugin_js':UiPlugin.applyScript(id,dataTotext(file));UiFunc.show(data.cont);break;case'plugin_css':UiPlugin.applyStyle(id,dataTotext(file));break;case'js':UiJS.apply(name,dataTotext(file),data.cont);break;case'css':UiCSS.apply(name,dataTotext(file),data.cont);break;case'html':UiHTML.apply(name,dataTotext(file));Widget.setPlabel(name);break;case'icon':UiButton.apply(name,dataTotext(file));Widget.setPlabel(name);break;case'ui_json':UiFile.apply(dataTotext(file),data);break;}}
hub.onFetchError=(id,name,data,code)=>{if(id!=focused)return;Widget.setPlabel(name,'[ERROR]');switch(data.type){case'csv':case'img':break;}}
hub.onOtaStart=(id)=>{if(id!=focused)return;EL('ota_label').innerHTML=waiter(25,'var(--font)',false);}
hub.onOtaEnd=(id)=>{if(id!=focused)return;showPopup('[OTA] '+lang.done);EL('ota_label').innerHTML=lang.done;}
hub.onOtaError=(id,code)=>{if(id!=focused)return;showPopupError('[OTA] '+getError(code));EL('ota_label').innerHTML=lang.error;}
hub.onOtaPerc=(id,perc)=>{if(id!=focused)return;EL('ota_label').innerHTML=perc+'%';}
hub.onOtaUrlEnd=(id)=>{if(id!=focused)return;showPopup('[OTA] '+lang.done);}
hub.onOtaUrlError=(id,code)=>{if(id!=focused)return;showPopupError('[OTA url] '+getError(code));}
hub.onFsError=(id)=>{if(id==focused)EL('fsbr_inner').innerHTML=`<div class="fs_err">FS ${lang.error}</div>`;}
hub.onError=(id,code)=>{if(id==focused)showPopupError(getError(code));}
hub.onAck=(id,name)=>{if(id==focused)Ack.clear(name);}
hub.onUpdate=(id,name,data)=>{if(id!=focused)return;if(screen!='ui')return;applyUpdate(name,data);}
hub.onInfo=(id,info)=>{if(id==focused)showInfo(info);}
hub.onFsbr=(id,fs,total,used)=>{if(id==focused)showFsbr(fs,total,used);}
hub.onPrint=(id,text,color)=>{if(id==focused)printCLI(text,color);}
hub.onUi=(id,controls)=>{if(id==focused)showControls(id,controls);}
hub.onData=(id,data)=>{console.log('Data from '+id+': '+data);}
hub.onAlert=(id,text)=>{release_all();asyncAlert(hub.dev(id).info.name+': '+text);}
hub.onNotice=(id,text,color)=>{showPopup(hub.dev(id).info.name+': '+text,color);}
let push_timer=0;hub.onPush=(id,text)=>{let date=(new Date).getTime();if(date-push_timer>3000){push_timer=date;showNotif(hub.dev(id).info.name+': ',text);}}
hub.onHubError=(text)=>{showPopupError(text);}
